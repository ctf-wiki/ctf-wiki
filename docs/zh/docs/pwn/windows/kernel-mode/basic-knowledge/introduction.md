# åŸºç¡€çŸ¥è¯†

> å¦‚æœä½ å¯¹æ“ä½œç³»ç»ŸåŸºæœ¬ç†è®ºå¹¶ä¸ç†Ÿæ‚‰ï¼Œé‚£ç¬”è€…å…¶å®æ›´æ¨è [ä» Linux kernel è¿™ä¸€ä¸ªå¼€æºå®å†…æ ¸è¿›è¡Œå…¥é—¨](https://arttnba3.cn/2021/02/21/OS-0X00-LINUX-KERNEL-PART-I/)ï¼Œæœ¬æ–‡åŸºæœ¬ä¸ä¼šæ¶‰åŠæ“ä½œç³»ç»ŸåŸºç¡€æ¦‚å¿µã€‚

Windows æ“ä½œç³»ç»Ÿå…¨ç§°ä¸º**æ–°æŠ€æœ¯è§†çª—**ï¼ˆWindows New Technologyï¼Œç®€ç§° **Windows NT**ï¼‰ï¼Œå…¶ _æ›¾ç»_ å£°ç§°é‡‡ç”¨çš„æ˜¯**å¾®å†…æ ¸æ¶æ„**ï¼ˆmicro kernelï¼‰ï¼Œå³**å¤§éƒ¨åˆ†ç³»ç»Ÿç»„ä»¶éƒ½ä»¥ç”¨æˆ·æ€å½¢å¼å­˜åœ¨ï¼Œä»…æœ‰éƒ¨åˆ†å¿…è¦ç»„ä»¶ä»¥å†…æ ¸æ€å½¢å¼å­˜åœ¨**ï¼Œä½†å®é™…ä¸Šç°åœ¨ Windows å¾€å†…æ ¸æ€å¡äº†ä¸å°‘ä¸œè¥¿ï¼Œæ‰€ä»¥ç°åœ¨çš„ NT kernel æ›´åå‘äº _æ··åˆå†…æ ¸_ ï¼ˆhybrid kernelï¼‰ã€‚

![Windows å†…æ ¸æ¶æ„æ€»è§ˆ](https://s2.loli.net/2025/02/01/o9DzrNqSvLxIfdR.png)

æœ¬ç¯‡åšå®¢æˆ‘ä»¬ä¸»è¦ä»‹ç» **64 ä½** Windows NT kernel çš„åŸºæœ¬è¿è¡ŒåŸç†ä»¥åŠä¸€äº›åŸºæœ¬ç»„ä»¶ï¼Œä¸»è¦ä»¥ Windows 10 ä½œä¸ºæ¡ˆä¾‹è¿›è¡Œè®²è§£ï¼Œ _ä¸ä¼šæ¶‰åŠä¸ 32 ä½ç›¸å…³çš„å†…å®¹_ ã€‚

> å…³äº Windows å†…æ ¸ä¸€äº›ç»“æ„ä½“çš„å®šä¹‰å¯ä»¥å‚è§ [è¿™ä¸ªç½‘ç«™](https://www.vergiliusproject.com/kernels)

## ä¸€ã€ç”¨æˆ·æ€éƒ¨åˆ†

Windows NT æ“ä½œç³»ç»Ÿåœ¨ç”¨æˆ·æ€ä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š

- ç³»ç»Ÿè¿›ç¨‹ï¼ˆSystem Processesï¼‰
- æœåŠ¡ï¼ˆServicesï¼‰
- åº”ç”¨ï¼ˆApplicationsï¼‰
- ç¯å¢ƒå­ç³»ç»Ÿï¼ˆEnvironment Subsystemï¼‰

Windows ä¸‹æ‰€æœ‰ç”¨æˆ·æ€ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„è·å–æœ€ç»ˆéƒ½è¦é€šè¿‡ `ntdll.dll` æä¾›çš„ç³»ç»Ÿè°ƒç”¨æ¥å£å®Œæˆã€‚

## äºŒã€å†…æ ¸æ€éƒ¨åˆ†

 NT kernel å¹¶ä¸å­˜åœ¨ç¡¬ä»¶æ„ä¹‰ä¸Šçš„åˆ†å±‚ï¼ˆéƒ½è·‘åœ¨ ring0ï¼‰ï¼Œä½†åœ¨è®¾è®¡ä¸Šå­˜åœ¨åˆ†å±‚ä¾èµ–çš„æ¦‚å¿µï¼Œå¯ä»¥åˆ†ä¸ºå¦‚å›¾æ‰€ç¤ºçš„ä¸‰å±‚ï¼š

![Windows ç³»ç»Ÿæ¶æ„å±‚æ¬¡](https://s2.loli.net/2025/02/01/ZwtEYSgi8UPr7Wx.png)

### ä¸Šå±‚ï¼šæ‰§è¡Œä½“ ï¼ˆExecutiveï¼‰

**æ‰§è¡Œä½“**ï¼ˆExecutiveï¼‰æ˜¯ NT kernel çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œ **æœ¬è´¨ä¸Šå°±æ˜¯ä¼ ç»Ÿçš„æ“ä½œç³»ç»Ÿå†…æ ¸æœ¬ä½“**ï¼Œæ¯”è¾ƒæ ¸å¿ƒçš„ä¸€äº›å­ç³»ç»Ÿå¦‚ä¸‹ï¼š

- **å¯¹è±¡ç®¡ç†å™¨**ï¼ˆObject Managerï¼‰ï¼šå¯¹è±¡ç®¡ç†å™¨æ˜¯ **æ‰§è¡Œä½“çš„åº•å±‚éƒ¨åˆ†** ï¼Œåœ¨å†…æ ¸ä¸­ **æ‰€æœ‰çš„èµ„æºéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡** ï¼ˆobjectï¼‰ï¼Œå¯¹è±¡ç®¡ç†å™¨ä¾¿è´Ÿè´£ç®¡ç†æ‰€æœ‰çš„å†…æ ¸å¯¹è±¡ã€‚
- è¾“å…¥è¾“å‡ºç®¡ç†å™¨ï¼ˆI/O Managerï¼‰ï¼šè´Ÿè´£æ¥æ”¶ç”¨æˆ·æ€ç¨‹åºçš„ I/O è¯·æ±‚ï¼ˆå¦‚è®¿é—®ç£ç›˜ï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸ºå¯¹ç›¸å…³è®¾å¤‡çš„è°ƒç”¨ã€‚
- å®‰å…¨å¼•ç”¨ç›‘è§†å™¨ï¼ˆSecurity Reference Monitorï¼‰ï¼šWindows ä½¿ç”¨**è®¿é—®æ§åˆ¶åˆ—è¡¨**ï¼ˆAccess Control Listï¼‰æ¥ç¡®å®šå¯¹è±¡çš„å®‰å…¨æ€§ï¼Œè¯¥å­ç³»ç»Ÿä¾¿è´Ÿè´£å®è¡Œå®‰å…¨è§„åˆ™ã€‚
- è¿›ç¨‹é—´é€šä¿¡ç®¡ç†å™¨ï¼ˆIPC Managerï¼‰ï¼šè´Ÿè´£å¤„ç†ä¸åŒè¿›ç¨‹é—´çš„é€šä¿¡è¯·æ±‚ã€‚
- è™šæ‹Ÿå†…å­˜ç®¡ç†å™¨ï¼ˆVirtual Memory Managerï¼‰ï¼šè´Ÿè´£ä»å†…æ ¸å±‚é¢è¿›è¡Œæ•´ä¸ªæ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†ã€‚
- è¿›ç¨‹ç®¡ç†å™¨ï¼ˆProcess Managerï¼‰ï¼šè´Ÿè´£è¿›ç¨‹ä¸çº¿ç¨‹çš„åˆ›å»ºä¸é”€æ¯ï¼Œ _ä¸è´Ÿè´£ç›´æ¥è°ƒåº¦_ã€‚
- å³æ’å³ç”¨ç®¡ç†å™¨ï¼ˆPlug and Play Managerï¼‰ï¼šè´Ÿè´£å¤„ç†è®¾å¤‡åŠ¨æ€è½½å…¥ä¸å¸è½½æ—¶è¿›è¡Œæ£€æµ‹åŠæä¾›ç›¸åº”æœåŠ¡ï¼Œå¤§éƒ¨åˆ†å®é™…ä¸Šåœ¨ç”¨æˆ·æ€çš„ `Plug and Play` ä¸­å®ç°ã€‚
- ç”µæºç®¡ç†å™¨ï¼ˆPower Managerï¼‰ï¼šè´Ÿè´£å¤„ç†ç”µæºç›¸å…³äº‹ä»¶ï¼ˆå…³æœºã€ç¡çœ ç­‰ï¼‰ï¼Œå¹¶é€šçŸ¥ç›¸å…³è”çš„é©±åŠ¨ç¨‹åºã€‚
- å›¾å½¢è®¾å¤‡æ¥å£ï¼ˆGraphic Device Interfaceï¼‰ï¼šè´Ÿè´£æ‰€æœ‰åŸºæœ¬çš„ç»˜å›¾åŠŸèƒ½ï¼Œè‡ª NT 4.0 èµ·ç§»å…¥å†…æ ¸æ€ä¸­è¿è¡Œï¼ˆæ­¤å‰åœ¨ç”¨æˆ·æ€ï¼‰ã€‚

æ‰§è¡Œä½“ç›¸å…³çš„ä»£ç ä½äº `ntoskrnl.exe` ä¸­ï¼Œå…¶å‘ç”¨æˆ·æ€å¯¼å‡ºçš„æ¥å£ä½äº `ntdll.dll` ä¸­ã€‚

### ä¸­å±‚ï¼šï¼ˆå¾®ï¼‰å†…æ ¸ï¼ˆKernelï¼‰

**å†…æ ¸**ï¼ˆKernelï¼‰åœ¨ NT kernel ä¸­**ä»…**è´Ÿè´£å¤šå¤„ç†å™¨é—´åŒæ­¥ã€çº¿ç¨‹ç›´æ¥è°ƒåº¦ã€ä¸­æ–­/å¼‚å¸¸åˆ†å‘ç­‰æœ€åŸºæœ¬çš„ _ç¡¬ä»¶ä¾§èŒèƒ½_ ï¼Œç¬¦åˆâ€œå¾®å†…æ ¸â€æ¶æ„çš„åŸºæœ¬æ€æƒ³ã€‚

å†…æ ¸ç›¸å…³ä»£ç ä½äº `ntoskrnl.exe` ä¸­ã€‚

### ä¸­å±‚ï¼šå†…æ ¸æ¨¡å¼é©±åŠ¨ï¼ˆKernel Mode Driverï¼‰

Windows ä¸‹çš„é©±åŠ¨æœ‰ä¸¤ç§ï¼šç”¨æˆ·æ¨¡å¼é©±åŠ¨å’Œå†…æ ¸æ¨¡å¼é©±åŠ¨ï¼Œåè€…è´Ÿè´£å‘å‰è€…æä¾›å¯¹åº”çš„æ¥å£ï¼Œå¹¶å°†æ•°æ®ä¼ é€’ç»™æ›´ä¸ºåº•å±‚çš„é©±åŠ¨ç¨‹åºã€‚

å†…æ ¸æ¨¡å¼é©±åŠ¨å¯ä»¥åˆ†ä¸ºå¦‚å›¾æ‰€ç¤ºçš„ä¸‰å±‚ï¼Œè¶Šè´´è¿‘åº•å±‚è¶Šé è¿‘è¯¦ç»†å…·ä½“çš„ç¡¬ä»¶ç»“æ„ï¼š

![](https://s2.loli.net/2025/02/01/KeypmW8xGPViXQH.png)

å†…æ ¸æ¨¡å¼é©±åŠ¨è¢«å®ç°ä¸ºç¦»æ•£çš„æ¨¡å—åŒ–ç»„ä»¶ï¼Œè€Œéä½äºæŸä¸ªç‰¹å®šçš„ PE æ–‡ä»¶ä¸­ï¼ˆæœ‰ç‚¹åƒ LKMï¼Ÿï¼‰ã€‚

### ä¸‹å±‚ï¼šç¡¬ä»¶æŠ½è±¡å±‚ï¼ˆHardware Abstract Layerï¼‰

**ç¡¬ä»¶æŠ½è±¡å±‚**ï¼ˆHardware Abstract Layerï¼‰è´Ÿè´£éšè—ä¸å±è”½åº•å±‚ä¸åŒç¡¬ä»¶çš„å„ç§ç»†èŠ‚ï¼Œä»è€Œå‘ä¸Šå±‚å†…æ ¸æä¾›**ç»Ÿä¸€çš„æŠ½è±¡ç¡¬ä»¶æ¥å£**ï¼Œä¾‹å¦‚ IO æ¥å£ã€ä¸­æ–­æ§åˆ¶å™¨ç­‰ç¡¬ä»¶è¡Œä¸ºçš„ç»Ÿä¸€æŠ½è±¡ã€‚

HAL çš„ç›®çš„ä¸»è¦æ˜¯æ¶ˆé™¤ç¡¬ä»¶æ¶æ„é—´çš„å·®å¼‚ï¼Œä»è€Œæ–¹ä¾¿æ“ä½œç³»ç»Ÿä¸é©±åŠ¨å¼€å‘è€…ä¸ºä¸åŒç¡¬ä»¶å¹³å°ç¼–å†™ä¸å…·ä½“ç¡¬ä»¶æ¶æ„æ— å¼ºç›¸å…³çš„ä»£ç ä»¥è·¨å¹³å°è¿è¡Œï¼Œä»è€Œæ— éœ€ä¸ºæ¯ä¸ªç¡¬ä»¶å¹³å°éƒ½å•ç‹¬ç¼–å†™ä¸€å¥—é’ˆå¯¹æ€§ä»£ç ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ HAL ä¸»è¦è´Ÿè´£ IO ç­‰é€šç”¨èµ„æºçš„æŠ½è±¡ï¼Œéƒ¨åˆ†é©±åŠ¨çš„éƒ¨åˆ†æ“ä½œä»ç„¶æ˜¯ç»•å¼€ HAL ç›´æ¥ä¸ç¡¬ä»¶è¿›è¡Œé€šä¿¡çš„ã€‚

HAL ç›¸å…³ä»£ç ä½äº `hal.dll` ä¸­ã€‚

## â€œä¸€åˆ‡çš†å¯¹è±¡â€

ç±»ä¼¼äº *NIX ç³»ç»Ÿä¸­ä¸€åˆ‡çš†æ–‡ä»¶çš„å“²å­¦ï¼Œåœ¨ Windows NT kernel å½“ä¸­åŒæ ·æœ‰**ä¸€åˆ‡éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡**ï¼ˆobjectï¼‰çš„è¯´æ³•ï¼Œæ–‡ä»¶ã€è®¾å¤‡ã€åŒæ­¥æœºåˆ¶ã€æ³¨å†Œè¡¨é¡¹ç­‰**åœ¨å†…æ ¸ä¸­éƒ½è¡¨ç¤ºä¸ºå¯¹è±¡**ï¼Œæ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ª `header` å­˜å‚¨å¯¹è±¡åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚åå­—ã€ç±»å‹ã€ä½ç½®ï¼‰ï¼Œä»¥åŠä¸€ä¸ª `body` å­˜å‚¨æ•°æ®ã€‚

NT kernel ä¸­çš„å¯¹è±¡å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

- æ‰§è¡Œä½“å¯¹è±¡ï¼ˆExecutive Objectsï¼‰ï¼šæ‰§è¡Œä½“å¯¹å¤–æš´éœ²çš„èµ„æºå¯¹è±¡ï¼ˆå¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€æ–‡ä»¶ç­‰ï¼‰ï¼Œå¯¹ç”¨æˆ·æ€å¯è§ã€‚
- å†…æ ¸å¯¹è±¡ï¼ˆKernel Objectsï¼‰ï¼šæœ€åŸºæœ¬çš„èµ„æºå¯¹è±¡ï¼ˆå¦‚ç‰©ç†è®¾å¤‡ç­‰ï¼‰ï¼Œå¯¹ç”¨æˆ·æ€ä¸å¯è§ã€‚

### ä¸€ã€\_OBJECT\_HEADERï¼šå¯¹è±¡åŸºæœ¬ä¿¡æ¯

åœ¨ NT kernel ä¸­ `_OBJECT_HEADER` ç»“æ„ä½“ç”¨æ¥å­˜å‚¨å¯¹è±¡çš„åŸºæœ¬ä¿¡æ¯ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š
```powershell
kd> dt nt!_OBJECT_HEADER
   +0x000 PointerCount     : Int8B
   +0x008 HandleCount      : Int8B
   +0x008 NextToFree       : Ptr64 Void
   +0x010 Lock             : _EX_PUSH_LOCK
   +0x018 TypeIndex        : UChar
   +0x019 TraceFlags       : UChar
   +0x019 DbgRefTrace      : Pos 0, 1 Bit
   +0x019 DbgTracePermanent : Pos 1, 1 Bit
   +0x01a InfoMask         : UChar
   +0x01b Flags            : UChar
   +0x01b NewObject        : Pos 0, 1 Bit
   +0x01b KernelObject     : Pos 1, 1 Bit
   +0x01b KernelOnlyAccess : Pos 2, 1 Bit
   +0x01b ExclusiveObject  : Pos 3, 1 Bit
   +0x01b PermanentObject  : Pos 4, 1 Bit
   +0x01b DefaultSecurityQuota : Pos 5, 1 Bit
   +0x01b SingleHandleEntry : Pos 6, 1 Bit
   +0x01b DeletedInline    : Pos 7, 1 Bit
   +0x01c Reserved         : Uint4B
   +0x020 ObjectCreateInfo : Ptr64 _OBJECT_CREATE_INFORMATION
   +0x020 QuotaBlockCharged : Ptr64 Void
   +0x028 SecurityDescriptor : Ptr64 Void
   +0x030 Body             : _QUAD
```

ä¸€ä¸ªå¯¹è±¡é™¤äº†å›ºå®šçš„ `_OBJECT_HEADER` ä»¥å¤–**è¿˜å¯ä»¥æœ‰é¢å¤–çš„ optional header æ¥å­˜å‚¨é¢å¤–çš„ä¿¡æ¯**ï¼Œå¯¹åº”çš„ optional header æ˜¯å¦å­˜åœ¨ç”± `_OBJECT_HEADER->InfoMask` æ©ç å†³å®šï¼š

![](https://s2.loli.net/2025/02/01/S8hIzlRWCFGjTed.png)

å½“ `_OBJECT_HEADER->InfoMask` æ©ç ä¸­å­˜åœ¨å¯¹åº”ä½æ—¶åˆ™è¡¨ç¤º _å¯¹åº”çš„ optional header å­˜åœ¨_ ï¼Œç”±äº optional header çš„å­˜å‚¨é¡ºåºå›ºå®šï¼ŒNT kernel å¯ä»¥å¾ˆå®¹æ˜“è®¡ç®—å‡ºä¸åŒ header å¯¹åº”çš„åç§»ï¼Œæ©ç ä¸ header type & size å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š

| Bit  |              Type              | Size (on X86) |
| :--: | :----------------------------: | :-----------: |
| 0x01 | nt!_OBJECT_HEADER_CREATOR_INFO |     0x10      |
| 0x02 |  nt!_OBJECT_HEADER_NAME_INFO   |     0x10      |
| 0x04 | nt!_OBJECT_HEADER_HANDLE_INFO  |     0x08      |
| 0x08 |  nt!_OBJECT_HEADER_QUOTA_INFO  |     0x10      |
| 0x10 | nt!_OBJECT_HEADER_PROCESS_INFO |     0x08      |

åœ¨**NT kernel 19H1 ç‰ˆæœ¬ä»¥å‰**ï¼ŒWindows å†…æ ¸**ä»…**ä½¿ç”¨ `Pool Allocator` ï¼Œæ­¤æ—¶å¯¹äºæ¯ä¸ªåˆ†é…çš„å†…æ ¸æ± å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª `_POOL_HEADER` ç»“æ„ä½“å­˜å‚¨ç›¸åº”çš„ä¿¡æ¯ï¼š

```powershell
kd> dt nt!_POOL_HEADER
   +0x000 PreviousSize     : Pos 0, 8 Bits
   +0x000 PoolIndex        : Pos 8, 8 Bits
   +0x002 BlockSize        : Pos 0, 8 Bits
   +0x002 PoolType         : Pos 8, 8 Bits
   +0x000 Ulong1           : Uint4B
   +0x004 PoolTag          : Uint4B
   +0x008 ProcessBilled    : Ptr64 _EPROCESS
   +0x008 AllocatorBackTraceIndex : Uint2B
   +0x00a PoolTagHash      : Uint2B
```

ç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªå†…æ ¸å¯¹è±¡çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://s2.loli.net/2025/02/01/rzoqgZXxNSmsa52.png)

### äºŒã€å¯¹è±¡ç®¡ç†å™¨ä¸å‘½åç©ºé—´

NT kernel ä¸­æ‰€æœ‰çš„å¯¹è±¡é€šè¿‡**å¯¹è±¡ç®¡ç†å™¨**ï¼ˆObject Managerï¼‰è¿›è¡Œç®¡ç†ï¼Œç”¨æˆ·æ€å¯¹ä»»ä½•å¯¹è±¡çš„è®¿é—®éƒ½éœ€è¦é€šè¿‡å¯¹è±¡ç®¡ç†å­ç³»ç»Ÿï¼Œå¯¹è±¡ç®¡ç†å™¨ä¸»è¦è´Ÿè´£å¦‚ä¸‹ä»»åŠ¡ï¼š

- ç®¡ç†å¯¹è±¡çš„åˆ›å»ºä¸é”€æ¯
- ç»´æŠ¤å¯¹è±¡å‘½åç©ºé—´æ•°æ®åº“
- è¿½è¸ªåˆ†é…ç»™è¿›ç¨‹çš„èµ„æº
- è¿½è¸ªç‰¹å®šå¯¹è±¡çš„è®¿é—®æƒé™
- ç®¡ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ

å¯¹è±¡å½’å±äºä¸åŒçš„[å‘½åç©ºé—´](https://learn.microsoft.com/zh-cn/windows/win32/termserv/kernel-object-namespaces)ï¼ˆNamespaceï¼‰ï¼Œä¸åŒçš„ç”¨æˆ·ä¼šè¯ï¼ˆuser sessionï¼‰ä¾¿ä¸ºä¸åŒçš„å‘½åç©ºé—´ï¼Œå¯¹è±¡åˆ›å»ºæ—¶é»˜è®¤å½’å±äºå½“å‰ä¼šè¯çš„å‘½åç©ºé—´ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€ä¸ªå…¨å±€å…±äº«çš„**å…¨å±€å‘½åç©ºé—´**ï¼Œä»è€Œä½¿å¾—å¯¹è±¡å¯ä»¥åœ¨ä¸åŒä¼šè¯é—´è¿›è¡Œå…±äº«ã€‚

> åˆ›å»ºå¯¹è±¡æ—¶å¯ä»¥é€šè¿‡ `"Global\"` å‰ç¼€æ¥å°†è¯¥å¯¹è±¡åˆ›å»ºäºå…¨å±€å‘½åç©ºé—´ä¸­ï¼Œä¾‹å¦‚é€šè¿‡å¦‚ä¸‹ä»£ç å¯ä»¥åˆ›å»ºä¸€ä¸ªå±äºå…¨å±€å‘½åç©ºé—´çš„äº‹ä»¶å¯¹è±¡ï¼š
>
> ```cpp
> CreateEvent( NULL, FALSE, FALSE, "Global\\ARTTNBA3" );
> ```
>
> ä¹Ÿå¯ä»¥é€šè¿‡ `â€œLocal\â€` å‰ç¼€æ˜¾å¼è¯´æ˜å¯¹è±¡åˆ›å»ºåœ¨ä¼šè¯å‘½åç©ºé—´ä¸­ã€‚

### ä¸‰ã€å¥æŸ„ï¼ˆhandlerï¼‰

> æœ‰ç‚¹ç±»ä¼¼äº Linux ä¸‹æ–‡ä»¶æè¿°ç¬¦çš„æ¦‚å¿µï¼Œä½†æ˜¯æ‰©å±•åˆ°äº†å¤§éƒ¨åˆ†å†…æ ¸å¯¹è±¡ã€‚
>
> > éå¸¸ä¸çŸ¥æ‰€è°“çš„ç¿»è¯‘ï¼Œç¬”è€…ä¸ªäººæ„Ÿè§‰ç¿»è¯‘æˆ _å¼•ç”¨ç¬¦_ å¯èƒ½ä¼šæ›´å¥½ä¸€äº›ã€‚

**å¥æŸ„**ï¼ˆhandlerï¼‰æ˜¯ Windows ä¸‹ç”¨æˆ·æ€ç¨‹åºç”¨æ¥ç®¡ç†å¯¹åº”å†…æ ¸å¯¹è±¡çš„ä¸€ä¸ªå¯¹è±¡æè¿°ç¬¦ï¼Œè¡¨ç¤ºå½¢å¼ä¸ºä¸€ä¸ªæ•´æ•°å€¼ï¼ˆ32/64 ä½ç³»ç»Ÿä¸­ä¸º 32/64 ä½æ•´æ•°ï¼‰ï¼Œç”¨æˆ·ç¨‹åºé€šè¿‡å…¶æ‹¥æœ‰çš„å¥æŸ„å¯ä»¥è®¿é—®å†…æ ¸ä¸­ç›¸å¯¹åº”çš„å†…æ ¸å¯¹è±¡ã€‚

åœ¨ Windows ä¸­ä¸€å…±æœ‰ä»¥ä¸‹å‡ ç§å­˜å‚¨å¯¹è±¡ä¿¡æ¯çš„å¥æŸ„è¡¨ï¼š

- Windows NT kernel ä¸­æ‰€æœ‰å¯¹è±¡çš„å¥æŸ„éƒ½å­˜æ”¾åœ¨ä¸€ä¸ªå…¨å±€çš„å¥æŸ„è¡¨å½“ä¸­
- æ¯ä¸ªè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„ä¸€ä¸ªå¥æŸ„è¡¨ï¼ˆå…¶åœ°å€å­˜æ”¾åœ¨è¿›ç¨‹æ§åˆ¶å—çš„ `_EPROCESS->_HANDLER_TABLE->TableCode` ä¸­ï¼‰ï¼Œ**è¿›ç¨‹æ‰€è·å–åˆ°çš„å¯¹è±¡å¥æŸ„å€¼å®é™…ä¸Šæ˜¯ã€è¯¥è¡¨å¯¹åº”é¡¹çš„ä¸‹æ ‡ç´¢å¼•å€¼x4ã€‘**ï¼ˆ64 ä½ç³»ç»Ÿï¼Œæ¯ä¸ªæ¡ç›® 16 å­—èŠ‚ï¼‰

è¿›ç¨‹å¥æŸ„è¡¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­ç¬¬ 0 é¡¹ä¸ºä¿ç•™é¡¹ï¼Œå¥æŸ„è¡¨é¡¹ä¸º `_HANDLE_TABLE_ENTRY` ç»“æ„ï¼Œå…¶ä½ 44 ä½å€¼å·¦ç§» 4 ä½åŠ ä¸Š `0xffff000000000000` ä¾¿æ˜¯å¯¹è±¡å¤´åœ°å€ï¼š

> åœ¨ Windows 7 å½“ä¸­è¿›ç¨‹å¥æŸ„è¡¨å®é™…ä¸Šä»…ç®€å•å­˜æ”¾å¯¹è±¡çš„åœ°å€ï¼Œä½†æ˜¯åˆ°äº†é«˜ç‰ˆæœ¬å†…æ ¸ä¸€åˆ‡éƒ½å¼€å§‹å˜å¾—å¤æ‚äº†èµ·æ¥ã€‚

![32 ä½ NT kernel ä¸­å¥æŸ„è¡¨çš„ç»“æ„ï¼Œ64 ä½ä¸‹çš„åŸç†åŸºæœ¬ä¸€è‡´](https://s2.loli.net/2025/02/01/yZk1NKeIqBcriVS.png)

åŒæ—¶ `TableCode` ä½¿ç”¨ä½ 4 ä½**æ ‡è¯†å¥æŸ„è¡¨çš„ç»“æ„å±‚æ¬¡**â€”â€”å³**è¿›ç¨‹å¥æŸ„è¡¨å®é™…ä¸Šå¯ä»¥æœ‰å¤šå±‚ç»“æ„**ï¼Œç±»ä¼¼äºé¡µè¡¨ï¼Œ**ä»…æœ‰æœ€åä¸€å±‚å­˜æ”¾å¯¹è±¡åœ°å€ï¼Œå…¶ä»–å±‚éƒ½ç”¨äºå­˜æ”¾è¡¨åœ°å€**ï¼Œæ¯å¼ è¡¨çš„å¤§å°ä¸º 4096 å­—èŠ‚ï¼ˆä¸€å¼ å†…å­˜é¡µå¤§å°ï¼‰ï¼š

![](https://s2.loli.net/2025/02/01/nU3FkTsiGpPMw8Q.png)

## å†…å­˜ç®¡ç†

å†…å­˜ç®¡ç†æ˜¯æ“ä½œç³»ç»Ÿæœ€æ ¸å¿ƒçš„ä¸€éƒ¨ä»½ä¹‹ä¸€ï¼Œä¸å¯ä¸å“å°ã€‚

### ä¸€ã€ç‰©ç†å†…å­˜ç®¡ç†

#### å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€

é¦–å…ˆæ¥ä¸€å¼  64 ä½ NT kernel å†…å­˜å¸ƒå±€æ€»è§ˆï¼š

> 32 ä½å°±æš‚æ—¶ä¸è€ƒè™‘ç ”ç©¶äº†ï¼Œæ¯•ç«Ÿä» Win11 å¼€å§‹å°±å·²ç»éƒ½æ˜¯çº¯ 64 ä½äº†ã€‚

| **Start**               | **End**                   | **Size**  | **Description**          | Usage                                                  |
| ----------------------- | ------------------------- | --------- | ------------------------ | ------------------------------------------------------ |
| FFFF080000000000       | FFFFF67FFFFFFFFF         | 238TB     | Unused System Space      | ä¸ä¼šè¢«ç”¨åˆ°çš„ç©ºé—´                                       |
| FFFFF68000000000       | FFFFF6FFFFFFFFFF         | 512GB     | PTE Space                | é¡µè¡¨æ‰€åœ¨åŒºåŸŸ                                           |
| FFFFF70000000000       | FFFFF77FFFFFFFFF         | 512GB     | HyperSpace               | ç”¨æ¥åšä¸´æ—¶ä¸­è½¬æ˜ å°„                                     |
| FFFFF78000000000       | FFFFF78000000FFF         | 4K        | Shared System Page       | å…±äº«å†…å­˜ç©ºé—´ï¼Œï¼ˆä½œä¸ºå†…æ ¸å…¥å£ç‚¹ï¼Ÿï¼‰åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­éƒ½æœ‰æ˜ å°„ |
| FFFFF78000001000       | FFFFF7FFFFFFFFFF         | 512GB-4K  | System Cache Working Set | ç³»ç»Ÿç¼“å­˜çš„å·¥ä½œé›† |
| FFFFF80000000000       | FFFFF87FFFFFFFFF         | 512GB     | Initial Loader Mappings  | æœ€åˆçš„å†…æ ¸åŠ è½½å™¨æ‰€ç”¨åŒºåŸŸ                               |
| FFFFF88000000000       | FFFFF89FFFFFFFFF         | 128GB     | Sys PTEs                 | ç³»ç»Ÿé¡µè¡¨é¡¹åŒºåŸŸï¼ŒMDL æ˜ å°„çš„è™šæ‹Ÿå†…å­˜å’Œé©±åŠ¨æ˜ åƒéƒ½åœ¨æ­¤å¤„   |
| FFFFF8a000000000       | FFFFF8bFFFFFFFFF         | 128GB     | Paged Pool Area          | åˆ†é¡µå†…å­˜åŒºåŸŸ                                           |
| FFFFF90000000000       | FFFFF97FFFFFFFFF         | 512GB     | Session Space            |                                                        |
| FFFFF98000000000       | FFFFFa70FFFFFFFF         | 1TB       | Dynamic Kernel VA Space  | åŠ¨æ€å†…å­˜åŒºåŸŸ                                           |
| FFFFFa8000000000       | *nt!MmNonPagedPoolStart-1 | 6TB Max   | PFN Database             | å­˜å‚¨ PFN ç›¸å…³ä¿¡æ¯                                      |
| *nt!MmNonPagedPoolStart | *nt!MmNonPagedPoolEnd     | 512GB Max | Non-Paged Pool           | éåˆ†é¡µå†…å­˜åŒºåŸŸï¼ˆä¸ä¼šè¢«æ¢åˆ°ç¡¬ç›˜ä¸Šï¼‰                     |
| FFFFFFFFFFc00000       | FFFFFFFFFFFFFFFF         | 4MB       | HAL and Loader Mappings  | ç¡¬ä»¶æŠ½è±¡å±‚ä¸åŠ è½½å™¨æ‰€ç”¨åŒºåŸŸ                             |

#### _MMPFNï¼šç‰©ç†é¡µæ¡†

ç±»ä¼¼äº Linux kernel ä¸­ä½¿ç”¨ `page` ç»“æ„ä½“æ•°ç»„è¡¨ç¤ºç‰©ç†å†…å­˜çš„æ–¹å¼ï¼Œåœ¨ NT kernel ä¸­ä½¿ç”¨ `_MMPFN` ç»“æ„ä½“æ¥è¡¨ç¤º**ä¸€å¼ ç‰©ç†é¡µ**ï¼Œå¹¶é€šè¿‡ä¸€ä¸ª**ç»“æ„ä½“æ•°ç»„**æ¥ç®¡ç†**æ‰€æœ‰çš„ç‰©ç†å†…å­˜é¡µ**ï¼Œæ•°ç»„ä¸‹æ ‡å³ä¸ºç‰©ç†é¡µçš„**é¡µå¸§å·**ï¼ˆPage Frame Numberï¼ŒPFNï¼‰ï¼Œè¯¥æ•°ç»„å³ä¸º `PFN Database` åŒºåŸŸï¼Œåœ¨å…¨å±€æŒ‡é’ˆå˜é‡ `_MMPFN* MmPfnDatabase`  ä¸­å­˜æ”¾ç€è¯¥æ•°ç»„çš„åœ°å€ï¼š

![](https://s2.loli.net/2025/02/01/DjXOsiKcuGe3F62.png)

æ ¹æ® Page çš„ä¸åŒç”¨é€”ï¼Œé active é¡µé¢å¯¹åº”çš„`_MMPFN` ä¼šè¢«æ”¾å…¥ä¸åŒçš„é“¾è¡¨å½“ä¸­ï¼Œé“¾è¡¨å¤´ä¸º `_MMPFNLIST` ç»“æ„ä½“ï¼š

- `MmZeroedPageListHead` ï¼šæ¸…é›¶äº†çš„ç©ºé—²é¡µé¢é“¾è¡¨
- `MmFreePageListHead`ï¼šå¸¸è§„ç©ºé—²é¡µé¢é“¾è¡¨ï¼Œç³»ç»Ÿç©ºé—²æ—¶ä¼šä»ä¸­å–å‡ºé¡µé¢è¿›è¡Œæ¸…é›¶åæ”¾åˆ° `MmZeroedPageListHead`  ä¸Š
- `MmStandbyPageListHead`ï¼šè¿›ç¨‹ä»å…¶å·¥ä½œé›†ï¼ˆworking setï¼Œå³**è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­é©»ç•™åœ¨ç‰©ç†å†…å­˜ä¸­çš„ä¸€ç»„é¡µé¢**ï¼‰ä¸­ä¸¢å¼ƒé¡µé¢æ—¶ï¼Œè‹¥é¡µæœªè¢«ä¿®æ”¹åˆ™æ”¾å…¥è¯¥é“¾è¡¨ï¼Œåœ¨ free é“¾è¡¨å’Œ zeroed é“¾è¡¨éƒ½ä¸ºç©ºæ—¶ä¼šä»ä¸Šåˆ†é…é¡µé¢
- `MmModifiedPageListHead`ï¼šè¿›ç¨‹ä»å…¶å·¥ä½œé›†ä¸­ä¸¢å¼ƒé¡µé¢æ—¶ï¼Œè‹¥é¡µè¢«ä¿®æ”¹ä¸”éœ€è¦å†™å›ç£ç›˜åˆ™æ”¾å…¥è¯¥é“¾è¡¨ï¼Œåœ¨ modified page writer å®Œæˆæ“ä½œä¹‹åä¼šå°†é¡µé¢æ”¾è‡³ standby é“¾è¡¨
- `MmModifiedNoWritePageListHead`ï¼šè¿›ç¨‹ä»å…¶å·¥ä½œé›†ä¸­ä¸¢å¼ƒé¡µé¢æ—¶ï¼Œè‹¥é¡µè¢«ä¿®æ”¹ä¸”**ä¸**éœ€è¦å†™å›ç£ç›˜åˆ™æ”¾å…¥è¯¥é“¾è¡¨ï¼Œmodified page writer å®Œæˆæ“ä½œä¹‹åä¼šå°†é¡µé¢æ”¾è‡³ standby é“¾è¡¨
- `MmBadPageListHead`ï¼šè¿™äº›é¡µé¢å¯èƒ½å­˜åœ¨ä¸€äº›æ•…éšœ

> è¿›ç¨‹ä»å…¶å·¥ä½œé›†ä¸­ä¸¢å¼ƒé¡µé¢æœ‰ä¸¤ç§åŸå› ï¼Œä¸€æ˜¯åŸæœ‰å·¥ä½œé›†å·²æ»¡ä¸”è¦å¼•å…¥æ–°é¡µé¢ï¼ŒäºŒæ˜¯å†…å­˜ç®¡ç†å™¨ä¿®å‰ªäº†å…¶å·¥ä½œé›†ï¼ˆä¾‹å¦‚å†…å­˜ä¸å¤Ÿç”¨äº†ï¼‰ã€‚
>
> åœ¨è¿›ç¨‹é€€å‡ºæ—¶ï¼Œæ‰€æœ‰çš„é¡µé¢éƒ½ä¼šè¿›å…¥ freepagelist é“¾è¡¨ä¸­ã€‚

![](https://s2.loli.net/2025/02/01/F31JSlV7XCruWyT.png)

é¡µé¢åœ¨ä¸åŒé“¾è¡¨é—´å¾ªç¯çš„æ€»è§ˆå›¾å¦‚ä¸‹ï¼š

![](https://s2.loli.net/2025/02/01/p2amPDjBd34IZYk.png)

åœ¨ `_MMPFN` ç»“æ„ä½“å½“ä¸­åŒæ ·ç”¨äº†å¤§é‡çš„ unionï¼Œå½“é¡µé¢åœ¨ä¸åŒé“¾è¡¨é—´å¾ªç¯æ—¶ï¼Œ `_MMPFN` ä¸åŒåç§»çš„å­—æ®µæœ‰ç€ä¸åŒå«ä¹‰ï¼š

![image.png](https://s2.loli.net/2023/12/29/JqmC3DZRiVpMPbB.png)

#### é¡µä½å›¾

> å¾…æ–½å·¥ã€‚

### äºŒã€Pool Memoryï¼ˆbefore 19H1ï¼‰

Windows NT kernel å°†é¡µé¢æŒ‰ç…§ä¸åŒçš„ç”¨é€”åˆ†ä¸ºä¸åŒçš„â€œ**æ± **â€ï¼ˆPoolï¼‰æ¥ç®¡ç†ï¼Œå¹¶å°†è¿™äº›é¡µé¢åˆ’åˆ†ä¸ºæ›´ç»†ç²’åº¦çš„å°å¯¹è±¡ä¾›å†…æ ¸ç»„ä»¶ä½¿ç”¨ï¼Œæ± çš„æ€»ç±»ä¸€å…±æœ‰ä¸‰ç§ï¼š

- éæ¢é¡µæ± ï¼ˆNon Paged Poolï¼‰ï¼šè¯¥æ± ä¸­çš„é¡µé¢å¸¸é©»ç‰©ç†å†…å­˜ä¸­ï¼Œä¸ä¼šè¢«æ¢å‡ºåˆ°ç£ç›˜
- æ¢é¡µæ± ï¼ˆPaged Poolï¼‰ï¼šè¯¥æ± ä¸­çš„é¡µé¢åœ¨å†…å­˜ç´§å¼ æ—¶å¯èƒ½è¢«æ¢å‡ºåˆ°ç£ç›˜
- ä¼šè¯æ¢é¡µæ± ï¼ˆSession Paged Poolï¼‰ï¼šè¯¥æ± ä¸­çš„é¡µé¢åœ¨å†…å­˜ç´§å¼ æ—¶å¯èƒ½è¢«æ¢å‡ºåˆ°ç£ç›˜ï¼Œä¸åŒä¼šè¯é—´å­˜åœ¨éš”ç¦»

#### åŸºæœ¬å•ä½ï¼šæ± å—ï¼ˆPool Blockï¼‰

æ± å†…å­˜ä¸­æ¯æ¬¡å†…å­˜åˆ†é…çš„å¯¹è±¡ç§°ä¸ºä¸€ä¸ªæ± å—ï¼ˆPool Blockï¼‰ï¼Œç±»ä¼¼äº ptmalloc2 ä¸­çš„ chunkï¼Œæ¯ä¸ªæ± å—çš„æ•°æ®å‰éƒ¨æœ‰ä¸€ä¸ª header å­˜å‚¨å¦‚ä¸‹æ•°æ®ï¼š

- Previous Sizeï¼šç›¸é‚»ä½åœ°å€æ± å—çš„å¤§å°**å³ç§» 4 ä½çš„ç»“æœ**
- Pool Indexï¼šæ± å—å½’å±çš„æ± æè¿°ç¬¦ç»„çš„ç´¢å¼•ï¼Œå¤šä¸ªæ± æè¿°ç¬¦ç»„æˆä¸€ä¸ªæ± æè¿°ç¬¦æ•°ç»„
- Block Sizeï¼šæ± å—å¤§å°**å³ç§» 4 ä½çš„ç»“æœ**
- Pool Typeï¼šæ± å—æ‰€å±æ± çš„ç±»å‹
- Pool Tagï¼šè°ƒè¯•æ—¶ç”¨äºè¿›è¡Œè¯†åˆ«çš„å­—ç¬¦
- ï¼ˆä¸€ä¸ªUnionï¼‰ï¼š
    - Process Billedï¼šæŒ‡å‘åˆ†é…äº†è¿™ä¸ªæ± å—çš„è¿›ç¨‹æè¿°ç¬¦ `_EPROCESS` çš„æŒ‡é’ˆ
    - ï¼ˆä¸€ä¸ªç»“æ„ä½“ï¼‰
        - Allocator Back Trace Indexï¼š
        - Pool Tag Hashï¼š

æ­¤å¤–ï¼Œè‡ª Windows Server 2003 ç‰ˆæœ¬èµ·ï¼Œåœ¨ Pool Chunk å°¾éƒ¨å¼•å…¥äº† Canary å­—æ®µï¼Œç”¨äºé¢„é˜²æ½œåœ¨çš„ chunk overflowï¼Œè¿™ä¸ªå€¼ä¼šåœ¨ ï¼ˆ _æš‚æ—¶æ²¡æŸ¥åˆ°æ›´å¤šä¿¡æ¯ï¼Œæ¨æµ‹æ˜¯æ± å—åˆ†é…ä¸é‡Šæ”¾æ—¶_ ï¼‰ æ—¶è¢«æ£€æŸ¥ã€‚

![](https://s2.loli.net/2025/02/01/abBQ3WwxVCvdPj8.png)

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPool Chunk ä»…ç”¨äºè¯·æ±‚å†…å­˜å¤§å°ä¸å¤§äº 4080 å­—èŠ‚çš„æƒ…å†µï¼ˆåŠ ä¸Š 16 å­—èŠ‚çš„ header åˆšå¥½ä¸€å¼ å†…å­˜é¡µå¤§å°ï¼‰ã€‚

Pool Chunk çš„ç®¡ç†ä¸ ptmalloc2 chunk éå¸¸ç›¸ä¼¼ï¼Œåœ¨ NT kernel ä¸­ä¼šå¤ç”¨ Freed Chunk çš„ Data å­—æ®µæ¥ç»„ç»‡ Free Chunk ä¸ºå•å‘æˆ–åŒå‘é“¾è¡¨ï¼š

![](https://s2.loli.net/2025/02/03/MoOTksItJ6Wvdmr.png)

#### æ± æè¿°ç¬¦ï¼šå†…æ ¸å…±äº«å†…å­˜æ± 

> è¿™ä¸ªç»“æ„åœ¨ Windows 10 æ•°ä¸ªç‰ˆæœ¬å½“ä¸­ä¹Ÿç»å†äº†ä¸€å®šçš„å¤§å¤§å°å°çš„å˜åŒ–ï¼Œ ä½†æ¯”è¾ƒå…³é”®çš„å˜åŒ–æ˜¯ä» 1809 ç‰ˆæœ¬åˆ° 1903 ï¼ˆ19H1ï¼‰ç‰ˆæœ¬ï¼Œè‡ª 1903 ç‰ˆæœ¬ NT kernel å¼•å…¥äº† Segment Heap æœºåˆ¶ä½œä¸ºå†…æ ¸çš„åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼Œå› æ­¤è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä¸»è¦è®² 1809 åŠä»¥å‰çš„ä»ä½¿ç”¨æ± å†…å­˜åˆ†é…å™¨çš„ 64 ä½ç‰ˆæœ¬ã€‚

ç±»ä¼¼äº Linux kernel ä¸­çš„ `kmem_cache` ï¼ŒWindows kernel ä¸­å•ä¸ªå†…å­˜æ± ä½¿ç”¨ `_POOL_DESCRIPTOR` ç»“æ„è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://s2.loli.net/2025/02/05/lcemqOtFIfyMCVa.png)

æ± æè¿°ç¬¦æ‰€å¯¹åº”çš„å†…å­˜æ± åœ¨æ•´ä¸ªå†…æ ¸é—´å…±äº«ï¼Œæ¯”è¾ƒæ ¸å¿ƒçš„æœ‰ä¸¤ä¸ªé“¾è¡¨ï¼š

- ListHeads é“¾è¡¨æ•°ç»„ï¼šå­˜æ”¾å¸¸è§„çš„é‡Šæ”¾åçš„æ± å—ï¼Œä½¿ç”¨åŒå‘é“¾è¡¨è¿›è¡Œè¿æ¥ï¼Œæ ¹æ®æ± å—å¤§å°çš„ä¸åŒæ”¾å…¥ä¸åŒçš„å­é“¾è¡¨ä¸­
- PendingFrees é“¾è¡¨ï¼šå½“å†…å­˜æ± è®¾ç½®äº† `DELAY_FREE` æ ‡å¿—ä½æ—¶ï¼Œæ± å—é‡Šæ”¾åä¼šå…ˆé“¾å…¥è¯¥å•å‘é“¾è¡¨ï¼ˆå¤§å°ä¸é™ï¼‰ï¼Œå½“é“¾è¡¨æ·±åº¦è¶…è¿‡æŒ‡å®šå€¼æ—¶å†ç»Ÿä¸€å›æ”¶

æ‰€æœ‰åˆå§‹çš„å†…å­˜æ± æè¿°ç¬¦éƒ½æ”¾åœ¨ `nt!PoolVector` æ•°ç»„å½“ä¸­ã€‚

#### æ ¸å¿ƒç‹¬å å†…å­˜æ± ï¼šLookaside Lists

æ± æè¿°ç¬¦å¯¹åº”çš„å†…å­˜æ± åœ¨æ‰€æœ‰æ ¸å¿ƒé—´å…±äº«ï¼Œæ ¸å¿ƒä¸€å¤šæ•ˆç‡å°±ç¾éš¾äº†ï¼Œå› æ­¤æ¯ä¸ªæ ¸å¿ƒå®é™…ä¸Šè¿˜æœ‰ä¸€ä¸ªç‹¬æœ‰çš„å†…å­˜æ± ï¼Œå­˜æ”¾åœ¨å†…æ ¸æ€ GS å¯„å­˜å™¨æŒ‡å‘çš„ `å¤„ç†å™¨æ§åˆ¶åŒº`ï¼ˆProcess Control Regionï¼Œä¸º `_KPCR` ç»“æ„ä½“ï¼Œç±»ä¼¼äº Linux ä¸‹çš„ `.percpu` æ®µï¼‰å½“ä¸­â€”â€” Lookaside Lists ç”¨äºä¼˜å…ˆå¤„ç†å½“å‰æ ¸å¿ƒçš„æ± å†…å­˜è¯·æ±‚ï¼Œåªæœ‰å½“å…¶ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚æ—¶æ‰ä¼šå‘å…±äº«å†…å­˜æ± è¯·æ±‚å†…å­˜ã€‚

LookasideList çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ ¹æ®å¤§å°å½’å±æ•°ç»„ä¸Šä¸åŒçš„é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨åˆåˆ†ä¸ºäºŒä¸ªå­é“¾ï¼šä¸€ä¸ªå•å‘é“¾è¡¨ï¼ˆé»˜è®¤ï¼Œé•¿åº¦æœ‰ä¸Šé™ï¼ŒLIFOï¼‰ä¸ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ˆå‰è€…æ»¡æ—¶æ”¾åˆ°è¿™ï¼‰ï¼ŒLookasideList çš„æ•°ç»„æˆå‘˜æ•°é‡è¾ƒå°‘å› æ­¤ä»…ç”¨äºè¾ƒå°çš„å†…å­˜åˆ†é…ã€‚

![](https://s2.loli.net/2025/02/05/VBuc9hZysC2fbr4.png)

LookasideList ä¸€å…±æœ‰å››ç±»ï¼ˆ`PP == Per Processsor`ï¼‰ï¼š

- PPLookasideListï¼šç”¨äºé¢‘ç¹åˆ†é…ä¸é‡Šæ”¾çš„å¯¹è±¡çš„ LookasideList
- PPNxPagedLookasideListï¼šéæ¢é¡µæ± çš„ non-eXecuted é¡µé¢çš„ LookasideList
- PPNPagedLookasideListï¼šéæ¢é¡µæ± çš„ LookasideList
- PPPagedLookasideListï¼šæ¢é¡µæ± çš„ LookasideList

> PPLookasideList å’Œå…¶ä»– LookasideList æœ‰ä»€ä¹ˆä¸åŒï¼Ÿç¬”è€…ä¹Ÿä¸çŸ¥é“ ~~ï¼Œé™å¾… Windows å¼€æºçš„é‚£ä¸€å¤©~~ ......

#### å†…å­˜åˆ†é…åŸºæœ¬ç®—æ³•

##### 1. å†…å­˜è¯·æ±‚é¡ºåº

æ± å†…å­˜çš„åˆ†é…æ ¸å¿ƒå‡½æ•°æ˜¯ `ExAllocatePoolWithTag(POOL_TYPE PoolType,SIZE_T NumberOfBytes,ULONG Tag)` ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨æŒ‡å®šåˆ†é…çš„æ± ç±»å‹ã€éœ€è¦çš„å†…å­˜å¤§å°ç­‰ä¿¡æ¯ï¼Œå†…æ ¸ç»„ä»¶ä¸é©±åŠ¨é€šå¸¸é€šè¿‡è¯¥ API æˆ–æ˜¯æ›´ä¸Šå±‚çš„ Wrapper å®Œæˆå†…æ ¸ä¸­çš„å†…å­˜åˆ†é…è¯·æ±‚

- é€šç”¨çš„æ± å†…å­˜åˆ†é…ä»…é€‚ç”¨äºå°äº 4080 å­—èŠ‚çš„å†…å­˜è¯·æ±‚ï¼Œå¯¹äºå¤§äºè¿™ä¸ªå¤§å°çš„å†…å­˜è¯·æ±‚åˆ™å†…éƒ¨ä¼šé€šè¿‡ `nt!ExpAllocateBigPool()` å®Œæˆ
- é¦–å…ˆä¼šå°è¯•æ ¹æ®è¯·æ±‚çš„æ± ç±»å‹ä» `_KPCR` çš„ LookasideList åŒºåŸŸçš„ä¸åŒé“¾è¡¨è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚æœå¯ä»¥æ»¡è¶³åˆ™ç›´æ¥è¿”å›
- è‹¥ LookasideList æ— æ³•æ»¡è¶³ï¼Œé”ä¸Šå¯¹åº”çš„æ± ï¼Œå¹¶å°è¯•ä» ListHeads é“¾è¡¨è¿›è¡Œåˆ†é…ï¼Œè‹¥åˆ†é…çš„æ± å—å¤§å°å¤§äºæ‰€éœ€åˆ™ä¼šå°†å…¶åˆ†å‰²ä¸ºä¸¤å—ï¼Œä¸€å—è¿”å›ç»™ç”¨æˆ·ä¸€å—æŒ‚å› ListHeads é“¾è¡¨
- è‹¥æ— å¯ç”¨æ± å—ï¼Œåˆ™ä¼šè°ƒç”¨ `nt!MiAllocatePoolPages` åˆ†é…å†…å­˜é¡µï¼Œå¹¶å°†å…¶åˆ†å‰²ä¸ºä¸¤å—ï¼Œä¸€å—è¿”å›ç»™ç”¨æˆ·ä¸€å—æŒ‚å› ListHeads é“¾è¡¨


##### 2. æ± å—åˆ†å‰²æ–¹æ³•ï¼šéé¡µå¯¹é½çš„å—ä»å°¾éƒ¨åˆ†å‰²

åœ¨åˆ†å‰²æ± å—æ—¶ï¼Œå†…æ ¸é¦–å…ˆä¼šæ£€æŸ¥æ± å—çš„åœ°å€ï¼Œè‹¥ä¸å†…å­˜é¡µå¤§å°å¯¹é½ï¼ˆ0x1000ï¼‰åˆ™ä»å¤´éƒ¨åˆ†å‰²å‡ºç”¨æˆ·æ‰€éœ€çš„æ± å—ï¼Œå¦åˆ™ä»å°¾éƒ¨åˆ†å‰²ä¸‹ç”¨æˆ·æ‰€éœ€çš„æ± å—ã€‚

![](https://s2.loli.net/2025/02/05/tNK6CdgSholBeq4.png)

#### å†…å­˜é‡Šæ”¾åŸºæœ¬ç®—æ³•

æ± å†…å­˜çš„é‡Šæ”¾æ ¸å¿ƒå‡½æ•°æ˜¯ `ExFreePoolWithTag( PVOID Entry, ULONG Tag)` ï¼Œå†…æ ¸ç»„ä»¶ä¸é©±åŠ¨é€šå¸¸é€šè¿‡è¯¥ API æˆ–æ˜¯æ›´ä¸Šå±‚çš„ Wrapper å®Œæˆå†…æ ¸ä¸­çš„å†…å­˜é‡Šæ”¾è¯·æ±‚ã€‚

åœ¨ Chunk header å½“ä¸­å­˜æ”¾ç€è¯¥ Chunk æ‰€å±çš„ Pool Type & Indexï¼Œå› æ­¤é‡Šæ”¾æ—¶å¯ä»¥ç›´æ¥åˆ¤æ–­å½’å±çš„ Pool ä¸å¯¹åº”çš„ Listï¼Œå…·ä½“é‡Šæ”¾æµç¨‹å¦‚ä¸‹ï¼š

- é¦–å…ˆæ£€æŸ¥è¯¥ Chunk æ˜¯å¦ä¸ºé¡µçš„ç¬¬ä¸€ä¸ª Chunk ï¼ˆé¡µå¯¹é½ï¼‰ï¼Œè‹¥æ˜¯åˆ™å°è¯•è°ƒç”¨ `nt!MiFreePoolPages()` è¿›è¡Œå›æ”¶ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›
- æ¥ä¸‹æ¥æ£€æŸ¥ç‰©ç†ç›¸é‚»é«˜åœ°å€ Chunk çš„ PrevSize æ˜¯å¦ä¸è¯¥ Chunk header è®°å½•çš„ Size ç›¸ç­‰ï¼Œè‹¥å¦ä¼šæŠ¥é”™
- å¦‚æœ Size å°äºæŸä¸ªç‰¹å®šå€¼ï¼Œå°è¯•æ”¾å›ç›¸åº”çš„ Lookaside List ä¸­
- å¦‚æœå¯¹åº”çš„ Pool è®¾ç½®äº† `DELAY_FREE` æ ‡å¿—ä½ï¼Œæ”¾å› PendingFrees Listï¼ˆå¦‚æœPendingFreeDepth å¤§äºæŸä¸ªç‰¹å®šå€¼ï¼Œä¼šå…ˆè°ƒç”¨ `nt!ExDeferredFreePool` å‡½æ•°æ¸…ç©º PendingFrees Listï¼‰
- æ£€æŸ¥ç›¸é‚»ä½åœ°å€ã€é«˜åœ°å€ Chunk çŠ¶æ€ï¼Œåˆå¹¶ç©ºé—²å—ï¼Œéœ€è¦æ³¨æ„è¿™é‡Œ _ä¸ä¼šä¸ä¸‹ä¸€å¼ å†…å­˜é¡µçš„å¤´éƒ¨ Chunk åˆå¹¶_ 
- æœ€åæ£€æŸ¥è¯¥ Chunk æ‰€åœ¨ Page æ˜¯å¦ä¸ºç©ºé—²é¡µï¼Œè‹¥æ˜¯åˆ™è°ƒç”¨ `nt!MiFreePoolPages()` è¿›è¡Œå›æ”¶ï¼Œå¦åˆ™æ”¾å›å¯¹åº”çš„ ListHeads é“¾è¡¨

### ä¸‰ã€Segment Heap in Kernelï¼ˆfrom 19H1ï¼‰

**è‡ª NT kernel 19H1 ç‰ˆæœ¬èµ·ï¼Œç”¨æˆ·æ€ Segment Heap çš„åˆ†é…é€»è¾‘è¢«å¼•å…¥å†…æ ¸ã€‚**

> å¾…æ–½å·¥ã€‚

## ç³»ç»Ÿè°ƒç”¨

### ä¸€ã€ç³»ç»Ÿè°ƒç”¨è·¯å¾„

ç±»ä¼¼äº Linux ä¸‹çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒWindows ä¸‹ç”±å†…æ ¸å‘ç”¨æˆ·æ€è¿›ç¨‹æä¾›çš„æœåŠ¡ç§°ä¸º**ç³»ç»ŸæœåŠ¡**ï¼ˆsystem serviceï¼‰ï¼Œæ‰€æœ‰å¯¹ç³»ç»ŸæœåŠ¡çš„è°ƒç”¨éƒ½é€šè¿‡ `ntdll.dll` æ¥å®Œæˆè¿›å…¥å†…æ ¸çš„è¿‡ç¨‹ï¼š

![ä»¥ Notepad åˆ›å»ºæ–‡ä»¶ä¸ºç¤ºä¾‹çš„ Windows ç³»ç»Ÿè°ƒç”¨è·¯å¾„](https://s2.loli.net/2025/02/01/cbfeQk6OagNXMZP.png)

> åœ¨ `ntdll.dll` ä¸­ä»¥ `Nt` å¼€å¤´çš„ä»¥åŠä»¥ `Zw` å¼€å¤´çš„å‡½æ•°çš†ä¸ºç³»ç»Ÿè°ƒç”¨ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰å·®åˆ«ã€‚

ä»¥ `NtDeleteFile` è¿™ä¸€ç³»ç»ŸæœåŠ¡ä¸ºä¾‹ï¼Œè‹¥æ”¯æŒ syscall æŒ‡ä»¤åˆ™é€šè¿‡ `syscall` æŒ‡ä»¤è¿›å…¥å†…æ ¸ï¼Œå¦åˆ™é€šè¿‡ `int 0x2E` è½¯ä¸­æ–­èµ°ä¸­æ–­é—¨è¿›å…¥å†…æ ¸ï¼š

![](https://s2.loli.net/2025/02/01/byVx3MwQfCKJavL.png)

> `0x7FFE0000` è¿™å—åŒºåŸŸä¸ºä¸€å—**å†…æ ¸ä¸ç”¨æˆ·è¿›ç¨‹å…±äº«çš„å†…å­˜**ï¼ˆåªæœ‰å†…æ ¸æœ‰å†™æƒé™ï¼‰ï¼Œä¸ºä¸€ä¸ª `KUSER_SHARED_DATA` ç»“æ„ä½“ï¼Œç”±å†…æ ¸å‘ç”¨æˆ·æ€æä¾›ä¸€äº›ä¿¡æ¯ã€‚
>
> åœ¨åç§» `0x308` å¤„å­˜æ”¾çš„ä¾¿æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨æ¥æ ‡è¯†è¯¥æ¶æ„æ˜¯å¦æ”¯æŒ `syscall` æŒ‡ä»¤ã€‚

Windows ç³»ç»Ÿè°ƒç”¨å†…æ ¸å±‚çš„å…¥å£è¢«è®¾ç½®ä¸º `KiSystemCall64()` å‡½æ•°ï¼Œå½“è¿›è¡Œ `syscall` æŒ‡ä»¤/ `0x2E` è½¯ä¸­æ–­æ—¶ï¼ŒCPU ä¼šåˆ‡æ¢åˆ° ring0 å¹¶æ‰§è¡Œè¯¥å‡½æ•°ä½œä¸ºç»Ÿä¸€çš„ç³»ç»Ÿè°ƒç”¨å…¥å£ç‚¹ï¼Œè¯¥å‡½æ•°å®šä¹‰äº `ntoskrnl.exe` ä¸­ï¼Œæ ¹æ® `rax` å¯„å­˜å™¨æŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨å·æ¥è°ƒç”¨ SSDT ä¸­å¯¹åº”çš„å†…æ ¸å‡½æ•°ã€‚

![](https://s2.loli.net/2025/02/01/VLWQjOwufy8UnT4.png)

> æ³¨ï¼šæœ‰çš„æ—¶å€™ç³»ç»Ÿè°ƒç”¨å…¥å£ä¸º `kiSystemCall64Shadow()` å‡½æ•°ï¼Œä¸è¿‡è¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè·³è½¬åˆ° `kiSystemCall64()` ä¸­çš„ `KiSystemServiceUser` æ ‡ç­¾ã€‚

### äºŒã€ç³»ç»ŸæœåŠ¡æè¿°ç¬¦è¡¨

#### SSDT åŸºæœ¬ç»“æ„

é€†å‘åˆ†æ `ntoskrnl.exe` ä¸­çš„  `KiSystemCall64()` å‡½æ•°ï¼Œæ³¨æ„åˆ°å…¶ä¼šå¼•ç”¨åˆ° `KeServiceDescriptorTable` å’Œ `KeServiceDescriptorTable` è¿™ä¸¤ä¸ªå˜é‡ï¼Œè¿™ä¾¿æ˜¯**ç³»ç»ŸæœåŠ¡æè¿°ç¬¦è¡¨**ï¼ˆSystem Service Descriptor Tableï¼Œç®€ç§° `SSDT` ï¼‰ï¼Œç”¨æ¥å­˜å‚¨**ä¸åŒçš„ç³»ç»Ÿè°ƒç”¨å·å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°**ï¼š

![](https://s2.loli.net/2025/02/01/AycmGR8wENvHjeg.png)

å…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª `tag_SERVICE_DESCRIPTOR_TABLE` ç»“æ„ä½“ï¼Œä¸ºç”±å››å¼ å­è¡¨ç»„æˆçš„ `SYSTEM_SERVICE_TABLE` **ç»“æ„ä½“æ•°ç»„**ï¼š

```c
typedef struct tag_SERVICE_DESCRIPTOR_TABLE {
    SYSTEM_SERVICE_TABLE nt;		// KeServiceDescriptorTable åªæœ‰è¿™å¼ è¡¨
    SYSTEM_SERVICE_TABLE win32k;	// KeServiceDescriptorTableShadow é¢å¤–å¤šç”¨ä¸€ä¸ªè¿™å¼ è¡¨
    SYSTEM_SERVICE_TABLE sst3;
    SYSTEM_SERVICE_TABLE sst4;
} SERVICE_DESCRIPTOR_TABLE;
```

 `SYSTEM_SERVICE_TABLE` ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œå…¶ä¸­çš„ `ServiceTable` æˆå‘˜ä¸ºå®è´¨ä¸Šçš„ç³»ç»Ÿè°ƒç”¨è¡¨ï¼š

```c
typedef struct tag_SYSTEM_SERVICE_TABLE {
    PULONG      ServiceTable;	// å®é™…çš„ç³»ç»Ÿè°ƒç”¨è¡¨
    PULONG      CounterTable;	// 
    ULONG       ServiceLimit;	// ç³»ç»Ÿè°ƒç”¨çš„æ•°é‡
    PCHAR       ArgumentTable;	// å‚æ•°æ•°é‡è¡¨
} SYSTEM_SERVICE_TABLE;
```

![](https://s2.loli.net/2025/02/01/vNFWB1j9YVIZEdH.png)

`ServiceTable` æˆå‘˜ **å®é™…ä¸Šä¸ºä¸€ä¸ªæŒ‡å‘ã€ç›®æ ‡å‡½æ•°åˆ°ç³»ç»Ÿè°ƒç”¨è¡¨åç§»ã€‘çš„æ•°ç»„çš„æŒ‡é’ˆï¼Œæ¯ä¸€é¡¹ä¸º 4 å­—èŠ‚**ï¼Œä½†æ˜¯å®é™…ä¸Šè®¡ç®—æ—¶ä¼š _å°†è¯¥å€¼å…ˆå³ç§»å››ä½_ åå†ä¸ _ç³»ç»Ÿè°ƒç”¨è¡¨èµ·å§‹åœ°å€_ ç›¸åŠ è·å–ç³»ç»Ÿè°ƒç”¨å®é™…çš„åœ°å€ï¼Œå³ï¼š
$$
Addr_{syscall} = Addr_{ServiceTable} + (ServiceTable[syscall\_nr] >> 4)
$$

ç”±æ­¤æˆ‘ä»¬å¾—åˆ° SSDT çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆä»¥ `NtOpenFile()` ç³»ç»Ÿè°ƒç”¨ä¸ºä¾‹ï¼‰ï¼š

![](https://s2.loli.net/2025/02/01/J4bHB6uQV1nOFMA.png)

åœ¨ Windbg ä¸­éªŒè¯ï¼š

![](https://s2.loli.net/2025/02/01/IgC4Fm9ZYnhp7WQ.png)

è¿™é‡Œä¸ºä»€ä¹ˆè¦è¿›è¡Œå·¦å³ç§» 4 ä½çš„ç¥ç§˜æ“ä½œæœ‰ä»¥ä¸‹åŸå› ï¼š

- **å‡ºäºå®‰å…¨æ€§è€ƒè™‘**ï¼Œè¿™æ ·ä½¿å¾—é€šè¿‡ SSDT è°ƒç”¨åˆ°çš„ç³»ç»Ÿè°ƒç”¨èŒƒå›´è¢«é™åˆ¶åœ¨ SSDT é™„è¿‘ 4G åç§»å¤„ï¼Œé©±åŠ¨åœ°å€ç©ºé—´ä¹‹é—´é—´éš”è‡³å°‘ 4GBï¼Œè€Œ SSDT åœ°å€åˆæ˜¯å†™æ­»åœ¨ä»£ç é‡Œçš„ï¼Œè¿™æ ·å¯ä»¥å¾ˆå¥½åœ°é˜²æ­¢å¯¹ SSDT çš„åŠ«æŒï¼ŒåŠ å¤§æ”»å‡»éš¾åº¦ã€‚
- **å­˜å‚¨æ ˆä¸Šå‚æ•°æ•°é‡**ï¼ŒNT kernel å¾ˆå¤šç³»ç»Ÿè°ƒç”¨å‚æ•°éƒ½è¿œå¤§äº 6 ä¸ªï¼Œå› æ­¤éœ€è¦ä½¿ç”¨æ ˆè¿›è¡Œä¼ å‚ï¼Œæ­¤æ—¶è¿™ 4 bit ä¾¿ç”¨äºè®°å½•ä¸åŒç³»ç»Ÿè°ƒç”¨**ä½¿ç”¨æ ˆè¿›è¡Œä¼ é€’çš„å‚æ•°æ•°é‡**ã€‚

#### _Shadow SSDTï¼šGUIç¨‹åºçš„ SSDT_ 

**å½±å­ç³»ç»ŸæœåŠ¡æè¿°ç¬¦è¡¨**ï¼ˆShadow System Service Descriptor Tableï¼Œç®€ç§° `Shadow SSDT` ï¼‰æ˜¯**GUI ç¨‹åºæ‰€ä¸“ç”¨çš„ä¸€å¼  SSDT**ï¼Œç›¸æ¯”èµ· SSDT è€Œè¨€å…¶é¢å¤–å¤šäº†ä¸€å¼ è´Ÿè´£å›¾å½¢ç›¸å…³ç³»ç»Ÿè°ƒç”¨çš„å­è¡¨ `W32pServiceTable` ï¼Œä½äº `win32k.sys` å³ **å›¾å½¢å­ç³»ç»Ÿ** ä¸­ï¼š

> SSDT å’Œ Shadow SSDT ç¬¬ä¸€å¼ å­è¡¨éƒ½æ˜¯ `KiServiceTable` ï¼Œå¯¹åº” NT kernel çš„å¸¸è§„ç³»ç»Ÿè°ƒç”¨ã€‚

![æ³¨æ„è¿™é‡ŒæŒ‡å‘ SystemServiceTable ä¸æ˜¯æŒ‡é’ˆè€Œæ˜¯å±•å¼€](https://s2.loli.net/2025/02/01/vBinIhjLrtHElw2.png)

å½“åº”ç”¨ç¨‹å¼åœ¨ Windows ä¸‹è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œçº¿ç¨‹æ§åˆ¶å—ï¼ˆ`KTHREAD` ï¼‰ä¸­å¯¹åº”çš„æ ‡å¿—ä½å†³å®šäº†è°ƒç”¨å“ªä¸€å¼ å¤§è¡¨ï¼Œ`eax` å¯„å­˜å™¨çš„ 13 ~ 12 ä½è¢«ç”¨æ¥æŒ‡å®šè°ƒç”¨å“ªä¸€å¼ å­è¡¨ï¼Œä½ 12 ä½åˆ™è¢«ç”¨æ¥æŒ‡å®šè¡¨ä¸­å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨ï¼š

![](https://s2.loli.net/2025/02/01/7EsiL5ednOkg1Y8.png)

> #### _æ‰©å±•é˜…è¯»ï¼šKeServiceDescriptorTableFilter_
>
> è‡ª Windows 10 å¼€å§‹å¼•å…¥äº†è¿™å¼ è¡¨ï¼Œå½“ KTHREAD ä¸­è®¾ç½®äº† `RestrictedGuiThread` æ ‡å¿—ä½æ—¶ä¼šç”¨è¯¥è¡¨æ›¿ä»£ Shadow SSDTï¼Œä¸è¿‡ç›®å‰è¯¥è¡¨ç›¸å…³çš„èµ„æ–™æš‚æ—¶æ¯”è¾ƒå°‘ï¼ˆğŸ•Šï¼‰

## è¿›ç¨‹ç®¡ç†

### ä¸€ã€NT kernel ä¸­çš„è¿›ç¨‹ä¸çº¿ç¨‹

åœ¨ Windows NT kernel å½“ä¸­ä½¿ç”¨ `_EPROCESS` ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹ï¼Œç±»ä¼¼äº Linux ä¸‹çš„ `task_struct`ï¼Œè¯¥ç»“æ„ä½“å½“ä¸­å­˜å‚¨äº† Windows è¿›ç¨‹çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ‰€æœ‰è¿›ç¨‹çš„ `_EPROCESS` ä¹‹é—´æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚

å†…æ ¸æ€ GS å¯„å­˜å™¨æŒ‡å‘ `å¤„ç†å™¨æ§åˆ¶åŒº`ï¼ˆProcess Control Regionï¼‰ï¼Œç±»ä¼¼äº Linux ä¸‹çš„ `.percpu` æ®µï¼Œå…¶ä¸­å­˜æ”¾ç€æŒ‡å‘å½“å‰çº¿ç¨‹æ§åˆ¶å—çš„æŒ‡é’ˆï¼Œåœ¨è¿™å…¶ä¸­ä¾¿åˆå­˜æ”¾ç€æŒ‡å‘å½“å‰è¿›ç¨‹æ§åˆ¶å—çš„æŒ‡é’ˆã€‚

![](https://s2.loli.net/2025/02/01/a5lbF1fgDAUErcz.png)

### äºŒã€Tokenï¼šè¿›ç¨‹æƒé™å‡­è¯

æ­£å¦‚ Linux åœ¨ `task_struct` å½“ä¸­ä½¿ç”¨ `cred` ç»“æ„ä½“æ ‡è¯†è¿›ç¨‹çš„æƒé™ï¼ŒNT kernel ä¸­ä½¿ç”¨ `_Token` ç»“æ„ä½“æ ‡è¯†è¿›ç¨‹çš„æƒé™ã€‚

> å¾…æ–½å·¥ã€‚

## Reference

https://arttnba3.cn/

[Microsoft Learn. Spark possibility. ](https://learn.microsoft.com/en-us/)

ã€Šwindowså†…æ ¸åŸç†ä¸å®ç°ã€‹â€”â€”æ½˜çˆ±æ°‘ è‘—

[CodeMachine - Windows Object Headers](https://codemachine.com/articles/object_headers.html)

[BlackHat USA 2021  - Windows Heapâ€Backed Pool](https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Windows-Heap-Backed-Pool-The-Good-The-Bad-And-The-Encoded.pdf)

[CodeMachine - Kernel Virtual Address Layout](https://codemachine.com/articles/x64_kernel_virtual_address_space_layout.html)

[[åŸåˆ›]Windowså†…å­˜ç¯‡â…¡ x64å†…æ ¸å†…å­˜å¸ƒå±€çš„è¿ç§»æ¼”å˜ ](https://bbs.kanxue.com/thread-262931-1.htm)

[Page Frame Number Database](https://flylib.com/books/en/4.491.1.69/1/)

[Windows ç³»ç»Ÿè°ƒç”¨åˆ†æä¸å…æ€å®ç°](https://myzxcg.com/2022/01/Windows-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%88%86%E6%9E%90%E4%B8%8E%E5%85%8D%E6%9D%80%E5%AE%9E%E7%8E%B0/)

[A Syscall Journey in the Windows Kernel](https://alice.climent-pommeret.red/posts/a-syscall-journey-in-the-windows-kernel/)

[Windows Internals](https://github.com/Faran-17/Windows-Internals)

[æ¢ç´¢Windowså†…æ ¸ç³»åˆ—â€”â€”å¥æŸ„ï¼Œåˆ©ç”¨å¥æŸ„è¿›è¡Œè¿›ç¨‹ä¿æŠ¤](https://tttang.com/archive/1682/)

[AngelBoyâ€”â€”Windows Kernel Heap: Segment heap in windows kernel Part 1](https://speakerdeck.com/scwuaptx/windows-kernel-heap-segment-heap-in-windows-kernel-part-1)

[Inside Windows Page Frame Number (PFN) - Part 1](https://rayanfam.com/topics/inside-windows-page-frame-number-part1/)

[OSR - Windows Pool Manager](https://www.osr.com/nt-insider/2014-issue1/windows-pool-manager/)

[Exploit Development: Swimming In The (Kernel) Pool - Leveraging Pool Vulnerabilities From Low-Integrity Exploits, Part 1](https://connormcgarr.github.io/swimming-in-the-kernel-pool-part-1/)

[Kernel Pool Exploitation on Windows 7 - Tarjei Mandt](https://media.blackhat.com/bh-dc-11/Mandt/BlackHat_DC_2011_Mandt_kernelpool-wp.pdf)

[BlackHat USA 2012 - Windows 8 Heap Internals](https://media.blackhat.com/bh-us-12/Briefings/Valasek/BH_US_12_Valasek_Windows_8_Heap_Internals_Slides.pdf)

[Vergilius Project | Kernels](https://www.vergiliusproject.com/kernels)